<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier Mécanique J.L</title>
  <style>
  :root{
    --bg:#1b1b1b;
    --card:#262626;
    --accent:#f5c542;
    --text:#e6e6e6;
    --border:#3a3a3a;
    --danger:#ff4d4d;
  }
  body{
    font-family:Inter, system-ui, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:18px;
  }
  h1,h2,h3{color:var(--accent);margin:0 0 10px}
  .container{max-width:1080px;margin:0 auto}
  .card{
    background:var(--card);
    padding:18px;
    border-radius:10px;
    border:1px solid var(--border);
    margin-bottom:14px;
    box-shadow:0 4px 10px rgba(0,0,0,0.4);
  }
  input,select,textarea{
    width:100%;padding:8px;
    background:#111;
    color:var(--text);
    border:1px solid var(--border);
    border-radius:6px;
    margin-top:6px;
  }
  label{font-weight:600;font-size:13px}
  button{
    background:var(--accent);
    color:#000;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 3px 6px rgba(0,0,0,0.4);
  }
  button.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid var(--accent);
  }
  table{width:100%;border-collapse:collapse;margin-top:10px;color:var(--text)}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
  th{background:#333;color:var(--accent)}
  .topbar{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:12px
  }
  .history-item{
    background:#202020;border-left:4px solid var(--accent);
    padding:10px;margin-bottom:8px;border-radius:6px
  }
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > div{flex:1;min-width:160px}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .small{font-size:12px;color:#bbbbbb}
  .muted{font-size:12px;color:#aaaaaa}

  @media print{
    body *{visibility:hidden}
    #printArea,*#printArea *{visibility:visible}
    #printArea{position:fixed;left:0;top:0;width:100%}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div style="width:40px;height:40px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:10px">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="#FFD400" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-.46-.5z"/>
        </svg>
      </div>
      <h1>Garage-Atelier Mécanique J.L — Gestion (1 utilisateur)</h1>
      <div class="actions">
        <button id="btnSettings">Paramètres</button>
        <button id="btnExportCSV" class="ghost">Exporter CSV</button>
        <button id="btnPrint">Imprimer / Exporter PDF</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom:8px">Créer Devis / Travail</h2>
      <div class="row">
        <div>
          <label>Client</label>
          <input id="customerName" placeholder="Nom du client" />
        </div>
        <div>
          <label>Numéro de facture (auto)</label>
          <input id="invoiceNumber" disabled />
        </div>
      </div>
      <label>Véhicule / Description</label>
      <input id="jobDesc" placeholder="Ex: Honda Civic 2012 - Freins avant" />

      <div class="flex" style="margin-top:10px">
        <div class="card" style="flex:1">
          <h3 class="small">Ajouter une pièce</h3>
          <label>Nom pièce</label>
          <input id="partName" placeholder="Ex: Plaquette de frein" />
          <div class="row">
            <div>
              <label>Quantité</label>
              <input id="partQty" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Prix unitaire</label>
              <input id="partPrice" type="number" min="0" step="0.01" />
            </div>
          </div>
          <button style="margin-top:8px" id="addPart">Ajouter pièce</button>
        </div>

        <div class="card" style="flex:1">
          <h3 class="small">Ajouter main-d'œuvre</h3>
          <label>Description</label>
          <input id="laborDesc" placeholder="Ex: Remplacement plaquettes" />
          <div class="row">
            <div>
              <label>Heures</label>
              <input id="laborHours" type="number" min="0" step="0.1" />
            </div>
            <div>
              <label>Taux /h</label>
              <input id="laborRate" type="number" min="0" step="0.01" />
            </div>
          </div>
          <button style="margin-top:8px" id="addLabor">Ajouter main-d'œuvre</button>
        </div>
      </div>

      <h3 style="margin-top:12px">Articles</h3>
      <table id="itemsTable">
        <thead><tr><th>Type</th><th>Description</th><th>Qté/hrs</th><th>Prix/unité</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:12px;align-items:center">
        <div style="width:320px;">
          <label>Appliquer taxes</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <label><input type="checkbox" id="applyGST" /> TPS/GST</label>
            <label><input type="checkbox" id="applyQST" /> TVQ/QST</label>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <label class="small">TPS (%)</label>
            <input id="gstRate" type="number" step="0.001" />
            <label class="small">TVQ (%)</label>
            <input id="qstRate" type="number" step="0.001" />
          </div>
        </div>

        <div style="text-align:right;min-width:260px">
          <div class="muted">Sous-total: <span id="subTotal">0.00</span> $</div>
          <div class="muted">TPS: <span id="gstAmount">0.00</span> $</div>
          <div class="muted">TVQ: <span id="qstAmount">0.00</span> $</div>
          <h3>Total: $<span id="totalAmount">0.00</span></h3>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="saveInvoice">Enregistrer facture</button>
            <button id="clearItems" class="ghost">Vider</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Factures enregistrées</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input id="searchInvoices" placeholder="Rechercher client, numéro ou date" />
        <select id="filterSort">
          <option value="new">Les plus récentes</option>
          <option value="old">Les plus anciennes</option>
        </select>
      </div>
      <table id="invoicesTable">
        <thead><tr><th>N°</th><th>Date</th><th>Client</th><th>Véhicule/Job</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Hidden printable area -->
    <div id="printArea" style="display:none"></div>

    <!-- Settings Modal (simple) -->
    <div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
      <div style="width:720px;max-width:95%;background:white;padding:18px;border-radius:10px">
        <h3>Paramètres de l'atelier</h3>
        <label>Nom de l'entreprise</label>
        <input id="companyName" />
        <label>Adresse / Téléphone</label>
        <textarea id="companyContact" rows="2"></textarea>
        <div class="row">
          <div>
            <label>TPS par défaut (%)</label>
            <input id="gstDefault" type="number" step="0.001" />
          </div>
          <div>
            <label>TVQ par défaut (%)</label>
            <input id="qstDefault" type="number" step="0.001" />
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="saveSettings">Sauvegarder</button>
          <button id="closeSettings" class="ghost">Fermer</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- State ---
    let items = [];
    const STORAGE = {
      invoices: 'ar_invoices_v1',
      settings: 'ar_settings_v1',
      invoiceCounter: 'ar_invoice_counter_v1'
    };

    // --- Utilities ---
    const $ = id => document.getElementById(id);
    function money(n){return Number(n||0).toFixed(2)}

    // --- Load settings or defaults ---
    function loadSettings(){
      const s = JSON.parse(localStorage.getItem(STORAGE.settings) || '{}');
      $('companyName').value = s.companyName || 'Garage-Atelier Mécanique J.L';
      $('companyContact').value = s.companyContact || 'Adresse\nTéléphone';
      $('gstDefault').value = s.gstDefault ?? 5.00;
      $('qstDefault').value = s.qstDefault ?? 9.975;
      $('gstRate').value = s.gstDefault ?? 5.00;
      $('qstRate').value = s.qstDefault ?? 9.975;
    }

    // --- Invoice number ---
    function nextInvoiceNumber(){
      let n = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
      localStorage.setItem(STORE.InvoiceCounter, n);
      return String(n).padStart(5,'0');
    }

    function updateInvoiceNumberField(){
      const next = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
      $('invoiceNumber').value = String(next).padStart(5,'0');
    }

    // --- Add items ---
    $('addPart').addEventListener('click',()=>{
      const name = $('partName').value.trim();
      const qty = Number($('partQty').value)||0;
      const price = Number($('partPrice').value)||0;
      if(!name || qty<=0 || price<0) return alert('Nom, quantité et prix requis');
      items.push({type:'Pièce',desc:name,qty,rate:price});
      renderItems();
      $('partName').value='';$('partPrice').value='';$('partQty').value=1;
    });

    $('addLabor').addEventListener('click',()=>{
      const desc = $('laborDesc').value.trim();
      const hrs = Number($('laborHours').value)||0;
      const rate = Number($('laborRate').value)||0;
      if(!desc || hrs<=0 || rate<0) return alert('Description, heures et taux requis');
      items.push({type:"Main-d'œuvre",desc,qty:hrs,rate});
      renderItems();
      $('laborDesc').value='';$('laborHours').value='';$('laborRate').value='';
    });

    function renderItems(){
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML='';
      let sub=0;
      items.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        const total = Number(it.qty)*Number(it.rate);
        sub += total;
        tr.innerHTML = `<td>${it.type}</td><td>${it.desc}</td><td>${it.qty}</td><td>${money(it.rate)}</td><td>${money(total)}</td><td><button data-idx='${idx}' class='ghost'>Suppr</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('#itemsTable button[data-idx]').forEach(b=>b.addEventListener('click',e=>{
        const i = Number(e.currentTarget.dataset.idx); items.splice(i,1); renderItems();
      }));
      $('subTotal').innerText = money(sub);
      applyTaxAndTotals();
    }

    function applyTaxAndTotals(){
      const sub = Number($('subTotal').innerText)||0;
      const gstOn = $('applyGST').checked;
      const qstOn = $('applyQST').checked;
      const gstRate = Number($('gstRate').value)||0;
      const qstRate = Number($('qstRate').value)||0;
      const gstAmount = gstOn ? sub * gstRate/100 : 0;
      const qstAmount = qstOn ? (sub + gstAmount) * qstRate/100 : 0; // QST applied on subtotal+GST in QC rules
      $('gstAmount').innerText = money(gstAmount);
      $('qstAmount').innerText = money(qstAmount);
      $('totalAmount').innerText = money(sub + gstAmount + qstAmount);
    }

    ['applyGST','applyQST','gstRate','qstRate'].forEach(id=>$(id).addEventListener('change',applyTaxAndTotals));

    $('clearItems').addEventListener('click',()=>{items=[];renderItems();});

    // --- Save invoice ---
    $('saveInvoice').addEventListener('click',()=>{
      const customer = $('customerName').value.trim();
      if(!customer) return alert('Nom du client requis');
      if(items.length===0) return alert('Ajouter au moins un élément');
      const inv = {
        number: $('invoiceNumber').value || nextInvoiceNumber(),
        date: new Date().toLocaleString(),
        customer, job: $('jobDesc').value, items: JSON.parse(JSON.stringify(items)),
        subtotal: Number($('subTotal').innerText)||0,
        gst: Number($('gstAmount').innerText)||0,
        qst: Number($('qstAmount').innerText)||0,
        total: Number($('totalAmount').innerText)||0
      };
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      list.unshift(inv);
      localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
      // increment counter if needed
      if(!localStorage.getItem(STORAGE.invoiceCounter)) localStorage.setItem(STORAGE.invoiceCounter, Number(inv.number));
      updateInvoiceNumberField();
      // Reset
      items = [];
      $('customerName').value='';$('jobDesc').value='';
      renderItems();
      loadInvoices();
      alert('Facture enregistrée');
    });

    // --- Load invoices list ---
    function loadInvoices(){
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      const tbody = document.querySelector('#invoicesTable tbody');
      tbody.innerHTML='';
      const q = $('searchInvoices').value.trim().toLowerCase();
      const sorted = list.sort((a,b)=>{ return ($('filterSort').value==='new')? (new Date(b.date) - new Date(a.date)) : (new Date(a.date)-new Date(b.date)); });
      sorted.forEach((inv,idx)=>{
        if(q && !(inv.customer.toLowerCase().includes(q) || inv.number.includes(q) || inv.date.toLowerCase().includes(q))) return;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${inv.number}</td><td>${inv.date}</td><td>${inv.customer}</td><td>${inv.job||''}</td><td>${money(inv.total)}</td><td>
          <div style='display:flex;gap:6px'>
            <button data-idx='${idx}' class='ghost view'>Voir</button>
            <button data-idx='${idx}' class='ghost del'>Suppr</button>
          </div>
        </td>`;
        tbody.appendChild(tr);
      });
      // attach actions
      document.querySelectorAll('#invoicesTable .view').forEach(b=>b.addEventListener('click',e=>{
        const i = Number(e.currentTarget.dataset.idx);
        viewInvoice(i);
      }));
      document.querySelectorAll('#invoicesTable .del').forEach(b=>b.addEventListener('click',e=>{
        if(!confirm('Supprimer facture ?')) return;
        const i = Number(e.currentTarget.dataset.idx);
        const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
        list.splice(i,1);
        localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
        loadInvoices();
      }));
    }

    function viewInvoice(i){
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      const inv = list[i];
      if(!inv) return alert('Facture introuvable');
      // populate printable area
      const settings = JSON.parse(localStorage.getItem(STORAGE.settings) || '{}');
      const company = settings.companyName || 'Garage-Atelier Mécanique J.L';
      const contact = settings.companyContact || '';
      const html = buildInvoiceHTML(company,contact,inv);
      const printArea = $('printArea');
      printArea.style.display='block';
      printArea.innerHTML = html;
      window.print();
      printArea.style.display='none';
    }

    function buildInvoiceHTML(company,contact,inv){
      let itemsHtml = '';
      inv.items.forEach(it=> itemsHtml += `<tr><td>${it.type}</td><td>${it.desc}</td><td>${it.qty}</td><td>${money(it.rate)}</td><td>${money(it.qty*it.rate)}</td></tr>`);
      return `
        <div style='padding:20px;font-family:Arial;width:800px'>
          <h2>${company}</h2>
          <div style='white-space:pre-wrap'>${contact}</div>
          <hr />
          <div style='display:flex;justify-content:space-between'>
            <div><strong>Facture #: </strong>${inv.number}<br/><strong>Date:</strong> ${inv.date}<br/><strong>Client:</strong> ${inv.customer}</div>
            <div><strong>Job:</strong><br/>${inv.job||''}</div>
          </div>
          <table style='width:100%;margin-top:12px;border-collapse:collapse'>
            <thead><tr style='background:#f3f4f6'><th>Type</th><th>Description</th><th>Qté/hrs</th><th>Prix/u</th><th>Total</th></tr></thead>
            <tbody>${itemsHtml}</tbody>
          </table>
          <div style='margin-top:12px;text-align:right'>
            <div>Sous-total: ${money(inv.subtotal)} $</div>
            <div>TPS: ${money(inv.gst)} $</div>
            <div>TVQ: ${money(inv.qst)} $</div>
            <h3>Total: ${money(inv.total)} $</h3>
          </div>
          <hr />
          <div class='small'>Merci! Paiement comptant ou par carte.</div>
        </div>
      `;
    }

    // --- Export CSV ---
    $('btnExportCSV').addEventListener('click',()=>{
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      if(list.length===0) return alert('Aucune facture');
      let csv = 'number,date,customer,job,subtotal,gst,qst,total\n';
      list.forEach(i=> csv += `${i.number},"${i.date}","${i.customer}","${(i.job||'').replace(/"/g,'""')}",${i.subtotal},${i.gst},${i.qst},${i.total}\n`);
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='factures.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // --- Print current draft (assemble invoice from current fields) ---
    $('btnPrint').addEventListener('click',()=>{
      if(items.length===0) return alert('Aucun article à imprimer.');
      const inv = {
        number: $('invoiceNumber').value || nextInvoiceNumber(),
        date: new Date().toLocaleString(),
        customer: $('customerName').value || '', job: $('jobDesc').value,
        items: items, subtotal: Number($('subTotal').innerText)||0, gst: Number($('gstAmount').innerText)||0, qst: Number($('qstAmount').innerText)||0, total: Number($('totalAmount').innerText)||0
      };
      const settings = JSON.parse(localStorage.getItem(STORAGE.settings) || '{}');
      const html = buildInvoiceHTML(settings.companyName||'Garage-Atelier Mécanique J.L',settings.companyContact||'',inv);
      const printArea = $('printArea'); printArea.style.display='block'; printArea.innerHTML = html; window.print(); printArea.style.display='none';
    });

    // --- Settings modal ---
    $('btnSettings').addEventListener('click',()=>{$('settingsModal').style.display='flex';});
    $('closeSettings').addEventListener('click',()=>{$('settingsModal').style.display='none';});
    $('saveSettings').addEventListener('click',()=>{
      const s = {companyName:$('companyName').value,companyContact:$('companyContact').value,gstDefault:Number($('gstDefault').value)||0,qstDefault:Number($('qstDefault').value)||0};
      localStorage.setItem(STORAGE.settings,JSON.stringify(s));
      // update tax fields
      $('gstRate').value = s.gstDefault; $('qstRate').value = s.qstDefault;
      $('settingsModal').style.display='none';
      alert('Paramètres sauvegardés');
    });

    // --- Search/sort handlers ---
    $('searchInvoices').addEventListener('input',loadInvoices);
    $('filterSort').addEventListener('change',loadInvoices);

    // --- Init ---
    loadSettings(); updateInvoiceNumberField(); renderItems(); loadInvoices();

    // --- Simple PWA: register a service worker created from a blob so the app can be installable offline ---
    if('serviceWorker' in navigator){
      const swCode = `self.addEventListener('install', e => { self.skipWaiting(); }); self.addEventListener('activate', e => {clients.claim();}); self.addEventListener('fetch', e => {/* no-op but allows offline install */});`;
      try{
        const blob = new Blob([swCode],{type:'text/javascript'});
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url).then(()=>console.log('SW registered (blob)')).catch(()=>{});
      }catch(e){console.warn('SW failed',e)}
    }

    // Provide guidance for first-time users
    if(!localStorage.getItem('ar_welcome_shown')){
      alert('Astuce: ouvre les Paramètres pour configurer nom d\'entreprise et taux de taxes. Utilise Imprimer -> "Enregistrer en PDF" pour exporter la facture en PDF.');
      localStorage.setItem('ar_welcome_shown', '1');
    }
  </script>

</body>
</html>
