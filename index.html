<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier M√©canique J.L ‚Äî Gestion</title>

  <style>
    :root{
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
      --muted:#aaaaaa;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }
    h1,h2,h3,h4{
      color:var(--accent);
      margin:0 0 10px;
    }
    .muted{color:var(--muted);font-size:0.85rem;}
    a{color:var(--accent);}
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      background:#111;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:6px;
      margin-top:6px;
    }
    textarea{min-height:70px;resize:vertical;}
    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      color:var(--text);
      font-size:0.9rem;
    }
    th,td{
      padding:8px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    th{
      background:#333;
      color:var(--accent);
    }

    #sidebar{
      position:fixed;
      left:0;
      top:0;
      width:220px;
      height:100%;
      background:#111;
      border-right:1px solid var(--border);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:10;
    }
    #sidebar h2{
      color:var(--accent);
      margin-bottom:20px;
      font-size:20px;
    }
    .navBtn{width:100%;text-align:left;}
    .navBtn.active{background:var(--accent);color:#000;}

    .topbar{
      position:fixed;
      top:0;
      left:220px;
      right:0;
      height:70px;
      background:#1b1b1b;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      z-index:9;
    }

    #appPages{
      margin-left:220px;
      margin-top:70px;
      padding:20px;
    }
    .page{display:none;}

    .modal-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index:9999;
      align-items:center;
      justify-content:center;
    }
    .modal-panel{
      background:var(--card);
      width:750px;
      max-width:95%;
      padding:20px;
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
      max-height:90vh;
      overflow-y:auto;
    }

    /* STYLE IMPRESSION PRO */
    @media print {
      body * { visibility: hidden !important; }

      #printArea, #printArea * {
        visibility: visible !important;
      }

      #printArea{
        position:absolute;
        top:0;left:0;
        width:100%;
        background:#fff !important;
        color:#000 !important;
        padding:25px;
        font-family:Arial,sans-serif;
      }

      table th{
        background:#f0f0f0 !important;
        color:#000 !important;
      }
      table td{color:#000 !important;}
    }
  </style>
</head>

  <body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-dashboard">üìä Dashboard</button>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-services">üõ†Ô∏è Services</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="#FFD400">
        <path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-\46-.5z"/>
      </svg>
      <h1 style="font-size:18px;">Garage-Atelier M√©canique J.L ‚Äî Gestion</h1>
    </div>

    <div style="display:flex;gap:10px;">
      <button id="btnPrint">Imprimer facture</button>
    </div>
  </div>

  <!-- PAGES -->
  <div id="appPages">

        <!-- DASHBOARD -->
    <div class="page" id="page-dashboard" style="display:block;">
      <h2>Tableau de bord</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Factures totales</div>
          <div class="stat-value" id="statInvoices">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Revenus totaux</div>
          <div class="stat-value" id="statRevenue">0.00 $</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Clients</div>
          <div class="stat-value" id="statClients">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">V√©hicules</div>
          <div class="stat-value" id="statVehicles">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pi√®ces en stock</div>
          <div class="stat-value" id="statParts">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Stock faible (‚â§ 2)</div>
          <div class="stat-value" id="statLowStock">0</div>
        </div>
      </div>

      <div class="card" style="margin-top:20px;">
        <h3>Raccourcis</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
          <button class="ghost" onclick="showPage('page-invoices')">+ Nouvelle facture</button>
          <button class="ghost" onclick="showPage('page-clients')">+ Nouveau client</button>
          <button class="ghost" onclick="showPage('page-services')">Configurer services</button>
          <button class="ghost" onclick="showPage('page-parts')">G√©rer inventaire</button>
        </div>
      </div>
    </div>

    <!-- FACTURES (cr√©ation) -->
    <div class="page" id="page-invoices">
      <div class="card">
        <h2>Cr√©er Devis / Travail</h2>

        <label>Client</label>
        <input id="customerName" />

        <label>Num√©ro de facture</label>
        <input id="invoiceNumber" disabled />

        <label>Description / V√©hicule</label>
        <input id="jobDesc" />

        <!-- Ajouter une pi√®ce manuellement -->
        <h3>Ajouter une pi√®ce (manuel)</h3>
        <label>Nom pi√®ce / description</label>
        <input id="partName" />
        <label>Quantit√©</label>
        <input id="partQty" type="number" value="1" />
        <label>Prix unitaire</label>
        <input id="partPrice" type="number" />
        <button id="addPart">Ajouter pi√®ce</button>

        <!-- Main d'oeuvre -->
        <h3>Ajouter main-d'≈ìuvre</h3>
        <label>Description</label>
        <input id="laborDesc" />
        <label>Heures</label>
        <input id="laborHours" type="number" step="0.1" />
        <label>Taux / h</label>
        <input id="laborRate" type="number" step="0.01" />
        <button id="addLabor">Ajouter main-d'≈ìuvre</button>

        <!-- Ajouter service enregistr√© -->
        <button id="openServicePicker" class="ghost" style="margin-top:8px;">
          ‚ûï Ajouter un service enregistr√©
        </button>

        <h3>Articles</h3>
        <table id="itemsTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Qt√©/hrs</th>
              <th>Prix</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3>Totaux</h3>
        <div>Sous-total: <span id="subTotal">0.00</span> $</div>
        <div>TPS (5%): <span id="gstAmount">0.00</span> $</div>
        <div>TVQ (9.975%): <span id="qstAmount">0.00</span> $</div>
        <div><strong>Total: <span id="totalAmount">0.00</span> $</strong></div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="saveInvoice">Enregistrer facture</button>
          <button id="clearItems" class="ghost">Vider</button>
        </div>
      </div>

      <!-- Zone utilis√©e pour l‚Äôimpression -->
      <div id="printArea" style="display:none"></div>
    </div>

        <!-- CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Gestion des clients</h2>

      <div class="card">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="clientSearch" placeholder="Rechercher un client..." style="flex:1;min-width:200px;" />
          <button id="btnAddClient">Ajouter client</button>
        </div>
      </div>

      <div class="card">
        <table id="clientsTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>T√©l√©phone</th>
              <th>Email</th>
              <th>Adresse</th>
              <th>V√©hicules</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- V√âHICULES -->
    <div class="page" id="page-vehicles">
      <h2>V√©hicules</h2>
      <div class="card">
        <table id="vehiclesTable">
          <thead>
            <tr>
              <th>Client</th>
              <th>Marque</th>
              <th>Mod√®le</th>
              <th>Ann√©e</th>
              <th>Plaque</th>
              <th>VIN</th>
              <th>KM</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- SERVICES -->
    <div class="page" id="page-services">
      <h2>Services / R√©parations</h2>

      <div class="card">
        <h3>Ajouter un service</h3>

        <label>Nom du service</label>
        <input id="srvName" />

        <label>Cat√©gorie</label>
        <select id="srvCategory">
          <option value="Entretien">Entretien</option>
          <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
          <option value="Freins">Freins</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Refroidissement">Refroidissement</option>
          <option value="Diagnostic">Diagnostic</option>
          <option value="√âlectricit√©">√âlectricit√©</option>
          <option value="Pneus">Pneus</option>
          <option value="√âchappement">√âchappement</option>
          <option value="Transmission">Transmission</option>
          <option value="Moteur">Moteur</option>
          <option value="Divers">Divers</option>
        </select>

        <label>Description (optionnel)</label>
        <textarea id="srvDesc"></textarea>

        <h4>Prix fixe (forfait)</h4>
        <input id="srvPriceFixed" type="number" step="0.01" placeholder="Ex: 89.95" />

        <h4>OU Temps et taux horaire</h4>
        <label>Heures</label>
        <input id="srvHours" type="number" step="0.1" placeholder="Ex: 1.5" />
        <label>Taux horaire ($ / h)</label>
        <input id="srvRate" type="number" step="0.01" placeholder="Ex: 95" />

        <button id="srvAddBtn" style="margin-top:10px;">Ajouter le service</button>
      </div>

      <h3>Services enregistr√©s</h3>

      <div id="servicesList"
           style="display:flex;flex-wrap:wrap;gap:15px;">
      </div>
    </div>

        <!-- PI√àCES -->
    <div class="page" id="page-parts">
      <h2>Inventaire des pi√®ces</h2>

      <div class="card">
        <h3>Ajouter une pi√®ce</h3>

        <label>Nom de la pi√®ce</label>
        <input id="partInvName" />

        <label>Num√©ro de pi√®ce</label>
        <input id="partInvNumber" />

        <label>Cat√©gorie</label>
        <select id="partInvCategory">
          <option value="Moteur">Moteur</option>
          <option value="Transmission">Transmission</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Freins">Freins</option>
          <option value="√âchappement">√âchappement</option>
          <option value="√âlectrique">√âlectrique</option>
          <option value="Tuning">Tuning</option>
          <option value="Fabrication">Fabrication</option>
          <option value="Hybride">Hybride</option>
          <option value="Carrosserie">Carrosserie</option>
          <option value="Pneus">Pneus</option>
          <option value="Divers">Divers</option>
        </select>

        <label>Quantit√© en stock</label>
        <input id="partInvQty" type="number" value="1" />

        <label>Prix co√ªtant ($)</label>
        <input id="partInvCost" type="number" step="0.01" />

        <label>Prix de vente ($)</label>
        <input id="partInvPrice" type="number" step="0.01" />

        <button id="partInvAddBtn" style="margin-top:8px;">Ajouter dans l‚Äôinventaire</button>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
        <select id="partInvFilter">
          <option value="">Toutes cat√©gories</option>
          <option value="Moteur">Moteur</option>
          <option value="Transmission">Transmission</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Freins">Freins</option>
          <option value="√âchappement">√âchappement</option>
          <option value="√âlectrique">√âlectrique</option>
          <option value="Tuning">Tuning</option>
          <option value="Fabrication">Fabrication</option>
          <option value="Hybride">Hybride</option>
          <option value="Carrosserie">Carrosserie</option>
          <option value="Pneus">Pneus</option>
          <option value="Divers">Divers</option>
        </select>

        <input id="partInvSearch" placeholder="Rechercher une pi√®ce..." style="flex:1;min-width:200px;" />
      </div>

      <div id="partsInventoryList"
           style="display:flex;flex-wrap:wrap;gap:15px;">
      </div>
    </div>

    <!-- HISTORIQUE GLOBAL -->
    <div class="page" id="page-history">
      <h2>Historique des factures</h2>

      <div class="card">
        <table id="historyTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Client</th>
              <th>Description</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- PARAM√àTRES -->
    <div class="page" id="page-settings">
      <h2>Param√®tres syst√®me</h2>
      <div class="card">
        <p>Ici tu pourras √©ventuellement :</p>
        <ul>
          <li>Changer taux TPS / TVQ</li>
          <li>Modifier le nom du garage</li>
          <li>Exporter / importer sauvegarde</li>
          <li>R√©initialiser certaines donn√©es</li>
        </ul>
      </div>
    </div>

    <script>
/* ============================================================
   SELECTEURS RAPIDES
============================================================ */
const $ = id => document.getElementById(id);

/* ============================================================
   NAVIGATION ENTRE PAGES
============================================================ */
function showPage(pageId){
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  const pg = $(pageId);
  if (pg) pg.style.display = "block";

  document.querySelectorAll(".navBtn").forEach(btn =>
    btn.classList.toggle("active", btn.dataset.page === pageId)
  );
}

// activer dashboard au d√©part
showPage("page-dashboard");

/* ============================================================
   LOCAL STORAGE ‚Äî KEYS
============================================================ */
const STORAGE = {
  invoices: "ar_invoices_v2",
  invoiceCounter: "ar_invoice_counter_v2",
  clients: "ar_clients_v2",
  services: "ar_services_v2",
  parts: "ar_parts_v2"
};

/* ============================================================
   OUTILS G√âN√âRAUX
============================================================ */
function money(n){ return Number(n||0).toFixed(2); }

function loadLS(key, fallback){
  try{
    const val = JSON.parse(localStorage.getItem(key));
    return val ?? fallback;
  }catch(e){ return fallback; }
}

function saveLS(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* ============================================================
   FACTURES ‚Äî VARIABLES GLOBALES
============================================================ */
let INVOICES = loadLS(STORAGE.invoices, []);
let INVOICE_COUNTER = loadLS(STORAGE.invoiceCounter, 1);
let items = [];  // articles de la facture en cours

/* ============================================================
   CLIENTS / V√âHICULES
============================================================ */
let CLIENTS = loadLS(STORAGE.clients, []);

/* ============================================================
   SERVICES
============================================================ */
let SERVICES = loadLS(STORAGE.services, []);

/* ============================================================
   INVENTAIRE ‚Äî PI√àCES
============================================================ */
let PARTS = loadLS(STORAGE.parts, []);

      /* ============================================================
   FACTURES ‚Äî G√âN√âRATION NUM√âRO
============================================================ */
function getNextInvoiceNumber(){
  const num = INVOICE_COUNTER;
  INVOICE_COUNTER++;
  saveLS(STORAGE.invoiceCounter, INVOICE_COUNTER);
  return num;
}

/* ============================================================
   ARTICLES ‚Äî RENDU TABLE DES LIGNES
============================================================ */
function renderItems(){
  const tbody = document.querySelector("#itemsTable tbody");
  tbody.innerHTML = "";

  let sub = 0;

  items.forEach((it, i) => {
    const total = it.qty * it.rate;
    sub += total;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.type}</td>
      <td>${it.desc}</td>
      <td>${it.qty}</td>
      <td>${money(it.rate)}</td>
      <td>${money(total)}</td>
      <td><button class="ghost" onclick="removeItem(${i})">X</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Mise √† jour des totaux
  const gst = sub * 0.05;
  const qst = (sub + gst) * 0.09975;
  const total = sub + gst + qst;

  $("subTotal").innerText = money(sub);
  $("gstAmount").innerText = money(gst);
  $("qstAmount").innerText = money(qst);
  $("totalAmount").innerText = money(total);
}

/* ============================================================
   ARTICLES ‚Äî SUPPRESSION
============================================================ */
function removeItem(i){
  items.splice(i, 1);
  renderItems();
}

/* ============================================================
   AJOUT : PI√àCE MANUELLE
============================================================ */
$("addPart").onclick = () => {
  const name = $("partName").value.trim();
  const qty = Number($("partQty").value);
  const price = Number($("partPrice").value);

  if(!name || qty <= 0 || price <= 0){
    alert("Donn√©es invalides pour la pi√®ce.");
    return;
  }

  items.push({
    type:"Pi√®ce",
    desc:name,
    qty:qty,
    rate:price
  });

  $("partName").value="";
  $("partQty").value=1;
  $("partPrice").value="";
  renderItems();
};

/* ============================================================
   AJOUT : MAIN-D‚Äô≈íUVRE
============================================================ */
$("addLabor").onclick = () => {
  const desc = $("laborDesc").value.trim();
  const hrs = Number($("laborHours").value);
  const rate = Number($("laborRate").value);

  if(!desc || hrs <= 0 || rate <= 0){
    alert("Donn√©es invalides pour la main-d‚Äô≈ìuvre.");
    return;
  }

  items.push({
    type:"Main-d‚Äô≈ìuvre",
    desc:desc,
    qty:hrs,
    rate:rate
  });

  $("laborDesc").value="";
  $("laborHours").value="";
  $("laborRate").value="";
  renderItems();
};

/* ============================================================
   AJOUT : SERVICE ENREGISTR√â
============================================================ */
$("openServicePicker").onclick = () => openServicePicker();

function openServicePicker(){
  let list = SERVICES.map((s, i) => `
    <button class="ghost" onclick="addSavedService(${i})" 
            style="width:100%;text-align:left;margin-bottom:6px;">
      <b>${s.name}</b> ‚Äî <span class="muted">${s.category}</span>
    </button>
  `).join("");

  alert("üëá S√©lectionne un service dans la fen√™tre suivante.");

  const wrapper = document.createElement("div");
  wrapper.style.padding = "20px";
  wrapper.innerHTML = `
    <h3>Services disponibles</h3>
    ${list}
  `;

  document.body.appendChild(wrapper);
}

function addSavedService(i){
  const s = SERVICES[i];
  if(!s) return;

  if(s.price){
    items.push({
      type:"Service",
      desc:s.name,
      qty:1,
      rate:s.price
    });
  } else {
    const hrs = Number(s.hours || 1);
    const rt = Number(s.rate || 90);
    items.push({
      type:"Service",
      desc:s.name,
      qty:hrs,
      rate:rt
    });
  }

  renderItems();
  alert("Service ajout√© !");
}

/* ============================================================
   SAUVEGARDE FACTURE
============================================================ */
$("saveInvoice").onclick = () => {
  const customer = $("customerName").value.trim();
  if(!customer){
    alert("Le nom du client est requis.");
    return;
  }
  if(items.length === 0){
    alert("Aucun article dans la facture.");
    return;
  }

  const sub = Number($("subTotal").innerText);
  const gst = Number($("gstAmount").innerText);
  const qst = Number($("qstAmount").innerText);
  const total = Number($("totalAmount").innerText);

  const invoice = {
    id: Date.now(),
    number: getNextInvoiceNumber(),
    date: new Date().toLocaleString("fr-CA"),
    customer: customer,
    job: $("jobDesc").value.trim(),
    items: structuredClone(items),
    subTotal: sub,
    gst: gst,
    qst: qst,
    total: total
  };

  INVOICES.push(invoice);
  saveLS(STORAGE.invoices, INVOICES);

  alert("Facture enregistr√©e !");
  items = [];
  renderItems();
  $("customerName").value="";
  $("jobDesc").value="";
};

/* ============================================================
   IMPRESSION ‚Äî MODE PROFESSIONNEL
============================================================ */
function printInvoiceObject(inv){
  if(!inv) return;

  const area = $("printArea");

  area.innerHTML = `
    <div class="invoice-header">
      <h1>Garage-Atelier M√©canique J.L</h1>
      <div class="muted">Facture #${inv.number}</div>
      <div class="muted">${inv.date}</div>
    </div>

    <h3>Client</h3>
    <p><strong>${inv.customer}</strong><br>${inv.job || ""}</p>

    <h3>Articles</h3>
    <table>
      <thead>
        <tr>
          <th>Type</th><th>Description</th>
          <th>Qt√©/Hrs</th><th>Prix</th><th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${inv.items.map(it=>`
          <tr>
            <td>${it.type}</td>
            <td>${it.desc}</td>
            <td>${it.qty}</td>
            <td>${money(it.rate)}$</td>
            <td>${money(it.qty * it.rate)}$</td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div class="invoice-totals">
      <div><span>Sous-total</span><span>${money(inv.subTotal)} $</span></div>
      <div><span>TPS</span><span>${money(inv.gst)} $</span></div>
      <div><span>TVQ</span><span>${money(inv.qst)} $</span></div>
      <div><strong>Total</strong><strong>${money(inv.total)} $</strong></div>
    </div>
  `;

  window.print();
}

// bouton d‚Äôimpression principal
$("btnPrint").onclick = () => {
  if(INVOICES.length === 0){
    alert("Aucune facture √† imprimer.");
    return;
  }
  const last = INVOICES[INVOICES.length - 1];
  printInvoiceObject(last);
};

      /* ============================================================
   CLIENTS ‚Äî TABLE
============================================================ */
function renderClientsTable(){
  const tbody = document.querySelector("#clientsTable tbody");
  tbody.innerHTML = "";

  const q = $("clientSearch").value.trim().toLowerCase();

  CLIENTS.forEach(c => {
    const str = `${c.name} ${c.phone} ${c.email} ${c.address}`.toLowerCase();
    if(q && !str.includes(q)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.phone || ""}</td>
      <td>${c.email || ""}</td>
      <td>${c.address || ""}</td>
      <td>${(c.vehicles||[]).length}</td>
      <td><button class="ghost" onclick="openClientModal(${c.id})">Voir</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
   CLIENT ‚Äî MODAL (fiche client)
============================================================ */
function openClientModal(id){
  const modal = document.createElement("div");
  modal.className = "modal-backdrop";
  modal.style.display="flex";

  const client = CLIENTS.find(c => c.id === id);

  modal.innerHTML = `
    <div class="modal-panel">
      <h2>Fiche client</h2>

      <label>Nom</label>
      <input id="cName" value="${client.name}" />

      <label>T√©l√©phone</label>
      <input id="cPhone" value="${client.phone||""}" />

      <label>Email</label>
      <input id="cEmail" value="${client.email||""}" />

      <label>Adresse</label>
      <input id="cAddr" value="${client.address||""}" />

      <h3>V√©hicules</h3>
      <div id="vehList"></div>

      <h4>Ajouter un v√©hicule</h4>
      <label>Marque</label>
      <input id="vehMake" />
      <label>Mod√®le</label>
      <input id="vehModel" />
      <label>Ann√©e</label>
      <input id="vehYear" />
      <label>Plaque</label>
      <input id="vehPlate" />
      <label>VIN</label>
      <input id="vehVin" />
      <label>KM</label>
      <input id="vehKm" />

      <button onclick="addVehicle(${id})">Ajouter v√©hicule</button>

      <div style="margin-top:15px;display:flex;gap:8px;justify-content:flex-end;">
        <button class="ghost" onclick="deleteClient(${id})">Supprimer</button>
        <button onclick="saveClient(${id})">Enregistrer</button>
      </div>

      <div style="text-align:right;margin-top:10px;">
        <button class="ghost" onclick="this.closest('.modal-backdrop').remove()">Fermer</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  renderClientVehicles(id);
}

/* ============================================================
   CLIENT : RENDRE V√âHICULES
============================================================ */
function renderClientVehicles(id){
  const client = CLIENTS.find(c => c.id === id);
  const wrap = document.querySelector("#vehList");

  wrap.innerHTML = "";

  (client.vehicles||[]).forEach((v, idx) => {
    const div = document.createElement("div");
    div.style.border = "1px solid var(--border)";
    div.style.borderRadius = "8px";
    div.style.padding = "8px";
    div.style.marginBottom = "6px";

    div.innerHTML = `
      <b>${v.make} ${v.model} (${v.year})</b><br>
      Plaque: ${v.plate || ""}<br>
      VIN: ${v.vin || ""}<br>
      KM: ${v.km || ""}<br>
      <button class="ghost" onclick="deleteVehicle(${id}, ${idx})">Supprimer</button>
    `;

    wrap.appendChild(div);
  });
}

/* ============================================================
   CLIENT : SAUVEGARDE
============================================================ */
function saveClient(id){
  const c = CLIENTS.find(c => c.id === id);
  if(!c) return;

  c.name = $("cName").value.trim();
  c.phone = $("cPhone").value.trim();
  c.email = $("cEmail").value.trim();
  c.address = $("cAddr").value.trim();

  saveLS(STORAGE.clients, CLIENTS);
  renderClientsTable();
  document.querySelector(".modal-backdrop").remove();
}

/* ============================================================
   CLIENT : SUPPRESSION
============================================================ */
function deleteClient(id){
  if(!confirm("Supprimer ce client ?")) return;
  CLIENTS = CLIENTS.filter(c => c.id !== id);
  saveLS(STORAGE.clients, CLIENTS);
  renderClientsTable();
  document.querySelector(".modal-backdrop").remove();
}

/* ============================================================
   V√âHICULE : AJOUT
============================================================ */
function addVehicle(id){
  const c = CLIENTS.find(c => c.id === id);
  if(!c) return;

  const v = {
    make:$("vehMake").value.trim(),
    model:$("vehModel").value.trim(),
    year:$("vehYear").value.trim(),
    plate:$("vehPlate").value.trim(),
    vin:$("vehVin").value.trim(),
    km:$("vehKm").value.trim()
  };

  if(!v.make || !v.model){
    alert("Marque ou mod√®le manquant.");
    return;
  }

  c.vehicles = c.vehicles || [];
  c.vehicles.push(v);

  saveLS(STORAGE.clients, CLIENTS);
  renderClientVehicles(id);
  renderVehiclesTable();
}

/* ============================================================
   V√âHICULE : SUPPRESSION
============================================================ */
function deleteVehicle(id, idx){
  const c = CLIENTS.find(c => c.id === id);
  if(!c) return;

  c.vehicles.splice(idx, 1);
  saveLS(STORAGE.clients, CLIENTS);

  renderClientVehicles(id);
  renderVehiclesTable();
}

/* ============================================================
   TABLEAU GLOBAL DES V√âHICULES
============================================================ */
function renderVehiclesTable(){
  const tbody = document.querySelector("#vehiclesTable tbody");
  tbody.innerHTML = "";

  CLIENTS.forEach(c => {
    (c.vehicles||[]).forEach(v => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.name}</td>
        <td>${v.make}</td>
        <td>${v.model}</td>
        <td>${v.year}</td>
        <td>${v.plate||""}</td>
        <td>${v.vin||""}</td>
        <td>${v.km||""}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}

      /* ============================================================
   SERVICES ‚Äî AFFICHAGE DES CARTES
============================================================ */
function renderServices(){
  const wrap = $("servicesList");
  wrap.innerHTML = "";

  SERVICES.forEach((s, i) => {
    const priceText = s.price
      ? `${money(s.price)} $`
      : `${s.hours} h √ó ${money(s.rate)} $`;

    const card = document.createElement("div");
    card.style = `
      background:var(--card);
      border:1px solid var(--border);
      padding:12px;
      border-radius:10px;
      width:260px;
    `;

    card.innerHTML = `
      <h3 style="margin:0 0 6px;">${s.name}</h3>
      <div class="muted">${s.category}</div>
      <div class="small" style="margin-top:4px;">${s.desc || ""}</div>

      <div style="margin-top:8px;">
        <b>Prix :</b> ${priceText}
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="ghost" onclick="editService(${i})" style="flex:1;">Modifier</button>
        <button class="ghost" onclick="deleteService(${i})" style="flex:1;">Supprimer</button>
      </div>
    `;

    wrap.appendChild(card);
  });
}

/* ============================================================
   SERVICES ‚Äî AJOUT
============================================================ */
$("srvAddBtn").onclick = () => {
  const name = $("srvName").value.trim();
  const category = $("srvCategory").value;
  const desc = $("srvDesc").value.trim();

  const priceFixed = Number($("srvPriceFixed").value);
  const hours = Number($("srvHours").value);
  const rate = Number($("srvRate").value);

  if(!name){
    alert("Le nom du service est requis.");
    return;
  }

  let entry = {
    id: Date.now(),
    name,
    category,
    desc
  };

  if(priceFixed > 0){
    entry.price = priceFixed;
  } else if(hours > 0 && rate > 0){
    entry.hours = hours;
    entry.rate = rate;
  } else {
    alert("Dois contenir un prix fixe ou heures + taux horaire.");
    return;
  }

  SERVICES.push(entry);
  saveLS(STORAGE.services, SERVICES);

  $("srvName").value="";
  $("srvDesc").value="";
  $("srvPriceFixed").value="";
  $("srvHours").value="";
  $("srvRate").value="";

  renderServices();
  alert("Service ajout√© !");
};

/* ============================================================
   SERVICES ‚Äî SUPPRESSION
============================================================ */
function deleteService(i){
  if(!confirm("Supprimer ce service ?")) return;
  SERVICES.splice(i, 1);
  saveLS(STORAGE.services, SERVICES);
  renderServices();
}

/* ============================================================
   SERVICES ‚Äî MODIFICATION
============================================================ */
function editService(i){
  const s = SERVICES[i];
  if(!s) return;

  const modal = document.createElement("div");
  modal.className = "modal-backdrop";
  modal.style.display = "flex";

  modal.innerHTML = `
    <div class="modal-panel">
      <h2>Modifier service</h2>

      <label>Nom</label>
      <input id="esName" value="${s.name}" />

      <label>Cat√©gorie</label>
      <select id="esCategory">
        ${[
          "Entretien","M√©canique g√©n√©rale","Freins","Suspension","Direction",
          "Refroidissement","Diagnostic","√âlectricit√©","Pneus","√âchappement",
          "Transmission","Moteur","Divers"
        ].map(c => `<option ${s.category===c?"selected":""}>${c}</option>`).join("")}
      </select>

      <label>Description</label>
      <textarea id="esDesc">${s.desc||""}</textarea>

      <h4>Prix fixe OU heures/taux :</h4>
      <input id="esPrice" type="number" step="0.01" placeholder="Prix fixe" value="${s.price||""}" />

      <label>Heures</label>
      <input id="esHours" type="number" step="0.1" value="${s.hours||""}" />

      <label>Taux horaire ($/h)</label>
      <input id="esRate" type="number" step="0.01" value="${s.rate||""}" />

      <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end;">
        <button class="ghost" onclick="this.closest('.modal-backdrop').remove()">Annuler</button>
        <button onclick="saveServiceEdition(${i})">Enregistrer</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function saveServiceEdition(i){
  const s = SERVICES[i];

  s.name = $("esName").value.trim();
  s.category = $("esCategory").value;
  s.desc = $("esDesc").value.trim();

  const price = Number($("esPrice").value);
  const hours = Number($("esHours").value);
  const rate = Number($("esRate").value);

  delete s.price;
  delete s.hours;
  delete s.rate;

  if(price > 0){
    s.price = price;
  } else if(hours > 0 && rate > 0){
    s.hours = hours;
    s.rate = rate;
  } else {
    alert("Dois contenir un prix fixe ou heures + taux horaire.");
    return;
  }

  saveLS(STORAGE.services, SERVICES);
  renderServices();
  document.querySelector(".modal-backdrop").remove();
}

/* ============================================================
   INT√âGRATION ‚Äî Ajout service ‚Üí facture
============================================================ */
function addSavedService(i){
  const s = SERVICES[i];
  if(!s) return;

  if(s.price){
    items.push({
      type:"Service",
      desc:s.name,
      qty:1,
      rate:s.price
    });
  } else {
    items.push({
      type:"Service",
      desc:s.name,
      qty:s.hours,
      rate:s.rate
    });
  }

  renderItems();
  alert("Service ajout√© √† la facture !");
}

      /* ============================================================
   INVENTAIRE PI√àCES ‚Äî RENDRE LISTE
============================================================ */
function renderParts(){
  const wrap = $("partsInventoryList");
  wrap.innerHTML = "";

  const q = $("partInvSearch").value.trim().toLowerCase();
  const filter = $("partInvFilter").value;

  PARTS.forEach((p, i) => {

    const hay = `${p.name} ${p.number}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(filter && p.category !== filter) return;

    const profit = p.price ? ((p.price - p.cost) / p.price * 100).toFixed(0) : 0;

    const card = document.createElement("div");
    card.style = `
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      width:260px;
    `;

    card.innerHTML = `
      <h3 style="margin:0 0 8px;">${p.name}</h3>
      <div class="small"># Pi√®ce : <b>${p.number || "-"}</b></div>
      <div class="small">Cat√©gorie : <b>${p.category}</b></div>
      <div class="small">Stock : <b>${p.qty}</b></div>
      <div class="small">Co√ªt : <b>${money(p.cost)}$</b></div>
      <div class="small">Prix : <b>${money(p.price)}$</b></div>
      <div class="small">Marge : <b>${profit}%</b></div>

      <div style="display:flex;gap:6px;margin-top:10px;">
        <button class="ghost" style="flex:1;" onclick="editPart(${i})">Modifier</button>
        <button class="ghost" style="flex:1;" onclick="deletePart(${i})">Supprimer</button>
      </div>

      <button class="ghost" 
              style="margin-top:10px;width:100%;" 
              onclick="addPartToInvoice(${i})">
        ‚ûï Ajouter √† la facture
      </button>
    `;

    wrap.appendChild(card);
  });
}

/* ============================================================
   INVENTAIRE ‚Äî AJOUT
============================================================ */
$("partInvAddBtn").onclick = () => {
  const name = $("partInvName").value.trim();
  const number = $("partInvNumber").value.trim();
  const category = $("partInvCategory").value;
  const qty = Number($("partInvQty").value);
  const cost = Number($("partInvCost").value);
  const price = Number($("partInvPrice").value);

  if(!name || qty <= 0 || cost <= 0 || price <= 0){
    alert("Informations invalides.");
    return;
  }

  PARTS.push({
    id: Date.now(),
    name, number, category,
    qty, cost, price
  });

  saveLS(STORAGE.parts, PARTS);
  renderParts();

  $("partInvName").value="";
  $("partInvNumber").value="";
  $("partInvQty").value=1;
  $("partInvCost").value="";
  $("partInvPrice").value="";
};

/* ============================================================
   INVENTAIRE ‚Äî SUPPRESSION
============================================================ */
function deletePart(i){
  if(!confirm("Supprimer cette pi√®ce ?")) return;
  PARTS.splice(i,1);
  saveLS(STORAGE.parts, PARTS);
  renderParts();
}

/* ============================================================
   INVENTAIRE ‚Äî MODIFICATION
============================================================ */
function editPart(i){
  const p = PARTS[i];
  if(!p) return;

  const modal = document.createElement("div");
  modal.className = "modal-backdrop";
  modal.style.display = "flex";

  modal.innerHTML = `
    <div class="modal-panel">
      <h2>Modifier pi√®ce</h2>

      <label>Nom</label>
      <input id="epName" value="${p.name}" />

      <label># Pi√®ce</label>
      <input id="epNumber" value="${p.number || ""}" />

      <label>Cat√©gorie</label>
      <select id="epCategory">
        ${[
          "Moteur","Transmission","Suspension","Direction","Freins",
          "√âchappement","√âlectrique","Tuning","Fabrication",
          "Hybride","Carrosserie","Pneus","Divers"
        ].map(c => `<option ${c===p.category?"selected":""}>${c}</option>`).join("")}
      </select>

      <label>Quantit√©</label>
      <input id="epQty" type="number" value="${p.qty}" />

      <label>Co√ªt</label>
      <input id="epCost" type="number" value="${p.cost}" />

      <label>Prix</label>
      <input id="epPrice" type="number" value="${p.price}" />

      <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end;">
        <button class="ghost" onclick="this.closest('.modal-backdrop').remove()">Annuler</button>
        <button onclick="savePartEdition(${i})">Enregistrer</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function savePartEdition(i){
  const p = PARTS[i];

  p.name = $("epName").value.trim();
  p.number = $("epNumber").value.trim();
  p.category = $("epCategory").value;
  p.qty = Number($("epQty").value);
  p.cost = Number($("epCost").value);
  p.price = Number($("epPrice").value);

  saveLS(STORAGE.parts, PARTS);
  renderParts();
  document.querySelector(".modal-backdrop").remove();
}

/* ============================================================
   AJOUT D'UNE PI√àCE D'INVENTAIRE ‚Üí FACTURE
============================================================ */
function addPartToInvoice(i){
  const p = PARTS[i];
  if(!p) return;

  if(p.qty <= 0){
    alert("Stock √©puis√© !");
    return;
  }

  p.qty--;
  saveLS(STORAGE.parts, PARTS);

  items.push({
    type:"Pi√®ce (Inventaire)",
    desc:`${p.name} (#${p.number})`,
    qty:1,
    rate:p.price
  });

  renderParts();
  renderItems();
}

/* ============================================================
   HISTORIQUE ‚Äî RENDRE TABLE
============================================================ */
function renderHistory(){
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  INVOICES.forEach((inv, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.customer}</td>
      <td>${inv.job || "-"}</td>
      <td>${money(inv.total)} $</td>
      <td>
        <button class="ghost" onclick="openInvoiceEditor(${inv.id})">Ouvrir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
   HISTORIQUE ‚Äî √âDITION FACTURE
============================================================ */
function openInvoiceEditor(id){
  const inv = INVOICES.find(x => x.id === id);
  if(!inv){
    alert("Facture introuvable.");
    return;
  }

  const modal = document.createElement("div");
  modal.className = "modal-backdrop";
  modal.style.display = "flex";

  modal.innerHTML = `
    <div class="modal-panel">
      <h2>Facture #${inv.number}</h2>

      <div><b>Date :</b> ${inv.date}</div>
      <div><b>Client :</b> ${inv.customer}</div>
      <div><b>Description :</b> ${inv.job}</div>

      <h3 style="margin-top:12px;">Articles</h3>
      <table>
        <thead>
          <tr>
            <th>Type</th><th>Description</th><th>Qt√©</th><th>Prix</th><th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${inv.items.map(it => `
            <tr>
              <td>${it.type}</td>
              <td>${it.desc}</td>
              <td>${it.qty}</td>
              <td>${money(it.rate)}</td>
              <td>${money(it.qty * it.rate)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <h3>Totaux</h3>
      <div>Sous-total : ${money(inv.subTotal)} $</div>
      <div>TPS : ${money(inv.gst)} $</div>
      <div>TVQ : ${money(inv.qst)} $</div>
      <div><b>Total : ${money(inv.total)} $</b></div>

      <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
        <button onclick="printInvoiceObject(INVOICES.find(x=>x.id===${id}))">Imprimer</button>
        <button class="ghost" onclick="this.closest('.modal-backdrop').remove()">Fermer</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

      /* ============================================================
   DASHBOARD ‚Äî ACTUALISATION
============================================================ */
function refreshDashboard(){
  // Nombre de factures
  $("statInvoices").innerText = INVOICES.length;

  // Revenus totaux
  let totalRevenue = 0;
  INVOICES.forEach(inv => totalRevenue += Number(inv.total || 0));
  $("statRevenue").innerText = money(totalRevenue) + " $";

  // Nombre de clients
  $("statClients").innerText = CLIENTS.length;

  // Nombre de v√©hicules
  let vCount = 0;
  CLIENTS.forEach(c => {
    if(c.vehicles) vCount += c.vehicles.length;
  });
  $("statVehicles").innerText = vCount;

  // Pieces totales en stock
  let pCount = 0, lowStock = 0;
  PARTS.forEach(p => {
    pCount += Number(p.qty);
    if(Number(p.qty) <= 2) lowStock++;
  });

  $("statParts").innerText = pCount;
  $("statLowStock").innerText = lowStock;
}


/* ============================================================
   IMPRESSION FACTURE ‚Äî MODE PRO
============================================================ */
function printInvoiceObject(inv){
  if(!inv) return alert("Erreur : facture introuvable.");

  const area = $("printArea");
  area.innerHTML = `
    <div class="invoice-header">
      <h1>Garage-Atelier M√©canique J.L</h1>
      <div class="muted">Facture #${inv.number}<br>${inv.date}</div>
    </div>

    <div><b>Client :</b> ${inv.customer}</div>
    <div><b>Description :</b> ${inv.job}</div>

    <h3 style="margin-top:15px;">Articles</h3>
    <table>
      <thead>
        <tr>
          <th>Type</th><th>Description</th><th>Qt√©</th><th>Prix</th><th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${inv.items.map(it => `
          <tr>
            <td>${it.type}</td>
            <td>${it.desc}</td>
            <td>${it.qty}</td>
            <td>${money(it.rate)}$</td>
            <td>${money(it.qty * it.rate)}$</td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div class="invoice-totals">
      <div><span>Sous-total :</span><span>${money(inv.subTotal)}$</span></div>
      <div><span>TPS :</span><span>${money(inv.gst)}$</span></div>
      <div><span>TVQ :</span><span>${money(inv.qst)}$</span></div>
      <div><strong>Total :</strong><strong>${money(inv.total)}$</strong></div>
    </div>
  `;

  window.print();
}


/* ============================================================
   CHANGEMENT DE PAGE (sidebar)
============================================================ */
function showPage(id){
  document.querySelectorAll(".page").forEach(p => p.style.display="none");
  document.querySelectorAll(".navBtn").forEach(b => b.classList.remove("active"));

  const pg = $(id);
  if(pg) pg.style.display = "block";

  const btn = document.querySelector(`.navBtn[data-page="${id}"]`);
  if(btn) btn.classList.add("active");
}


/* ============================================================
   INITIALISATION COMPL√àTE
============================================================ */
function initApp(){

  /* ‚Äî Charger les donn√©es ‚Äî */
  loadFromLS();

  /* ‚Äî Rendre interfaces ‚Äî */
  renderItems();
  renderParts();
  renderHistory();
  renderClientsTable();
  renderVehiclesTable();
  renderServices();

  /* ‚Äî Statistiques ‚Äî */
  refreshDashboard();

  /* ‚Äî Navigation Sidebar ‚Äî */
  document.querySelectorAll(".navBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const pg = btn.dataset.page;
      showPage(pg);
    });
  });

  /* ‚Äî Bouton "Imprimer facture" (page facture) ‚Äî */
  $("btnPrint").onclick = () => {
    const tmp = {
      number:$("invoiceNumber").value,
      date:new Date().toLocaleDateString("fr-CA"),
      customer:$("customerName").value,
      job:$("jobDesc").value,
      items:[...items],
      subTotal:Number($("subTotal").innerText),
      gst:Number($("gstAmount").innerText),
      qst:Number($("qstAmount").innerText),
      total:Number($("totalAmount").innerText)
    };
    printInvoiceObject(tmp);
  };

  console.log("Garage-Atelier M√©canique J.L ‚Äî Application charg√©e ‚úì");
}

/* D√©marrage automatique */
initApp();

</script>
</body>
</html>
