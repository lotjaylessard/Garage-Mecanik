<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier M√©canique J.L ‚Äî Gestion</title>
  <style>
    :root{
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
      --muted:#aaaaaa;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }
    h1,h2,h3,h4{
      color:var(--accent);
      margin:0 0 10px;
    }
    .muted{color:var(--muted);font-size:0.85rem;}
    a{color:var(--accent);}
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      background:#111;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:6px;
      margin-top:6px;
    }
    textarea{min-height:70px;resize:vertical;}
    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      color:var(--text);
      font-size:0.9rem;
    }
    th,td{
      padding:8px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    th{
      background:#333;
      color:var(--accent);
    }

    /* --- Layout --- */
    #sidebar{
      position:fixed;
      left:0;
      top:0;
      width:220px;
      height:100%;
      background:#111;
      border-right:1px solid var(--border);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:10;
    }
    #sidebar h2{
      color:var(--accent);
      margin-bottom:20px;
      font-size:20px;
    }
    .navBtn{
      width:100%;
      text-align:left;
    }
    .navBtn.active{
      background:var(--accent);
      color:#000;
    }

    .topbar{
      position:fixed;
      top:0;
      left:220px;
      right:0;
      height:70px;
      background:#1b1b1b;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      z-index:9;
    }
    #appPages{
      margin-left:220px;
      margin-top:70px;
      padding:20px;
    }
    .page{display:none;}

    /* Dashboard cards */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
    }
    .stat-card{
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px;
    }
    .stat-label{font-size:0.85rem;color:var(--muted);}
    .stat-value{font-size:1.3rem;font-weight:700;margin-top:4px;}

    /* Modal base */
    .modal-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index:9999;
      align-items:center;
      justify-content:center;
    }
    .modal-panel{
      background:var(--card);
      width:750px;
      max-width:95%;
      padding:20px;
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
      max-height:90vh;
      overflow-y:auto;
    }

    @media(max-width:800px){
      #sidebar{
        position:static;
        width:100%;
        height:auto;
        flex-direction:row;
        flex-wrap:wrap;
      }
      .topbar{
        position:static;
        margin-left:0;
      }
      #appPages{
        margin-left:0;
        margin-top:0;
      }
    }

    /* ===================== QUICK LINKS ===================== */
    .quick-links a {
  display:block;
  padding:8px 0;
  border-bottom:1px solid var(--border);
  color:var(--accent);
  font-size:1rem;
  text-decoration:none;
}

.quick-links a:hover {
  color:white;
  text-decoration:underline;
}

    .quick-tile {
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#111;
}

.qt-left {
  display:flex;
  align-items:center;
  gap:10px;
}

.qt-icon {
  font-size:1.6rem;
}

.qt-name {
  font-size:1.1rem;
  font-weight:700;
}

.qt-url {
  font-size:0.8rem;
  color:var(--muted);
}

.qt-actions button {
  font-size:1.1rem;
}

#page-workorders select,
#page-workorders input,
#page-workorders textarea {
  background:#111;
  color:white;
  border:1px solid var(--border);
  border-radius:5px;
  padding:6px;
}

    .status-badge {
  padding:4px 8px;
  border-radius:6px;
  font-weight:600;
  font-size:0.85rem;
  color:black;
}
.status-draft { background:#888; }
.status-in_progress { background:#f5c542; }
.status-waiting_parts { background:#ff7f27; }
.status-completed { background:#4CAF50; }
.status-billed { background:#2196F3; }


  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-dashboard">üìä Dashboard</button>
    <button class="navBtn" data-page="page-workorders">üìã Work Order</button>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-services">üõ†Ô∏è Services</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-notes">üìù Notes</button>
    <button class="navBtn" data-page="page-links">üîó Liens Rapides</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="#FFD400">
        <path d="M12 15.5A3.5 3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-.46-.5z"/>
      </svg>
      <h1 style="font-size:18px;">Garage-Atelier M√©canique J.L ‚Äî Gestion</h1>
    </div>
    <div style="display:flex;gap:10px;">
      <button id="btnPrint">Imprimer facture</button>
    </div>
  </div>

  <!-- PAGES -->
  <div id="appPages">

    <!-- DASHBOARD -->
    <div class="page" id="page-dashboard" style="display:block;">
      <h2>Tableau de bord</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Factures totales</div>
          <div class="stat-value" id="statInvoices">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Revenus totaux</div>
          <div class="stat-value" id="statRevenue">0.00 $</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Clients</div>
          <div class="stat-value" id="statClients">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">V√©hicules</div>
          <div class="stat-value" id="statVehicles">0</div>
        </div>
        <div class="stat-card">
    <div class="stat-label">5 derni√®res factures</div>
    <div id="lastInvoicesBox" style="margin-top:6px;font-size:0.9rem;line-height:1.2rem;"></div>
</div>
      </div>

      <div class="card" style="margin-top:20px;">
        <h3>Raccourcis</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
          <button class="ghost" onclick="showPage('page-invoices')">+ Nouvelle facture</button>
          <button class="ghost" onclick="showPage('page-clients')">+ Nouveau client</button>
          <button class="ghost" onclick="showPage('page-services')">Configurer services</button>
          <button class="ghost" onclick="showPage('page-parts')">G√©rer inventaire</button>
        </div>
      </div>
    </div>


        <!-- WORK ORDERS -->
    <div class="page" id="page-workorders">
      <h2>Bons de travail</h2>

      <div class="card">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
          <button id="btnNewWorkOrder">‚ûï Nouveau bon de travail</button>

          <select id="woStatusFilter" style="max-width:200px;">
            <option value="">Tous les statuts</option>
            <option value="draft">Brouillon</option>
            <option value="in_progress">En cours</option>
            <option value="waiting_parts">En attente de pi√®ces</option>
            <option value="completed">Termin√©</option>
            <option value="billed">Factur√©</option>
          </select>

          <input id="woSearch"
                 placeholder="Rechercher (client, v√©hicule, # BT...)"
                 style="flex:1;min-width:200px;">
        </div>

        <table id="woTable">
          <thead>
            <tr>
              <th># BT</th>
              <th>Date</th>
              <th>Client</th>
              <th>V√©hicule</th>
              <th>Statut</th>
              <th>Total estim√©</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="woDetailCard">
        <h3>D√©tail du bon de travail</h3>
        <div class="muted">
          S√©lectionne un bon de travail dans la liste ci-dessus
          ou clique sur <strong>‚ÄúNouveau bon de travail‚Äù</strong> pour en cr√©er un.
        </div>
        <div id="woDetailContent"></div>
      </div>
    </div>

    <!-- FACTURES (liste compl√®te) -->
<div class="page" id="page-invoice-list">
  <div class="card">
    <h2>Factures</h2>

    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <input id="invoiceSearch" placeholder="Recherche (#, client, v√©hicule)" style="flex:1;" />
      <select id="invoiceStatusFilter">
        <option value="">-- Tous les statuts --</option>
        <option value="draft">Brouillon</option>
        <option value="pending">En attente de paiement</option>
        <option value="paid">Pay√©e</option>
      </select>
      <button id="btnNewInvoice">‚ûï Nouvelle facture</button>
    </div>

    <table id="invoiceListTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Client</th>
          <th>Total</th>
          <th>Statut</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


    <!-- FACTURES (cr√©ation seulement) -->
    <div class="page" id="page-invoice-editor">
      <div class="card">
        <h2>Cr√©er Devis / Travail</h2>
        <label>Client</label>
<select id="customerSelect"></select>
<button id="btnCreateCustomerFromInvoice" class="ghost" style="margin-top:6px;">‚ûï Nouveau client</button>

        <label>Num√©ro de facture</label>
        <input id="invoiceNumber" disabled />

        <label>Description / V√©hicule</label>
<select id="vehicleSelect" style="width:100%; padding:5px;">
    <option value="">-- Choisir un v√©hicule --</option>
</select>

<!-- ON GARDE jobDesc CACH√â pour compatibilit√© interne -->
<input id="jobDesc" style="display:none;" />

        <h3>Ajouter une pi√®ce</h3>
        <label>Nom pi√®ce / description</label>
        <input id="partName" />
        <label>Quantit√©</label>
        <input id="partQty" type="number" value="1" />
        <label>Prix unitaire</label>
        <input id="partPrice" type="number" />
        <button id="addPart">Ajouter pi√®ce</button>
        <button id="openPartPicker" class="ghost">
    ‚ûï Ajouter une pi√®ce enregistr√©e
  </button>

        <h3>Ajouter main-d'≈ìuvre</h3>
        <label>Description</label>
        <input id="laborDesc" />
        <label>Heures</label>
        <input id="laborHours" type="number" step="0.1" />
        <label>Taux / h</label>
        <input id="laborRate" type="number" step="0.01" />
        <button id="addLabor">Ajouter main-d'≈ìuvre</button>

        <button id="openServicePicker" class="ghost" style="margin-top:8px;">
          ‚ûï Ajouter un service enregistr√©
        </button>

        <h3>Articles</h3>
        <table id="itemsTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Qt√©/hrs</th>
              <th>Prix</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3>Totaux</h3>
        <div>Sous-total: <span id="subTotal">0.00</span> $</div>
        <div>TPS: <span id="gstAmount">0.00</span> $</div>
        <div>TVQ: <span id="qstAmount">0.00</span> $</div>
        <div><strong>Total: <span id="totalAmount">0.00</span> $</strong></div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="saveInvoice">Enregistrer facture</button>
          <button id="clearItems" class="ghost">Vider</button>
        </div>
      </div>

      <div id="printArea" style="display:none"></div>
    </div>

    <!-- CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Gestion des clients</h2>
      <div class="card">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="clientSearch" placeholder="Rechercher un client..." style="flex:1;min-width:200px;" />
          <button id="btnAddClient">Ajouter client</button>
        </div>
      </div>
      <div class="card">
        <table id="clientsTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>T√©l√©phone</th>
              <th>Email</th>
              <th>Adresse</th>
              <th>V√©hicules</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- V√âHICULES -->
    <div class="page" id="page-vehicles">
      <h2>V√©hicules</h2>
      <div class="card">
        <table id="vehiclesTable">
          <thead>
            <tr>
              <th>Client</th>
              <th>Marque</th>
              <th>Mod√®le</th>
              <th>Ann√©e</th>
              <th>Plaque</th>
              <th>VIN</th>
              <th>KM</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- SERVICES -->
    <div class="page" id="page-services">
      <h2>Services / R√©parations</h2>

      <div class="card">
        <h3>Ajouter un service</h3>

        <label>Nom du service</label>
        <input id="srvName" />

        <label>Cat√©gorie</label>
        <select id="srvCategory">
          <option value="Entretien">Entretien</option>
          <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
          <option value="Freins">Freins</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Refroidissement">Refroidissement</option>
          <option value="Diagnostic">Diagnostic</option>
          <option value="√âlectricit√©">√âlectricit√©</option>
          <option value="Pneus">Pneus</option>
          <option value="√âchappement">√âchappement</option>
          <option value="Transmission">Transmission</option>
          <option value="Moteur">Moteur</option>
          <option value="Divers">Divers</option>
        </select>

        <label>Description (optionnel)</label>
        <textarea id="srvDesc"></textarea>

        <h4>Prix fixe (forfait)</h4>
        <input id="srvPriceFixed" type="number" step="0.01" placeholder="Ex: 89.95" />

        <h4>OU Temps et taux horaire</h4>
        <label>Heures</label>
        <input id="srvHours" type="number" step="0.1" placeholder="Ex: 1.5" />
        <label>Taux horaire ($ / h)</label>
        <input id="srvRate" type="number" step="0.01" placeholder="Ex: 95" />

        <button id="srvAddBtn" style="margin-top:10px;">Ajouter le service</button>
      </div>

      <h3>Services enregistr√©s</h3>
      <div id="servicesList" style="display:flex;flex-wrap:wrap;gap:15px;"></div>
    </div>

    <!-- PI√àCES -->
    <div class="page" id="page-parts">
      <h2>Inventaire des pi√®ces</h2>

      <div class="card">
        <h3>Ajouter une pi√®ce</h3>

        <label>Nom de la pi√®ce</label>
        <input id="partInvName" />

        <label>Num√©ro de pi√®ce</label>
        <input id="partInvNumber" />

        <label>Cat√©gorie</label>
        <select id="partInvCategory">
          <option value="Moteur">Moteur</option>
          <option value="Transmission">Transmission</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Freins">Freins</option>
          <option value="√âchappement">√âchappement</option>
          <option value="√âlectrique">√âlectrique</option>
          <option value="Tuning">Tuning</option>
          <option value="Fabrication">Fabrication</option>
          <option value="Hybride">Hybride</option>
          <option value="Carrosserie">Carrosserie</option>
          <option value="Pneus">Pneus</option>
          <option value="Divers">Divers</option>
        </select>

        <label>Quantit√© en stock</label>
        <input id="partInvQty" type="number" value="1" />

        <label>Prix co√ªtant ($)</label>
        <input id="partInvCost" type="number" step="0.01" />

        <label>Prix de vente ($)</label>
        <input id="partInvPrice" type="number" step="0.01" />

        <button id="partInvAddBtn" style="margin-top:8px;">Ajouter dans l‚Äôinventaire</button>
      </div>

      <select id="partInvFilter" style="margin-bottom:10px;">
        <option value="">Toutes cat√©gories</option>
        <option value="Moteur">Moteur</option>
        <option value="Transmission">Transmission</option>
        <option value="Suspension">Suspension</option>
        <option value="Direction">Direction</option>
        <option value="Freins">Freins</option>
        <option value="√âchappement">√âchappement</option>
        <option value="√âlectrique">√âlectrique</option>
        <option value="Tuning">Tuning</option>
        <option value="Fabrication">Fabrication</option>
        <option value="Hybride">Hybride</option>
        <option value="Carrosserie">Carrosserie</option>
        <option value="Pneus">Pneus</option>
        <option value="Divers">Divers</option>
      </select>

      <input id="partInvSearch" placeholder="Rechercher une pi√®ce (nom, # ou cat√©gorie)..." style="margin-bottom:15px;" />

      <div id="partsInventoryList" style="display:flex;flex-wrap:wrap;gap:15px;"></div>
    </div>

    <!-- HISTORIQUE GLOBAL -->
    <div class="page" id="page-history">
      <h2>Historique des factures</h2>
      <div class="card">
        <div style="display:flex; gap:15px; margin:10px 0;">
  
  <div>
    <label>Filtrer par client :</label><br>
    <select id="filterClient">
      <option value="">Tous les clients</option>
    </select>
  </div>

  <div>
    <label>Filtrer par v√©hicule :</label><br>
    <select id="filterVehicle">
      <option value="">Tous les v√©hicules</option>
    </select>
  </div>

</div>
        <table id="historyTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Client</th>
              <th>V√©hicule / Job</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- NOTES -->
<div class="page" id="page-notes">
  <h2>Notes</h2>

  <div class="card">
    <h3>Ajouter une note</h3>

    <label>Cat√©gorie :</label>
    <select id="noteCategory">
      <option value="general">G√©n√©ral</option>
      <option value="urgent">Urgent</option>
      <option value="todo">√Ä faire</option>
    </select>

    <label style="margin-top:10px;">Contenu :</label>
    <textarea id="noteInput" placeholder="√âcris ta note ici..." style="min-height:90px;"></textarea>

    <button id="addNoteBtn" style="margin-top:8px;">Ajouter la note</button>
  </div>

  <div class="card">
    <h3>Historique des notes</h3>

    <input id="noteSearch" placeholder="Rechercher une note..." style="width:100%;margin-bottom:10px;padding:6px;">

    <div id="notesList"></div>

    <div style="text-align:right;margin-top:15px;">
      <button id="exportNotesBtn" class="ghost">Exporter</button>
      <button id="importNotesBtn" class="ghost">Importer</button>
      <input type="file" id="importNotesFile" accept=".json" style="display:none;">
    </div>
  </div>
</div>


<!-- LIENS RAPIDES -->
<div class="page" id="page-links">
  <h2>Liens Rapides</h2>

  <!-- Ajout d‚Äôun lien -->
  <div class="card">
    <h3>Ajouter un lien</h3>

    <label>Nom du site :</label>
    <input id="linkName" placeholder="Ex: RockAuto">

    <label>URL :</label>
    <input id="linkURL" placeholder="https://...">

    <label>Cat√©gorie :</label>
    <select id="linkCategory">
      <option value="pieces">üîß Pi√®ces</option>
      <option value="manuels">üìò Manuels</option>
      <option value="electricite">‚ö° √âlectricit√©</option>
      <option value="diagnostic">ü©∫ Diagnostic</option>
      <option value="tuning">üî• Tuning</option>
      <option value="general">üìé G√©n√©ral</option>
    </select>

    <label>Ic√¥ne :</label>
    <input id="linkIcon" placeholder="Ex: üîß">

    <button id="addLinkBtn" style="margin-top:8px;">Ajouter le lien</button>
  </div>

  <!-- Barre de recherche -->
  <div class="card">
    <h3>Liens enregistr√©s</h3>

    <input id="linkSearch" placeholder="Rechercher un lien..." style="width:100%;margin-bottom:10px;padding:6px;">

    <div id="linksList"></div>

    <div style="text-align:right;margin-top:15px;">
      <button id="exportLinksBtn" class="ghost">Exporter</button>
      <button id="importLinksBtn" class="ghost">Importer</button>
      <input type="file" id="importLinksFile" accept=".json" style="display:none;">
    </div>
    <div class="card">
    <h3>Liens personnalis√©s</h3>
    <p class="muted">Tu veux que j'ajoute un syst√®me pour ajouter tes propres liens? Dis-moi, je peux te coder √ßa aussi.</p>
  </div>
</div>
</div>


    
    <!-- PARAM√àTRES -->
    <div class="page" id="page-settings">
      <h2>Param√®tres</h2>
      <div class="card">
        <label>Nom du garage</label>
        <input id="settingGarageName" />

        <label>TPS (%)</label>
        <input id="settingGST" type="number" step="0.01" />

        <label>TVQ (%)</label>
        <input id="settingQST" type="number" step="0.01" />

        <button id="saveSettings" style="margin-top:10px;">Enregistrer les param√®tres</button>
        <div class="muted" style="margin-top:6px;">Les nouvelles factures utiliseront ces taux de taxes.</div>

        <hr style="margin:20px 0; border-color:var(--border);">

        <h3>Sauvegarde / Restauration</h3>
        <button id="btnExportData">üì§ Exporter toutes les donn√©es</button>
        <br><br>
        <input type="file" id="importBackupFile" style="display:none;" />
        <button id="btnImportData" class="ghost">üì• Importer un backup (.json)</button>

        <div class="muted" style="margin-top:10px;">
          Sauvegarde toutes vos donn√©es (factures, clients, pi√®ces, services, param√®tres, etc.)
          dans un fichier .json que vous pouvez restaurer plus tard.
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL CLIENT -->
  <div id="clientModal" class="modal-backdrop">
    <div class="modal-panel">
      <h2>Fiche Client</h2>
      <div id="clientModalContent">Chargement...</div>
      <div style="text-align:right;margin-top:15px;">
        <button id="closeClientModal" class="ghost">Fermer</button>
      </div>
    </div>
  </div>

  <!-- MODAL SERVICES PICKER -->
  <div id="servicePickerModal" class="modal-backdrop">
    <div class="modal-panel" style="width:700px;">
      <h2>Choisir un service</h2>

      <label style="margin-top:10px;">Filtrer par cat√©gorie :</label>
      <select id="servicePickerFilter" style="margin-bottom:15px;">
        <option value="">Toutes les cat√©gories</option>
        <option value="Entretien">Entretien</option>
        <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
        <option value="Freins">Freins</option>
        <option value="Suspension">Suspension</option>
        <option value="Direction">Direction</option>
        <option value="Refroidissement">Refroidissement</option>
        <option value="Diagnostic">Diagnostic</option>
        <option value="√âlectricit√©">√âlectricit√©</option>
        <option value="Pneus">Pneus</option>
        <option value="√âchappement">√âchappement</option>
        <option value="Transmission">Transmission</option>
        <option value="Moteur">Moteur</option>
        <option value="Divers">Divers</option>
      </select>

      <div id="servicePickerList">Chargement...</div>

      <div style="text-align:right;margin-top:15px;">
        <button id="closeServicePicker" class="ghost">Fermer</button>
      </div>
    </div>
  </div>

  
  <!-- MODAL PART PICKER -->
<div id="partPickerModal" class="modal-backdrop">
  <div class="modal-panel" style="width:700px;">
    <h2>Choisir une pi√®ce</h2>

    <label style="margin-top:10px;">Filtrer par cat√©gorie :</label>
    <select id="partPickerFilter" style="margin-bottom:15px;">
      <option value="">Toutes cat√©gories</option>
      <option value="Moteur">Moteur</option>
      <option value="Transmission">Transmission</option>
      <option value="Suspension">Suspension</option>
      <option value="Direction">Direction</option>
      <option value="Freins">Freins</option>
      <option value="√âchappement">√âchappement</option>
      <option value="√âlectrique">√âlectrique</option>
      <option value="Tuning">Tuning</option>
      <option value="Fabrication">Fabrication</option>
      <option value="Hybride">Hybride</option>
      <option value="Carrosserie">Carrosserie</option>
      <option value="Pneus">Pneus</option>
      <option value="Divers">Divers</option>
    </select>

    <div id="partPickerList">Chargement...</div>

    <div style="text-align:right;margin-top:15px;">
      <button id="closePartPicker" class="ghost">Fermer</button>
    </div>
  </div>
</div>

  
  <!-- MODAL EDIT FACTURE -->
  <div id="invoiceEditModal" class="modal-backdrop">
    <div class="modal-panel" style="width:900px;">
      <h2>Modifier Facture</h2>
      <div id="invoiceEditContent">Chargement...</div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px;">
        <button id="printInvoiceEditBtn" class="ghost">Imprimer</button>
        <button class="ghost" id="exportPdfEditBtn">Export PDF</button>
        <button id="deleteInvoiceBtn" class="ghost">Supprimer</button>
        <button id="saveInvoiceEditBtn">Enregistrer</button>
        <button id="closeInvoiceEditModal" class="ghost">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* ===================== HELPERS & STORAGE ===================== */
const STORAGE = {
  invoices:'ar_invoices_v2',
  settings:'ar_settings_v1',
  invoiceCounter:'ar_invoice_counter_v1',
  clients:'ar_clients_v1',
  parts:'ar_parts_inventory_v1',
  services:'ar_services_v1',
  notes: 'ar_notes_v1',
  workorders: 'ar_workorders_v1'
};

const $ = id => document.getElementById(id);
function money(n){return Number(n||0).toFixed(2);}

/* ===================== NAVIGATION ===================== */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const pg = $(id);
  if(pg) pg.style.display='block';
  document.querySelectorAll('.navBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.page===id);
  });

  // === ROUTAGE LOGIQUE DES PAGES ===
  switch(id){
    case "page-invoice-list":
      renderInvoiceList();
      break;

    case "page-invoice-editor":
      resetInvoiceForm();
      break;
  }
}

document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click',()=>showPage(btn.dataset.page));
});

/* ===================== GLOBAL DATA ===================== */
let SETTINGS = {garageName:'Garage-Atelier M√©canique J.L', gst:5, qst:9.975};
let INVOICES = [];
let WORKORDERS = [];
let items = [];
let CLIENTS = [];
let PARTS = [];
let SERVICES = [];

  
  /* ===================== WORK ORDERS (Bons de travail) ===================== */

function loadWorkOrders(){
  try{
    WORKORDERS = JSON.parse(localStorage.getItem(STORAGE.workorders) || '[]');
    if (!Array.isArray(WORKORDERS)) WORKORDERS = [];
  }catch(e){
    WORKORDERS = [];
  }
}

function saveWorkOrders(){
  localStorage.setItem(STORAGE.workorders, JSON.stringify(WORKORDERS));
}

  function saveNewWorkOrder() {
  const clientId = $("woClientSelect")?.value;
  const vehicleId = $("woVehicleSelect")?.value;
  const description = $("woDescription")?.value.trim();
  const status = $("woStatus")?.value;

  if (!clientId) return alert("S√©lectionne un client.");
  if (!vehicleId) return alert("S√©lectionne un v√©hicule.");

  const client = CLIENTS.find(c => String(c.id) === String(clientId));
  const vehicle = client.vehicles.find(v => String(v.id) === String(vehicleId));

  // Cr√©ation du Work Order minimal
  const wo = {
    id: Date.now(),
    number: "BT-" + Date.now(),
    date: new Date().toLocaleString("fr-CA"),
    clientId,
    clientName: client.name,
    vehicleId,
    vehicleLabel: `${vehicle.year} ${vehicle.make} ${vehicle.model}`,
    description,
    status,
    parts: [],
    labor: [],
    estimateTotal: 0
  };

  WORKORDERS.push(wo);
  saveWorkOrders();
  renderWorkOrders();

  // Afficher confirmation
  $("woDetailContent").innerHTML = `
    <div class="muted">Bon de travail cr√©√© avec succ√®s.</div>
  `;
}

  function renderPartPicker() {
  const list = $("partPickerList");
  const modal = $("partPickerModal");
  list.innerHTML = "";

  if (!PARTS.length) {
    list.innerHTML = `<div class="muted">Aucune pi√®ce enregistr√©e.</div>`;
    modal.style.display = "flex";
    return;
  }

  PARTS.forEach(p => {
    const btn = document.createElement("button");
    btn.dataset.number = p.number;
    btn.style = "width:100%;margin-bottom:6px;";
    btn.className = "ghost";
    btn.innerHTML = `${p.name} ‚Äî ${p.price}$`;

    list.appendChild(btn);
  });

  modal.style.display = "flex";
}

  function renderServicePicker() {
  const list = $("servicePickerList");
  const modal = $("servicePickerModal");
  list.innerHTML = "";

  if (!SERVICES.length) {
    list.innerHTML = `<div class="muted">Aucun service enregistr√©.</div>`;
    modal.style.display = "flex";
    return;
  }

  SERVICES.forEach(s => {
    const btn = document.createElement("button");
    btn.dataset.service = s.id;
    btn.style = "width:100%;margin-bottom:6px;";
    btn.className = "ghost";

    const label = s.priceFixed
      ? `${s.name} ‚Äî ${s.priceFixed}$`
      : `${s.name} ‚Äî ${s.hours || 1}h @ ${s.rate || 60}$/h`;

    btn.innerHTML = label;
    list.appendChild(btn);
  });

  modal.style.display = "flex";
}

  
  /* Ajouter une pi√®ce √† un WO */
function woAddPartLine(wo) {
  const modal = $("partPickerModal");
  const listEl = $("partPickerList");
  if (!modal || !listEl) return;

  // On ouvre le modal
  modal.style.display = "flex";

  // Si tu n'as aucune pi√®ce dans l'inventaire
  if (!PARTS.length) {
    listEl.innerHTML = `<div class="muted">Aucune pi√®ce enregistr√©e dans l'inventaire.</div>`;
    return;
  }

  // On affiche toutes les pi√®ces (on ne touche pas au module facture)
  listEl.innerHTML = PARTS.map((p, idx) => {
    const stock = Number(p.qty || 0);
    return `
      <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;">
        <b>${p.name}</b> <span class="muted">#${p.number || ""}</span><br>
        <span class="muted">Cat√©gorie : ${p.category || "Divers"}</span><br>
        <span class="muted">Stock : ${stock}</span><br>
        <span class="muted">Prix : ${money(p.price || 0)} $</span><br>
        <button class="ghost" data-wo-part-index="${idx}">‚ûï Utiliser pour ce bon</button>
      </div>
    `;
  }).join("");

  // Quand on clique sur "Utiliser pour ce bon"
  listEl.querySelectorAll("button[data-wo-part-index]").forEach(btn => {
    btn.onclick = () => {
      const idx = Number(btn.dataset.woPartIndex);
      const part = PARTS[idx];
      if (!part) return;

      // Demande la quantit√© √† utiliser pour ce Work Order
      const qtyInput = prompt("Quantit√© pour cette pi√®ce sur ce bon de travail :", "1");
      const qty = Number(qtyInput);
      if (!qty || qty <= 0) return;

      const stock = Number(part.qty || 0);
      if (qty > stock) {
        alert("Attention : la quantit√© demand√©e d√©passe le stock actuel (" + stock + ").");
      }

      wo.parts.push({
        name: part.name,
        number: part.number,
        qty,
        rate: Number(part.price || 0),
        total: qty * Number(part.price || 0)
      });

      saveWorkOrders();
      woRenderLines(wo);

      modal.style.display = "none";
    };
  });
}


/* Ajouter main-d'≈ìuvre √† un WO */
function woAddLaborLine(wo) {
  const modal = $("servicePickerModal");
  const listEl = $("servicePickerList");
  if (!modal || !listEl) return;

  modal.style.display = "flex";

  if (!SERVICES.length) {
    listEl.innerHTML = `<div class="muted">Aucun service enregistr√©.</div>`;
    return;
  }

  // On r√©utilise la logique d'affichage des services
  listEl.innerHTML = SERVICES.map(s => {
    const typeLabel = s.priceFixed > 0
      ? `Forfait: ${money(s.priceFixed)} $`
      : (s.hours > 0 && s.rate > 0
          ? `${s.hours} h x ${money(s.rate)} $/h`
          : `Non d√©fini`);

    const icon = (typeof SERVICE_ICONS !== "undefined" && SERVICE_ICONS[s.category])
      ? SERVICE_ICONS[s.category]
      : "‚öôÔ∏è";

    return `
      <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;">
        <b>${icon} ${s.name}</b><br>
        <span class="muted">Cat√©gorie : ${s.category || "Divers"}</span><br>
        <span class="muted">Tarification : ${typeLabel}</span><br>
        ${s.desc ? `<div class="muted" style="margin-top:4px;">${s.desc}</div>` : ""}
        <button class="ghost" data-wo-service-id="${s.id}">
          ‚ûï Utiliser pour ce bon
        </button>
      </div>
    `;
  }).join("");

  // Quand on clique sur "Utiliser pour ce bon"
  listEl.querySelectorAll("button[data-wo-service-id]").forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.woServiceId;
      const srv = SERVICES.find(s => String(s.id) === String(id));
      if (!srv) return;

      let hours = 1;
      let rate = 0;

      if (srv.priceFixed > 0) {
        // Forfait : 1 "unit√©" √† prix fixe
        hours = 1;
        rate = Number(srv.priceFixed || 0);
      } else if (srv.hours > 0 && srv.rate > 0) {
        // Tarif horaire
        hours = Number(srv.hours || 0);
        rate = Number(srv.rate || 0);
      }

      wo.labor.push({
        description: srv.name,
        hours,
        rate,
        total: hours * rate
      });

      saveWorkOrders();
      woRenderLines(wo);

      modal.style.display = "none";
    };
  });
}

  
  /* Rendu des lignes d‚Äôun WO */
function woRenderLines(wo) {
  // pi√®ces
  const pBody = $("woPartsTable").querySelector("tbody");
  pBody.innerHTML = wo.parts.map((p,i)=>`
    <tr>
      <td>${p.name}</td>
      <td>${p.qty}</td>
      <td>${money(p.rate)}$</td>
      <td>${money(p.qty*p.rate)}$</td>
      <td>
        <button class="ghost" onclick="woEditLine(${wo.id},'part',${i})">‚úèÔ∏è</button>
        <button class="ghost" onclick="woRemovePart(${wo.id},${i})">üóë</button>
      </td>
    </tr>
  `).join("");

  // main d‚Äô≈ìuvre
  const lBody = $("woLaborTable").querySelector("tbody");
  lBody.innerHTML = wo.labor.map((l,i)=>`
    <tr>
      <td>${l.description}</td>
      <td>${l.hours}</td>
      <td>${money(l.rate)}$</td>
      <td>${money(l.hours*l.rate)}$</td>
      <td>
        <button class="ghost" onclick="woEditLine(${wo.id},'labor',${i})">‚úèÔ∏è</button>
        <button class="ghost" onclick="woRemoveLabor(${wo.id},${i})">üóë</button>
      </td>
    </tr>
  `).join("");

  // total estim√©
  const total =
    wo.parts.reduce((s,p)=>s+p.qty*p.rate,0) +
    wo.labor.reduce((s,l)=>s+l.hours*l.rate,0);

  wo.estimateTotal = total;
  $("woEstimateTotal").innerText = money(total) + " $";

  saveWorkOrders();
}

function woEditLine(woId, type, index) {
  const wo = WORKORDERS.find(w => w.id == woId);
  if (!wo) return;

  const modal = $("woEditModal");
  const box = $("woEditContent");

  let line = (type === "part") ? wo.parts[index] : wo.labor[index];

  if (type === "part") {
    box.innerHTML = `
      <label>Nom</label>
      <input id="woEditName" value="${line.name}">

      <label>Quantit√©</label>
      <input id="woEditQty" type="number" value="${line.qty}">

      <label>Prix unitaire</label>
      <input id="woEditRate" type="number" step="0.01" value="${line.rate}">
    `;
  } else {
    box.innerHTML = `
      <label>Description</label>
      <input id="woEditDesc" value="${line.description}">

      <label>Heures</label>
      <input id="woEditHours" type="number" step="0.1" value="${line.hours}">

      <label>Taux horaire</label>
      <input id="woEditRate" type="number" step="0.01" value="${line.rate}">
    `;
  }

  modal.style.display = "flex";

  $("woEditCancel").onclick = () => modal.style.display = "none";

  $("woEditSave").onclick = () => {
    if (type === "part") {
      line.name = $("woEditName").value;
      line.qty = Number($("woEditQty").value);
      line.rate = Number($("woEditRate").value);
      line.total = line.qty * line.rate;
    } else {
      line.description = $("woEditDesc").value;
      line.hours = Number($("woEditHours").value);
      line.rate = Number($("woEditRate").value);
      line.total = line.hours * line.rate;
    }

    saveWorkOrders();
    woRenderLines(wo);

    modal.style.display = "none";
  };
}

  
  function woRemovePart(woId,index){
  const wo = WORKORDERS.find(w=>w.id==woId);
  if(!wo) return;
  wo.parts.splice(index,1);
  saveWorkOrders();
  woRenderLines(wo);
}

function woRemoveLabor(woId,index){
  const wo = WORKORDERS.find(w=>w.id==woId);
  if(!wo) return;
  wo.labor.splice(index,1);
  saveWorkOrders();
  woRenderLines(wo);
}


function renderWorkOrders(){
  const table = $("woTable");
  const tbody = table ? table.querySelector("tbody") : null;
  if (!tbody) return;

  if (!WORKORDERS.length){
    tbody.innerHTML = `<tr>
        <td colspan="7" class="muted">Aucun bon de travail pour le moment.</td>
      </tr>`;
    return;
  }

  tbody.innerHTML = "";
    const selectedStatus = $("woStatusFilter").value;
  const search = $("woSearch").value.toLowerCase();

  // Appliquer filtre statut + recherche
  let filtered = WORKORDERS.filter(wo => {
    let ok = true;

    if (selectedStatus && wo.status !== selectedStatus) ok = false;

    if (search) {
      const hay = `${wo.clientName} ${wo.vehicleLabel} ${wo.number}`.toLowerCase();
      if (!hay.includes(search)) ok = false;
    }

    return ok;
  });


  filtered.forEach(wo => {
    const tr = document.createElement("tr");
    tr.dataset.id = wo.id;
    tr.innerHTML = `
      <td>${wo.number || ""}</td>
      <td>${wo.date || ""}</td>
      <td>${wo.clientName || ""}</td>
      <td>${wo.vehicleLabel || ""}</td>
      <td>
  <span class="status-badge status-${wo.status}">
    ${wo.status.replace("_"," ")}
  </span>
</td>
      <td>${money(wo.estimateTotal || 0)} $</td>
      <td><button class="ghost" data-action="open">Ouvrir</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function initWorkOrdersModule(){
  loadWorkOrders();
  renderWorkOrders();

  $("woStatusFilter").onchange = renderWorkOrders;
$("woSearch").oninput = renderWorkOrders;

  const btnNew = $("btnNewWorkOrder");
  if (btnNew){
    btnNew.onclick = () => {
  const detail = $("woDetailContent");
  if (!detail) return;

  detail.innerHTML = `
    <div style="display:grid;gap:10px;max-width:600px;">

      <label>Client :</label>
      <select id="woClientSelect"></select>

      <label>V√©hicule :</label>
      <select id="woVehicleSelect">
        <option value="">S√©lectionner un client d'abord</option>
      </select>

      <label>Description du probl√®me :</label>
      <textarea id="woDescription" style="min-height:80px;"></textarea>

      <label>Statut :</label>
      <select id="woStatus">
        <option value="draft">Brouillon</option>
        <option value="in_progress">En cours</option>
        <option value="waiting_parts">En attente de pi√®ces</option>
        <option value="completed">Termin√©</option>
      </select>

      <button id="btnSaveWO" style="margin-top:10px;">üíæ Sauvegarder</button>
    </div>
  `;

  // Remplir clients
  const cSel = $("woClientSelect");
  cSel.innerHTML = `<option value="">S√©lectionner</option>`;
  CLIENTS.forEach(c => {
    cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });

  // Charger v√©hicules selon client
  cSel.onchange = () => {
    const vSel = $("woVehicleSelect");
    vSel.innerHTML = `<option value="">S√©lectionner</option>`;

    const client = CLIENTS.find(c => String(c.id) === String(cSel.value));
    if (!client || !client.vehicles) return;

    client.vehicles.forEach(v => {
      const label = `${v.year} ${v.make} ${v.model} (${v.plate || "sans plaque"})`;
      vSel.innerHTML += `<option value="${v.id}">${label}</option>`;
    });
  };

  // Sauvegarde Work Order
  $("btnSaveWO").onclick = saveNewWorkOrder;
};
  }

  const table = $("woTable");
  if (table){
    table.onclick = (e) => {
      const btn = e.target.closest("button[data-action='open']");
      if (!btn) return;

      const tr = btn.closest("tr");
      const id = tr?.dataset.id;
      const wo = WORKORDERS.find(w => String(w.id) === String(id));
      const detail = $("woDetailContent");
      if (!detail || !wo) return;

      detail.innerHTML = `
  <h3>Bon de travail #${wo.number}</h3>

  <div class="muted" style="margin-bottom:10px;">${wo.date}</div>

  <div style="margin-bottom:20px;">
    <b>Client :</b> ${wo.clientName}<br>
    <b>V√©hicule :</b> ${wo.vehicleLabel}<br>
    <b>Description :</b><br>
    <div class="muted" style="white-space:pre-line;margin-top:4px;">
      ${wo.description || "(aucune description)"}
    </div>
  </div>

  <div class="card">
    <h3>Pi√®ces</h3>
    <button id="woAddPart" class="ghost">‚ûï Ajouter une pi√®ce</button>
    <table id="woPartsTable" style="margin-top:10px;">
      <thead>
        <tr><th>Nom</th><th>Qt√©</th><th>Prix</th><th>Total</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:20px;">
    <h3>Main d'≈ìuvre</h3>
    <button id="woAddLabor" class="ghost">‚ûï Ajouter main d'≈ìuvre</button>
    <table id="woLaborTable" style="margin-top:10px;">
      <thead>
        <tr><th>Description</th><th>Heures</th><th>Rate</th><th>Total</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:20px;text-align:right;">
    <h3>Total estim√© : <span id="woEstimateTotal">0 $</span></h3>
  </div>
  <div class="card" style="margin-top:20px;text-align:right;">
  <button id="woConvertToInvoice">‚û°Ô∏è Cr√©er une facture</button>
</div>
`;
      
$("woAddPart").onclick = () => woAddPartLine(wo);
$("woAddLabor").onclick = () => woAddLaborLine(wo);
woRenderLines(wo);
$("woConvertToInvoice").onclick = () => woConvertToInvoice(wo);


    };
  }
}


  // === Mise √† jour automatique du menu v√©hicule selon le client ===
$("customerSelect").onchange = () => {
    const clientName = $("customerSelect").value;
    const client = CLIENTS.find(c => c.name === clientName);
    const vehicleMenu = $("vehicleSelect");

    // Vider l'ancien contenu
    vehicleMenu.innerHTML = "";

    // Aucun client choisi
    if (!client) {
        vehicleMenu.innerHTML = `<option value="">‚Äî S√©lectionnez un client ‚Äî</option>`;
        $("jobDesc").value = "";
        return;
    }

    // Si client sans v√©hicule
    if (!client.vehicles || client.vehicles.length === 0) {
        vehicleMenu.innerHTML = `<option value="">‚Äî Aucun v√©hicule enregistr√© ‚Äî</option>`;
        $("jobDesc").value = "";
        return;
    }

    // Sinon : remplir avec les v√©hicules du client
    client.vehicles.forEach(v => {
        const label = `${v.year || ""} ${v.make || ""} ${v.model || ""}`.trim();
        vehicleMenu.innerHTML += `<option value="${label}">${label}</option>`;
    });

    // mettre la valeur du premier v√©hicule dans jobDesc
    $("jobDesc").value = vehicleMenu.value;
};

// Quand un v√©hicule est s√©lectionn√© ‚Üí mettre la valeur dans jobDesc
$("vehicleSelect").onchange = () => {
    $("jobDesc").value = $("vehicleSelect").value;
};


/* ===================== SETTINGS ===================== */
function loadSettings(){
  try{
    SETTINGS = JSON.parse(localStorage.getItem(STORAGE.settings) || 'null') || SETTINGS;
  }catch(e){}
}
function saveSettings(){
  localStorage.setItem(STORAGE.settings, JSON.stringify(SETTINGS));
}
function initSettings(){
  loadSettings();
  if($('settingGarageName')) $('settingGarageName').value = SETTINGS.garageName;
  if($('settingGST')) $('settingGST').value = SETTINGS.gst;
  if($('settingQST')) $('settingQST').value = SETTINGS.qst;

  if($('saveSettings')){
    $('saveSettings').addEventListener('click',()=>{
      SETTINGS.garageName = $('settingGarageName').value.trim() || SETTINGS.garageName;
      SETTINGS.gst = Number($('settingGST').value)||SETTINGS.gst;
      SETTINGS.qst = Number($('settingQST').value)||SETTINGS.qst;
      saveSettings();
      alert('Param√®tres enregistr√©s.');
      renderTotals();
    });
  }
}

/* ===================== INVOICES CORE ===================== */
function loadInvoices(){
  try{
    INVOICES = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
    if(!Array.isArray(INVOICES)) INVOICES=[];
  }catch(e){INVOICES=[];}
}
  
function saveInvoices(){
  localStorage.setItem(STORAGE.invoices, JSON.stringify(INVOICES));
}
  function renderInvoiceList() {
  const tbody = $("invoiceListTable").querySelector("tbody");
  tbody.innerHTML = "";

  if (!INVOICES.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Aucune facture</td></tr>`;
    return;
  }

  const search = $("invoiceSearch").value.toLowerCase();
  const statusFilter = $("invoiceStatusFilter").value;

  let filtered = INVOICES.filter(inv => {
    let ok = true;

    if (statusFilter && inv.status !== statusFilter) ok = false;

    if (search) {
      const hay =
        `${inv.number} ${inv.customer} ${inv.job}`.toLowerCase();
      if (!hay.includes(search)) ok = false;
    }

    return ok;
  });

  filtered.forEach(inv => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.customer}</td>
      <td>${money(inv.total)}</td>
      <td>${inv.status || "draft"}</td>
      <td>
        <button class="ghost" onclick="openInvoiceEditor(${inv.number})">Ouvrir</button>
      </td>
    `;

    tbody.appendChild(row);
  });
}

  // === FILTRES DE RECHERCHE ET STATUT (3D) ===
$("invoiceSearch").oninput = renderInvoiceList;
$("invoiceStatusFilter").onchange = renderInvoiceList;

  function openInvoiceEditor(number) {
  const inv = INVOICES.find(i => i.number == number);
  if (!inv) return;

  // Aller sur la page √©diteur
  showPage("page-invoice-editor");

  resetInvoiceForm();

  $("invoiceNumber").value = inv.number;

  // Client
  const c = CLIENTS.find(c => c.name === inv.customer);
  if (c) $("customerSelect").value = c.id;

  $("jobDesc").value = inv.job;

  items = [];
  inv.items.forEach(it => items.push({...it}));

  renderItems();
  invoiceCalcTotals();
}


/* STOCK & INVENTAIRE */
function loadParts(){
  try{
    PARTS = JSON.parse(localStorage.getItem(STORAGE.parts) || '[]');
    if(!Array.isArray(PARTS)) PARTS=[];
  }catch(e){PARTS=[];}
}
function saveParts(){
  localStorage.setItem(STORAGE.parts, JSON.stringify(PARTS));
}
function findInventoryPartFromText(text){
  text = (text||'').toLowerCase();
  for(const p of PARTS){
    const num = String(p.number||'').toLowerCase();
    if(num && text.includes(num)) return p;
  }
  return null;
}
function adjustStockForLinkedItem(item, deltaQty){
  if(!item || !item.invNumber) return;
  const num = String(item.invNumber);
  const part = PARTS.find(p=>String(p.number)===num);
  if(!part) return;
  const current = Number(part.qty||0);
  part.qty = current + deltaQty;
  if(part.qty<0) part.qty=0;
  saveParts();
  renderParts();
  renderDashboard();
}
function linkNewItemToInventory(item){
  if(!item || !item.desc || !item.type || !item.type.toLowerCase().includes('pi√®ce')) return;
  const part = findInventoryPartFromText(item.desc);
  if(!part) return;
  const qty = Number(item.qty)||1;
  const currentQty = Number(part.qty||0);
  if(currentQty<qty){
    alert("Stock insuffisant pour cette pi√®ce en inventaire.");
    return false;
  }
  part.qty = currentQty - qty;
  item.invNumber = part.number;
  saveParts();
  renderParts();
  renderDashboard();
  return true;
}

/* RENDER ITEMS & TOTALS */
function renderTotals(subTotalOverride){
  const sub = (typeof subTotalOverride === 'number') ? subTotalOverride
               : items.reduce((s,it)=>s+it.qty*it.rate,0);
  const gstRate = Number(SETTINGS.gst||5)/100;
  const qstRate = Number(SETTINGS.qst||9.975)/100;

  const gst = sub * gstRate;
  const qst = (sub + gst) * qstRate;
  const total = sub + gst + qst;

  if($('subTotal')) $('subTotal').innerText = money(sub);
  if($('gstAmount')) $('gstAmount').innerText = money(gst);
  if($('qstAmount')) $('qstAmount').innerText = money(qst);
  if($('totalAmount')) $('totalAmount').innerText = money(total);
}

function renderItems(){
  const tbody = document.querySelector('#itemsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  let sub=0;
  items.forEach((it,i)=>{
    const total=it.qty*it.rate;
    sub+=total;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.type}</td>
      <td>${it.desc}</td>
      <td>${it.qty}</td>
      <td>${money(it.rate)}</td>
      <td>${money(total)}</td>
      <td><button class="ghost" onclick="removeItem(${i})">X</button></td>
    `;
    tbody.appendChild(tr);
  });
  renderTotals(sub);
}

function removeItem(i){
  const item = items[i];
  if(item && item.invNumber){
    const qty = Number(item.qty)||1;
    adjustStockForLinkedItem(item, qty);
  }
  items.splice(i,1);
  renderItems();
}

if($('clearItems')){
  $('clearItems').addEventListener('click',()=>{
    if(!items.length) return;
    if(!confirm("Vider tous les articles de la facture ?")) return;
    items.forEach(it=>{
      if(it.invNumber){
        const qty = Number(it.qty)||1;
        adjustStockForLinkedItem(it, qty);
      }
    });
    items=[];
    renderItems();
  });
}

/* ADD PART & LABOR */
if($('addPart')){
  $('addPart').addEventListener('click',()=>{
    const name = $('partName').value.trim();
    const qty = Number($('partQty').value)||0;
    const price = Number($('partPrice').value)||0;
    if(!name || qty<=0) return alert("Informations pi√®ce incompl√®tes");
    const newItem = {type:'Pi√®ce',desc:name,qty,rate:price};
    const linkedOk = linkNewItemToInventory(newItem);
    if(linkedOk===false) return;
    items.push(newItem);
    $('partName').value='';
    $('partPrice').value='';
    $('partQty').value=1;
    renderItems();
  });
}
if($('addLabor')){
  $('addLabor').addEventListener('click',()=>{
    const desc=$('laborDesc').value.trim();
    const hours=Number($('laborHours').value)||0;
    const rate=Number($('laborRate').value)||0;
    if(!desc || hours<=0 || rate<=0) return alert("Infos main-d'≈ìuvre incompl√®tes");
    items.push({type:"Main-d'≈ìuvre",desc,qty:hours,rate});
    $('laborDesc').value='';
    $('laborHours').value='';
    $('laborRate').value='';
    renderItems();
  });
}

/* INVOICE NUMBERS */
function nextInvoiceNumber(){
  let num = Number(localStorage.getItem(STORAGE.invoiceCounter)||0);
  num++;
  localStorage.setItem(STORAGE.invoiceCounter, String(num));
  return num;
}
function resetInvoiceForm(){
  // On vide la s√©lection client (nouveau select)
  if ($('customerSelect')) {
    $('customerSelect').value = '';
  }

  // On vide la description du job si le champ existe
  if ($('jobDesc')) {
    $('jobDesc').value = '';
  }

  // On vide les items de la facture
  items = [];
  renderItems();

  // On met le prochain num√©ro de facture
  if ($('invoiceNumber')) {
    $('invoiceNumber').value = nextInvoiceNumber();
  }
}

/* SAVE INVOICE (NEW) */
function renderInvoicesTable(){
  // plus de table sur la page Factures; on met √† jour Historique + Dashboard
  renderHistoryTable();
  renderDashboard();
}

if($('saveInvoice')){
  $('saveInvoice').addEventListener('click',()=>{
    if(!items.length) return alert("Aucun article dans la facture.");
    const customerId = $("customerSelect").value;
if(!customerId){
    alert("Veuillez s√©lectionner un client.");
    return;
}
const clientObj = CLIENTS.find(c => String(c.id) === String(customerId));
const cust = clientObj ? clientObj.name : "Client inconnu";
    if(!cust) return alert("Le nom du client est requis.");
    const job = $("vehicleSelect").value || "";
    const number = $('invoiceNumber').value || nextInvoiceNumber();
    const dateStr = new Date().toLocaleDateString('fr-CA');

    const sub = items.reduce((s,it)=>s+it.rate*it.qty,0);
    const gstRate = Number(SETTINGS.gst||5)/100;
    const qstRate = Number(SETTINGS.qst||9.975)/100;
    const gst = sub*gstRate;
    const qst = (sub+gst)*qstRate;
    const total = sub+gst+qst;

    const inv = {number,date:dateStr,customer:cust,job,items:[...items],subTotal:sub,gst,qst,total};
    INVOICES.push(inv);
    saveInvoices();
    alert("Facture enregistr√©e.");
    resetInvoiceForm();
    renderInvoicesTable();
  });
}

/* INIT INVOICES */
function initInvoices(){
  loadInvoices();
  loadParts();
  loadClients();
  resetInvoiceForm();
  renderInvoicesTable();
  refreshInvoiceClientSelect();
}

/* ===================== CLIENTS ===================== */
function loadClients(){
  try{
    CLIENTS = JSON.parse(localStorage.getItem(STORAGE.clients) || '[]');
    if(!Array.isArray(CLIENTS)) CLIENTS=[];
  }catch(e){CLIENTS=[];}
}
function saveClients(){
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
}

  /* ======== AJOUT POUR INVOICES : s√©lectionner un client ======== */
function refreshInvoiceClientSelect() {
  const select = $("customerSelect");
  if (!select) return;
  select.innerHTML = "";

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "-- S√©lectionner un client --";
  select.appendChild(opt0);

  CLIENTS.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    select.appendChild(opt);
  });
}

/* ======== REMPLIR LE MENU DES V√âHICULES ======== */
function refreshVehicleListForInvoice() {
    const customerId = $("customerSelect").value;
    const select = $("vehicleSelect");
    select.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "-- Choisir un v√©hicule --";
    select.appendChild(opt0);

    if (!customerId) return;

    const clientObj = CLIENTS.find(c => String(c.id) === String(customerId));
    if (!clientObj || !Array.isArray(clientObj.vehicles)) return;

    clientObj.vehicles.forEach(v => {
        const opt = document.createElement("option");
        opt.value = `${v.year} ${v.make} ${v.model} - ${v.plate}`;
        opt.textContent = `${v.year} ${v.make} ${v.model} (${v.plate})`;
        select.appendChild(opt);
    });
}

/* ======== Quand on change de client => Raffra√Æchir les v√©hicules ======== */
$("customerSelect").addEventListener("change", refreshVehicleListForInvoice);

  
  /* ======== AJOUT : cr√©er un client pendant une facture ======== */
$("btnCreateCustomerFromInvoice").onclick = () => {
  const name = prompt("Nom du nouveau client :");
  if (!name) return;

  const phone = prompt("T√©l√©phone (optionnel) :") || "";
  const email = prompt("Email (optionnel) :") || "";
  const address = prompt("Adresse (optionnel) :") || "";

  const newClient = {
    id: Date.now(),
    name,
    phone,
    email,
    address,
    vehicles: []
  };

  CLIENTS.push(newClient);
  saveClients();
  refreshInvoiceClientSelect();

  $("customerSelect").value = newClient.id;

  alert("Client ajout√© !");
  renderClientsTable();
};

function renderVehiclesPage(){
  const tbody = document.querySelector('#vehiclesTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  CLIENTS.forEach(c=>{
    (c.vehicles||[]).forEach(v=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${c.name||''}</td>
        <td>${v.make||''}</td>
        <td>${v.model||''}</td>
        <td>${v.year||''}</td>
        <td>${v.plate||''}</td>
        <td>${v.vin||''}</td>
        <td>${v.km||''}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}

function renderClientsTable(){
  const tbody = document.querySelector('#clientsTable tbody');
  if(!tbody) return;
  const q = ($('clientSearch')?.value || '').toLowerCase();
  tbody.innerHTML='';
  CLIENTS.forEach(c=>{
    const hay = `${c.name||''} ${c.phone||''} ${c.email||''} ${c.address||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    const vehicleCount = Array.isArray(c.vehicles)?c.vehicles.length:0;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${c.name||''}</td>
      <td>${c.phone||''}</td>
      <td>${c.email||''}</td>
      <td>${c.address||''}</td>
      <td>${vehicleCount}</td>
      <td><button class="ghost" data-action="open-client" data-id="${c.id}">Fiche</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-action="open-client"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id = btn.dataset.id;
      openClientModal(id);
    });
  });
  renderVehiclesPage();
  renderDashboard();
}

function findClientById(id){
  return CLIENTS.find(c=>String(c.id)===String(id));
}

function openClientModal(id){
  const modal=$('clientModal');
  if(!modal) return;
  modal.style.display='flex';
  renderClientModal(id);
}
function closeClientModal(){
  const modal=$('clientModal');
  if(modal) modal.style.display='none';
}
if($('closeClientModal')){
  $('closeClientModal').addEventListener('click',closeClientModal);
}

function renderClientModal(id){
  loadClients();
  const content=$('clientModalContent');
  if(!content) return;
  const isNew = !id;
  let client;
  if(isNew){
    client={id:Date.now(),name:'',phone:'',email:'',address:'',notes:'',vehicles:[]};
  }else{
    client=findClientById(id);
    if(!client){
      alert('Client introuvable');
      closeClientModal();
      return;
    }
  }
  const invoices=INVOICES;
  const clientInvoices=invoices.filter(inv=>(inv.customer||'').toLowerCase()===(client.name||'').toLowerCase());

  content.innerHTML=`
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div>
        <h3 style="margin:0 0 6px;color:var(--accent);">Informations client</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <label>Nom</label>
            <input id="clientFormName" value="${client.name||''}" />
          </div>
          <div style="flex:1;min-width:160px;">
            <label>T√©l√©phone</label>
            <input id="clientFormPhone" value="${client.phone||''}" />
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <div style="flex:1;min-width:200px;">
            <label>Email</label>
            <input id="clientFormEmail" value="${client.email||''}" />
          </div>
          <div style="flex:1;min-width:200px;">
            <label>Adresse</label>
            <input id="clientFormAddress" value="${client.address||''}" />
          </div>
        </div>
        <label style="margin-top:8px;">Notes</label>
        <textarea id="clientFormNotes">${client.notes||''}</textarea>
      </div>

      <div>
        <h3 style="margin:10px 0 6px;color:var(--accent);">V√©hicules</h3>
        <div id="clientVehiclesList" class="small"></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:120px;"><label>Marque</label><input id="vehMake" /></div>
          <div style="flex:1;min-width:120px;"><label>Mod√®le</label><input id="vehModel" /></div>
          <div style="flex:1;min-width:80px;"><label>Ann√©e</label><input id="vehYear" /></div>
        </div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:120px;"><label>Plaque</label><input id="vehPlate" /></div>
          <div style="flex:1;min-width:150px;"><label>VIN</label><input id="vehVin" /></div>
          <div style="flex:1;min-width:80px;"><label>KM</label><input id="vehKm" type="number" /></div>
        </div>
        <label style="margin-top:6px;">Notes v√©hicule</label>
        <textarea id="vehNotes"></textarea>
        <button id="clientAddVehicleBtn" style="margin-top:6px;">Ajouter v√©hicule</button>
      </div>

      <div>
        <h3 style="margin:10px 0 6px;color:var(--accent);">Historique (factures)</h3>
        <div id="clientHistory" class="small"></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        ${isNew ? '' : '<button id="clientDeleteBtn" class="ghost">Supprimer client</button>'}
        <button id="clientSaveBtn">Enregistrer</button>
      </div>
    </div>
  `;

  function renderVehiclesList(){
    const wrap=$('clientVehiclesList');
    if(!wrap) return;
    if(!client.vehicles || client.vehicles.length===0){
      wrap.innerHTML='<div class="muted">Aucun v√©hicule pour ce client.</div>';
      return;
    }
    wrap.innerHTML=client.vehicles.map((v,idx)=>`
      <div style="border:1px solid var(--border);border-radius:6px;padding:6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div><strong>${v.make||''} ${v.model||''} ${v.year||''}</strong></div>
          <div class="small">Plaque: ${v.plate||''} | VIN: ${v.vin||''} | KM: ${v.km||''}</div>
          <div class="small">${v.notes||''}</div>
        </div>
        <button class="ghost" data-index="${idx}" data-role="del-veh">Suppr</button>
      </div>
    `).join('');
    wrap.querySelectorAll('button[data-role="del-veh"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=Number(btn.dataset.index);
        client.vehicles.splice(idx,1);
        renderVehiclesList();
      });
    });
  }
  renderVehiclesList();

  const histWrap=$('clientHistory');
  if(histWrap){
    if(clientInvoices.length===0){
      histWrap.innerHTML='<div class="muted">Aucune facture associ√©e pour ce client pour le moment.</div>';
    }else{
      histWrap.innerHTML=clientInvoices.map(inv=>`
        <div style="border-bottom:1px solid var(--border);padding:4px 0;">
          <div><strong>#${inv.number}</strong> - ${inv.date}</div>
          <div class="small">${inv.job||''}</div>
          <div class="small">Total: ${money(inv.total||0)} $</div>
        </div>
      `).join('');
    }
  }

  if($('clientSaveBtn')){
    $('clientSaveBtn').addEventListener('click',()=>{
      const name=$('clientFormName').value.trim();
      if(!name){alert('Le nom du client est requis.');return;}
      client.name=name;
      client.phone=$('clientFormPhone').value.trim();
      client.email=$('clientFormEmail').value.trim();
      client.address=$('clientFormAddress').value.trim();
      client.notes=$('clientFormNotes').value.trim();
      const idx=CLIENTS.findIndex(c=>String(c.id)===String(client.id));
      if(idx===-1) CLIENTS.push(client);
      else CLIENTS[idx]=client;
      saveClients();
      refreshInvoiceClientSelect();
      renderClientsTable();
      closeClientModal();
    });
  }
  if($('clientAddVehicleBtn')){
    $('clientAddVehicleBtn').addEventListener('click',()=>{
      const make=$('vehMake').value.trim();
      const model=$('vehModel').value.trim();
      const year=$('vehYear').value.trim();
      if(!make && !model){
        alert('Au moins marque ou mod√®le requis pour le v√©hicule.');
        return;
      }
      const v={
        id:Date.now(),
        make,
        model,
        year,
        plate:$('vehPlate').value.trim(),
        vin:$('vehVin').value.trim(),
        km:$('vehKm').value.trim(),
        notes:$('vehNotes').value.trim()
      };
      if(!Array.isArray(client.vehicles)) client.vehicles=[];
      client.vehicles.push(v);
      $('vehMake').value='';
      $('vehModel').value='';
      $('vehYear').value='';
      $('vehPlate').value='';
      $('vehVin').value='';
      $('vehKm').value='';
      $('vehNotes').value='';
      renderVehiclesList();
    });
  }
  if($('clientDeleteBtn') && !isNew){
    $('clientDeleteBtn').addEventListener('click',()=>{
      if(!confirm('Supprimer ce client ?')) return;
      CLIENTS=CLIENTS.filter(c=>String(c.id)!==String(client.id));
      saveClients();
      renderClientsTable();
      closeClientModal();
    });
  }
}

function initClientsModule(){
  loadClients();
  if($('clientSearch')){
    $('clientSearch').addEventListener('input',renderClientsTable);
  }
  if($('btnAddClient')){
    $('btnAddClient').addEventListener('click',()=>openClientModal(null));
  }
  renderClientsTable();
}

/* ===================== INVENTAIRE PI√àCES ===================== */
function renderParts(){
  const wrap=$('partsInventoryList');
  if(!wrap) return;
  wrap.innerHTML='';
  const q=($('partInvSearch')?.value || '').toLowerCase();
  const filterCat=($('partInvFilter')?.value || '');
  PARTS.forEach((p,i)=>{
    const hay = `${p.name||''} ${p.number||''} ${p.category||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(filterCat && p.category && p.category!==filterCat) return;
    const profit = p.price>0 ? ((p.price-p.cost)/p.price*100).toFixed(0) : 0;
    const card=document.createElement('div');
    card.style=`
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      width:260px;
    `;
    card.innerHTML=`
      <h3 style="margin-bottom:10px;color:var(--accent);">${p.name}</h3>
      <div class="small"># Pi√®ce : <b>${p.number||''}</b></div>
      <div class="small">Cat√©gorie : <b>${p.category||'Divers'}</b></div>
      <div class="small">Stock : <b>${p.qty}</b></div>
      <div class="small">Co√ªt : <b>${money(p.cost)} $</b></div>
      <div class="small">Prix : <b>${money(p.price)} $</b></div>
      <div class="small">Marge : <b>${profit}%</b></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="ghost" data-action="edit" data-id="${i}" style="flex:1;">Modifier</button>
        <button class="ghost" data-action="del" data-id="${i}" style="flex:1;">Supprimer</button>
      </div>
      <button class="ghost" data-action="addToInvoice" data-id="${i}" style="margin-top:10px;width:100%;">‚ûï Ajouter √† la facture</button>
    `;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll('button[data-action="del"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.dataset.id);
      if(!confirm('Supprimer cette pi√®ce ?')) return;
      PARTS.splice(id,1);
      saveParts();
      renderParts();
      renderDashboard();
    });
  });
  wrap.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.dataset.id);
      const p=PARTS[id];
      if(!p) return;
      const newName=prompt("Nom de la pi√®ce :",p.name)||p.name;
      const newNumber=prompt("Num√©ro de pi√®ce :",p.number||"")||p.number;
      const newCat=prompt("Cat√©gorie :",p.category||'Divers')||p.category||'Divers';
      const newQty=Number(prompt("Quantit√© :",p.qty)||p.qty);
      const newCost=Number(prompt("Prix co√ªtant :",p.cost)||p.cost);
      const newPrice=Number(prompt("Prix de vente :",p.price)||p.price);
      PARTS[id]={name:newName,number:newNumber,category:newCat,qty:newQty,cost:newCost,price:newPrice};
      saveParts();
      renderParts();
      renderDashboard();
    });
  });
  wrap.querySelectorAll('button[data-action="addToInvoice"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.dataset.id);
      const p=PARTS[id];
      if(!p) return;
      const currentQty=Number(p.qty||0);
      if(currentQty<=0){
        alert("Stock insuffisant pour cette pi√®ce.");
        return;
      }
      p.qty=currentQty-1;
      saveParts();
      renderParts();
      renderDashboard();
      const newItem={
        type:"Pi√®ce (Inventaire)",
        desc:`${p.name} (#${p.number})`,
        qty:1,
        rate:p.price,
        invNumber:p.number
      };
      items.push(newItem);
      renderItems();
    });
  });
}

function initPartsModule(){
  loadParts();
  if($('partInvAddBtn')){
    $('partInvAddBtn').addEventListener('click',()=>{
      const name=$('partInvName').value.trim();
      const number=$('partInvNumber').value.trim();
      const qty=Number($('partInvQty').value)||0;
      const cost=Number($('partInvCost').value)||0;
      const price=Number($('partInvPrice').value)||0;
      const category=$('partInvCategory')?.value || 'Divers';
      if(!name){alert("Nom obligatoire");return;}
      if(qty<0){alert("Quantit√© invalide");return;}
      PARTS.push({name,number,qty,cost,price,category});
      saveParts();
      renderParts();
      renderDashboard();
      $('partInvName').value='';
      $('partInvNumber').value='';
      $('partInvQty').value=1;
      $('partInvCost').value='';
      $('partInvPrice').value='';
    });
  }
  if($('partInvSearch')) $('partInvSearch').addEventListener('input',renderParts);
  if($('partInvFilter')) $('partInvFilter').addEventListener('change',renderParts);
  renderParts();
}

/* ===================== SERVICES ===================== */
function loadServices(){
  try{
    SERVICES = JSON.parse(localStorage.getItem(STORAGE.services) || '[]');
    if(!Array.isArray(SERVICES)) SERVICES=[];
  }catch(e){SERVICES=[];}
}
function saveServices(){
  localStorage.setItem(STORAGE.services, JSON.stringify(SERVICES));
}
const SERVICE_ICONS = {
  "Entretien":"üõ¢Ô∏è",
  "M√©canique g√©n√©rale":"üß∞",
  "Freins":"üõë",
  "Suspension":"ü¶æ",
  "Direction":"üõû",
  "Refroidissement":"‚ùÑÔ∏è",
  "Diagnostic":"üîé",
  "√âlectricit√©":"üîå",
  "Pneus":"üöó",
  "√âchappement":"üî©",
  "Transmission":"‚öôÔ∏è",
  "Moteur":"üöÄ",
  "Divers":"üì¶"
};

function addServiceToInvoice(s){
  let desc=s.name;
  if(s.desc) desc+=" ‚Äî "+s.desc;
  let item;
  if(s.priceFixed>0){
    item={type:"Service",desc,qty:1,rate:s.priceFixed};
  }else if(s.hours>0 && s.rate>0){
    item={type:"Service (horaire)",desc,qty:s.hours,rate:s.rate};
  }else{
    item={type:"Service",desc,qty:1,rate:0};
  }
  items.push(item);
  renderItems();
}

function renderServices(){
  const wrap=$('servicesList');
  if(!wrap) return;
  wrap.innerHTML='';
  if(!SERVICES.length){
    wrap.innerHTML='<div class="muted">Aucun service enregistr√© pour le moment.</div>';
    return;
  }
  SERVICES.forEach(s=>{
    const typeLabel = s.priceFixed>0
      ? `Forfait: ${money(s.priceFixed)} $`
      : (s.hours>0 && s.rate>0
        ? `${s.hours} h x ${money(s.rate)} $/h`
        : `Non d√©fini`);
    const icon = SERVICE_ICONS[s.category] || "‚öôÔ∏è";
    const card=document.createElement('div');
    card.style=`
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      width:260px;
    `;
    card.innerHTML=`
      <h3 style="margin-bottom:6px;color:var(--accent);">${icon} ${s.name}</h3>
      <div class="small">Cat√©gorie : <b>${s.category}</b></div>
      <div class="small">Tarification : <b>${typeLabel}</b></div>
      ${s.desc ? `<div class="small" style="margin-top:6px;">${s.desc}</div>` : ""}
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="ghost" data-action="edit-srv" data-id="${s.id}" style="flex:1;">Modifier</button>
        <button class="ghost" data-action="del-srv" data-id="${s.id}" style="flex:1;">Supprimer</button>
      </div>
      <button class="ghost" data-action="add-to-invoice" data-id="${s.id}" style="margin-top:8px;width:100%;">‚ûï Ajouter √† la facture</button>
    `;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll('button[data-action="del-srv"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      if(!confirm('Supprimer ce service ?')) return;
      SERVICES=SERVICES.filter(s=>String(s.id)!==String(id));
      saveServices();
      renderServices();
    });
  });
  wrap.querySelectorAll('button[data-action="edit-srv"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      const s=SERVICES.find(x=>String(x.id)===String(id));
      if(!s) return;
      const newName=prompt("Nom du service :",s.name)||s.name;
      const newCat=prompt("Cat√©gorie :",s.category)||s.category;
      const newDesc=prompt("Description :",s.desc||"") ?? s.desc;
      const newFixed=Number(prompt("Prix fixe (0 si aucun):",s.priceFixed||0)||s.priceFixed||0);
      const newHours=Number(prompt("Heures (0 si aucun):",s.hours||0)||s.hours||0);
      const newRate=Number(prompt("Taux horaire (0 si aucun):",s.rate||0)||s.rate||0);
      Object.assign(s,{name:newName,category:newCat,desc:newDesc,priceFixed:newFixed,hours:newHours,rate:newRate});
      saveServices();
      renderServices();
    });
  });
  wrap.querySelectorAll('button[data-action="add-to-invoice"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      const s=SERVICES.find(x=>String(x.id)===String(id));
      if(!s) return;
      addServiceToInvoice(s);
      alert("Service ajout√© √† la facture en cours.");
    });
  });
}

function initServicesModule(){
  loadServices();
  renderServices();

  if($('srvAddBtn')){
    $('srvAddBtn').addEventListener('click',()=>{
      const name=$('srvName').value.trim();
      const category=$('srvCategory')?.value || 'Divers';
      const desc=$('srvDesc').value.trim();
      const priceFixed=Number($('srvPriceFixed').value)||0;
      const hours=Number($('srvHours').value)||0;
      const rate=Number($('srvRate').value)||0;
      if(!name){alert("Nom du service requis.");return;}
      if(priceFixed<=0 && (hours<=0 || rate<=0)){
        alert("D√©finir soit un prix fixe, soit heures + taux.");
        return;
      }
      const srv={id:Date.now(),name,category,desc,priceFixed,hours,rate};
      SERVICES.push(srv);
      saveServices();
      renderServices();
      $('srvName').value='';
      $('srvDesc').value='';
      $('srvPriceFixed').value='';
      $('srvHours').value='';
      $('srvRate').value='';
    });
  }

  const modal=$('servicePickerModal');
  const list=$('servicePickerList');
  const btnOpen=$('openServicePicker');
  const btnClose=$('closeServicePicker');
  const filterSelect=$('servicePickerFilter');

  function renderPicker(){
    loadServices();
    if(!SERVICES.length){
      list.innerHTML='<div class="muted">Aucun service enregistr√© pour le moment.</div>';
      return;
    }
    const filter=filterSelect?.value || '';
    const grouped={};
    SERVICES.forEach(s=>{
      if(filter && s.category!==filter) return;
      if(!grouped[s.category]) grouped[s.category]=[];
      grouped[s.category].push(s);
    });
    let html='';
    Object.keys(grouped).sort().forEach(cat=>{
      const icon=SERVICE_ICONS[cat] || "‚öôÔ∏è";
      html+=`
        <h3 style="color:var(--accent);margin-top:15px;">${icon} ${cat}</h3>
        <div style="margin-bottom:10px;border-bottom:1px solid var(--border);"></div>
      `;
      grouped[cat].forEach(s=>{
        const label = s.priceFixed>0
          ? `${s.name} ‚Äî ${money(s.priceFixed)} $`
          : `${s.name} ‚Äî ${s.hours} h √ó ${money(s.rate)} $/h`;
        html+=`
          <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:6px;">
            <div><b>${label}</b></div>
            ${s.desc ? `<div class="small">${s.desc}</div>` : ""}
            <button class="ghost" data-action="pick-service" data-id="${s.id}" style="margin-top:4px;">Ajouter √† la facture</button>
          </div>
        `;
      });
    });
    list.innerHTML=html;
    list.querySelectorAll('button[data-action="pick-service"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.dataset.id;
        const s=SERVICES.find(x=>String(x.id)===String(id));
        if(!s) return;
        addServiceToInvoice(s);
        modal.style.display='none';
      });
    });
  }

  if(btnOpen && modal && list){
    btnOpen.addEventListener('click',()=>{
      renderPicker();
      modal.style.display='flex';
    });
  }
  if(btnClose && modal){
    btnClose.addEventListener('click',()=>modal.style.display='none');
  }
  if(filterSelect){
    filterSelect.addEventListener('change',renderPicker);
  }
}

  /* ===================== PART PICKER ===================== */

const partPickerModal = $("partPickerModal");
const partPickerList = $("partPickerList");
const partPickerFilter = $("partPickerFilter");
const btnOpenPartPicker = $("openPartPicker");
const btnClosePartPicker = $("closePartPicker");

/* Rendu du modal */
function renderPartPicker() {
    loadParts(); // recharge √† jour
    let filter = partPickerFilter?.value || "";
    let html = "";

    let partsToShow = PARTS.filter(p => !filter || p.category === filter);

    if (partsToShow.length === 0) {
        partPickerList.innerHTML = `<div class="muted">Aucune pi√®ce dans cette cat√©gorie.</div>`;
        return;
    }

    partsToShow.forEach(p => {
        html += `
    <div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:6px;">
        <b>${p.name}</b> (#${p.number})<br>
        Cat√©gorie : ${p.category}<br>
        Prix : ${money(p.price)} $<br>
        Stock : ${p.qty}<br>

        <label style="font-size:0.8rem; color:var(--muted);">Quantit√© :</label>
        <input type="number" min="1" max="${p.qty}" value="1"
               id="qty_${p.number}"
               style="width:70px; padding:4px; margin-top:4px; background:#111; color:white; border:1px solid var(--border); border-radius:4px;">

        <button class="ghost" data-number="${p.number}" style="margin-top:6px;">
          ‚ûï Ajouter
        </button>
    </div>
`;

    });

    partPickerList.innerHTML = html;

    // √âv√©nement pour chaque bouton Ajouter
    partPickerList.querySelectorAll("button[data-number]").forEach(btn => {
        btn.onclick = () => {
            const num = btn.dataset.number;
            const part = PARTS.find(x => String(x.number) === String(num));
            if (!part) return;

            // Quantit√© choisie
const qField = $("qty_" + num);
let qtyToAdd = Number(qField?.value || 1);
if (qtyToAdd < 1) qtyToAdd = 1;

// V√©rifie stock
if (part.qty < qtyToAdd) {
    alert("Stock insuffisant. Disponible : " + part.qty);
    return;
}

// D√©cr√©mente le stock
part.qty -= qtyToAdd;
saveParts();
renderParts();
renderDashboard();

// Ajoute dans la facture
items.push({
    type: "Pi√®ce (Inventaire)",
    desc: `${part.name} (#${part.number})`,
    qty: qtyToAdd,
    rate: part.price,
    invNumber: part.number
});

renderItems();
partPickerModal.style.display = "none";
        };
    });
}

/* Ouvrir le PartPicker */
if (btnOpenPartPicker) {
    btnOpenPartPicker.onclick = () => {
        renderPartPicker();
        partPickerModal.style.display = "flex";
    };
}

/* Fermer */
if (btnClosePartPicker) {
    btnClosePartPicker.onclick = () => {
        partPickerModal.style.display = "none";
    };
}

/* Filtre cat√©gorie */
partPickerFilter.onchange = renderPartPicker;

  
/* ===================== HISTORIQUE & DASHBOARD ===================== */
function renderHistoryTable(){
  const tbody = document.querySelector('#historyTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const filterClient = $("filterClient")?.value || "";
const filterVehicle = $("filterVehicle")?.value || "";

INVOICES
  .slice()
  .sort((a, b) => Number(b.number) - Number(a.number))
  .filter(inv => {
      if (filterClient && inv.customer !== filterClient) return false;
      if (filterVehicle) {
    const job = (inv.job || "").toLowerCase();
    const v = filterVehicle.toLowerCase();

    // Essaye de trouver la marque, mod√®le ou ann√©e dans la description du job
    if (!job.includes(v)) {
        // Ex.: "Honda Civic 2014" devrait matcher m√™me si la plaque est diff√©rente
        const parts = v.split(" ").filter(x => x.trim().length > 0);
        let allMatch = true;

        parts.forEach(p => {
            if (!job.includes(p)) allMatch = false;
        });

        if (!allMatch) return false;
    }
}

      return true;
  })
  .forEach(inv => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><button class="ghost" onclick="openInvoiceEditModal(${inv.number})">#${inv.number}</button></td>
        <td>${inv.date}</td>
        <td>${inv.customer || ""}</td>
        <td>${inv.job || ""}</td>
        <td>${money(inv.total || 0)} $</td>
      `;
      tbody.appendChild(tr);
  });
}

  // === Activation des filtres historique ===
if ($("filterClient")) {
  $("filterClient").onchange = () => {
    renderDashboard();     // Met √† jour la liste des v√©hicules selon le client
    renderHistoryTable();  // Rafra√Æchit le tableau
  };
}

if ($("filterVehicle")) {
  $("filterVehicle").onchange = renderHistoryTable;
}


function renderDashboard(){
  const invoicesCount=INVOICES.length;
  const revenue=INVOICES.reduce((s,inv)=>s+Number(inv.total||0),0);
  const clientsCount=CLIENTS.length;
  let vehiclesCount=0;
  CLIENTS.forEach(c=>vehiclesCount+=(c.vehicles||[]).length);
  const partsCount=PARTS.reduce((s,p)=>s+Number(p.qty||0),0);
  const lowStock=PARTS.filter(p=>Number(p.qty||0)<=2).length;
  if($('statInvoices')) $('statInvoices').innerText=invoicesCount;
  if($('statRevenue')) $('statRevenue').innerText=money(revenue)+' $';
  if($('statClients')) $('statClients').innerText=clientsCount;
  if($('statVehicles')) $('statVehicles').innerText=vehiclesCount;
  
    /* ===== 5 DERNI√àRES FACTURES ===== */
if ($("lastInvoicesBox")) {

    const lastFive = [...INVOICES]
        .sort((a, b) => new Date(b.date) - new Date(a.date)) // plus r√©cent ‚Üí plus ancien
        .slice(0, 5);

    $("lastInvoicesBox").innerHTML = "";

    let html = "";

    if (lastFive.length === 0) {
        html = `<span style="color:var(--muted);">Aucune facture enregistr√©e.</span>`;
    } else {
        html += `<div style="display:flex;flex-direction:column;gap:6px;">`;

        // ICI : affichage direct dans l‚Äôordre tri√©
        lastFive.forEach(inv => {
            html += `
                <div 
                    style="padding:6px; border:1px solid var(--border); border-radius:6px; cursor:pointer;"
                    onclick="openFromDashboard('${inv.number}')"
                >
                    <b>#${inv.number}</b> ‚Äî ${money(inv.total)} $
                    <br><span class="muted">${inv.customer || "Client inconnu"}</span>
                </div>
            `;
        });

        html += `</div>`;
    }

    $("lastInvoicesBox").innerHTML = html;
}

    /* === Mettre √† jour les filtres (client & v√©hicule) === */
  if ($("filterClient")) {
      const selClient = $("filterClient");
      const currentClient = selClient.value || "";

      const clients = [...new Set(CLIENTS.map(c => c.name))].sort();
      selClient.innerHTML =
        `<option value="">Tous les clients</option>` +
        clients.map(c => `<option value="${c}">${c}</option>`).join("");

      // On garde la s√©lection si possible
      if (currentClient && clients.includes(currentClient)) {
        selClient.value = currentClient;
      }
  }

  if ($("filterVehicle")) {
      const selVeh = $("filterVehicle");
      const currentVeh = selVeh.value || "";

      // Quel client est s√©lectionn√© dans le filtre ?
      const selectedClientName = $("filterClient")?.value || "";

      let vehicles = [];

      if (selectedClientName) {
          // ‚ûú Seulement les v√©hicules de CE client
          const clientObj = CLIENTS.find(c => c.name === selectedClientName);
          if (clientObj && Array.isArray(clientObj.vehicles)) {
              vehicles = clientObj.vehicles;
          }
      } else {
          // ‚ûú Aucun client filtr√© ‚ûú tous les v√©hicules de tous les clients
          CLIENTS.forEach(c => (c.vehicles || []).forEach(v => vehicles.push(v)));
      }

      const unique = [];
      vehicles.forEach(v => {
          const label = `${v.make || ""} ${v.model || ""} ${v.year || ""}`.trim();
          if (label && !unique.includes(label)) unique.push(label);
      });

      unique.sort();

      selVeh.innerHTML =
        `<option value="">Tous les v√©hicules</option>` +
        unique.map(label => `<option value="${label}">${label}</option>`).join("");

      // Si l'ancien v√©hicule existe encore dans la liste, on le remet
      if (currentVeh && unique.includes(currentVeh)) {
        selVeh.value = currentVeh;
      }
  }
}

  
  function openFromDashboard(number){
    showPage("page-history");
    const row = document.querySelector(`[data-invoice-number="${number}"]`);
    if(row) row.scrollIntoView({behavior:"smooth", block:"center"});
}

/* ===================== EDIT EXISTING INVOICE ===================== */
function openInvoiceEditModal(invoiceNumber){
  const modal=$('invoiceEditModal');
  const content=$('invoiceEditContent');
  if(!modal || !content) return;
  const inv=INVOICES.find(x=>String(x.number)===String(invoiceNumber));
  if(!inv){
    alert("Facture introuvable.");
    return;
  }
  let editItems=JSON.parse(JSON.stringify(inv.items||[]));
  window.editInvoiceObj = inv;
window.editItems = editItems;     // ‚Üê n√©cessaire pour afficher les items modifi√©s

  function renderEditUI(){
    content.innerHTML=`
      <label>Client</label>
      <input id="editInvCustomer" value="${inv.customer||''}" />

      <label>Description / V√©hicule</label>
      <input id="editInvJob" value="${inv.job||''}" />

      <h3>Articles</h3>
      <table style="margin-top:10px;width:100%;">
        <thead>
          <tr>
            <th>Type</th>
            <th>Description</th>
            <th>Qt√©</th>
            <th>Prix</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="editItemsBody"></tbody>
      </table>

      <div style="margin-top:10px;">
  <button id="addEditItemBtn" class="ghost">+ Ajouter un article</button>

  <div id="editItemMenu" 
       style="display:none;background:#333;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px;">
    <button class="ghost" id="editAddInventory">‚ûï Pi√®ce (inventaire)</button>
    <button class="ghost" id="editAddManualPart">‚ûï Pi√®ce manuelle</button>
    <button class="ghost" id="editAddService">üõ†Ô∏è Service enregistr√©</button>
    <button class="ghost" id="editAddLabor">üë®‚Äçüîß Main-d‚Äô≈ìuvre</button>
  </div>
</div>

      <h3 style="margin-top:20px;">Totaux</h3>
      <div>Sous-total : <span id="editSubTotal">0.00</span> $</div>
      <div>TPS : <span id="editGST">0.00</span> $</div>
      <div>TVQ : <span id="editQST">0.00</span> $</div>
      <div style="font-weight:700;">Total : <span id="editTotal">0.00</span> $</div>
    `;
    renderEditItems();
  }

  function renderEditItems(){
    const tbody=$('editItemsBody');
    if(!tbody) return;
    tbody.innerHTML='';
    let sub=0;
    editItems.forEach((it,i)=>{
      const total=it.qty*it.rate;
      sub+=total;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input value="${it.type||''}" data-field="type" data-i="${i}" /></td>
        <td><input value="${it.desc||''}" data-field="desc" data-i="${i}" /></td>
        <td><input type="number" value="${it.qty||0}" data-field="qty" data-i="${i}" /></td>
        <td><input type="number" value="${it.rate||0}" data-field="rate" data-i="${i}" /></td>
        <td>${money(total)}</td>
        <td><button class="ghost" data-del="${i}">X</button></td>
      `;
      tbody.appendChild(tr);
    });
    const gst=sub*(SETTINGS.gst/100);
    const qst=(sub+gst)*(SETTINGS.qst/100);
    const total=sub+gst+qst;
    $('editSubTotal').innerText=money(sub);
    $('editGST').innerText=money(gst);
    $('editQST').innerText=money(qst);
    $('editTotal').innerText=money(total);

    tbody.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const idx=Number(inp.dataset.i);
        const field=inp.dataset.field;
        let val=inp.value;
        if(field==="qty" || field==="rate") val=Number(val);
        editItems[idx][field]=val;
        renderEditItems();
      });
    });
    tbody.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=Number(btn.dataset.del);
        editItems.splice(idx,1);
        renderEditItems();
      });
    });
  }

  document.addEventListener('click',function handler(e){
    if(e.target && e.target.id==="addEditItemBtn"){
      editItems.push({type:"Autre",desc:"Nouvel article",qty:1,rate:0});
      renderEditItems();
    }
  },{once:true});

  $('saveInvoiceEditBtn').onclick=()=>{
    inv.customer=$('editInvCustomer').value.trim();
    inv.job=$('editInvJob').value.trim();
    inv.items=editItems;
    const sub=editItems.reduce((s,it)=>s+it.qty*it.rate,0);
    const gst=sub*(SETTINGS.gst/100);
    const qst=(sub+gst)*(SETTINGS.qst/100);
    inv.subTotal=sub;
    inv.gst=gst;
    inv.qst=qst;
    inv.total=sub+gst+qst;
    saveInvoices();
    alert("Facture mise √† jour!");
    modal.style.display='none';
    renderHistoryTable();
    renderDashboard();
  };

  $('deleteInvoiceBtn').onclick=()=>{
    if(!confirm("Supprimer cette facture ?")) return;
    INVOICES=INVOICES.filter(x=>String(x.number)!==String(inv.number));
    saveInvoices();
    modal.style.display='none';
    renderHistoryTable();
    renderDashboard();
  };

  $('printInvoiceEditBtn').onclick = () => {
  const inv = window.editInvoiceObj;
  if (!inv) {
    alert("Impossible de charger la facture.");
    return;
  }

  const area = $("printArea");
  area.innerHTML = `
    <h2 style="color:black;">Facture #${inv.number}</h2>
    <p><strong>Date :</strong> ${inv.date}</p>
    <p><strong>Client :</strong> ${inv.customer || ""}</p>
    <p><strong>Description :</strong> ${inv.job || ""}</p>

    <h3>Articles</h3>
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
          <th>Qt√©</th>
          <th>Prix</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${editItems.map(it => `
          <tr>
            <td>${it.type}</td>
            <td>${it.desc}</td>
            <td>${it.qty}</td>
            <td>${money(it.rate)} $</td>
            <td>${money(it.qty * it.rate)} $</td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <h3>Totaux</h3>
    <p><strong>Sous-total :</strong> ${money(inv.subTotal)} $</p>
    <p><strong>TPS :</strong> ${money(inv.gst)} $</p>
    <p><strong>TVQ :</strong> ${money(inv.qst)} $</p>
    <p><strong>Total :</strong> ${money(inv.total)} $</p>
  `;

  window.print();
};

$("exportPdfEditBtn").onclick = async () => {
  const inv = window.editInvoiceObj;
  if (!inv) {
    alert("Impossible de charger la facture.");
    return;
  }

  // On cr√©e un conteneur PDF ind√©pendant, sans aucun SVG externe
  const pdfContainer = document.createElement("div");
  pdfContainer.id = "pdfContent";
  pdfContainer.style.padding = "20px";
  pdfContainer.style.fontFamily = "Arial";
  pdfContainer.style.color = "#000";
  pdfContainer.style.background = "#fff";
  pdfContainer.style.width = "800px"; // format A4 largeur

  pdfContainer.innerHTML = `
  <!-- HEADER -->
  <h2 style="color:#FFD000; margin:0; padding:0;">J.L. Garage</h2>
<p style="margin:0 0 10px 0; font-size:13px; color:#000;">T√©l√©phone : 581-309-6481</p>

<hr style="border:0;border-top:2px solid #FFD000;margin:10px 0;">

  <h2 style="color:#000;margin-top:10px;">Facture #${inv.number}</h2>

  <p style="color:#000;"><strong>Date :</strong> ${inv.date}</p>
  <p style="color:#000;"><strong>Client :</strong> ${inv.customer}</p>
  <p style="color:#000;"><strong>Description :</strong> ${inv.job || ""}</p>

  <h3 style="color:#FFD000; margin-top:20px;">Articles</h3>

  <table style="width:100%; border-collapse:collapse; font-size:14px; color:#000;">
    <thead>
      <tr style="color:#000;">
        <th style="border-bottom:2px solid #000;">Type</th>
        <th style="border-bottom:2px solid #000;">Description</th>
        <th style="border-bottom:2px solid #000;">Qt√©</th>
        <th style="border-bottom:2px solid #000;">Prix</th>
        <th style="border-bottom:2px solid #000;">Total</th>
      </tr>
    </thead>

    <tbody>
      ${window.editItems.map(it => `
        <tr style="color:#000;">
          <td>${it.type}</td>
          <td>${it.desc}</td>
          <td>${it.qty}</td>
          <td>${money(it.rate)} $</td>
          <td>${money(it.qty * it.rate)} $</td>
        </tr>
      `).join("")}
    </tbody>
  </table>

  <h3 style="color:#FFD000; margin-top:20px;">Totaux</h3>

  <p style="color:#000;"><strong>Sous-total :</strong> ${money(inv.subTotal)} $</p>
  <p style="color:#000;"><strong>TPS :</strong> ${money(inv.gst)} $</p>
  <p style="color:#000;"><strong>TVQ :</strong> ${money(inv.qst)} $</p>
  <p style="color:#000; font-size:18px;"><strong>Total :</strong> ${money(inv.total)} $</p>

  <hr style="border:0;border-top:1px solid #999;margin:25px 0 10px 0;">

  <!-- FOOTER -->
  <div style="text-align:center;font-size:12px;color:#000;">
    Merci de votre confiance ‚Äî J.L. Garage  
  </div>
`;


  // On ajoute TEMPORAIREMENT ce conteneur √† la page
  document.body.appendChild(pdfContainer);

  // Conversion en canvas
  const canvas = await html2canvas(pdfContainer, {
    scale: 2,
    useCORS: true,
    logging: false,
  });

  // Suppression du conteneur apr√®s capture
  document.body.removeChild(pdfContainer);

  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

  pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
  pdf.save(`facture_${inv.number}.pdf`);
};

  
  $('closeInvoiceEditModal').onclick=()=>{
    modal.style.display='none';
  };

  modal.style.display='flex';
  renderEditUI();
  
  // Ouvrir/fermer le menu
$('addEditItemBtn').onclick = () => {
  const menu = $('editItemMenu');
  menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
};

  $('editAddInventory').onclick = () => {
  if (!PARTS.length) {
    alert("Aucune pi√®ce dans l‚Äôinventaire.");
    return;
  }

  // Choisir la pi√®ce
  let list = "Choisir une pi√®ce :\n\n";
  PARTS.forEach((p, i) => {
    list += `${i+1}) ${p.name} (#${p.number}) ‚Äî ${money(p.price)}$\n`;
  });

  const choice = Number(prompt(list)) - 1;
  if (choice < 0 || choice >= PARTS.length) return;

  const p = PARTS[choice];

  if (p.qty <= 0) return alert("Stock insuffisant.");

  p.qty--;
  saveParts();

  editItems.push({
    type: "Pi√®ce (Inventaire)",
    desc: `${p.name} (#${p.number})`,
    qty: 1,
    rate: p.price,
    invNumber: p.number
  });

  renderEditItems();
  renderDashboard();
};

  $('editAddInventory').onclick = () => {
  if (!PARTS.length) {
    alert("Aucune pi√®ce dans l‚Äôinventaire.");
    return;
  }

  // Choisir la pi√®ce
  let list = "Choisir une pi√®ce :\n\n";
  PARTS.forEach((p, i) => {
    list += `${i+1}) ${p.name} (#${p.number}) ‚Äî ${money(p.price)}$\n`;
  });

  const choice = Number(prompt(list)) - 1;
  if (choice < 0 || choice >= PARTS.length) return;

  const p = PARTS[choice];

  if (p.qty <= 0) return alert("Stock insuffisant.");

  p.qty--;
  saveParts();

  editItems.push({
    type: "Pi√®ce (Inventaire)",
    desc: `${p.name} (#${p.number})`,
    qty: 1,
    rate: p.price,
    invNumber: p.number
  });

  renderEditItems();
  renderDashboard();
};

  $('editAddService').onclick = () => {
  if (!SERVICES.length) {
    alert("Aucun service enregistr√©.");
    return;
  }

  let list = "Choisir un service :\n\n";
  SERVICES.forEach((s, i) => {
    list += `${i+1}) ${s.name} ‚Äî ${s.category}\n`;
  });

  const idx = Number(prompt(list)) - 1;
  if (idx < 0 || idx >= SERVICES.length) return;

  const s = SERVICES[idx];

  let item;
  if (s.priceFixed > 0) {
    item = {type:"Service", desc:s.name, qty:1, rate:s.priceFixed};
  } else {
    item = {type:"Service (horaire)", desc:s.name, qty:s.hours, rate:s.rate};
  }

  editItems.push(item);
  renderEditItems();
};

  $('editAddLabor').onclick = () => {
  const desc = prompt("Description :");
  if (!desc) return;

  const hours = Number(prompt("Heures :", 1));
  const rate = Number(prompt("Taux / h :", 90));

  editItems.push({
    type: "Main-d'≈ìuvre",
    desc,
    qty: hours,
    rate
  });

  renderEditItems();
};

  $('editAddManualPart').onclick = () => {
  const desc = prompt("Nom de la pi√®ce :");
  if (!desc) return;

  const qty = Number(prompt("Quantit√© :", 1));
  if (!qty || qty <= 0) return;

  const price = Number(prompt("Prix unitaire :", 0));
  if (price < 0) return;

  editItems.push({
    type: "Pi√®ce",
    desc,
    qty,
    rate: price
  });

  renderEditItems();
};

}

/* ===================== PRINT SIMPLE ===================== */
if($('btnPrint')){
  $('btnPrint').addEventListener('click',()=>{
    if(!items.length){alert("Aucun article √† imprimer.");return;}
    window.print();
  });
}

/* ===================== BACKUP EXPORT / IMPORT ===================== */
function exportAllData(){
  const data={
    settings:SETTINGS,
    invoices:INVOICES,
    clients:CLIENTS,
    parts:PARTS,
    services:SERVICES
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const date=new Date().toISOString().split("T")[0];
  a.href=url;
  a.download=`garage_backup_${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importAllData(json){
  try{
    if(json.settings) SETTINGS=json.settings;
    if(json.invoices) INVOICES=json.invoices;
    if(json.clients) CLIENTS=json.clients;
    if(json.parts) PARTS=json.parts;
    if(json.services) SERVICES=json.services;
    saveSettings();
    saveInvoices();
    saveClients();
    saveParts();
    saveServices();
    initSettings();
    renderInvoicesTable();
    renderClientsTable();
    renderParts();
    renderServices();
    renderDashboard();
    alert("Backup import√© avec succ√®s !");
  }catch(e){
    alert("Erreur lors de l‚Äôimportation du fichier.");
  }
}

if($("btnExportData")){
  $("btnExportData").addEventListener("click", exportAllData);
}
if($("btnImportData")){
  $("btnImportData").addEventListener("click",()=>{
    $("importBackupFile").click();
  });
}
if($("importBackupFile")){
  $("importBackupFile").addEventListener("change",(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=function(evt){
      try{
        const json=JSON.parse(evt.target.result);
        importAllData(json);
      }catch(err){
        alert("Fichier invalide.");
      }
    };
    reader.readAsText(file);
  });
}

/* ===================== NOTES ===================== */

let NOTES = [];

/* Charger */
function loadNotes() {
    try {
        NOTES = JSON.parse(localStorage.getItem(STORAGE.notes) || '[]');
        if (!Array.isArray(NOTES)) NOTES = [];
    } catch (e) { NOTES = []; }
}

/* Sauver */
function saveNotes() {
    localStorage.setItem(STORAGE.notes, JSON.stringify(NOTES));
}

/* Ajouter note */
function addNote(text, category) {
    const now = new Date();
    const stamp = now.toLocaleString("fr-CA");

    NOTES.push({
        id: Date.now(),
        text,
        category,
        date: stamp
    });

    NOTES.sort((a, b) => b.id - a.id);
    saveNotes();
    renderNotes();
}

/* Modifier */
function updateNote(id, newText) {
    const n = NOTES.find(x => x.id === id);
    if (!n) return;
    n.text = newText;
    saveNotes();
    renderNotes();
}

/* Supprimer */
function deleteNote(id) {
    if (!confirm("Supprimer cette note ?")) return;
    NOTES = NOTES.filter(n => n.id !== id);
    saveNotes();
    renderNotes();
}

/* Rendu Notes */
function renderNotes() {
    const wrap = $("notesList");
    if (!wrap) return;

    const search = ($("noteSearch")?.value || "").toLowerCase();

    let filtered = NOTES.filter(n =>
        n.text.toLowerCase().includes(search) ||
        n.category.toLowerCase().includes(search) ||
        n.date.toLowerCase().includes(search)
    );

  // TRI INTELLIGENT : Urgent ‚Üí √Ä faire ‚Üí G√©n√©ral, puis date
const priority = { urgent: 1, todo: 2, general: 3 };

filtered.sort((a, b) => {
    if (priority[a.category] !== priority[b.category]) {
        return priority[a.category] - priority[b.category];
    }
    return b.id - a.id; // plus r√©cent en premier
});

    if (filtered.length === 0) {
        wrap.innerHTML = `<div class="muted">Aucune note correspondante.</div>`;
        return;
    }

    let html = "";

// GROUPES PAR CAT√âGORIE
const groups = {
    urgent: filtered.filter(n => n.category === "urgent"),
    todo: filtered.filter(n => n.category === "todo"),
    general: filtered.filter(n => n.category === "general")
};

// Fonction pour g√©n√©rer un s√©parateur propre
function categoryHeader(cat, count) {
    const colors = {
        urgent: "#c62828",
        todo: "#f9a825",
        general: "#1565c0"
    };

    const labels = {
        urgent: "üö® Urgent",
        todo: "üìù √Ä faire",
        general: "üìò G√©n√©ral"
    };

    return `
        <h3 style="
            margin-top:20px;
            color:${colors[cat]};
            border-bottom:2px solid ${colors[cat]};
            padding-bottom:4px;
        ">
            ${labels[cat]} (${count})
        </h3>
    `;
}

// Construction du HTML group√©
["urgent", "todo", "general"].forEach(cat => {
    if (groups[cat].length === 0) return;

    html += categoryHeader(cat, groups[cat].length);

    groups[cat].forEach(n => {
        html += `
            <div style="border:1px solid var(--border);padding:10px;border-radius:8px;margin-bottom:8px;">
                
                <div style="font-size:0.8rem;color:var(--muted); display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem;">${n.date}</span>

                    <span style="
                        padding:3px 8px;
                        border-radius:6px;
                        font-size:0.9rem;
                        font-weight:700;
                        color:white;
                        background:${n.category === 'urgent' 
                            ? '#c62828' 
                            : n.category === 'todo' 
                              ? '#f9a825' 
                              : '#1565c0'};
                    ">
                        ${n.category === 'urgent'
                            ? 'üö® Urgent'
                            : n.category === 'todo'
                                ? 'üìù √Ä faire'
                                : 'üìò G√©n√©ral'}
                    </span>
                </div>

                <div id="noteText_${n.id}" style="margin-top:6px;">
                    ${n.text.replace(/\n/g,'<br>')}
                </div>

                <div style="margin-top:8px; display:flex;gap:10px;">
                    <button class="ghost" onclick="editNote(${n.id})">‚úèÔ∏è Modifier</button>
                    <button class="ghost" onclick="deleteNote(${n.id})">üóëÔ∏è Supprimer</button>
                </div>
            </div>
        `;
    });
});

wrap.innerHTML = html;
}

/* Mode √©dition */
function editNote(id) {
    const n = NOTES.find(x => x.id === id);
    if (!n) return;

    const container = $("noteText_" + id);

    container.innerHTML = `
        <textarea id="editNoteInput_${id}" style="width:100%;min-height:80px;">${n.text}</textarea>
        <button class="ghost" onclick="saveEdit(${id})" style="margin-top:6px;">üíæ Sauver</button>
    `;
}

function saveEdit(id) {
    const field = $("editNoteInput_" + id);
    if (!field) return;

    updateNote(id, field.value);
}

/* Export */
function exportNotes() {
    const blob = new Blob([JSON.stringify(NOTES, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "notes_export.json";
    a.click();
}

/* Import */
function importNotes(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) throw "Format invalide";

            NOTES = data;
            saveNotes();
            renderNotes();
            alert("Import compl√©t√© !");
        } catch (err) {
            alert("Erreur : fichier invalide.");
        }
    };

    reader.readAsText(file);
}

/* Initialisation */
function initNotesModule() {
    loadNotes();
    renderNotes();

    if ($("addNoteBtn")) {
        $("addNoteBtn").onclick = () => {
            const text = $("noteInput").value.trim();
            const cat = $("noteCategory").value;
            if (!text) return alert("Entrez une note.");
            addNote(text, cat);
            $("noteInput").value = "";
        };
    }

    if ($("noteSearch")) $("noteSearch").oninput = renderNotes;

    if ($("exportNotesBtn")) $("exportNotesBtn").onclick = exportNotes;

    if ($("importNotesBtn")) {
        $("importNotesBtn").onclick = () => $("importNotesFile").click();
    }

    if ($("importNotesFile")) {
        $("importNotesFile").onchange = importNotes;
    }
}


  /* ===================== LIENS RAPIDES ===================== */

let LINKS = [];

/* Charger */
function loadLinks() {
    try {
        LINKS = JSON.parse(localStorage.getItem("ar_links_v1") || "[]");
        if (!Array.isArray(LINKS)) LINKS = [];
    } catch (e) { LINKS = []; }
}

/* Sauver */
function saveLinks() {
    localStorage.setItem("ar_links_v1", JSON.stringify(LINKS));
}

/* Ajouter lien */
function addLink(name, url, cat, icon) {
    LINKS.push({
        id: Date.now(),
        name,
        url,
        category: cat,
        icon,
        fav: false
    });

    renderLinks();
    saveLinks();
}

/* Supprimer */
function deleteLink(id) {
    if (!confirm("Supprimer ce lien ?")) return;
    LINKS = LINKS.filter(l => l.id !== id);
    saveLinks();
    renderLinks();
}

/* Modifier */
function editLink(id) {
    const link = LINKS.find(l => l.id === id);
    if (!link) return;

    const newName = prompt("Nom :", link.name);
    if (!newName) return;

    const newURL = prompt("URL :", link.url);
    if (!newURL) return;

    const newIcon = prompt("Ic√¥ne :", link.icon);
    if (!newIcon) return;

    link.name = newName;
    link.url = newURL;
    link.icon = newIcon;

    saveLinks();
    renderLinks();
}

/* Favori */
function toggleFav(id) {
    const link = LINKS.find(l => l.id === id);
    if (!link) return;
    link.fav = !link.fav;
    saveLinks();
    renderLinks();
}

/* Rendu */
function renderLinks() {
    const wrap = $("linksList");
    if (!wrap) return;

    const search = ($("linkSearch")?.value || "").toLowerCase();

    // Filtre par recherche
    let filtered = LINKS.filter(l =>
        l.name.toLowerCase().includes(search) ||
        l.url.toLowerCase().includes(search) ||
        l.category.toLowerCase().includes(search)
    );

    // Tri intelligent : favoris en haut
    filtered.sort((a, b) => {
        if (a.fav && !b.fav) return -1;
        if (!a.fav && b.fav) return 1;
        return a.name.localeCompare(b.name);
    });

    wrap.innerHTML = filtered.map(l => `
        <div class="quick-tile">
            <div class="qt-left">
                <div class="qt-icon">${l.icon || "üîó"}</div>
                <div class="qt-info">
                    <div class="qt-name">${l.name}</div>
                    <div class="qt-url">${l.url}</div>
                </div>
            </div>

            <div class="qt-actions">
                <button class="ghost" onclick="window.open('${l.url}','_blank')">üåê</button>
                <button class="ghost" onclick="editLink(${l.id})">‚úèÔ∏è</button>
                <button class="ghost" onclick="deleteLink(${l.id})">üóëÔ∏è</button>
                <button class="ghost" onclick="toggleFav(${l.id})">${l.fav ? "‚≠ê" : "‚òÜ"}</button>
            </div>
        </div>
    `).join("");
}

/* Export */
function exportLinks() {
    const blob = new Blob([JSON.stringify(LINKS, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "liens_rapides_export.json";
    a.click();
}

/* Import */
function importLinks(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) throw "Format invalide";

            LINKS = data;
            saveLinks();
            renderLinks();
            alert("Import compl√©t√© !");
        } catch {
            alert("Erreur : fichier invalide.");
        }
    };

    reader.readAsText(file);
}

function initLinksModule() {
    loadLinks();
    renderLinks();

    $("addLinkBtn").onclick = () => {
        const name = $("linkName").value.trim();
        const url = $("linkURL").value.trim();
        const cat = $("linkCategory").value;
        const icon = $("linkIcon").value.trim() || "üîó";

        if (!name || !url) return alert("Nom et URL obligatoires.");

        addLink(name, url, cat, icon);

        $("linkName").value = "";
        $("linkURL").value = "";
        $("linkIcon").value = "";
    };

    $("linkSearch").oninput = renderLinks;

    $("exportLinksBtn").onclick = exportLinks;
    $("importLinksBtn").onclick = () => $("importLinksFile").click();
    $("importLinksFile").onchange = importLinks;
}

  function woConvertToInvoice(wo) {
  const number = nextInvoiceNumber();

  const invoice = {
    number,
    date: new Date().toLocaleDateString("fr-CA"),
    customer: wo.clientName,
    job: wo.vehicleLabel + " - " + (wo.description || ""),
    items: [],
    subTotal: 0,
    gst: 0,
    qst: 0,
    total: 0
  };

  wo.parts.forEach(p => {
    invoice.items.push({
      type: "Pi√®ce",
      desc: p.name,
      qty: p.qty,
      rate: p.rate
    });
  });

  wo.labor.forEach(l => {
    invoice.items.push({
      type: "Main-d'≈ìuvre",
      desc: l.description,
      qty: l.hours,
      rate: l.rate
    });
  });

  invoice.subTotal = invoice.items.reduce((s,it)=>s+it.qty*it.rate,0);
  invoice.gst = invoice.subTotal * (SETTINGS.gst/100);
  invoice.qst = (invoice.subTotal + invoice.gst) * (SETTINGS.qst/100);
  invoice.total = invoice.subTotal + invoice.gst + invoice.qst;

  INVOICES.push(invoice);
  saveInvoices();

  wo.status = "billed";
  saveWorkOrders();
  renderWorkOrders();

  alert("Facture #" + number + " cr√©√©e !");
  showPage("page-invoice-editor");
    $("btnNewInvoice").onclick = () => {
  resetInvoiceForm();
  showPage("page-invoice-editor");
};

}

  
/* ===================== INIT ALL ===================== */
window.addEventListener('load',()=>{
  initSettings();
  initInvoices();
  initClientsModule();
  initPartsModule();
  initServicesModule();
  initNotesModule();
  initLinksModule();
  initWorkOrdersModule();
  renderDashboard();
});
  
</script>

<!-- MODAL D'√âDITION DE LIGNE -->
<div id="woEditModal" class="modal-backdrop">
  <div class="modal-panel" style="width:400px;">
    <h2>Modifier la ligne</h2>
    <div id="woEditContent"></div>

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px;">
      <button id="woEditCancel" class="ghost">Annuler</button>
      <button id="woEditSave">Enregistrer</button>
    </div>
  </div>
</div>
  
</body>
</html>
