<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier M√©canique J.L ‚Äî Gestion</title>

  <style>
    :root{
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
    }

    body{
      font-family:Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }

    h1,h2,h3{color:var(--accent);margin:0 0 10px}

    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }

    input,select,textarea{
      width:100%;
      padding:8px;
      background:#111;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:6px;
      margin-top:6px;
    }

    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }

    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      color:var(--text);
    }

    th,td{
      padding:8px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }

    th{
      background:#333;
      color:var(--accent);
    }

    /* SIDEBAR */
    #sidebar{
      position:fixed;
      left:0;
      top:0;
      width:200px;
      height:100%;
      background:#111;
      border-right:1px solid var(--border);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:14px;
      z-index:10;
    }

    #sidebar h2{
      color:var(--accent);
      margin-bottom:20px;
      font-size:20px;
    }

    /* HEADER */
    .topbar{
      position:fixed;
      top:0;
      left:200px;
      right:0;
      height:70px;
      background:#1b1b1b;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      z-index:9;
    }

    /* PAGES */
    #appPages{
      margin-left:200px;
      margin-top:70px;
      padding:20px;
    }

    .page{display:none;}
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="#FFD400">
        <path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-.46-.5z" />
      </svg>

      <h1>Garage-Atelier M√©canique J.L ‚Äî Gestion</h1>
    </div>

    <div style="display:flex;gap:10px;">
      <button id="btnSettings">Param√®tres</button>
      <button id="btnExportCSV" class="ghost">Exporter CSV</button>
      <button id="btnPrint">Imprimer</button>
    </div>
  </div>

  <!-- PAGES CONTAINER -->
  <div id="appPages">

    <!-- PAGE FACTURES (visible par d√©faut) -->
    <div class="page" id="page-invoices" style="display:block;">

      <div class="card">
        <h2>Cr√©er Devis / Travail</h2>

        <label>Client</label>
        <input id="customerName" />

        <label>Num√©ro de facture</label>
        <input id="invoiceNumber" disabled />

        <label>Description / V√©hicule</label>
        <input id="jobDesc" />

        <h3>Ajouter une pi√®ce</h3>
        <label>Nom pi√®ce</label>
        <input id="partName" />
        <label>Quantit√©</label>
        <input id="partQty" type="number" value="1" />
        <label>Prix unitaire</label>
        <input id="partPrice" type="number" />
        <button id="addPart">Ajouter pi√®ce</button>

        <h3>Ajouter main-d'≈ìuvre</h3>
        <label>Description</label>
        <input id="laborDesc" />
        <label>Heures</label>
        <input id="laborHours" type="number" />
        <label>Taux / h</label>
        <input id="laborRate" type="number" />
        <button id="addLabor">Ajouter main-d'≈ìuvre</button>

        <h3>Articles</h3>
        <table id="itemsTable"><thead><tr>
          <th>Type</th><th>Description</th><th>Qt√©/hrs</th><th>Prix</th><th>Total</th><th></th>
        </tr></thead><tbody></tbody></table>

        <h3>Total</h3>
        <div>Sous-total: <span id="subTotal">0.00</span> $</div>
        <div>TPS: <span id="gstAmount">0.00</span> $</div>
        <div>TVQ: <span id="qstAmount">0.00</span> $</div>
        <div>Total: <span id="totalAmount">0.00</span> $</div>

        <button id="saveInvoice">Enregistrer facture</button>
        <button id="clearItems" class="ghost">Vider</button>
      </div>

      <div class="card">
        <h2>Factures enregistr√©es</h2>

        <input id="searchInvoices" placeholder="Rechercher..." />
        <select id="filterSort">
          <option value="new">Plus r√©centes</option>
          <option value="old">Plus anciennes</option>
        </select>

        <table id="invoicesTable"><thead><tr>
          <th>#</th><th>Date</th><th>Client</th><th>Job</th><th>Total</th><th></th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div id="printArea" style="display:none"></div>
    </div>

    <!-- PAGE CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Gestion des Clients</h2>
      <input id="clientSearch" placeholder="Rechercher un client..." />
      <button id="btnAddClient">Ajouter client</button>
      <table id="clientsTable"><thead><tr>
        <th>Nom</th><th>T√©l√©phone</th><th>V√©hicules</th><th></th>
      </tr></thead><tbody></tbody></table>
    </div>

    <!-- AUTRES PAGES -->
    <div class="page" id="page-vehicles"><h2>V√©hicules</h2></div>
    <div class="page" id="page-parts"><h2>Inventaire de pi√®ces</h2></div>
    <div class="page" id="page-history"><h2>Historique</h2></div>
    <div class="page" id="page-settings"><h2>Param√®tres</h2></div>

  </div>

<script>
/* ====================================================================
   NAVIGATION ENTRE LES PAGES
==================================================================== */

document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const pg = document.getElementById(btn.dataset.page);
    if(pg) pg.style.display='block';
  });
});

/* ====================================================================
   LOGIQUE DE FACTURATION (INVOICES ENGINE)
==================================================================== */

const STORAGE = {
  invoices:'ar_invoices_v1',
  settings:'ar_settings_v1',
  invoiceCounter:'ar_invoice_counter_v1',
  clients:'ar_clients_v1'
};

let items=[];
const $=id=>document.getElementById(id);
function money(n){return Number(n||0).toFixed(2);}

/* --- Num√©ro de facture --- */
function updateInvoiceNumber(){
  let n = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
  $('invoiceNumber').value = String(n).padStart(5,'0');
}
updateInvoiceNumber();

/* --- Ajouter pi√®ce --- */
$('addPart').addEventListener('click',()=>{
  const name=$('partName').value.trim();
  const qty=Number($('partQty').value)||0;
  const price=Number($('partPrice').value)||0;

  if(!name || qty<=0) return alert("Informations pi√®ce incompl√®tes");

  items.push({type:'Pi√®ce',desc:name,qty,rate:price});
  $('partName').value='';
  $('partPrice').value='';
  $('partQty').value=1;
  renderItems();
});

/* --- Ajouter main-d'≈ìuvre --- */
$('addLabor').addEventListener('click',()=>{
  const desc=$('laborDesc').value.trim();
  const hrs=Number($('laborHours').value)||0;
  const rate=Number($('laborRate').value)||0;

  if(!desc || hrs<=0) return alert("Informations main-d'≈ìuvre incompl√®tes");

  items.push({type:"Main-d'≈ìuvre",desc,qty:hrs,rate});
  $('laborDesc').value='';
  $('laborHours').value='';
  $('laborRate').value='';
  renderItems();
});

/* --- Affichage des items --- */
function renderItems(){
  const tbody=document.querySelector('#itemsTable tbody');
  tbody.innerHTML='';
  let sub=0;

  items.forEach((it,i)=>{
    const total = it.qty * it.rate;
    sub += total;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.type}</td>
      <td>${it.desc}</td>
      <td>${it.qty}</td>
      <td>${money(it.rate)}</td>
      <td>${money(total)}</td>
      <td><button class="ghost" onclick="removeItem(${i})">X</button></td>
    `;
    tbody.appendChild(tr);
  });

  $('subTotal').innerText = money(sub);
  $('gstAmount').innerText = money(sub * 0.05);
  $('qstAmount').innerText = money((sub + sub*0.05) * 0.09975);
  $('totalAmount').innerText = money(sub + (sub*0.05) + ((sub+sub*0.05)*0.09975));
}

function removeItem(i){
  items.splice(i,1);
  renderItems();
}

/* --- Sauvegarder facture --- */
$('saveInvoice').addEventListener('click',()=>{
  const customer=$('customerName').value.trim();
  if(!customer) return alert("Nom du client requis");

  let number = $('invoiceNumber').value;
  let list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');

  list.unshift({
    number,
    date:new Date().toLocaleString(),
    customer,
    job:$('jobDesc').value.trim(),
    items,
    subtotal:Number($('subTotal').innerText),
    gst:Number($('gstAmount').innerText),
    qst:Number($('qstAmount').innerText),
    total:Number($('totalAmount').innerText)
  });

  localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
  localStorage.setItem(STORAGE.invoiceCounter, Number(number));

  items=[];
  renderItems();
  loadInvoices();
  updateInvoiceNumber();

  alert("Facture enregistr√©e !");
});

/* --- Listage factures --- */
function loadInvoices(){
  const list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  const tbody=document.querySelector('#invoicesTable tbody');
  tbody.innerHTML='';

  list.forEach((inv,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.customer}</td>
      <td>${inv.job}</td>
      <td>${money(inv.total)}</td>
      <td><button class="ghost" onclick="deleteInvoice(${i})">Suppr</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function deleteInvoice(i){
  if(!confirm("Supprimer ?")) return;
  let list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  list.splice(i,1);
  localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
  loadInvoices();
}

loadInvoices();
renderItems();

/* ====================================================================
   CLIENTS
==================================================================== */

function loadClients(){
  const list = JSON.parse(localStorage.getItem(STORAGE.clients)||'[]');
  const tbody=document.querySelector('#clientsTable tbody');
  tbody.innerHTML='';

  list.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${c.name}</td>
      <td>${c.phone||''}</td>
      <td>${(c.vehicles||[]).join(", ")}</td>
      <td><button class="ghost" onclick="viewClient(${i})">Fiche</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function viewClient(i){
  const list = JSON.parse(localStorage.getItem(STORAGE.clients)||'[]');
  const c = list[i];
  $('clientModalContent').innerHTML = `
    <label>Nom</label>
    <input id="cm_name" value="${c.name}">
    <label>T√©l√©phone</label>
    <input id="cm_phone" value="${c.phone||''}">
    <h3>V√©hicules</h3>
    <ul>${c.vehicles.map(v=>`<li>${v}</li>`).join("")}</ul>
  `;
  document.getElementById('clientModal').style.display='flex';
}

document.getElementById('closeClientModal').onclick=()=>{
  document.getElementById('clientModal').style.display='none';
};

loadClients();

</script>

</body>
</html>
