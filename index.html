<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier M√©canique J.L ‚Äî Gestion</title>

  <style>
    :root{
      --sidebar-width:200px;
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
    }

    body{
      font-family:Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }

    h1,h2,h3{color:var(--accent);margin:0 0 10px;}
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }

    input,select,textarea{
      width:100%;
      padding:8px;
      background:#111;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:6px;
      margin-top:6px;
    }

    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }

    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      color:var(--text);
    }

    th,td{
      padding:8px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }

    th{background:#333;color:var(--accent);}

    /* Sidebar */
    #sidebar{
      position:fixed;
      left:0;
      top:0;
      width:var(--sidebar-width);
      height:100%;
      background:#111;
      border-right:1px solid var(--border);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:14px;
      z-index:10;
    }

    #sidebar h2{
      color:var(--accent);
      margin-bottom:20px;
      font-size:20px;
    }

    /* Header */
    .topbar{
      position:fixed;
      top:0;
      left:var(--sidebar-width);
      right:0;
      height:70px;
      background:#1b1b1b;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      z-index:9;
    }

    /* Page Wrapper */
    #appPages{
      margin-left:var(--sidebar-width);
      margin-top:70px;
      padding:20px;
    }

    .page{display:none;}
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
<button class="navBtn" data-page="page-clients">üë§ Clients</button>
<button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
<button class="navBtn" data-page="page-services">üõ†Ô∏è Services</button>
<button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
<button class="navBtn" data-page="page-history">üìú Historique</button>
<button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="#FFD400">
        <path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-.46-.5z"/>
      </svg>

      <h1>Garage-Atelier M√©canique J.L ‚Äî Gestion</h1>
    </div>

    <div style="display:flex;gap:10px;">
      <button id="btnSettings">Param√®tres</button>
      <button id="btnExportCSV" class="ghost">Exporter CSV</button>
      <button id="btnPrint">Imprimer</button>
    </div>
  </div>

  <!-- PAGE CONTAINER -->
  <div id="appPages">

    <!-- FACTURES -->
    <div class="page" id="page-invoices" style="display:block;">
      <div class="card">
        <h2>Cr√©er Devis / Travail</h2>

        <label>Client</label>
        <input id="customerName" />

        <label>Num√©ro de facture</label>
        <input id="invoiceNumber" disabled />

        <label>Description / V√©hicule</label>
        <input id="jobDesc" />

        <h3>Ajouter une pi√®ce</h3>
        <label>Nom pi√®ce</label>
        <input id="partName" />
        <label>Quantit√©</label>
        <input id="partQty" type="number" value="1" />
        <label>Prix unitaire</label>
        <input id="partPrice" type="number" />
        <button id="addPart">Ajouter pi√®ce</button>

        <h3>Ajouter main-d'≈ìuvre</h3>
        <label>Description</label>
        <input id="laborDesc" />
        <label>Heures</label>
        <input id="laborHours" type="number" />
        <label>Taux / h</label>
        <input id="laborRate" type="number" />
        <button id="addLabor">Ajouter main-d'≈ìuvre</button>

<button id="openServicePicker" class="ghost" style="margin-top:8px;">
  ‚ûï Ajouter un service enregistr√©
</button>
        
        <h3>Articles</h3>
        <table id="itemsTable">
          <thead><tr>
            <th>Type</th><th>Description</th><th>Qt√©/hrs</th><th>Prix</th><th>Total</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>

        <h3>Total</h3>
        <div>Sous-total: <span id="subTotal">0.00</span> $</div>
        <div>TPS: <span id="gstAmount">0.00</span> $</div>
        <div>TVQ: <span id="qstAmount">0.00</span> $</div>
        <div>Total: <span id="totalAmount">0.00</span> $</div>

        <button id="saveInvoice">Enregistrer facture</button>
        <button id="clearItems" class="ghost">Vider</button>
      </div>

      <div class="card">
        <h2>Factures enregistr√©es</h2>
        <input id="searchInvoices" placeholder="Rechercher..." />
        <select id="filterSort">
          <option value="new">Plus r√©centes</option>
          <option value="old">Plus anciennes</option>
        </select>

        <table id="invoicesTable">
          <thead><tr>
            <th>#</th><th>Date</th><th>Client</th><th>Job</th><th>Total</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="printArea" style="display:none"></div>
    </div>

    <!-- CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Gestion des Clients</h2>

      <div style="display:flex;gap:10px;margin-bottom:15px;align-items:center;">
        <input id="clientSearch" placeholder="Rechercher un client..." />
        <button id="btnAddClient">Ajouter client</button>
      </div>

      <table id="clientsTable">
        <thead><tr>
          <th>Nom</th>
          <th>T√©l√©phone</th>
          <th>Email</th>
          <th>Adresse</th>
          <th>V√©hicules</th>
          <th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- V√âHICULES -->
    <div class="page" id="page-vehicles">
      <h2>Gestion des V√©hicules</h2>

      <input id="vehicleSearch" placeholder="Recherche : plaque, VIN, client..." />

      <table id="vehiclesTable">
        <thead><tr>
          <th>Client</th>
          <th>V√©hicule</th>
          <th>Plaque</th>
          <th>VIN</th>
          <th>KM</th>
          <th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SERVICES -->
<div class="page" id="page-services">
  <h2>Services / R√©parations</h2>

  <div class="card">
    <h3>Ajouter un service</h3>

    <label>Nom du service</label>
    <input id="srvName" />

    <label>Cat√©gorie</label>
    <select id="srvCategory">
      <option value="Entretien">Entretien</option>
      <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
      <option value="Freins">Freins</option>
      <option value="Suspension">Suspension</option>
      <option value="Direction">Direction</option>
      <option value="Refroidissement">Refroidissement</option>
      <option value="Diagnostic">Diagnostic</option>
      <option value="√âlectricit√©">√âlectricit√©</option>
      <option value="Pneus">Pneus</option>
      <option value="√âchappement">√âchappement</option>
      <option value="Transmission">Transmission</option>
      <option value="Moteur">Moteur</option>
      <option value="Divers">Divers</option>
    </select>

    <label>Description (optionnel)</label>
    <textarea id="srvDesc"></textarea>

    <h4>Prix fixe (forfait)</h4>
    <input id="srvPriceFixed" type="number" step="0.01" placeholder="Ex: 89.95" />

    <h4>OU Temps et taux horaire</h4>
    <label>Heures</label>
    <input id="srvHours" type="number" step="0.1" placeholder="Ex: 1.5" />
    <label>Taux horaire ($ / h)</label>
    <input id="srvRate" type="number" step="0.01" placeholder="Ex: 95" />

    <button id="srvAddBtn">Ajouter le service</button>
  </div>

  <h3>Services enregistr√©s</h3>
  <div id="servicesList" style="display:flex;flex-wrap:wrap;gap:15px;"></div>
</div>

    <!-- Pi√®ces -->
<div class="page" id="page-parts">
  <h2>Inventaire des pi√®ces</h2>

  <div class="card">
    <h3>Ajouter une pi√®ce</h3>

    <label>Nom de la pi√®ce</label>
    <input id="partInvName" />

    <label>Num√©ro de pi√®ce</label>
    <input id="partInvNumber" />

    <label>Cat√©gorie</label>
    <select id="partInvCategory">
      <option value="Moteur">Moteur</option>
      <option value="Transmission">Transmission</option>
      <option value="Suspension">Suspension</option>
      <option value="Direction">Direction</option>
      <option value="Freins">Freins</option>
      <option value="√âchappement">√âchappement</option>
      <option value="√âlectrique">√âlectrique</option>
      <option value="Tuning">Tuning</option>
      <option value="Fabrication">Fabrication</option>
      <option value="Hybride">Hybride</option>
      <option value="Carrosserie">Carrosserie</option>
      <option value="Pneus">Pneus</option>
      <option value="Divers">Divers</option>
    </select>

    <label>Quantit√© en stock</label>
    <input id="partInvQty" type="number" value="1" />

    <label>Prix co√ªtant ($)</label>
    <input id="partInvCost" type="number" step="0.01" />

    <label>Prix de vente ($)</label>
    <input id="partInvPrice" type="number" step="0.01" />

    <button id="partInvAddBtn">Ajouter dans l‚Äôinventaire</button>
  </div>

  <select id="partInvFilter" style="margin-bottom:10px;">
    <option value="">Toutes cat√©gories</option>
    <option value="Moteur">Moteur</option>
    <option value="Transmission">Transmission</option>
    <option value="Suspension">Suspension</option>
    <option value="Direction">Direction</option>
    <option value="Freins">Freins</option>
    <option value="√âchappement">√âchappement</option>
    <option value="√âlectrique">√âlectrique</option>
    <option value="Tuning">Tuning</option>
    <option value="Fabrication">Fabrication</option>
    <option value="Hybride">Hybride</option>
    <option value="Carrosserie">Carrosserie</option>
    <option value="Pneus">Pneus</option>
    <option value="Divers">Divers</option>
  </select>

  <input id="partInvSearch" placeholder="Rechercher une pi√®ce (nom ou num√©ro)..." style="margin-bottom:15px;" />

  <div id="partsInventoryList" style="display:flex;flex-wrap:wrap;gap:15px;"></div>
</div>
    
    <div class="page" id="page-history"></div>
    <div class="page" id="page-settings"></div>
  </div>

  <!-- MODAL CLIENT -->
  <div id="clientModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:var(--card); width:750px; max-width:95%; padding:20px; border-radius:12px; border:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,0.6); max-height:90vh; overflow-y:auto;">
      <h2>Fiche Client</h2>
      <div id="clientModalContent">Chargement...</div>
      <div style="text-align:right; margin-top:15px;"><button id="closeClientModal" class="ghost">Fermer</button></div>
    </div>
  </div>
  
  <!-- MODAL CHOIX SERVICE -->
<div id="servicePickerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:var(--card); width:700px; max-width:95%; padding:20px; border-radius:12px; border:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,0.6); max-height:90vh; overflow-y:auto;">
<h2>Choisir un service</h2>

<label style="margin-top:10px;">Filtrer par cat√©gorie :</label>
<select id="servicePickerFilter" style="margin-bottom:15px;">
  <option value="">Toutes les cat√©gories</option>
  <option value="Entretien">Entretien</option>
  <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
  <option value="Freins">Freins</option>
  <option value="Suspension">Suspension</option>
  <option value="Direction">Direction</option>
  <option value="Refroidissement">Refroidissement</option>
  <option value="Diagnostic">Diagnostic</option>
  <option value="√âlectricit√©">√âlectricit√©</option>
  <option value="Pneus">Pneus</option>
  <option value="√âchappement">√âchappement</option>
  <option value="Transmission">Transmission</option>
  <option value="Moteur">Moteur</option>
  <option value="Divers">Divers</option>
</select>

<div id="servicePickerList">Chargement...</div>

    <div style="text-align:right; margin-top:15px;">
      <button id="closeServicePicker" class="ghost">Fermer</button>
    </div>
  </div>
</div>


<script>
/* ===================== NAVIGATION ===================== */

document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const pg = document.getElementById(btn.dataset.page);
    if(pg) pg.style.display='block';
  });
});


/* ===================== INVOICES ENGINE ===================== */

const STORAGE = {
  invoices:'ar_invoices_v1',
  settings:'ar_settings_v1',
  invoiceCounter:'ar_invoice_counter_v1',
  clients:'ar_clients_v1'
};

let items = [];
const $ = id => document.getElementById(id);

function money(n){return Number(n||0).toFixed(2);}

  /* ===================== INVOICE NUMBER ===================== */

function updateInvoiceNumber(){
  let n = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
  $('invoiceNumber').value = String(n).padStart(5,'0');
}
updateInvoiceNumber();

/* ===================== ADD ITEMS ===================== */

$('addPart').addEventListener('click',()=>{
  const name=$('partName').value.trim();
  const qty=Number($('partQty').value)||0;
  const price=Number($('partPrice').value)||0;
  if(!name || qty<=0) return alert("Informations pi√®ce incompl√®tes");

  const newItem = {type:'Pi√®ce',desc:name,qty,rate:price};

  // Tente de lier √† une pi√®ce d'inventaire si le # de pi√®ce est dans la description
  const linkedOk = linkNewItemToInventory(newItem);
  if(linkedOk === false) return; // stock insuffisant, on annule

  items.push(newItem);
  $('partName').value='';
  $('partPrice').value='';
  $('partQty').value=1;
  renderItems();
});

$('addLabor').addEventListener('click',()=>{
  const desc=$('laborDesc').value.trim();
  const hrs=Number($('laborHours').value)||0;
  const rate=Number($('laborRate').value)||0;
  if(!desc || hrs<=0) return alert("Informations main-d'≈ìuvre incompl√®tes");

  items.push({type:"Main-d'≈ìuvre",desc,qty:hrs,rate});
  $('laborDesc').value='';
  $('laborHours').value='';
  $('laborRate').value='';
  renderItems();
});

/* ===================== RENDER ITEMS ===================== */
function renderItems(){
  const tbody=document.querySelector('#itemsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  let sub=0;

  items.forEach((it,i)=>{
    const total = it.qty * it.rate;
    sub += total;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.type}</td>
      <td>${it.desc}</td>
      <td>${it.qty}</td>
      <td>${money(it.rate)}</td>
      <td>${money(total)}</td>
      <td><button class="ghost" onclick="removeItem(${i})">X</button></td>
    `;
    tbody.appendChild(tr);
  });

  $('subTotal').innerText = money(sub);
  $('gstAmount').innerText = money(sub * 0.05);
  $('qstAmount').innerText = money((sub + sub*0.05) * 0.09975);
  $('totalAmount').innerText = money(sub + (sub*0.05) + ((sub+sub*0.05)*0.09975));
}


/* ===================== REMOVE ITEM ===================== */
function removeItem(i){
  const item = items[i];

  // restaurer le stock si l‚Äôitem est li√© √† l‚Äôinventaire
  if(item && item.invNumber){
    const qty = Number(item.qty)||1;
    adjustStockForLinkedItem(item, qty);
  }

  items.splice(i,1);
  renderItems();
}


/* ===================== CLEAR ALL ITEMS ===================== */
if($('clearItems')){
  $('clearItems').addEventListener('click',()=>{
    if(!items.length) return;

    if(!confirm("Vider tous les articles de la facture ?")) return;

    // Restaurer le stock pour tous les items li√©s
    items.forEach(it=>{
      if(it.invNumber){
        const qty = Number(it.qty)||1;
        adjustStockForLinkedItem(it, qty);
      }
    });

    // Vider la facture
    items = [];
    renderItems();
  });
}


/* ===================== SAVE INVOICE ===================== */

$('saveInvoice').addEventListener('click',()=>{
  const customer=$('customerName').value.trim();
  if(!customer) return alert("Nom du client requis");

  let number = $('invoiceNumber').value;
  let list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');

  list.unshift({
    number,
    date:new Date().toLocaleString(),
    customer,
    job:$('jobDesc').value.trim(),
    items,
    subtotal:Number($('subTotal').innerText),
    gst:Number($('gstAmount').innerText),
    qst:Number($('qstAmount').innerText),
    total:Number($('totalAmount').innerText)
  });

  localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
  localStorage.setItem(STORAGE.invoiceCounter, Number(number));

  items=[];
  renderItems();
  loadInvoices();
  updateInvoiceNumber();

  alert("Facture enregistr√©e !");
});

/* ===================== LOAD INVOICES ===================== */

function loadInvoices(){
  const list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  const tbody=document.querySelector('#invoicesTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  list.forEach((inv,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.customer}</td>
      <td>${inv.job}</td>
      <td>${money(inv.total)}</td>
      <td><button class="ghost" onclick="deleteInvoice(${i})">Suppr</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function deleteInvoice(i){
  if(!confirm("Supprimer ?")) return;
  let list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  list.splice(i,1);
  localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
  loadInvoices();
}

loadInvoices();
renderItems();

/* ====================================================================
   CLIENTS (MODULE COMPLET)
==================================================================== */

let CLIENTS = [];

function loadClientsFromStorage(){
  try{
    CLIENTS = JSON.parse(localStorage.getItem(STORAGE.clients) || '[]');
    if(!Array.isArray(CLIENTS)) CLIENTS = [];
  }catch(e){
    CLIENTS = [];
  }
}

function saveClientsToStorage(){
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
}

function renderClientsTable(){
  const tbody = document.querySelector('#clientsTable tbody');
  if(!tbody) return;
  const qEl = $('clientSearch');
  const q = qEl ? qEl.value.trim().toLowerCase() : '';
  tbody.innerHTML = '';

  CLIENTS.forEach(client => {
    const haystack = `${client.name||''} ${client.phone||''} ${client.email||''} ${client.address||''}`.toLowerCase();
    if(q && !haystack.includes(q)) return;

    const vehicleCount = Array.isArray(client.vehicles) ? client.vehicles.length : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${client.name||''}</td>
      <td>${client.phone||''}</td>
      <td>${client.email||''}</td>
      <td>${client.address||''}</td>
      <td>${vehicleCount}</td>
      <td>
        <button class="ghost" data-action="open-client" data-id="${client.id}">Fiche</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-action="open-client"]').forEach(btn => {
    btn.addEventListener('click', () => {
      openClientModal(btn.dataset.id);
    });
  });
}

function findClientById(id){
  return CLIENTS.find(c => String(c.id) === String(id));
}

function openClientModal(id){
  const modal = $('clientModal');
  modal.style.display = 'flex';
  renderClientModal(id);
}

function closeClientModal(){
  $('clientModal').style.display = 'none';
}

function renderClientModal(id){
  loadClientsFromStorage();
  const content = $('clientModalContent');

  const isNew = !id;
  let client = isNew ? {
    id: Date.now(),
    name:'',
    phone:'',
    email:'',
    address:'',
    notes:'',
    vehicles:[]
  } : findClientById(id);

  if(!client){
    alert("Client introuvable");
    return closeClientModal();
  }

  const invoices = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  const clientInvoices = invoices.filter(inv => (inv.customer||'').toLowerCase() === (client.name||'').toLowerCase());

  content.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:14px;">
      <h3 style="color:var(--accent);">Informations client</h3>

      <label>Nom</label>
      <input id="clientFormName" value="${client.name||''}" />

      <label>T√©l√©phone</label>
      <input id="clientFormPhone" value="${client.phone||''}" />

      <label>Email</label>
      <input id="clientFormEmail" value="${client.email||''}" />

      <label>Adresse</label>
      <input id="clientFormAddress" value="${client.address||''}" />

      <label>Notes</label>
      <textarea id="clientFormNotes">${client.notes||''}</textarea>

      <h3 style="color:var(--accent);">V√©hicules</h3>
      <div id="clientVehiclesList"></div>

      <label>Marque</label><input id="vehMake">
      <label>Mod√®le</label><input id="vehModel">
      <label>Ann√©e</label><input id="vehYear">
      <label>Plaque</label><input id="vehPlate">
      <label>VIN</label><input id="vehVin">
      <label>KM</label><input id="vehKm" type="number">
      <label>Notes v√©hicule</label><textarea id="vehNotes"></textarea>

      <button id="clientAddVehicleBtn">Ajouter v√©hicule</button>

      <h3 style="color:var(--accent);">Historique</h3>
      <div id="clientHistory"></div>

      <div style="display:flex;justify-content:flex-end;gap:10px;">
        ${isNew ? "" : `<button id="clientDeleteBtn" class="ghost">Supprimer</button>`}
        <button id="clientSaveBtn">Enregistrer</button>
      </div>
    </div>
  `;

  function renderVehicles(){
    const wrap=$('clientVehiclesList');
    if(!client.vehicles || client.vehicles.length===0){
      wrap.innerHTML = '<div class="muted">Aucun v√©hicule.</div>';
      return;
    }
    wrap.innerHTML = client.vehicles.map((v,i)=>`
      <div style="border:1px solid var(--border);padding:6px;margin-bottom:4px;border-radius:6px;">
        <div><b>${v.make} ${v.model} ${v.year}</b></div>
        <div class="small">Plaque: ${v.plate} | VIN: ${v.vin} | KM: ${v.km}</div>
        <button class="ghost" data-index="${i}" data-role="delete-veh">Supprimer</button>
      </div>
    `).join('');

    wrap.querySelectorAll('[data-role="delete-veh"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        client.vehicles.splice(Number(btn.dataset.index),1);
        renderVehicles();
      });
    });
  }

  renderVehicles();

  /* Historique */
  const hist=$('clientHistory');
  if(clientInvoices.length===0){
    hist.innerHTML='<div class="muted">Aucune facture.</div>';
  } else {
    hist.innerHTML = clientInvoices.map(inv=>`
      <div style="border-bottom:1px solid var(--border);padding:4px 0;">
        <b>#${inv.number}</b> ‚Äî ${inv.date} ‚Äî ${inv.total}$<br>
        <span class="small">${inv.job}</span>
      </div>
    `).join('');
  }

  /* Save */
  $('clientSaveBtn').addEventListener('click',()=>{
    client.name=$('clientFormName').value.trim();
    if(!client.name) return alert("Nom requis");
    client.phone=$('clientFormPhone').value.trim();
    client.email=$('clientFormEmail').value.trim();
    client.address=$('clientFormAddress').value.trim();
    client.notes=$('clientFormNotes').value.trim();

    const idx=CLIENTS.findIndex(c=>String(c.id)===String(client.id));
    if(idx===-1) CLIENTS.push(client);
    else CLIENTS[idx]=client;

    saveClientsToStorage();
    renderClientsTable();
    loadVehicles();
    closeClientModal();
  });

  /* Add vehicle */
  $('clientAddVehicleBtn').addEventListener('click',()=>{
    const v={
      id:Date.now(),
      make:$('vehMake').value.trim(),
      model:$('vehModel').value.trim(),
      year:$('vehYear').value.trim(),
      plate:$('vehPlate').value.trim(),
      vin:$('vehVin').value.trim(),
      km:$('vehKm').value.trim(),
      notes:$('vehNotes').value.trim()
    };
    if(!v.make && !v.model) return alert("Marque ou mod√®le requis.");

    client.vehicles.push(v);
    renderVehicles();
  });

  /* Delete client */
  const btnDelete = $('clientDeleteBtn');
  if(btnDelete){
    btnDelete.addEventListener('click',()=>{
      if(!confirm("Supprimer ce client ?")) return;
      CLIENTS = CLIENTS.filter(c=>String(c.id)!==String(client.id));
      saveClientsToStorage();
      renderClientsTable();
      loadVehicles();
      closeClientModal();
    });
  }
}

/* Init Clients */
function initClients(){
  loadClientsFromStorage();
  if($('clientSearch'))
    $('clientSearch').addEventListener('input', renderClientsTable);
  if($('btnAddClient'))
    $('btnAddClient').addEventListener('click',()=>openClientModal(null));
  if($('closeClientModal'))
    $('closeClientModal').addEventListener('click',closeClientModal);

  renderClientsTable();
}
initClients();

/* ====================================================================
   VEHICLES PAGE (AUTO-SYNC)
==================================================================== */

function loadVehicles(){
  const tbody=document.querySelector('#vehiclesTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  const q = ($('vehicleSearch')?.value||'').toLowerCase();

  CLIENTS.forEach(client=>{
    (client.vehicles||[]).forEach(v=>{
      const hay=`${client.name} ${v.make} ${v.model} ${v.year} ${v.plate} ${v.vin}`.toLowerCase();
      if(q && !hay.includes(q)) return;

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${client.name}</td>
        <td>${v.make||''} ${v.model||''} ${v.year||''}</td>
        <td>${v.plate||''}</td>
        <td>${v.vin||''}</td>
        <td>${v.km||''}</td>
        <td><button class="ghost" onclick="openClientModal(${client.id})">Fiche client</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}

if($('vehicleSearch'))
  $('vehicleSearch').addEventListener('input',loadVehicles);

/* Sync vehicles after clients saved */
const _saveClients = saveClientsToStorage;
saveClientsToStorage = function(){
  _saveClients();
  loadClientsFromStorage();
  loadVehicles();
};

loadVehicles();

  /* ====================================================================
   LIEN FACTURE <-> INVENTAIRE
==================================================================== */

// Trouve une pi√®ce d'inventaire √† partir d'un texte (description) qui contient le # de pi√®ce
function findInventoryPartFromText(text){
  text = (text || "").toLowerCase();
  for(let i=0; i<PARTS.length; i++){
    const num = String(PARTS[i].number || "").toLowerCase();
    if(num && text.includes(num)){ // Option 2 : match si le num√©ro appara√Æt n'importe o√π
      return PARTS[i];
    }
  }
  return null;
}

// D√©duire ou restaurer le stock pour un item li√©
function adjustStockForLinkedItem(item, deltaQty){
  if(!item || !item.invNumber) return;
  const num = String(item.invNumber);
  const part = PARTS.find(p => String(p.number) === num);
  if(!part) return;

  const current = Number(part.qty || 0);
  part.qty = current + deltaQty;
  if(part.qty < 0) part.qty = 0;

  saveParts();
  renderParts();
}

// Lorsqu'on cr√©e un nouvel item de facture, essayer de le lier √† une pi√®ce d'inventaire
function linkNewItemToInventory(item){
  // On ne lie que les items de type "Pi√®ce" pour √©viter les faux positifs sur la main-d'≈ìuvre
  if(!item || !item.desc || !item.type || !item.type.toLowerCase().includes('pi√®ce')) return;

  const part = findInventoryPartFromText(item.desc);
  if(!part) return; // aucune pi√®ce correspondante, on ne fait rien

  const qty = Number(item.qty)||1;
  const currentQty = Number(part.qty || 0);

  if(currentQty < qty){
    alert("Stock insuffisant pour cette pi√®ce en inventaire.");
    return false; // on annule la cr√©ation
  }

  part.qty = currentQty - qty;
  item.invNumber = part.number; // on marque l'item comme li√© √† cette pi√®ce
  saveParts();
  renderParts();
  return true;
}
  
/* ====================================================================
   INVENTAIRE DES PI√àCES ‚Äî CARTES VISUELLES
==================================================================== */

let PARTS = [];

function loadParts(){
  try{
    PARTS = JSON.parse(localStorage.getItem("ar_parts_inventory") || "[]");
    if(!Array.isArray(PARTS)) PARTS = [];
  }catch(e){
    PARTS = [];
  }
}

function saveParts(){
  localStorage.setItem("ar_parts_inventory", JSON.stringify(PARTS));
}

function renderParts(){
  const wrap = $("partsInventoryList");
  if(!wrap) return;
  wrap.innerHTML = "";

  const q = ($("partInvSearch")?.value || "").toLowerCase();
  const filterCat = ($("partInvFilter")?.value || "");

  PARTS.forEach((p,i)=>{
    const hay = `${p.name||""} ${p.number||""} ${p.category||""}`.toLowerCase(); // recherche avanc√©e
    if(q && !hay.includes(q)) return;
    if(filterCat && p.category && p.category !== filterCat) return;

    const profit = p.price > 0 ? ((p.price - p.cost) / p.price * 100).toFixed(0) : 0;

    const card = document.createElement("div");
    card.style = `
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      width:260px;
    `;

    card.innerHTML = `
      <h3 style="margin-bottom:10px;color:var(--accent);">${p.name}</h3>
      <div class="small"># Pi√®ce : <b>${p.number||""}</b></div>
      <div class="small">Cat√©gorie : <b>${p.category||"Divers"}</b></div>
      <div class="small">Stock : <b>${p.qty}</b></div>
      <div class="small">Co√ªt : <b>${p.cost.toFixed(2)} $</b></div>
      <div class="small">Prix : <b>${p.price.toFixed(2)} $</b></div>
      <div class="small">Marge : <b>${profit}%</b></div>

      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="ghost" data-action="edit" data-id="${i}" style="flex:1;">Modifier</button>
        <button class="ghost" data-action="del" data-id="${i}" style="flex:1;">Supprimer</button>
      </div>

      <button class="ghost" data-action="addToInvoice" data-id="${i}" style="margin-top:10px;width:100%;">
        ‚ûï Ajouter √† la facture
      </button>
    `;

    wrap.appendChild(card);
  });

  /* Supprimer une pi√®ce */
  wrap.querySelectorAll("button[data-action='del']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = Number(btn.dataset.id);
      if(confirm("Supprimer cette pi√®ce ?")){
        PARTS.splice(id,1);
        saveParts();
        renderParts();
      }
    });
  });

  /* Modifier une pi√®ce */
  wrap.querySelectorAll("button[data-action='edit']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = Number(btn.dataset.id);
      editPart(id);
    });
  });

  /* Ajouter une pi√®ce √† la facture + d√©duction stock */
  wrap.querySelectorAll("button[data-action='addToInvoice']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = Number(btn.dataset.id);
      const p = PARTS[id];
      if(!p) return;

      const currentQty = Number(p.qty||0);
      if(currentQty <= 0){
        alert("Stock insuffisant pour cette pi√®ce.");
        return;
      }

      // d√©duire 1 du stock
      p.qty = currentQty - 1;

      // cr√©er l'item de facture li√© √† cette pi√®ce
      const newItem = {
        type:"Pi√®ce (Inventaire)",
        desc:`${p.name} (#${p.number})`,
        qty:1,
        rate:p.price,
        invNumber:p.number // pour savoir √† quelle pi√®ce √ßa se rattache
      };

      saveParts();
      renderParts();

      items.push(newItem);
      renderItems();
    });
  });
}

function editPart(i){
  const p = PARTS[i];
  if(!p) return;

  const newName = prompt("Nom de la pi√®ce :", p.name) || p.name;
  const newNumber = prompt("Num√©ro de pi√®ce :", p.number||"") || p.number;
  const newCat = prompt("Cat√©gorie :", p.category || "Divers") || p.category || "Divers";
  const newQty = Number(prompt("Quantit√© :", p.qty) || p.qty);
  const newCost = Number(prompt("Prix co√ªtant :", p.cost) || p.cost);
  const newPrice = Number(prompt("Prix de vente :", p.price) || p.price);

  PARTS[i] = {
    name:newName,
    number:newNumber,
    category:newCat,
    qty:newQty,
    cost:newCost,
    price:newPrice
  };

  saveParts();
  renderParts();
}

/* Ajouter une pi√®ce via formulaire */
if($("partInvAddBtn")){
  $("partInvAddBtn").addEventListener("click",()=>{
    const name = $("partInvName").value.trim();
    const number = $("partInvNumber").value.trim();
    const qty = Number($("partInvQty").value)||0;
    const cost = Number($("partInvCost").value)||0;
    const price = Number($("partInvPrice").value)||0;
    const category = $("partInvCategory")?.value || "Divers";

    if(!name) return alert("Nom obligatoire");

    PARTS.push({name,number,qty,cost,price,category});
    saveParts();
    renderParts();

    $("partInvName").value="";
    $("partInvNumber").value="";
    $("partInvQty").value=1;
    $("partInvCost").value="";
    $("partInvPrice").value="";
  });
}

/* Recherche + filtre */
if($("partInvSearch"))
  $("partInvSearch").addEventListener("input",renderParts);

if($("partInvFilter"))
  $("partInvFilter").addEventListener("change",renderParts);

/* Init */
loadParts();
renderParts();

  /* ====================================================================
   SERVICES / R√âPARATIONS
==================================================================== */

let SERVICES = [];

function loadServices(){
  try{
    SERVICES = JSON.parse(localStorage.getItem("ar_services_v1") || "[]");
    if(!Array.isArray(SERVICES)) SERVICES = [];
  }catch(e){
    SERVICES = [];
  }
}

function saveServices(){
  localStorage.setItem("ar_services_v1", JSON.stringify(SERVICES));
}

function renderServices(){
  const wrap = $("servicesList");
  if(!wrap) return;
  wrap.innerHTML = "";

  if(SERVICES.length === 0){
    wrap.innerHTML = '<div class="muted">Aucun service enregistr√© pour le moment.</div>';
    return;
  }

  SERVICES.forEach((s,i)=>{
    const card = document.createElement("div");
    card.style = `
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      width:260px;
    `;

    const typeLabel = s.priceFixed > 0
      ? `Forfait: ${s.priceFixed.toFixed(2)} $`
      : (s.hours > 0 && s.rate > 0
          ? `${s.hours} h x ${s.rate.toFixed(2)} $/h`
          : `Non d√©fini`);

    card.innerHTML = `
      <h3 style="margin-bottom:6px;color:var(--accent);">${s.name}</h3>
      <div class="small">Cat√©gorie : <b>${s.category}</b></div>
      <div class="small">Tarification : <b>${typeLabel}</b></div>
      ${s.desc ? `<div class="small" style="margin-top:6px;">${s.desc}</div>` : ""}

      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="ghost" data-action="edit-srv" data-id="${s.id}" style="flex:1;">Modifier</button>
        <button class="ghost" data-action="del-srv" data-id="${s.id}" style="flex:1;">Supprimer</button>
      </div>

      <button class="ghost" data-action="add-to-invoice" data-id="${s.id}" style="margin-top:8px;width:100%;">
        ‚ûï Ajouter √† la facture
      </button>
    `;

    wrap.appendChild(card);
  });

  // actions
  wrap.querySelectorAll("button[data-action='del-srv']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = btn.dataset.id;
      if(!confirm("Supprimer ce service ?")) return;
      SERVICES = SERVICES.filter(s => String(s.id) !== String(id));
      saveServices();
      renderServices();
    });
  });

  wrap.querySelectorAll("button[data-action='edit-srv']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = btn.dataset.id;
      const s = SERVICES.find(x => String(x.id) === String(id));
      if(!s) return;

      const newName = prompt("Nom du service :", s.name) || s.name;
      const newCat = prompt("Cat√©gorie :", s.category) || s.category;
      const newDesc = prompt("Description :", s.desc || "") ?? s.desc;
      const newFixed = Number(prompt("Prix fixe (0 si aucun):", s.priceFixed || 0) || s.priceFixed || 0);
      const newHours = Number(prompt("Heures (0 si aucun):", s.hours || 0) || s.hours || 0);
      const newRate = Number(prompt("Taux horaire (0 si aucun):", s.rate || 0) || s.rate || 0);

      s.name = newName;
      s.category = newCat;
      s.desc = newDesc;
      s.priceFixed = newFixed;
      s.hours = newHours;
      s.rate = newRate;

      saveServices();
      renderServices();
    });
  });

  // Ajouter √† la facture depuis la page Services
  wrap.querySelectorAll("button[data-action='add-to-invoice']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = btn.dataset.id;
      const s = SERVICES.find(x => String(x.id) === String(id));
      if(!s) return;
      addServiceToInvoice(s);
      alert("Service ajout√© √† la facture en cours.");
    });
  });
}

function addServiceToInvoice(s){
  let desc = s.name;
  if(s.desc) desc += " ‚Äî " + s.desc;

  let item;

  if(s.priceFixed > 0){
    item = {
      type:"Service",
      desc,
      qty:1,
      rate:s.priceFixed
    };
  }else if(s.hours > 0 && s.rate > 0){
    item = {
      type:"Service (horaire)",
      desc,
      qty:s.hours,
      rate:s.rate
    };
  }else{
    item = {
      type:"Service",
      desc,
      qty:1,
      rate:0
    };
  }

  items.push(item);
  renderItems();
}

/* ====== Formulaire d'ajout de service ====== */
function initServicesModule(){
  loadServices();
  renderServices();

  if($("srvAddBtn")){
    $("srvAddBtn").addEventListener("click",()=>{
      const name = $("srvName").value.trim();
      const category = $("srvCategory")?.value || "Divers";
      const desc = $("srvDesc").value.trim();
      const priceFixed = Number($("srvPriceFixed").value)||0;
      const hours = Number($("srvHours").value)||0;
      const rate = Number($("srvRate").value)||0;

      if(!name){
        alert("Nom du service requis.");
        return;
      }
      if(priceFixed <= 0 && (hours <= 0 || rate <= 0)){
        alert("Vous devez d√©finir soit un prix fixe, soit des heures + taux.");
        return;
      }

      const srv = {
        id:Date.now(),
        name,
        category,
        desc,
        priceFixed,
        hours,
        rate
      };

      SERVICES.push(srv);
      saveServices();
      renderServices();

      $("srvName").value="";
      $("srvDesc").value="";
      $("srvPriceFixed").value="";
      $("srvHours").value="";
      $("srvRate").value="";
    });
  }

  // Modal de s√©lection des services depuis la facture
  const modal = $("servicePickerModal");
  const list = $("servicePickerList");
  const btnOpen = $("openServicePicker");
  const btnClose = $("closeServicePicker");

  // Ic√¥nes m√©caniques par cat√©gorie
const SERVICE_ICONS = {
  "Entretien": "üõ¢Ô∏è",
  "M√©canique g√©n√©rale": "üß∞",
  "Freins": "üõë",
  "Suspension": "ü¶æ",
  "Direction": "üõû",
  "Refroidissement": "‚ùÑÔ∏è",
  "Diagnostic": "üîé",
  "√âlectricit√©": "üîå",
  "Pneus": "üöó",
  "√âchappement": "üî©",
  "Transmission": "‚öôÔ∏è",
  "Moteur": "üöÄ",
  "Divers": "üì¶"
};

  if(btnOpen && modal && list){
btnOpen.addEventListener("click",()=>{
  loadServices();

  const filterSelect = $("servicePickerFilter");

  function renderPicker(){
    if(SERVICES.length === 0){
      list.innerHTML = '<div class="muted">Aucun service enregistr√© pour le moment.</div>';
      return;
    }

    const filter = filterSelect?.value || "";

  }

  // Premier affichage
  renderPicker();

  // R√©agir au filtre
  if(filterSelect){
    filterSelect.onchange = renderPicker;
  }

  modal.style.display = "flex";
});

  // Regrouper par cat√©gories
  const grouped = {};
  SERVICES.forEach(s=>{
    if(!grouped[s.category]) grouped[s.category] = [];
    grouped[s.category].push(s);
  });

  let html = "";

  // Construire la liste par groupe
  Object.keys(grouped).sort().forEach(cat=>{
    html += `
      <h3 style="color:var(--accent);margin-top:15px;">${cat}</h3>
      <div style="margin-bottom:10px;border-bottom:1px solid var(--border);"></div>
    `;

    grouped[cat].forEach(s=>{
      const label = s.priceFixed > 0
        ? `${s.name} ‚Äî ${s.priceFixed.toFixed(2)} $`
        : `${s.name} ‚Äî ${s.hours} h √ó ${s.rate.toFixed(2)} $/h`;

      html += `
        <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:6px;">
          <div><b>${label}</b></div>
          ${s.desc ? `<div class="small">${s.desc}</div>` : ""}
          <button class="ghost" data-action="pick-service" data-id="${s.id}" style="margin-top:4px;">Ajouter √† la facture</button>
        </div>
      `;
    });
  });

  list.innerHTML = html;
  modal.style.display = "flex";

  // R√©appliquer les boutons
  list.querySelectorAll("button[data-action='pick-service']").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = btn.dataset.id;
      const s = SERVICES.find(x => String(x.id) === String(id));
      if(!s) return;
      addServiceToInvoice(s);
      modal.style.display = "none";
    });
  });
});
  }

  if(btnClose && modal){
    btnClose.addEventListener("click",()=>modal.style.display="none");
  }
}

initServicesModule();

</script>

</body>
</html>
