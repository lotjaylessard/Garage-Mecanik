
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atelier M√©canique J.L ‚Äî Gestion</title>
  <style>
    :root{
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
      --muted:#aaaaaa;
    }
    *{box-sizing:border-box;}
    body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;

  /* ‚úÖ R√©serve l‚Äôespace du layout FIXE (sidebar + topbar) */
  padding-left:230px;
  padding-top:70px;

  /* ‚úÖ Emp√™che tout d√©bordement horizontal qui ‚Äúpasse sous la sidebar‚Äù */
  overflow-x:hidden;
}
    h1,h2,h3,h4{
      color:var(--accent);
      margin:0 0 10px;
    }
    .muted{color:var(--muted);font-size:0.85rem;}
    a{color:var(--accent);}
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      background:#111;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:6px;
      margin-top:6px;
    }
    
    /* ‚úÖ Fix: ne pas appliquer width:100% aux checkboxes */
input[type="checkbox"]{
  width:auto !important;
  padding:0 !important;
  margin-top:0 !important;
  accent-color: var(--accent);
}

/* (optionnel) pour un rendu propre dans la ligne des taxes */
.tax-toggle input[type="checkbox"]{
  transform: scale(1.2);
}

    textarea{min-height:70px;resize:vertical;}
    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      color:var(--text);
      font-size:0.9rem;
    }
    th,td{
      padding:8px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    th{
      background:#333;
      color:var(--accent);
    }

    /* --- Layout --- */
    #sidebar{
      position:fixed;
      left:0;
      top:0;
      width:220px;
      height:100%;
      background:#111;
      border-right:1px solid var(--border);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:10;
    }
    #sidebar h2{
      color:var(--accent);
      margin-bottom:20px;
      font-size:20px;
    }
    .navBtn{
      width:100%;
      text-align:left;
    }
    .navBtn.active{
      background:var(--accent);
      color:#000;
    }

    .topbar{
      position:fixed;
      top:0;
      left:220px;
      right:0;
      height:70px;
      background:#1b1b1b;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      z-index:9;
    }
    
    #appPages{
  padding:24px;
}

    .page{display:none;}

    /* Dashboard cards */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
    }
    .stat-card{
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px;
    }
    .stat-label{font-size:0.85rem;color:var(--muted);}
    .stat-value{font-size:1.3rem;font-weight:700;margin-top:4px;}

    /* Modal base */
    .modal-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index:9999;
      align-items:center;
      justify-content:center;
    }
    .modal-panel{
      background:var(--card);
      width:750px;
      max-width:95%;
      padding:20px;
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
      max-height:90vh;
      overflow-y:auto;
    }

    @media(max-width:800px){
      #sidebar{
        position:static;
        width:100%;
        height:auto;
        flex-direction:row;
        flex-wrap:wrap;
      }
      .topbar{
        position:static;
        margin-left:0;
      }
      #appPages{
        margin-left:0;
        margin-top:0;
      }
      body{
  padding-left:0;
  padding-top:0;
}
    }

    /* ===================== QUICK LINKS ===================== */
    .quick-links a {
  display:block;
  padding:8px 0;
  border-bottom:1px solid var(--border);
  color:var(--accent);
  font-size:1rem;
  text-decoration:none;
}

.quick-links a:hover {
  color:white;
  text-decoration:underline;
}

    .quick-tile {
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#111;
}

.qt-left {
  display:flex;
  align-items:center;
  gap:10px;
}

.qt-icon {
  font-size:1.6rem;
}

.qt-name {
  font-size:1.1rem;
  font-weight:700;
}

.qt-url {
  font-size:0.8rem;
  color:var(--muted);
}

.qt-actions button {
  font-size:1.1rem;
}

#page-workorders select,
#page-workorders input,
#page-workorders textarea {
  background:#111;
  color:white;
  border:1px solid var(--border);
  border-radius:5px;
  padding:6px;
}

    .status-badge {
  padding:4px 8px;
  border-radius:6px;
  font-weight:600;
  font-size:0.85rem;
  color:black;
}
.status-draft { background:#888; }
.status-in_progress { background:#f5c542; }
.status-waiting_parts { background:#ff7f27; }
.status-completed { background:#4CAF50; }
.status-billed { background:#2196F3; }

    /* Couleur JAUNE pour EN COURS */
.status-en_cours {
  background-color: #f7c600;   /* jaune */
  color: black;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
  text-transform: capitalize;
}

/* Couleur VERTE pour TERMIN√â */
.status-termine {
  background-color: #28a745;   /* vert */
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
  text-transform: capitalize;
}
    
/* Couleur Rouge pour Supprimer */
    button.danger {
  color: #dc3545;
}
button.danger:hover {
  background-color: rgba(220, 53, 69, 0.15);
}

    button.link{
  background:none;
  border:none;
  padding:0;
  color:var(--accent);
  cursor:pointer;
  font-weight:600;
}
button.link:hover{
  text-decoration:underline;
}

  /* tout ton CSS existant */

  /* ===== MODALS (CLIENT / VEHICULE / FACTURE) ===== */
  .modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-box{
    background: #1e1e1e;
    border-radius: 10px;
    padding: 20px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  }

  .modal-actions{
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
  }

    /* ===== FACTURE PAY√âE ===== */
.invoice-paid-badge{
  display:inline-block;
  margin-left:10px;
  padding:6px 12px;
  border:2px solid #1f9d55;
  color:#1f9d55;
  font-weight:800;
  border-radius:10px;
  font-size:18px;
  letter-spacing:1px;
}

@media print{
  .no-print{display:none !important;}
  .modal-backdrop{background:transparent !important;}
  .modal-panel{box-shadow:none !important;}

  .invoice-paid-badge{
    color:#2ecc71 !important;
    border-color:#2ecc71 !important;
  }
}

    
    .client-name-link{
  cursor: pointer;
  font-weight: 600;
  color:#f5c542;
}


.client-name-link:hover{
  text-decoration: underline;
}

@media print {

  /* ===================== BASE PRINT ===================== */
  body {
    background:#fff !important;
    color:#000 !important;
  }

  .no-print {
    display:none !important;
  }

  /* ===================== MASQUER UI INTERNE ===================== */
  .invoice-ui-taxes,
  .invoice-ui-discount {
    display:none !important;
  }

  /* ===================== SUPPRIMER TOUTE INTERACTIVIT√â ===================== */
  input,
  select,
  textarea,
  button,
  label {
    display:none !important;
    pointer-events:none !important;
  }

  /* ===================== MODAL FACTURE CLEAN ===================== */
  .modal-backdrop {
    background:transparent !important;
  }

  .modal-panel {
    box-shadow:none !important;
    border:none !important;
  }

  /* ===================== TABLES PROPRES ===================== */
  table {
    border-collapse:collapse;
    width:100%;
  }

  th, td {
    border-bottom:1px solid #ccc;
    padding:6px 4px;
  }
}




    /* ===================== FIX CHECKBOX NATIVES (FACTURE) ===================== */
.invoice-tax-toggle input[type="checkbox"]{
  appearance: checkbox !important;
  -webkit-appearance: checkbox !important;
  -moz-appearance: checkbox !important;

  width: auto !important;
  height: auto !important;
  padding: 0 !important;
  margin: 0 !important;

  background: transparent !important;
  border: none !important;
}


    
.invoice-totals-grid{
  display:flex;
  gap:20px;
  justify-content:space-between;   /* ‚úÖ taxes √† gauche, totaux √† droite */
  align-items:flex-start;
  width:100%;                     /* ‚úÖ le conteneur prend toute la largeur (remplit le ‚Äúmauve‚Äù) */
  margin-top:15px;
}

@media (max-width: 800px){
  .invoice-totals-grid{
    flex-wrap:wrap;
  }
}

    .invoice-taxes-box{
  margin-right: auto; /* üî• force √† gauche du groupe */
}

.invoice-taxes-box{
  background:#1a1a1a;
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px 14px;
  min-width:220px;
}

.invoice-taxes-box h4{
  margin-bottom:8px;
}

.invoice-taxes-box label{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:6px;
}

.invoice-totals-values{
  text-align:right;
  min-width:220px;
}

    .invoice-bottom-grid{
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: 24px;
  align-items: start;
  margin-top: 15px;
}

.invoice-taxes-left{
  background:#1a1a1a;
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px 14px;
}

.invoice-taxes-left h4{
  margin-bottom:8px;
}

.invoice-taxes-left label{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:6px;
}

.invoice-totals-right{
  text-align:right;
}


    /* ===================== PDF MODE (html2canvas) ===================== */
.pdf-export .pdf-hide{
  display:none !important;
}

.pdf-export input,
.pdf-export select,
.pdf-export textarea,
.pdf-export button{
  display:none !important;
}


    /* ===============================
   SERVICES ‚Äî MODE LISTE PRO
=============================== */

.service-row{
  display:grid;
  grid-template-columns: 2.5fr 1fr 1.5fr 2.5fr;
  gap:12px;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  align-items:center;
}

.service-row:hover{
  background:rgba(255,255,255,0.03);
}

.srv-name strong{
  color:var(--accent);
  font-size:15px;
}

.srv-desc{
  font-size:12px;
  opacity:.8;
  margin-top:4px;
}

.srv-cat,
.srv-price{
  font-size:13px;
  opacity:.9;
}

.srv-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
}


    /* ===============================
   SERVICES ‚Äî BARRE RECHERCHE
=============================== */

.services-toolbar{
  display:flex;
  gap:12px;
  margin:10px 0 14px;
}

#serviceSearchInput{
  flex:1;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}

#serviceCategoryFilter{
  min-width:220px;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}


    /* ===============================
   FIX BARRE SERVICES (TAILLE)
=============================== */

.services-toolbar{
  display:flex;
  gap:12px;
  margin:12px 0 18px;
}

.services-toolbar input,
.services-toolbar select{
  height:42px;
  font-size:14px;
}

#serviceSearchInput{
  flex:1;
  min-width:260px;
  width:100%;
}

#serviceCategoryFilter{
  width:240px;
}


    .service-actions{
  display: flex;
  flex-direction: column;
  justify-content: center; /* üëà ALIGNEMENT IDENTIQUE AUX SERVICES */
  gap: 6px;
}

/* ===============================
   Status Liste Factures
=============================== */
    .status-badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:8px;
  font-weight:800;
  font-size:0.85rem;
  color:#fff;
}

/* Factures */
.status-paid{ background:#1b5e20; }    /* vert */
.status-unpaid{ background:#b71c1c; }  /* rouge */
.status-partial{ background:#f9a825; color:#111; } /* jaune (optionnel) */

/* WO Historique */
    .readonly{
  opacity:0.75;
  cursor:not-allowed;
}

/* Timer WO grosseur */
    .wo-timer-display{
  font-size: 2rem;
  font-weight: 700;
  letter-spacing: 2px;
  margin-top: 4px;
}

/* Header Bonjour, XXX */
    .header-greeting{
  font-weight:700;
  font-size:18px;
  color:var(--accent);
}

    
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


</head>
<body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-dashboard">üìä Dashboard</button>
    <button class="navBtn" data-page="page-workorders">üìã Work Order</button>
    <button class="navBtn" data-page="page-invoice-list">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-services">üõ†Ô∏è Services</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-notes">üìù Notes</button>
    <button class="navBtn" data-page="page-links">üîó Liens Rapides</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <img src=".img/Car on lift logo design.png"
           alt="Garage JL"
     style="height:32px;">
      <h1 style="font-size:18px;">Garage-Atelier M√©canique J.L ‚Äî Gestion</h1>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
  <span id="headerGreeting" class="header-greeting">
  Bonjour, Jeremy!
</span>
</div>

  </div>

  <!-- PAGES -->
  <div id="appPages">

    <!-- DASHBOARD -->
    <div class="page" id="page-dashboard" style="display:block;">
      <h2>Tableau de bord</h2>
      <div class="stats-grid">
        <div class="stat-card">
  <div class="stat-label">Factures Impay√©es</div>
  <div class="stat-value" id="statInvoices">0</div>

  <div class="stat-label" style="margin-top:6px;">Work Orders en cours</div>
  <div class="stat-value" id="statWOInProgress">0</div>
</div>
        <div class="stat-card">
  <div class="stat-label">Revenus totaux</div>
  <div class="stat-value" id="dashTotalRevenue">0 $</div>

  <div class="stat-label" style="margin-top:6px;">Profits totaux</div>
  <div class="stat-value" id="dashTotalProfit" style="color:#4CAF50;">
    0 $
  </div>
</div>
        <div class="stat-card">
          <div class="stat-label">Clients</div>
          <div class="stat-value" id="statClients">0</div>   
          <div class="stat-label">V√©hicules</div>
          <div class="stat-value" id="statVehicles">0</div>
        </div>
        </div>
      <div class="card">
  <h3>5 Derni√®res notes</h3>
  <div id="lastNotesBox"></div>
</div>
        <div class="stat-card">
    <div class="stat-label">5 derni√®res factures</div>
    <div id="lastInvoicesBox" style="margin-top:6px;font-size:0.9rem;line-height:1.2rem;"></div>
</div>
        <div class="stat-card">
  <div class="stat-label">5 derniers bons de travail</div>
  <div id="lastWorkOrdersBox" style="margin-top:6px;font-size:0.9rem;line-height:1.2rem;"></div>
</div>
      <div class="card" style="margin-top:20px;">
        <h3>Raccourcis</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
          <button class="ghost" onclick="openNewWorkOrderFromDashboard()">+ Nouveau Work Order</button>
          <button class="ghost" onclick="showPage('page-invoice-list')">Gestion Factures</button>
          <button class="ghost" onclick="showPage('page-clients')">+ Nouveau Client</button>
          <button class="ghost" onclick="showPage('page-services')">Configurer Services</button>
          <button class="ghost" onclick="showPage('page-parts')">Gestion Inventaire</button>
        </div>
      </div>
      </div>
    </div>


        <!-- WORK ORDERS -->
    <div class="page" id="page-workorders">
       <h2>Bons de travail</h2>
      <div class="card" id="woListCard">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
          <button id="btnNewWorkOrder">‚ûï Nouveau bon de travail</button>

         <input id="woSearch"
                 placeholder="Rechercher (client, v√©hicule, # BT...)"
                 style="flex:1;min-width:200px;">
          
<select id="woStatusFilter">
  <option value="">-- Status --</option>
  <option value="en_cours">En cours</option>
  <option value="termine">Termin√©</option>
</select>
        </div>

        <table id="woTable">
          <thead>
            <tr>
              <th># Bon Travail</th>
              <th>Date</th>
              <th>Client</th>
              <th>V√©hicule</th>
              <th>Km</th>
              <th>Statut</th>
              <th>Total estim√©</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <!-- D√âTAIL DU BON DE TRAVAIL -->
<div class="card" id="woDetailCard" style="display:none;">
  <div id="woDetailContent"></div>
</div>
    </div>

    <!-- FACTURES (liste compl√®te) -->
<div class="page" id="page-invoice-list">
  <h2>Factures</h2>
  
  <div class="card">
    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
      <input id="invoiceSearch" placeholder="Recherche (#, client, v√©hicule)" style="flex:1;" />
      <select id="invoiceStatusFilter">
        <option value="">-- Statuts --</option>
        <option value="pending">Impay√©e</option>
        <option value="partial">Partielle</option>
        <option value="paid">Pay√©e</option>
      </select>
    </div>

    <table id="invoiceListTable">
      <thead>
        <tr>
          <th># Facture</th>
          <th>Date</th>
          <th>Client</th>
          <th>Total</th>
          <th>Statut</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


    <!-- CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Gestion des clients</h2>
      <div class="card">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="clientSearch" placeholder="Rechercher un client..." style="flex:1;min-width:200px;" />
          <button id="btnAddClient">Ajouter client</button>
        </div>
      </div>
      <div class="card">
        <table id="clientsTable">
          <thead>
            <tr>
              <h3>Clients</h3>
              <th><button id="toggleClientSort" class="ghost">Nom ‚¨ç</button></th>
              <th>T√©l√©phone</th>
              <th>Email</th>
              <th>Adresse</th>
              <th>V√©hicules</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- V√âHICULES -->
    <div class="page" id="page-vehicles">
      <h2>V√©hicules</h2>
      <div class="card">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="vehicleSearch" type="text" placeholder="Rechercher un v√©hicule..." style="flex:1;min-width:200px;" />
          <button id="btnAddVehicle" type="button">Ajouter v√©hicule</button>
        </div>
      </div>
      <div class="card">
        <table id="vehiclesTable">
          <thead>
  <tr>
    <th><button id="sortVehClient" class="ghost">Client ‚¨ç</button></th>
    <th><button id="sortVehYear" class="ghost">Ann√©e ‚¨ç</button></th>
    <th><button id="sortVehMake" class="ghost">Marque ‚¨ç</button></th>
    <th><button id="sortVehModel" class="ghost">Mod√®le ‚¨ç</button></th>
    <th>Plaque</th>
    <th>VIN</th>
    <th>KM</th>
    <th>Actions</th>
  </tr>
</thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- SERVICES -->
    <div class="page" id="page-services">
      <h2>Services / R√©parations</h2>

      <div class="card">
        <h3>Ajouter un service</h3>

        <label>Nom du service</label>
        <input id="srvName" />

        <label>Cat√©gorie</label>
        <select id="srvCategory">
          <option value="Entretien">Entretien</option>
          <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
          <option value="Freins">Freins</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Refroidissement">Refroidissement</option>
          <option value="Diagnostic">Diagnostic</option>
          <option value="√âlectricit√©">√âlectricit√©</option>
          <option value="Pneus">Pneus</option>
          <option value="√âchappement">√âchappement</option>
          <option value="Transmission">Transmission</option>
          <option value="Moteur">Moteur</option>
          <option value="Divers">Divers</option>
        </select>

        <label>Description (optionnel)</label>
        <textarea id="srvDesc"></textarea>

        <h4>Prix fixe (forfait)</h4>
        <input id="srvPriceFixed" type="number" step="0.01" placeholder="Ex: 89.95" />

        <h4>OU Temps et taux horaire</h4>
        <label>Heures</label>
        <input id="srvHours" type="number" step="0.1" placeholder="Ex: 1.5" />
        <label>Taux horaire ($ / h)</label>
        <input id="srvRate" type="number" step="0.01" placeholder="Ex: 95" />

        <button id="srvAddBtn" style="margin-top:10px;">Ajouter le service</button>
      </div>

      <h3>Services enregistr√©s</h3>

<!-- üîç Barre recherche + filtre -->
<div class="services-toolbar">

  <input
    type="text"
    id="serviceSearchInput"
    placeholder="Rechercher un service..."
  />

  <select id="serviceCategoryFilter">
    <option value="">Toutes les cat√©gories</option>
    <option value="Entretien">Entretien</option>
    <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
    <option value="Freins">Freins</option>
    <option value="Suspension">Suspension</option>
    <option value="Direction">Direction</option>
    <option value="Refroidissement">Refroidissement</option>
    <option value="Diagnostic">Diagnostic</option>
    <option value="√âlectricit√©">√âlectricit√©</option>
    <option value="Pneus">Pneus</option>
    <option value="√âchappement">√âchappement</option>
    <option value="Transmission">Transmission</option>
    <option value="Moteur">Moteur</option>
    <option value="Divers">Divers</option>
  </select>

</div>

<div id="servicesList"></div>
    </div>

    <!-- PI√àCES -->
    <div class="page" id="page-parts">
      <h2>Inventaire des pi√®ces</h2>

      <div class="card">
        <h3>Ajouter une pi√®ce</h3>

        <label>Nom de la pi√®ce</label>
        <input id="partInvName" />

        <label>Num√©ro de pi√®ce</label>
        <input id="partInvNumber" />

        <label>Cat√©gorie</label>
        <select id="partInvCategory">
          <option value="Moteur">Moteur</option>
          <option value="Transmission">Transmission</option>
          <option value="Suspension">Suspension</option>
          <option value="Direction">Direction</option>
          <option value="Freins">Freins</option>
          <option value="√âchappement">√âchappement</option>
          <option value="√âlectrique">√âlectrique</option>
          <option value="Tuning">Tuning</option>
          <option value="Fabrication">Fabrication</option>
          <option value="Hybride">Hybride</option>
          <option value="Carrosserie">Carrosserie</option>
          <option value="Pneus">Pneus</option>
          <option value="Divers">Divers</option>
        </select>

        <label>Quantit√© en stock</label>
        <input id="partInvQty" type="number" value="1" />

        <label>Prix co√ªtant ($)</label>
        <input id="partInvCost" type="number" step="0.01" />

        <label>Prix de vente ($)</label>
        <input id="partInvPrice" type="number" step="0.01" />

        <button id="partInvAddBtn" type="button" style="margin-top:8px;">Ajouter dans l‚Äôinventaire</button>
      </div>

      <select id="partInvFilter" style="margin-bottom:10px;">
        <option value="">Toutes cat√©gories</option>
        <option value="Moteur">Moteur</option>
        <option value="Transmission">Transmission</option>
        <option value="Suspension">Suspension</option>
        <option value="Direction">Direction</option>
        <option value="Freins">Freins</option>
        <option value="√âchappement">√âchappement</option>
        <option value="√âlectrique">√âlectrique</option>
        <option value="Tuning">Tuning</option>
        <option value="Fabrication">Fabrication</option>
        <option value="Hybride">Hybride</option>
        <option value="Carrosserie">Carrosserie</option>
        <option value="Pneus">Pneus</option>
        <option value="Divers">Divers</option>
      </select>

      <input id="partInvSearch" placeholder="Rechercher une pi√®ce (nom, # ou cat√©gorie)..." style="margin-bottom:15px;" />

      <div id="partsInventoryList"></div>
    </div>

    <!-- HISTORIQUE GLOBAL -->
    <div class="page" id="page-history">

      <div style="display:flex; gap:15px; margin:10px 0;">
  
  <div>
    <label>Filtrer par client :</label><br>
    <select id="filterClient">
      <option value="">Tous les clients</option>
    </select>
  </div>

  <div>
    <label>Filtrer par v√©hicule :</label><br>
    <select id="filterVehicle">
      <option value="">Tous les v√©hicules</option>
    </select>
  </div>

</div>
      
      <h2>Historique des bons de travail</h2>
<div class="card">
  <table id="historyWOTable">
    <thead>
      <tr>
        <th># BT</th>
        <th>Date</th>
        <th>Client</th>
        <th>V√©hicule</th>
        <th>Statut</th>
        <th style="text-align:right;">Total estim√©</th>
        <th style="text-align:right;">Profit estim√©</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

      
      <h2>Historique des factures</h2>
      <div class="card">
        
        <table id="historyTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Client</th>
              <th>V√©hicule / Job</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- NOTES -->
<div class="page" id="page-notes">
  <h2>Notes</h2>

  <div class="card">
    <h3>Ajouter une note</h3>

    <label>Cat√©gorie :</label>
    <select id="noteCategory">
      <option value="general">G√©n√©ral</option>
      <option value="urgent">Urgent</option>
      <option value="todo">√Ä faire</option>
    </select>

    <label style="margin-top:10px;">Contenu :</label>
    <textarea id="noteInput" placeholder="√âcris ta note ici..." style="min-height:90px;"></textarea>

    <button id="addNoteBtn" style="margin-top:8px;">Ajouter la note</button>
  </div>

  <div class="card">
    <h3>Historique des notes</h3>

    <input id="noteSearch" placeholder="Rechercher une note..." style="width:100%;margin-bottom:10px;padding:6px;">

    <div id="notesList"></div>

    <div style="text-align:right;margin-top:15px;">
      <button id="exportNotesBtn" class="ghost">Exporter</button>
      <button id="importNotesBtn" class="ghost">Importer</button>
      <input type="file" id="importNotesFile" accept=".json" style="display:none;">
    </div>
  </div>
</div>


<!-- LIENS RAPIDES -->
<div class="page" id="page-links">
  <h2>Liens Rapides</h2>

  <!-- Ajout d‚Äôun lien -->
  <div class="card">
    <h3>Ajouter un lien</h3>

    <label>Nom du site :</label>
    <input id="linkName" placeholder="Ex: RockAuto">

    <label>URL :</label>
    <input id="linkURL" placeholder="https://...">

    <label>Cat√©gorie :</label>
    <select id="linkCategory">
      <option value="pieces">üîß Pi√®ces</option>
      <option value="manuels">üìò Manuels</option>
      <option value="electricite">‚ö° √âlectricit√©</option>
      <option value="diagnostic">ü©∫ Diagnostic</option>
      <option value="tuning">üî• Tuning</option>
      <option value="general">üìé G√©n√©ral</option>
    </select>

    <button id="addLinkBtn" style="margin-top:8px;">Ajouter le lien</button>
  </div>

  <!-- Barre de recherche -->
  <div class="card">
    <h3>Liens enregistr√©s</h3>

    <input id="linkSearch" placeholder="Rechercher un lien..." style="width:100%;margin-bottom:10px;padding:6px;">

    <div id="linksList"></div>

    <div style="text-align:right;margin-top:15px;">
      <button id="exportLinksBtn" class="ghost">Exporter</button>
      <button id="importLinksBtn" class="ghost">Importer</button>
      <input type="file" id="importLinksFile" accept=".json" style="display:none;">
    </div>
    <div class="card">
  <h3>Liens Techniques</h3>

  <div class="quick-links">
    <a href="https://www.calculator.net/conversion-calculator.html" target="_blank" rel="noopener">
      üîÑ Conversion Calculator ‚Äî Conversion Distance, Temperature, Aera, Volume, Weight
    </a>

    <a href="https://extremewheels.com/lug-nut-torque-chart/" target="_blank" rel="noopener">
      üõû Lug Nut Torque Specs - Lug Nut Chart All Vehicles
    </a>
    
    <a href="https://www.futek.com/bolttorque/metric" target="_blank" rel="noopener">
      üî© Torque Calculator ‚Äî Calculator Metric/SAE Bolts Torques
    </a>

    <a href="https://www.willtheyfit.com/" target="_blank" rel="noopener">
      Wheel Fit Calculator - Find is Wheel/Tires Assy will fit
    </a>

    <a href="https://www.startmycar.com/ca/" target="_blank" rel="noopener">
      Start My Car - Useful stuffs like fuse box locator, how to repair, services/repair/diagram manuals
    </a>
  </div>
</div>
</div>
</div>


    
    <!-- PARAM√àTRES -->
    <div class="page" id="page-settings">
      <h2>Param√®tres</h2>
      <div class="card">
        <label>Nom du garage</label>
        <input id="settingGarageName" />

        <label>TPS (%)</label>
        <input id="settingGST" type="number" step="0.01" />

        <label>TVQ (%)</label>
        <input id="settingQST" type="number" step="0.01" />

        <label>Taux horaire par d√©faut ($ / h)</label>
<input id="settingDefaultHourlyRate" type="number" step="0.01" placeholder="ex: 120">


<button id="applyDefaultRateToServices"
        class="ghost"
        style="margin-top:10px;">
  Appliquer le taux √† tous les services horaires
</button>

<div class="muted" style="margin-top:6px;">
  Modifie uniquement les services √† taux horaire (les forfaits ne sont pas touch√©s).
</div>

        <button id="saveSettings" style="margin-top:10px;">üíæ Enregistrer les param√®tres</button>
        <div class="muted" style="margin-top:6px;">Les nouvelles factures utiliseront ces taux de taxes.</div>

        <hr style="margin:20px 0; border-color:var(--border);">

        <h3>Sauvegarde / Restauration</h3>
        <button id="btnExportData">üì§ Exporter toutes les donn√©es</button>
        <br><br>
        <input type="file" id="importBackupFile" style="display:none;" />
        <button id="btnImportData" class="ghost">üì• Importer un backup (.json)</button>

        <div class="muted" style="margin-top:10px;">
          Sauvegarde toutes vos donn√©es (factures, clients, pi√®ces, services, param√®tres, etc.)
          dans un fichier .json que vous pouvez restaurer plus tard.
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL CLIENT -->
  <div id="clientModal" class="modal-backdrop">
    <div class="modal-panel">
      <h2>Fiche Client</h2>
      <div id="clientModalContent">Chargement...</div>
      <div style="text-align:right;margin-top:15px;">
        <button id="closeClientModal" class="ghost">Fermer</button>
      </div>
    </div>
  </div>


  <!-- ===================== VEHICLE MODAL ===================== -->
<div class="modal" id="vehicleModal" style="display:none;">
  <div class="modal-box" style="max-width:900px;">
    <h2>Fiche v√©hicule</h2>

    <div id="vehicleModalContent"></div>

    <div style="text-align:right;margin-top:15px;">
      <button class="ghost" onclick="closeVehicleModal()">Fermer</button>
    </div>
  </div>
</div>


  <!-- MODAL SERVICES PICKER -->
  <div id="servicePickerModal" class="modal-backdrop">
    <div class="modal-panel" style="width:700px;">
      <h2>Choisir un service</h2>

      <label style="margin-top:10px;">Filtrer par cat√©gorie :</label>
      <select id="servicePickerFilter" style="margin-bottom:15px;">
        <option value="">Toutes les cat√©gories</option>
        <option value="Entretien">Entretien</option>
        <option value="M√©canique g√©n√©rale">M√©canique g√©n√©rale</option>
        <option value="Freins">Freins</option>
        <option value="Suspension">Suspension</option>
        <option value="Direction">Direction</option>
        <option value="Refroidissement">Refroidissement</option>
        <option value="Diagnostic">Diagnostic</option>
        <option value="√âlectricit√©">√âlectricit√©</option>
        <option value="Pneus">Pneus</option>
        <option value="√âchappement">√âchappement</option>
        <option value="Transmission">Transmission</option>
        <option value="Moteur">Moteur</option>
        <option value="Divers">Divers</option>
      </select>

      <div id="servicePickerList">Chargement...</div>

      <div style="text-align:right;margin-top:15px;">
        <button id="closeServicePicker" class="ghost">Fermer</button>
      </div>
    </div>
  </div>

  
  <!-- MODAL PART PICKER -->
<div id="partPickerModal" class="modal-backdrop">
  <div class="modal-panel" style="width:700px;">
    <h2>Choisir une pi√®ce</h2>

    <label style="margin-top:10px;">Filtrer par cat√©gorie :</label>
    <select id="partPickerFilter" style="margin-bottom:15px;">
      <option value="">Toutes cat√©gories</option>
      <option value="Moteur">Moteur</option>
      <option value="Transmission">Transmission</option>
      <option value="Suspension">Suspension</option>
      <option value="Direction">Direction</option>
      <option value="Freins">Freins</option>
      <option value="√âchappement">√âchappement</option>
      <option value="√âlectrique">√âlectrique</option>
      <option value="Tuning">Tuning</option>
      <option value="Fabrication">Fabrication</option>
      <option value="Hybride">Hybride</option>
      <option value="Carrosserie">Carrosserie</option>
      <option value="Pneus">Pneus</option>
      <option value="Divers">Divers</option>
    </select>

    <div id="partPickerList">Chargement...</div>

    <div style="text-align:right;margin-top:15px;">
      <button id="closePartPicker" class="ghost">Fermer</button>
    </div>
  </div>
</div>

  
  <!-- MODAL EDIT FACTURE -->
  <div id="invoiceEditModal" class="modal-backdrop">
    <div class="modal-panel" style="width:900px;">
      <div id="invoiceEditContent">Chargement...</div>
    </div>
  </div>

<!-- MODAL AJOUT V√âHICULE -->
<div id="addVehicleModal" class="modal-backdrop" style="display:none;">
  <div class="modal-panel" style="max-width:520px;">
    <h2>Ajouter un v√©hicule</h2>

    <label>Client</label>
    <select id="vehClientSelect"></select>

    <label>Ann√©e</label>
    <input id="vehYear" type="number">

    <label>Marque</label>
    <input id="vehMake" type="text">

    <label>Mod√®le</label>
    <input id="vehModel" type="text">

    <label>Plaque</label>
    <input id="vehPlate">

    <label>VIN</label>
    <input id="vehVin">

    <label>Kilom√©trage</label>
    <input id="vehKm" type="number">

    <div class="modal-actions">
      <button class="ghost" onclick="closeAddVehicleModal()">Annuler</button>
      <button class="primary" onclick="saveNewVehicle()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

  
<script>

  
/* ===================== HELPERS & STORAGE ===================== */
const STORAGE = {
  invoices:'ar_invoices_v2',
  settings:'ar_settings_v1',
  invoiceCounter:'ar_invoice_counter_v1',
  clients:'ar_clients_v1',
  parts:'ar_parts_inventory_v1',
  services:'ar_services_v1',
  notes:'ar_notes_v1',
  workorders:'ar_workorders_v1'
};


  function escapeHTML(str){
  return String(str || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


  function renderInvoiceDiscount(inv, container){
  const row = container.querySelector("#invDiscountRow");
  const amount = container.querySelector("#invDiscountAmount");

  if (!row || !amount) return;

  if (inv.discount && inv.discount > 0){
    row.style.display = "flex";
    amount.textContent = "- " + money(inv.discount) + " $";
  } else {
    row.style.display = "none";
  }
}



/* ===== MIGRATION LOCALSTORAGE (TEMPORAIRE) ===== */
(function migrateOldStorage(){
  const map = {
    clients: ["clients","garage_clients","ar_clients"],
    parts: ["parts","garage_parts","ar_parts"],
    services: ["services","garage_services","ar_services"],
    notes: ["notes","garage_notes","ar_notes"],
    workorders: ["workorders","garage_workorders","ar_workorders"],
    invoices: ["invoices","garage_invoices","ar_invoices"]
  };

  Object.keys(map).forEach(key=>{
    const newKey = STORAGE[key];
    if (localStorage.getItem(newKey)) return;

    for (const oldKey of map[key]){
      const oldVal = localStorage.getItem(oldKey);
      if (oldVal){
        localStorage.setItem(newKey, oldVal);
        console.log(`‚úî Migration ${oldKey} ‚Üí ${newKey}`);
        break;
      }
    }
  });
})();


const $ = id => document.getElementById(id);
function money(n){return Number(n||0).toFixed(2);}


  function calcWorkOrderProfit(wo){
  if (!wo) return 0;

  // üî© profit pi√®ces
  const profitParts = Array.isArray(wo.parts)
    ? wo.parts.reduce((sum, p) => {
        const cost = Number(p.cost || 0);
        const rate = Number(p.rate || 0);
        const qty  = Number(p.qty || 0);
        return sum + ((rate - cost) * qty);
      }, 0)
    : 0;

  // üõ†Ô∏è profit main-d'≈ìuvre (100 %)
  const profitLabor = Array.isArray(wo.labor)
    ? wo.labor.reduce((sum, l) => {
        return sum + (Number(l.hours || 0) * Number(l.rate || 0));
      }, 0)
    : 0;

  return profitParts + profitLabor;
}


  function calcMargin(cost, price){
  cost = Number(cost || 0);
  price = Number(price || 0);

  if (price <= 0) return 0;

  return Math.round(((price - cost) / price) * 100);
}


  /* ===================== UPDATE TOTAUX LIVE (UI ONLY) ===================== */
function updateInvoiceTotalsLive(inv){
  const subEl = document.getElementById("invSubTotal");
  const gstEl = document.getElementById("invGST");
  const qstEl = document.getElementById("invQST");
  const totEl = document.getElementById("invTotal");

  if (!subEl || !gstEl || !qstEl || !totEl) return;

  // calcul local TEMPORAIRE (sans toucher √† inv)
  const subTotal = inv.items.reduce(
    (s,it)=> s + (Number(it.qty||0) * Number(it.rate||0)), 0
  );

  const gst = (inv.applyGST !== false)
    ? subTotal * (SETTINGS.gst / 100)
    : 0;

  const qst = (inv.applyQST !== false)
    ? (subTotal + gst) * (SETTINGS.qst / 100)
    : 0;

  const total = subTotal + gst + qst;

  subEl.textContent = money(subTotal) + " $";
  gstEl.textContent = money(gst) + " $";
  qstEl.textContent = money(qst) + " $";
  totEl.textContent = money(total) + " $";
}



  /* ===================== SUPABASE ===================== */
const SUPABASE_URL = "https://feeapfylfzlvgnqtglnh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlZWFwZnlsZnpsdmducXRnbG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDk3MDUsImV4cCI6MjA4MzAyNTcwNX0._ZQc89gbY5DFqFboR9fL8efeOZ2TZLG0zG8_5lzOOUY";

const sb = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

let SUPABASE_USER = null;


  
  /* ===================== SAFE STORAGE HELPERS ===================== */
function loadArrayFromStorage(key){
  try{
    const data = JSON.parse(localStorage.getItem(key) || "[]");
    return Array.isArray(data) ? data : [];
  }catch(e){
    return [];
  }
}


  /* ===================== CALCULS TOTAUX (SAFE + TAX FLAGS) ===================== */
function calcTotalsFromItems(items, inv){
  if (!Array.isArray(items)) items = [];

  const subTotal = items.reduce(
    (sum, it) => sum + (Number(it.qty || 0) * Number(it.rate || 0)),
    0
  );

  const applyGST = inv?.applyGST !== false;
  const applyQST = inv?.applyQST !== false;

  const gst = applyGST
    ? subTotal * (Number(SETTINGS.gst || 0) / 100)
    : 0;

  const qst = applyQST
    ? subTotal * (Number(SETTINGS.qst || 0) / 100)
    : 0;

  const total = subTotal + gst + qst;

  return {
    subTotal,
    gst,
    qst,
    total
  };
}


  function calcInvoiceTotals(inv){
  const subTotal = (inv.items || []).reduce(
    (sum, it) => sum + (Number(it.qty || 0) * Number(it.rate || 0)),
    0
  );

  const applyGST = inv.applyGST !== false;
  const applyQST = inv.applyQST !== false;

  const gst = applyGST ? subTotal * (SETTINGS.gst / 100) : 0;
  const qst = applyQST ? (subTotal + gst) * (SETTINGS.qst / 100) : 0;

  const total = subTotal + gst + qst;

  return { subTotal, gst, qst, total };
}


  /* ===================== RECALCUL FACTURE (SOURCE UNIQUE) ===================== */
function recalcInvoice(inv){

  const baseSubTotal = (inv.items || []).reduce(
    (sum, it) => sum + (Number(it.qty || 0) * Number(it.rate || 0)),
    0
  );

  // üîª ESCompte
  let discount = 0;
  const val = Number(inv.discountValue || 0);

  if (inv.discountType === "percent"){
    discount = baseSubTotal * (val / 100);
  } else {
    discount = val;
  }

  discount = Math.min(discount, baseSubTotal); // s√©curit√©

  const taxableSubTotal = baseSubTotal - discount;

  const applyGST = inv.applyGST !== false;
  const applyQST = inv.applyQST !== false;

  const gst = applyGST
    ? taxableSubTotal * (Number(SETTINGS.gst || 0) / 100)
    : 0;

  const qst = applyQST
    ? taxableSubTotal * (Number(SETTINGS.qst || 0) / 100)
    : 0;

  inv.subTotal = baseSubTotal;
  inv.discount = discount;
  inv.taxableSubTotal = taxableSubTotal;
  inv.gst = gst;
  inv.qst = qst;
  inv.total = taxableSubTotal + gst + qst;
}


  /* ===================== RENDU LIVE DES TOTAUX FACTURE ===================== */
function renderInvoiceTotals(inv, container){
  if (!container) return;

  const elSub = container.querySelector("#invSubTotal");
  const elGST = container.querySelector("#invGST");
  const elQST = container.querySelector("#invQST");
  const elTot = container.querySelector("#invTotal");

  if (elSub) elSub.textContent = money(inv.subTotal) + " $";
  if (elGST) elGST.textContent = money(inv.gst) + " $";
  if (elQST) elQST.textContent = money(inv.qst) + " $";
  if (elTot) elTot.textContent = money(inv.total) + " $";
}


  /* ===================== NORMALISATION TAXES FACTURE ===================== */
function normalizeInvoiceTaxes(inv){
  if (inv.applyGST === undefined) inv.applyGST = true;
  if (inv.applyQST === undefined) inv.applyQST = true;
}


/* ===================== RENDU LIVE DES TOTAUX FACTURE ===================== */
function renderInvoiceTotals(inv, container){
  if (!container) return;

  const elSub = container.querySelector("#invSubTotal");
  const elGST = container.querySelector("#invGST");
  const elQST = container.querySelector("#invQST");
  const elTot = container.querySelector("#invTotal");

  if (elSub) elSub.textContent = money(inv.subTotal) + " $";
  if (elGST) elGST.textContent = money(inv.gst) + " $";
  if (elQST) elQST.textContent = money(inv.qst) + " $";
  if (elTot) elTot.textContent = money(inv.total) + " $";
}


/* ===================== FACTURES ‚Äì RENDU UNIQUE ===================== */
function renderInvoiceSummary(inv){
  if (!inv) return '<div class="muted">Facture introuvable.</div>';

  // ===== CALCUL FACTURE PAY√âE =====
  let totalPaid = 0;
  if (Array.isArray(inv.payments)){
    inv.payments.forEach(p=>{
      totalPaid += Number(p.amount || 0);
    });
  }
  const total = Number(inv.total || 0);
const paidAmount = Number(inv.paidAmount || 0);

const isPaid =
  (String(inv.status || "").toLowerCase() === "paid") ||
  (paidAmount >= total) ||
  (totalPaid >= total);


  return `
    <h3 style="display:flex;align-items:center;gap:14px;">
      Facture #${inv.number}
      ${isPaid ? `<span class="invoice-paid-badge">PAY√â</span>` : ``}
    </h3>

    <div class="muted">${inv.date || ''}</div>

    <p><b>Client :</b> ${escapeHTML(inv.customer)}</p>
<p><b>V√©hicule / Job :</b> ${escapeHTML(inv.job)}</p>

    <table style="width:100%;margin-top:10px;">
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
          <th>Qt√©</th>
          <th>Prix</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${(inv.items || []).map(it=>`
          <tr>
            <td>${it.type}</td>
            <td>${it.desc}</td>
            <td>${it.qty}</td>
            <td>${money(it.rate)} $</td>
            <td>${money(it.qty * it.rate)} $</td>
          </tr>
        `).join('')}
      </tbody>
    </table>


<div class="invoice-bottom-grid">

  <!-- COLONNE GAUCHE : TAXES -->
  <div class="invoice-taxes-left pdf-hide">
    <h4>Taxes</h4>

    <label>
      <input type="checkbox" id="invApplyGST">
      TPS (${SETTINGS.gst}%)
    </label>

    <label>
      <input type="checkbox" id="invApplyQST">
      TVQ (${SETTINGS.qst}%)
    </label>
  </div>

  <!-- COLONNE DROITE : TOTAUX -->
  <div class="invoice-totals-right">
    <div>Sous-total : <span id="invSubTotal">${money(inv.subTotal)} $</span></div>
    <div>TPS : <span id="invGST">${money(inv.gst)} $</span></div>
    <div>TVQ : <span id="invQST">${money(inv.qst)} $</span></div>
    <h3>Total : <span id="invTotal">${money(inv.total)} $</span></h3>
  </div>
</div>
</div>
  `;
}


  /* ===================== # BT dans Work order ===================== */
  function generateWorkOrderNumber(clientName){
  if (!clientName) return "BT-UNKNOWN";

  // Initiales du client (Jean Tremblay ‚Üí JT)
  const initials = clientName
    .split(" ")
    .filter(w => w.length > 0)
    .map(w => w[0].toUpperCase())
    .join("");

  // Date AAAA-MM-JJ
  const d = new Date();
  const date =
    d.getFullYear() + "-" +
    String(d.getMonth() + 1).padStart(2, "0") + "-" +
    String(d.getDate()).padStart(2, "0");

  return `BT-${initials}-${date}`;
}


function loadInvoiceIntoEditor(inv){
  // 1) num√©ro
  if ($("invoiceNumber")) $("invoiceNumber").value = inv.number || "";

  // 2) afficher readonly (tu as d√©j√† les div dans le HTML)
  if ($("invoiceClientSelectBlock")) $("invoiceClientSelectBlock").style.display = "none";
  if ($("invoiceVehicleSelectBlock")) $("invoiceVehicleSelectBlock").style.display = "none";
  if ($("invoiceClientReadonly")) $("invoiceClientReadonly").style.display = "block";
  if ($("invoiceVehicleReadonly")) $("invoiceVehicleReadonly").style.display = "block";

  if ($("invoiceClientText")) $("invoiceClientText").innerText = inv.customer || "";
  if ($("invoiceVehicleText")) $("invoiceVehicleText").innerText = inv.vehicle || inv.job || "";

  // 3) items
  items = Array.isArray(inv.items) ? inv.items.map(x => ({...x})) : [];

  // 4) refresh UI
  if (typeof renderItems === "function") renderItems();
}
  

function showPage(id){

  // cacher toutes les pages
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');

  // afficher la page demand√©e
  const pg = $(id);
  if (pg) pg.style.display = 'block';

  // logique par page
  if (id === "page-dashboard") {
    loadWorkOrders();
  }

  if (id === "page-workorders") {
    initWorkOrdersModule();
  }

  // navigation active
  document.querySelectorAll('.navBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.page === id);
  });

  // routage sp√©cifique
  switch(id){
  case "page-invoice-list":
    loadInvoices();
    renderInvoiceList();
    break;

    case "page-settings":
  loadSettings();
  break;

      case "page-parts":
  PARTS = loadArrayFromStorage(STORAGE.parts);
  renderPartsList();

  if ($("partInvAddBtn")){
    $("partInvAddBtn").onclick = () => {

      const data = {
        id: EDITING_PART_ID || Date.now(),
        name: $("partInvName").value.trim(),
        number: $("partInvNumber").value.trim(),
        category: $("partInvCategory").value,
        qty: Number($("partInvQty").value || 0),
        cost: Number($("partInvCost").value || 0),
        price: Number($("partInvPrice").value || 0)
      };

      if (!data.name){
        alert("Nom de la pi√®ce requis.");
        return;
      }

      if (EDITING_PART_ID){
        PARTS = PARTS.map(p =>
          String(p.id) === String(EDITING_PART_ID) ? data : p
        );
      } else {
        PARTS.push(data);
      }

      localStorage.setItem(STORAGE.parts, JSON.stringify(PARTS));
      scheduleCloudSync();

      EDITING_PART_ID = null;
      $("partInvAddBtn").textContent = "Ajouter dans l‚Äôinventaire";

      $("partInvName").value = "";
      $("partInvNumber").value = "";
      $("partInvQty").value = 1;
      $("partInvCost").value = "";
      $("partInvPrice").value = "";

      renderPartsList();
    };
  }

  break;

  case "page-services":
  SERVICES = loadArrayFromStorage(STORAGE.services);
  renderServicesList();

  // üî• brancher le bouton Ajouter / Modifier ICI
  if ($("srvAddBtn")){
    $("srvAddBtn").onclick = () => {

      const data = {
        id: EDITING_SERVICE_ID || Date.now(),
        name: $("srvName").value.trim(),
        category: $("srvCategory").value,
        desc: $("srvDesc").value.trim(),
        priceFixed: Number($("srvPriceFixed").value || 0),
        hours: Number($("srvHours").value || 0),
        rate: Number($("srvRate").value || 0)
      };

      if (!data.name){
        alert("Nom du service requis.");
        return;
      }

      if (EDITING_SERVICE_ID){
        SERVICES = SERVICES.map(s =>
          String(s.id) === String(EDITING_SERVICE_ID) ? data : s
        );
      } else {
        SERVICES.push(data);
      }

      localStorage.setItem(STORAGE.services, JSON.stringify(SERVICES));
      scheduleCloudSync();

      // reset UI
      EDITING_SERVICE_ID = null;
      $("srvAddBtn").textContent = "Ajouter le service";

      $("srvName").value = "";
      $("srvDesc").value = "";
      $("srvPriceFixed").value = "";
      $("srvHours").value = "";
      $("srvRate").value = "";

      renderServicesList();
    };
  }

  break;

  case "page-history":

  // ‚úÖ IMPORTANT: charger les BT avant le rendu
  loadWorkOrders();

  // reset filtres historique
  if ($("filterClient")) $("filterClient").value = "";
  if ($("filterVehicle")) $("filterVehicle").value = "";

  if ($("filterClient")){
    $("filterClient").onchange = () => {
      renderHistoryTable();
      renderHistoryWOTable();
    };
  }

  if ($("filterVehicle")){
    $("filterVehicle").onchange = () => {
      renderHistoryTable();
      renderHistoryWOTable();
    };
  }

  renderHistoryTable();
  renderHistoryWOTable();
  break;
}
}


document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{

    // üß† CAS SP√âCIAL : on est dans un WO ouvert
    if (
      btn.dataset.page === "page-workorders" &&
      $("woDetailCard") &&
      $("woDetailCard").style.display === "block"
    ){
      returnToWOListFromDetail();
      showPage("page-workorders");
      return;
    }

    // comportement normal
    showPage(btn.dataset.page);
  });
});


/* ===================== AUTH SUPABASE ===================== */
async function supabaseLogin(){
  const email = "lessard.jeremy@outlook.com";
  const password = "Hemidugaz2026!";

  const { data, error } = await sb.auth.signInWithPassword({
    email,
    password
  });

  if (error){
    console.error("Supabase login error:", error.message);
    alert("Erreur connexion cloud");
    return;
  }

  SUPABASE_USER = data.user;
  console.log("‚úÖ Supabase connect√© :", SUPABASE_USER.email);
}


  /* ===================== CLOUD LOAD ===================== */
async function loadCloudData(){
  if (!SUPABASE_USER) return false;

  const { data, error } = await sb
    .from("garage_data")
    .select("data")
    .eq("user_id", SUPABASE_USER.id)
    .maybeSingle();

  if (error && error.code !== "PGRST116"){
    console.error("Cloud load error:", error);
    return false;
  }

  // üî∞ Aucune donn√©e cloud ‚Üí premi√®re utilisation
  if (!data){
    console.log("‚òÅÔ∏è Aucun data cloud, cr√©ation initiale...");
    await createInitialCloudData();
    return true;
  }

  // ‚úÖ Charger le cloud dans le localStorage
  hydrateLocalFromCloud(data.data);

  // üîÅ Recharger les donn√©es en m√©moire apr√®s hydratation cloud
loadInvoices();

// üîÑ Rafra√Æchir le dashboard avec les vraies donn√©es
renderDashboard();

  console.log("‚òÅÔ∏è Donn√©es cloud charg√©es");
  return true;
}


  /* ===================== CLOUD INIT ===================== */
async function createInitialCloudData(){
  const payload = {
    clients: loadArrayFromStorage(STORAGE.clients),
    invoices: loadArrayFromStorage(STORAGE.invoices),
    workorders: loadArrayFromStorage(STORAGE.workorders),
    notes: loadArrayFromStorage(STORAGE.notes),
    parts: loadArrayFromStorage(STORAGE.parts),
    services: loadArrayFromStorage(STORAGE.services),
    settings: JSON.parse(localStorage.getItem(STORAGE.settings) || "{}")
  };

  const { error } = await sb.from("garage_data").insert({
    user_id: SUPABASE_USER.id,
    data: payload
  });

  if (error){
    console.error("Cloud init error:", error);
    alert("Erreur initialisation cloud");
  } else {
    console.log("‚òÅÔ∏è Cloud initialis√©");
  }
}


  /* ===================== CLOUD ‚Üí LOCAL ===================== */
function hydrateLocalFromCloud(data){
  if (!data) return;

  localStorage.setItem(STORAGE.clients, JSON.stringify(data.clients || []));
  localStorage.setItem(STORAGE.invoices, JSON.stringify(data.invoices || []));
  localStorage.setItem(STORAGE.workorders, JSON.stringify(data.workorders || []));
  localStorage.setItem(STORAGE.notes, JSON.stringify(data.notes || []));
  localStorage.setItem(STORAGE.parts, JSON.stringify(data.parts || []));
  localStorage.setItem(STORAGE.services, JSON.stringify(data.services || []));
  localStorage.setItem(STORAGE.settings, JSON.stringify(data.settings || {}));

  // üîÅ Recharger les variables m√©moire
  loadInvoices();
  loadWorkOrders();
  CLIENTS = loadArrayFromStorage(STORAGE.clients);
  PARTS   = loadArrayFromStorage(STORAGE.parts);
  SERVICES= loadArrayFromStorage(STORAGE.services);
}


  /* ===================== CLOUD PUSH (SYNC) ===================== */
let cloudSyncTimer = null;

function scheduleCloudSync(delay = 1500){
  if (!SUPABASE_USER) return;

  clearTimeout(cloudSyncTimer);
  cloudSyncTimer = setTimeout(() => {
    pushLocalDataToCloud();
  }, delay);
}

async function pushLocalDataToCloud(){
  if (!SUPABASE_USER) return;

  const payload = {
    clients: loadArrayFromStorage(STORAGE.clients),
    invoices: loadArrayFromStorage(STORAGE.invoices),
    workorders: loadArrayFromStorage(STORAGE.workorders),
    notes: loadArrayFromStorage(STORAGE.notes),
    parts: loadArrayFromStorage(STORAGE.parts),
    services: loadArrayFromStorage(STORAGE.services),
    settings: JSON.parse(localStorage.getItem(STORAGE.settings) || "{}")
  };

  const { error } = await sb
    .from("garage_data")
    .update({
      data: payload,
      updated_at: new Date().toISOString()
    })
    .eq("user_id", SUPABASE_USER.id);

  if (error){
    console.warn("‚ö†Ô∏è Cloud sync √©chou√©e (offline ?)", error.message);
  } else {
    console.log("‚òÅÔ∏è Cloud synchronis√©");
  }
}

  
/* ===================== GLOBAL DATA ===================== */
let SETTINGS = {
  garageName: 'Garage-Atelier M√©canique J.L',
  gst: 5,
  qst: 9.975,
  defaultHourlyRate: 90   // ‚¨ÖÔ∏è valeur par d√©faut s√©curitaire
};
let INVOICES = [];
let WO_TIMER_INTERVAL = null;
let WO_TIMER_START = null;
let WO_TIMER_ELAPSED = 0; // temps accumul√© en ms
let WO_TIMER_PAUSED = false;
let WORKORDERS = [];
let items = [];
let CLIENTS = [];
let PARTS = [];
let EDITING_PART_ID = null;
let SERVICES = [];
let EDITING_SERVICE_ID = null;
let VEHICLES_SORT = {key: "client", dir: 1 // 1 = asc, -1 = desc 
  }; // ‚ö†Ô∏è utilis√© implicitement par renderVehiclesPage() pour le tri



function loadInvoices(){
  INVOICES = loadArrayFromStorage(STORAGE.invoices);
}


/* ======================================================
   FACTURE ‚Äî OUVERTURE MODALE √âDITION
   Point d‚Äôentr√©e UNIQUE du bouton "‚úèÔ∏è Modifier"
====================================================== */
function openInvoiceEditModal(number){
  loadInvoices();

  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv){
    alert("Facture introuvable.");
    return;
  }

  // r√©f√©rence globale pour l‚Äô√©dition
  window.currentInvoice = inv;

  // normaliser taxes si anciennes factures
  normalizeInvoiceTaxes(inv);

  // cloner les items pour √©dition
  items = Array.isArray(inv.items)
    ? inv.items.map(it => ({ ...it }))
    : [];

  // injecter UI
  renderInvoiceEditUI(inv);

  // afficher modal
  const modal = document.getElementById("invoiceEditModal");
  modal.style.display = "flex";
}


  /* ======================================================
   FACTURE ‚Äî UI √âDITION
====================================================== */
function renderInvoiceEditUI(inv){
  const box = document.getElementById("invoiceEditContent");
  if (!box) return;

  box.innerHTML = `
    <h2>Modifier facture #${inv.number}</h2>

    <div class="muted">${inv.date || ""}</div>

    <table id="itemsTable">
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
          <th>Qt√©</th>
          <th>Prix</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="invoice-bottom-grid">
      <div class="invoice-taxes-left">
        <h4>Taxes</h4>
        <label>
          <input type="checkbox" id="invApplyGST">
          TPS (${SETTINGS.gst}%)
        </label>
        <label>
          <input type="checkbox" id="invApplyQST">
          TVQ (${SETTINGS.qst}%)
        </label>
      </div>

      <div class="invoice-totals-right">
        <div>Sous-total : <span id="invSubTotal"></span></div>
        <div>TPS : <span id="invGST"></span></div>
        <div>TVQ : <span id="invQST"></span></div>
        <h3>Total : <span id="invTotal"></span></h3>
      </div>
    </div>

    <div class="modal-actions">
      <button class="ghost" onclick="closeInvoiceEditModal()">Fermer</button>
      <button onclick="saveInvoiceEdits()">üíæ Enregistrer</button>
    </div>
  `;

  // √©tat des taxes
  $("invApplyGST").checked = inv.applyGST !== false;
  $("invApplyQST").checked = inv.applyQST !== false;

  $("invApplyGST").onchange = () => {
    inv.applyGST = $("invApplyGST").checked;
    recalcInvoice(inv);
    renderInvoiceTotals(inv, document);
  };

  $("invApplyQST").onchange = () => {
    inv.applyQST = $("invApplyQST").checked;
    recalcInvoice(inv);
    renderInvoiceTotals(inv, document);
  };

  // rendu items + totaux
  renderItems();
  recalcInvoice(inv);
  renderInvoiceTotals(inv, document);
}


  function closeInvoiceEditModal(){
  document.getElementById("invoiceEditModal").style.display = "none";
}

function saveInvoiceEdits(){
  if (!currentInvoice) return;

  // r√©injecter les items √©dit√©s
  currentInvoice.items = items.map(it => ({ ...it }));

  recalcInvoice(currentInvoice);
  saveInvoices();

  closeInvoiceEditModal();
  renderInvoiceList();
}


function saveInvoices(){
  localStorage.setItem(STORAGE.invoices, JSON.stringify(INVOICES));
  scheduleCloudSync();
}


function toggleInvoicePaymentMenu(number){
  const menu = document.getElementById("invoicePayMenu-" + number);
  if (!menu) return;

  menu.style.display = (menu.style.display === "none" || !menu.style.display)
    ? "block"
    : "none";
}


function payInvoiceWithMethod(number, method){
  loadInvoices();

  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv){
    alert("Facture introuvable.");
    return;
  }

  const total = Number(inv.total || 0);
  const alreadyPaid = Number(inv.paidAmount || 0);
  const balance = Math.max(0, total - alreadyPaid);

  // üîí Rien √† payer
  if (balance <= 0){
    inv.status = "paid";
    inv.paymentMethod = method;
    saveInvoices();
    openInvoiceEditModal(number);
    return;
  }

  // üßæ Initialiser l'historique si manquant
  if (!Array.isArray(inv.payments)){
    inv.payments = [];
  }

  // ‚ûï AJOUT DU PAIEMENT FINAL
  inv.payments.push({
    date: new Date().toLocaleString("fr-CA"),
    amount: balance,
    method: method
  });

  // üî¢ Mettre la facture compl√®tement pay√©e
  inv.paidAmount = total;
  inv.status = "paid";
  inv.paymentMethod = method;

  saveInvoices();

// üîÅ RAFRA√éCHIR TOUTE L‚ÄôUI (SANS RELOAD)
loadInvoices();
renderInvoiceList();

if (typeof renderDashboard === "function") {
  renderDashboard();
}

// üîÑ Si on est d√©j√† sur la page factures, on force l‚ÄôUI visible
if (document.getElementById("page-invoice-list")?.style.display === "block") {
  renderInvoiceList();
}

// üîÅ ROUVRIR LE MODAL MIS √Ä JOUR
openInvoiceEditModal(number);
}

  
  /* ===================== WORK ORDERS (Bons de travail) ===================== */

function addServiceToCurrentWO(serviceId){
  // 1Ô∏è‚É£ Identifier le WO actuellement ouvert
  const woId = $("woEditId")?.value;
  if (!woId) {
    alert("Aucun bon de travail ouvert.");
    return;
  }

  const wo = getActiveWOById(woId);
  if (!wo) {
    alert("Bon de travail introuvable.");
    return;
  }

  // 2Ô∏è‚É£ Trouver le service
  const srv = SERVICES.find(s => String(s.id) === String(serviceId));
  if (!srv) return;

  // 3Ô∏è‚É£ Calcul heures / taux
  let hours = 1;
  let rate = 0;

  if (srv.priceFixed > 0){
    hours = 1;
    rate = Number(srv.priceFixed);
  } else if (srv.hours > 0 && srv.rate > 0){
    hours = Number(srv.hours);
    rate = Number(srv.rate);
  } else {
    return alert("Service mal configur√©.");
  }

  // 4Ô∏è‚É£ Ajouter au WO (PAS √Ä LA FACTURE)
  wo.labor.push({
    description: srv.name,
    hours,
    rate,
    total: hours * rate
  });

  // 5Ô∏è‚É£ Sauvegarde + rafra√Æchissement
  persistActiveWO(wo);
  woRenderLines(wo);

  alert(`Service "${srv.name}" ajout√© au bon de travail.`);
}

  function addPartToCurrentWO(partIndex){
  // 1Ô∏è‚É£ Identifier le WO actuellement ouvert
  const woId = $("woEditId")?.value;
  if (!woId){
    alert("Aucun bon de travail ouvert.");
    return;
  }

  const wo = getActiveWOById(woId);
  if (!wo){
    alert("Bon de travail introuvable.");
    return;
  }

  // 2Ô∏è‚É£ R√©cup√©rer la pi√®ce
  const part = PARTS[partIndex];
  if (!part) return;

  // 3Ô∏è‚É£ Demander la quantit√©
  const qty = Number(prompt(
    `Quantit√© pour "${part.name}" :`,
    "1"
  ));

  if (!qty || qty <= 0) return;

  // 4Ô∏è‚É£ Ajouter au WO (PAS √† la facture)
  wo.parts.push({
    name: part.name,
    number: part.number,
    qty,
    cost: Number(part.cost || 0),
    rate: Number(part.price || 0),
    total: qty * Number(part.price || 0)
  });

  // 5Ô∏è‚É£ Sauvegarde + rafra√Æchissement
  persistActiveWO(wo);
  woRenderLines(wo);

  alert(`Pi√®ce "${part.name}" ajout√©e au bon de travail.`);
}


  function openInvoiceView(number){
  loadInvoices();

  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv){
    alert("Facture introuvable : " + number);
    return;
  }

// üîí normalisation + calcul AU MOMENT D‚ÄôOUVRIR
normalizeInvoiceTaxes(inv);
recalcInvoice(inv);

  // Aller sur la page Factures
  showPage("page-invoice-list");

  // üîÑ S‚Äôassurer que la liste est rendue (sinon updateInvoiceRow ne trouve aucune ligne)
  if (typeof renderInvoiceList === "function") renderInvoiceList();

  // Injecter le r√©sum√© dans un modal
  if ($("invoiceEditModal")){
    $("invoiceEditContent").innerHTML = `
      <div class="card">
        ${renderInvoiceSummary(inv)}
      </div>

            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px;">
        <button class="ghost" onclick="openInvoiceAsWorkOrder('${inv.number}')">
          ‚úèÔ∏è Modifier
        </button>
        <button onclick="printInvoice()">
          üñ®Ô∏è Imprimer
        </button>
      </div>
    `;

    $("invoiceEditModal").style.display = "flex";

    
    setTimeout(() => {
  const gstBox = document.getElementById("invApplyGST");
  const qstBox = document.getElementById("invApplyQST");

  if (!gstBox && !qstBox) return;

  // refl√©ter l‚Äô√©tat sauvegard√©
  if (gstBox) gstBox.checked = inv.applyGST !== false;
  if (qstBox) qstBox.checked = inv.applyQST !== false;

  const onToggle = () => {
    if (gstBox) inv.applyGST = gstBox.checked;
    if (qstBox) inv.applyQST = qstBox.checked;

    // üî• recalcul VISUEL SEULEMENT
    updateInvoiceTotalsLive(inv);
  };

  if (gstBox) gstBox.onchange = onToggle;
  if (qstBox) qstBox.onchange = onToggle;
}, 0);
  }
}


  function invoiceToTempWO(invoice){
  return {
    __fromInvoice: true,              // üîí flag critique
    __invoiceNumber: invoice.number,  // lien inverse

    id: "INV-" + invoice.number,      // ID virtuel
    number: invoice.number,
    date: invoice.date,

    clientId: invoice.clientId ?? null,
vehicleId: invoice.vehicleId ?? null,
    
    clientName: invoice.customer,
    vehicleLabel: invoice.vehicle,
    vehicleKm: invoice.vehicleKm ?? null,
    status: invoice.status || "draft",

    parts: (invoice.items || [])
      .filter(i => i.type === "Pi√®ce")
      .map(i => ({
        name: i.desc,
        qty: Number(i.qty),
        rate: Number(i.rate),
        total: Number(i.qty) * Number(i.rate)
      })),

    labor: (invoice.items || [])
      .filter(i => i.type === "Main-d'≈ìuvre")
      .map(i => ({
        description: i.desc,
        hours: Number(i.qty),
        rate: Number(i.rate),
        total: Number(i.qty) * Number(i.rate)
      })),

    estimateTotal: invoice.total || 0
  };
}


  /* ===================== FACTURE -> UI WO (MODIF) ===================== */
window.openInvoiceAsWorkOrder = function(number){

  // üî• FERMER LE MODAL FACTURE S'IL EST OUVERT
if ($("invoiceEditModal")) {
  $("invoiceEditModal").style.display = "none";
}

  loadInvoices();

  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv){
    alert("Facture introuvable : " + number);
    return;
  }

  // 1) Convertir la facture en WO temporaire
  const tempWO = invoiceToTempWO(inv);

  // 2) Aller sur la page Work Orders (UI identique)
  showPage("page-workorders");

  initWorkOrdersModule(); // üîë charge l‚ÄôUI compl√®te du Work Order

  // 3) Masquer la liste et afficher le d√©tail
  if ($("woListCard")) $("woListCard").style.display = "none";
  if ($("woDetailCard")) $("woDetailCard").style.display = "block";

  // 4) Marquer ce WO comme "actif"
  window.__currentWO = tempWO;
  window.__currentTempWO = tempWO;

  // Important : si ton moteur WO utilise woEditId pour retrouver le WO actif
  if ($("woEditId")) $("woEditId").value = String(tempWO.id);

  // 5) Rendre la facture avec EXACTEMENT le moteur WO
  renderInvoiceAsWO(tempWO);
};


    /* =========================================================
   PONT: FACTURE (INVOICES) <-> WO UI (WORKORDERS)
   ========================================================= */

/* 1) Trouver le "WO actif" : vrai WO OU facture en mode WO */
function getActiveWOById(woId){
  // vrai WO
  const real = WORKORDERS.find(w => String(w.id) === String(woId));
  if (real) return real;

  // facture ouverte comme WO temporaire
  if (window.__currentTempWO && String(window.__currentTempWO.id) === String(woId)){
    return window.__currentTempWO;
  }

  // fallback (au cas o√π)
  if (window.__currentWO && String(window.__currentWO.id) === String(woId)){
    return window.__currentWO;
  }

  return null;
}

  
  function backToInvoiceList(){
  // üßπ 1) NETTOYER LE MODE FACTURE
  window.__currentTempWO = null;
  window.__currentWO = null;
  window.currentEditingInvoice = null;

  // üßπ 2) R√âTABLIR L‚ÄôUI WORK ORDERS
  if ($("woDetailCard")) $("woDetailCard").style.display = "none";
  if ($("woListCard")) $("woListCard").style.display = "block";

  // üßπ 3) VIDER LE CONTENU D√âTAIL
  if ($("woDetailContent")) $("woDetailContent").innerHTML = "";

  // üß≠ 4) RETOUR √Ä LA LISTE DES FACTURES
  showPage("page-invoice-list");
}

  
/* 2) Sauver: si c'est une facture -> INVOICES, sinon -> WORKORDERS */
function persistActiveWO(wo){
  if (!wo || !wo.id) return;

  // üîÅ MODE FACTURE (WO temporaire)
  if (wo.__fromInvoice){
    saveTempWOToInvoice(wo);
    return;
  }

  // üî¢ recalcul total estim√©
  const partsTotal = (wo.parts || []).reduce(
    (s,p)=> s + Number(p.total || (p.qty * p.rate) || 0), 0
  );

  const laborTotal = (wo.labor || []).reduce(
    (s,l)=> s + Number(l.total || (l.hours * l.rate) || 0), 0
  );

  wo.estimateTotal = partsTotal + laborTotal;

  // üîÅ remettre le WO modifi√© dans WORKORDERS
  const idx = WORKORDERS.findIndex(w => String(w.id) === String(wo.id));
  if (idx !== -1){
    WORKORDERS[idx] = wo;
  } else {
    WORKORDERS.push(wo);
  }

  // üî• NOUVEAU ‚Äî synchroniser facture li√©e
  const invoice = INVOICES.find(inv =>
    String(inv.workOrderNumber) === String(wo.number)
  );

  if (invoice?.status === "paid") return;
  
  if (invoice){

    invoice.items = [];

    // Pi√®ces
    (wo.parts || []).forEach(p => {
      invoice.items.push({
        type: "Pi√®ce",
        desc: p.name,
        qty: p.qty,
        rate: p.rate
      });
    });

    // Main-d‚Äô≈ìuvre
    (wo.labor || []).forEach(l => {
      invoice.items.push({
        type: "Main-d'≈ìuvre",
        desc: l.description,
        qty: l.hours,
        rate: l.rate
      });
    });

    recalcInvoice(invoice);
    saveInvoices();
  }

  // üíæ sauvegarde r√©elle
  localStorage.setItem(STORAGE.workorders, JSON.stringify(WORKORDERS));
  scheduleCloudSync();
}


  function startWOTimer(){
  if (WO_TIMER_INTERVAL) return;

  WO_TIMER_START = Date.now() - WO_TIMER_ELAPSED;
  WO_TIMER_PAUSED = false;

  // üîÅ Bascule boutons
  const startBtn = document.getElementById("woTimerBtn");
  const stopBtn  = document.getElementById("woTimerStopBtn");

  if (startBtn) startBtn.style.display = "none";
  if (stopBtn)  stopBtn.style.display  = "inline-block";

  WO_TIMER_INTERVAL = setInterval(() => {
    const elapsed = Date.now() - WO_TIMER_START;

    const display = document.getElementById("woTimerDisplay");
    if (!display) return;

    display.textContent = "‚è± " + formatDuration(elapsed);
  }, 1000);
}


  function pauseWOTimer(){
  if (!WO_TIMER_INTERVAL) return;

  clearInterval(WO_TIMER_INTERVAL);
  WO_TIMER_INTERVAL = null;

  WO_TIMER_ELAPSED = Date.now() - WO_TIMER_START;
  WO_TIMER_PAUSED = true;

  console.log("WO TIMER PAUSED", WO_TIMER_ELAPSED);
}


  function stopWOTimer(){
  if (!WO_TIMER_START) return;

  clearInterval(WO_TIMER_INTERVAL);
  WO_TIMER_INTERVAL = null;

  const elapsedMs = Date.now() - WO_TIMER_START;
  WO_TIMER_START = null;

    const totalMs = WO_TIMER_PAUSED ? WO_TIMER_ELAPSED : elapsedMs;

  const hours = Math.round((totalMs / 3600000) * 100) / 100;

  console.log("WO TIMER STOP");
  console.log("Heures calcul√©es :", hours);

  // üîÅ Bascule boutons
  const startBtn = document.getElementById("woTimerBtn");
  const stopBtn  = document.getElementById("woTimerStopBtn");

  if (startBtn) startBtn.style.display = "inline-block";
  if (stopBtn)  stopBtn.style.display  = "none";

  const display = document.getElementById("woTimerDisplay");
  if (display){
    display.textContent = "‚è± 00:00:00";
  }

      // ===============================
  // AJOUT MAIN-D‚Äô≈íUVRE AU WO
  // ===============================
  const woId = document.getElementById("woEditId")?.value;
  if (!woId) return;

  const wo = getActiveWOById(woId);
  if (!wo) return;

  if (!Array.isArray(wo.labor)) wo.labor = [];

  const rate = Number(SETTINGS.defaultLaborRate || 60);

  wo.labor.push({
    description: "Temps de travail (timer)",
    hours: hours,
    rate: rate,
    total: Math.round(hours * rate * 100) / 100
  });

  persistActiveWO(wo);
  woRenderLines(wo);

    WO_TIMER_ELAPSED = 0;
WO_TIMER_PAUSED = false;

}


  function syncWOTimerUI(){
  const startBtn = document.getElementById("woTimerBtn");
  const stopBtn  = document.getElementById("woTimerStopBtn");

  if (!startBtn || !stopBtn) return;

  const pauseBtn = document.getElementById("woTimerPauseBtn");

if (WO_TIMER_INTERVAL){
  startBtn.style.display = "none";
  stopBtn.style.display  = "inline-block";
  if (pauseBtn) pauseBtn.style.display = "inline-block";
} else {
  startBtn.style.display = "inline-block";
  stopBtn.style.display  = "none";
  if (pauseBtn) pauseBtn.style.display = "none";
}
}


  function formatDuration(ms){
  const totalSec = Math.floor(ms / 1000);
  const h = String(Math.floor(totalSec / 3600)).padStart(2,"0");
  const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2,"0");
  const s = String(totalSec % 60).padStart(2,"0");
  return `${h}:${m}:${s}`;
}


function returnToWOListFromDetail(){
  if (!$("woDetailCard") || $("woDetailCard").style.display === "none"){
    return;
  }

  const woId = $("woEditId")?.value;
  if (woId){
    const wo = getActiveWOById(woId);
    if (wo){
      persistActiveWO(wo);
    }
  }

  $("woDetailCard").style.display = "none";
  $("woListCard").style.display = "block";

  initWorkOrdersModule(); // ‚úÖ bon rendu
}


  
  function saveInvoiceFromWO(){
  const wo = window.__currentTempWO;
  if (!wo){
    alert("Aucune facture en cours de modification.");
    return;
  }

  // üîí 1) Enregistrer les modifications dans la facture
  persistActiveWO(wo);

  const invoiceNumber = wo.number; // garder le num√©ro AVANT nettoyage

  // üîÑ 2) Recharger les factures
  loadInvoices();

  // üßπ 3) Nettoyer l‚Äô√©tat Work Order / Facture
  window.__currentTempWO = null;
  window.__currentWO = null;
  window.currentEditingInvoice = null;

  if ($("woDetailCard")) $("woDetailCard").style.display = "none";
  if ($("woListCard")) $("woListCard").style.display = "block";
  if ($("woDetailContent")) $("woDetailContent").innerHTML = "";

  // üß≠ 4) Retour √† la page Factures
  showPage("page-invoice-list");

  // ü™ü 5) Rouvrir le MODAL de la facture modifi√©e
  setTimeout(()=>{
    openInvoiceEditModal(invoiceNumber);
  }, 50);
}

  
/* 3) Sauver le WO temporaire dans la facture (remplace items, recalcule totaux) */
function saveTempWOToInvoice(tempWO){
  if (!tempWO?.__fromInvoice) return;

  loadInvoices();

  const invNumber = tempWO.__invoiceNumber || String(tempWO.id || "").replace("INV-","");
  const inv = INVOICES.find(i => String(i.number) === String(invNumber));
  if (!inv){
    alert("Facture introuvable pour sauvegarde.");
    return;
  }

  // mettre √† jour infos visibles
  inv.customer = tempWO.clientName || inv.customer;
  inv.vehicle  = tempWO.vehicleLabel || inv.vehicle;

  // RECONSTRUIRE items (IMPORTANT: remplace, n'ajoute pas -> √©vite doublons)
  const items = [];

  (tempWO.parts || []).forEach(p=>{
    items.push({
      type: "Pi√®ce",
      desc: `${p.name || ""}${p.number ? " (#"+p.number+")" : ""}`.trim(),
      qty: Number(p.qty) || 0,
      rate: Number(p.rate) || 0,
      total: (Number(p.qty) || 0) * (Number(p.rate) || 0)
    });
  });

  (tempWO.labor || []).forEach(l=>{
    items.push({
      type: "Main-d'≈ìuvre",
      desc: l.description || "",
      qty: Number(l.hours) || 0,
      rate: Number(l.rate) || 0,
      total: (Number(l.hours) || 0) * (Number(l.rate) || 0)
    });
  });

  inv.items = items;

  // Totaux (centralis√©s)
const totals = calcInvoiceTotals(inv);
inv.subTotal = totals.subTotal;
inv.gst      = totals.gst;
inv.qst      = totals.qst;
inv.total    = totals.total;

  saveInvoices();

  // refresh UI
  if (typeof renderInvoiceList === "function") renderInvoiceList();
  if (typeof renderHistoryTable === "function") renderHistoryTable();
  if (typeof renderDashboard === "function") renderDashboard();
}


function renderInvoiceAsWO(wo){

  // ===== CALCUL FACTURE PAY√âE =====
let totalPaid = 0;

if (Array.isArray(wo.payments)){
  wo.payments.forEach(p=>{
    totalPaid += Number(p.amount || 0);
  });
}

const isPaid = totalPaid >= Number(wo.total || 0);

  const detail = $("woDetailContent");
  if (!detail) return;

  // üîë R√©utiliser EXACTEMENT le layout du Work Order
  detail.innerHTML = `

  <!-- BARRE D‚ÄôACTIONS (HAUT) -->
<div class="card">
  <button class="ghost" onclick="backToInvoiceList()">‚¨Ö Retour aux factures</button>
</div>

    <div class="card">
 <h2>
  Facture #${wo.number}
</h2>

  <p class="muted">Modification de facture (UI bon de travail)</p>

  <p>
    <b>Client :</b> ${wo.clientName}
  </p>

  <p>
    <b>V√©hicule :</b> ${wo.vehicleLabel}
  </p>

  <p style="margin-top:6px;">
  <b>Kilom√©trage :</b>
  <input
    type="number"
    id="woVehicleKm"
    value="${wo.vehicleKm ?? ''}"
    placeholder="KM"
    style="width:140px;margin-left:8px;"
    oninput="
      if (window.__currentWO) {
        window.__currentWO.vehicleKm = Number(this.value) || null;
      }
    "
  >
</p>
</div>

    <!-- PI√àCES -->
    <div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
  <h3>Pi√®ces</h3>
  <div>
    <button class="ghost" onclick="woAddPartLine(window.__currentTempWO)">‚ûï Pi√®ce Enregistr√©e</button>
    <button class="ghost" onclick="showManualPartBox()">‚ûï Ajouter Pi√®ce</button>
  </div>
</div>

  <table id="woPartsTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Qt√©</th>
        <th>Prix</th>
        <th>Profit</th>
        <th>Total</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="muted">
    Total pi√®ces : <span id="woPartsTotal">0.00 $</span>
  </div>
</div>

  <div id="woManualPartBox" class="card" style="display:none;">
  <h4>Ajouter une pi√®ce manuelle</h4>

  <label>Description</label>
  <input id="woManualPartName" placeholder="Ex: Boulon, huile, joint...">

  <label>Quantit√©</label>
  <input type="number" id="woManualPartQty" value="1" min="1">

  <label>Prix unitaire</label>
  <input type="number" id="woManualPartRate" value="0" step="0.01">

  <div style="display:flex;gap:10px;margin-top:10px;">
    <button class="ghost" onclick="saveManualPart()">üíæ Ajouter</button>
    <button class="ghost" onclick="cancelManualPart()">Annuler</button>
  </div>
</div>


    <!-- MAIN-D‚Äô≈íUVRE -->
    <div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
  <h3>Main-d'≈ìuvre</h3>
  <div>
    <button class="ghost" onclick="woAddLaborLine(window.__currentTempWO)">‚ûï Main-d'≈ìuvre Enregistr√©</button>
    <button class="ghost" onclick="showManualLaborBox()">‚ûï Ajouter Service</button>
  </div>
</div>

  <table id="woLaborTable">
    <thead>
      <tr>
        <th>Description</th>
        <th>Heures</th>
        <th>Taux</th>
        <th>Total</th>
        <th>Profit</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="muted">
    Total main-d'≈ìuvre : <span id="woLaborTotal">0.00 $</span>
  </div>
</div>

<div id="woManualLaborBox" class="card" style="display:none;">
  <h4>Ajouter un service manuel</h4>

  <label>Description</label>
  <input id="woManualLaborDesc" placeholder="Ex: Diagnostic, ajustement, r√©paration...">

  <label>Heures</label>
  <input type="number" id="woManualLaborHours" value="1" min="0.25" step="0.25">

  <label>Taux horaire</label>
  <input type="number" id="woManualLaborRate" step="0.01">

  <div style="display:flex;gap:10px;margin-top:10px;">
    <button class="ghost" onclick="saveManualLabor()">üíæ Ajouter</button>
    <button class="ghost" onclick="cancelManualLabor()">Annuler</button>
  </div>
</div>


    <!-- TOTAL -->
    <div class="card">
      <h3>Total estim√©</h3>
      <div><strong id="woEstimateTotal">0.00 $</strong></div>
      <div style="text-align:right;">
  <button onclick="saveInvoiceFromWO()">üíæ Enregistrer les modifications</button>
    </div>

  `;

  // üîÅ RENDRE LES LIGNES EXISTANTES (CRITIQUE)
  woRenderLines(wo);

  // üîí Bloquer actions interdites pour facture
  lockInvoiceUI();
}

  
  function showManualPartBox(){
  if ($("woManualPartBox")) {
    $("woManualPartBox").style.display = "block";
  }
}

function cancelManualPart(){
  if ($("woManualPartBox")) {
    $("woManualPartBox").style.display = "none";
  }
}

function saveManualPart(){
  const wo = window.__currentTempWO || window.__currentWO;
  if (!wo) return;

  const name = $("woManualPartName").value.trim();
  const qty  = Number($("woManualPartQty").value);
  const cost = Number($("woManualPartCost").value) || 0;
  const rate = Number($("woManualPartRate").value);

  if (!name || qty <= 0 || rate < 0){
    alert("Informations de la pi√®ce incompl√®tes.");
    return;
  }

  wo.parts.push({
  name,
  qty,
  cost,   // üëà vient du champ
  price: rate
});

  saveWorkOrders();
  woRenderLines(wo);

  // reset + fermer
  $("woManualPartName").value = "";
  $("woManualPartQty").value = 1;
  $("woManualPartCost").value = "";   // üëà AJOUT
  $("woManualPartRate").value = 0;
  $("woManualPartBox").style.display = "none";
}


  function showManualLaborBox(){
  const box = $("woManualLaborBox");
  if (!box) return;

  box.style.display = "block";

  // üîë TAUX HORAIRE PAR D√âFAUT (PARAM√àTRES)
  if ($("woManualLaborRate")) {
    $("woManualLaborRate").value = SETTINGS.defaultHourlyRate || 0;
  }
}


function cancelManualLabor(){
  const box = $("woManualLaborBox");
  if (box){
    box.style.display = "none";
  }
}

function saveManualLabor(){
  const wo = window.__currentTempWO || window.__currentWO;
  if (!wo) return;

  const desc  = $("woManualLaborDesc").value.trim();
  const hours = Number($("woManualLaborHours").value);
  const rate  = Number($("woManualLaborRate").value);

  if (!desc || hours <= 0 || rate < 0){
    alert("Informations du service incompl√®tes.");
    return;
  }

  wo.labor.push({
    description: desc,
    hours,
    rate
  });

  saveWorkOrders();
  woRenderLines(wo);

  // reset + fermer
  $("woManualLaborDesc").value = "";
  $("woManualLaborHours").value = 1;
  $("woManualLaborRate").value = SETTINGS.defaultHourlyRate || 0;
  $("woManualLaborBox").style.display = "none";
}



  function lockInvoiceUI(){
  // supprimer boutons WO non valides
  document.querySelectorAll(
    "button[onclick^='finishWorkOrder'], button[onclick^='deleteWorkOrder']"
  ).forEach(b => b.remove());

  // d√©sactiver changement statut
  const status = $("woStatus");
  if (status) status.disabled = true;
}

  
function loadWorkOrders(){
  WORKORDERS = loadArrayFromStorage(STORAGE.workorders);
}


function saveWorkOrders(){
  localStorage.setItem(STORAGE.workorders, JSON.stringify(WORKORDERS));
  scheduleCloudSync();
}
  

  function saveNewWorkOrder() {
  const clientId = $("woClientSelect")?.value;
  const vehicleId = $("woVehicleSelect")?.value;
  const description = $("woDescription")?.value.trim();
  const status = $("woStatus")?.value;

  if (!clientId) return alert("S√©lectionne un client.");
  if (!vehicleId) return alert("S√©lectionne un v√©hicule.");

  const client = CLIENTS.find(c => String(c.id) === String(clientId));
  const vehicle = client.vehicles.find(v => String(v.id) === String(vehicleId));

  // Cr√©ation du Work Order minimal
  
  // üîÅ Pr√©remplir KM depuis le v√©hicule
  let vehicleKm = 0;
  const clientObj = CLIENTS.find(c => String(c.id) === String(clientId));
  if (clientObj && Array.isArray(clientObj.vehicles)){
    const vehObj = clientObj.vehicles.find(v => String(v.id) === String(vehicleId));
    if (vehObj && vehObj.km){
      vehicleKm = vehObj.km;
    }
  }
const wo = {
    id: Date.now(),
    number: generateWorkOrderNumber(client.name),
    date: new Date().toLocaleString("fr-CA"),
    clientId,
    clientName: client.name,
    vehicleId,
    vehicleLabel: `${vehicle.year} ${vehicle.make} ${vehicle.model}`,
    description,
    notes: "",          // üìù notes techniques
    status: "en_cours",
    parts: [],
    labor: [],
    estimateTotal: 0
  };

WORKORDERS.push(wo);
saveWorkOrders();
renderWorkOrders();

/* üëâ OUVRIR AUTOMATIQUEMENT LE NOUVEAU WO */
showPage("page-workorders");

setTimeout(() => {
  const btn = document.querySelector(
    `tr[data-id="${wo.id}"] button[data-action="open"]`
  );
  if (btn) btn.click();
}, 0);
}

  function renderPartPicker() {
  const list = $("partPickerList");
  const modal = $("partPickerModal");
  list.innerHTML = "";

  if (!PARTS.length) {
    list.innerHTML = `<div class="muted">Aucune pi√®ce enregistr√©e.</div>`;
    modal.style.display = "flex";
    return;
  }

  PARTS.forEach(p => {
    const btn = document.createElement("button");
    btn.dataset.number = p.number;
    btn.style = "width:100%;margin-bottom:6px;";
    btn.className = "ghost";
    btn.innerHTML = `${p.name} ‚Äî ${p.price}$`;

    list.appendChild(btn);
  });

  modal.style.display = "flex";

  // ‚úÖ Activation des checkboxes (taxes par facture) dans CE modal
  const gstBox = document.getElementById("invApplyGST");
  const qstBox = document.getElementById("invApplyQST");

  if (gstBox){
    gstBox.onchange = () => {
      inv.applyGST = gstBox.checked;

      const totals = calcInvoiceTotals(inv);
      inv.subTotal = totals.subTotal;
      inv.gst      = totals.gst;
      inv.qst      = totals.qst;
      inv.total    = totals.total;

      saveInvoices();
      openInvoiceView(inv.number);
    };
  }

  if (qstBox){
    qstBox.onchange = () => {
      inv.applyQST = qstBox.checked;

      const totals = calcInvoiceTotals(inv);
      inv.subTotal = totals.subTotal;
      inv.gst      = totals.gst;
      inv.qst      = totals.qst;
      inv.total    = totals.total;

      saveInvoices();
      openInvoiceView(inv.number);
    };
  }
}

  function renderServicePicker() {
  const list = $("servicePickerList");
  const modal = $("servicePickerModal");
  list.innerHTML = "";

  if (!SERVICES.length) {
    list.innerHTML = `<div class="muted">Aucun service enregistr√©.</div>`;
    modal.style.display = "flex";
    return;
  }

  SERVICES.forEach(s => {
    const btn = document.createElement("button");
    btn.dataset.service = s.id;
    btn.style = "width:100%;margin-bottom:6px;";
    btn.className = "ghost";

    const label = s.priceFixed
      ? `${s.name} ‚Äî ${s.priceFixed}$`
      : `${s.name} ‚Äî ${s.hours || 1}h @ ${s.rate || 60}$/h`;

    btn.innerHTML = label;
    list.appendChild(btn);
  });

  modal.style.display = "flex";
}

  
  /* Ajouter une pi√®ce √† un WO */
function woAddPartLine(wo) {
  const modal = $("partPickerModal");
  const listEl = $("partPickerList");
  if (!modal || !listEl) return;

  // On ouvre le modal
  modal.style.display = "flex";

  // Si tu n'as aucune pi√®ce dans l'inventaire
  if (!PARTS.length) {
    listEl.innerHTML = `<div class="muted">Aucune pi√®ce enregistr√©e dans l'inventaire.</div>`;
    return;
  }

  // On affiche toutes les pi√®ces (on ne touche pas au module facture)
  listEl.innerHTML = PARTS.map((p, idx) => {
    const stock = Number(p.qty || 0);
    return `
      <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;">
        <b>${partIcon(p.category)} ${p.name}</b> <span class="muted">#${p.number || ""}</span><br>
        <span class="muted">Cat√©gorie : ${p.category || "Divers"}</span><br>
        <span class="muted">Stock : ${stock}</span><br>
        <span class="muted">Prix : ${money(p.price || 0)} $</span><br>
        <button class="ghost" data-wo-part-index="${idx}">‚ûï Utiliser pour ce bon</button>
      </div>
    `;
  }).join("");

  // Quand on clique sur "Utiliser pour ce bon"
  listEl.querySelectorAll("button[data-wo-part-index]").forEach(btn => {
    btn.onclick = () => {
      const idx = Number(btn.dataset.woPartIndex);
      const part = PARTS[idx];
      if (!part) return;

      // Demande la quantit√© √† utiliser pour ce Work Order
      const qtyInput = prompt("Quantit√© pour cette pi√®ce sur ce bon de travail :", "1");
      const qty = Number(qtyInput);
      if (!qty || qty <= 0) return;

      const stock = Number(part.qty || 0);
      if (qty > stock) {
        alert("Attention : la quantit√© demand√©e d√©passe le stock actuel (" + stock + ").");
      }

      wo.parts.push({
        name: part.name,
        number: part.number,
        qty,
        rate: Number(part.price || 0),
        total: qty * Number(part.price || 0)
      });

      persistActiveWO(wo);
      woRenderLines(wo);

      modal.style.display = "none";
    };
  });
}


/* Ajouter main-d'≈ìuvre √† un WO */
function woAddLaborLine(wo) {
  const modal = $("servicePickerModal");
  const listEl = $("servicePickerList");
  if (!modal || !listEl) return;

  modal.style.display = "flex";

  if (!SERVICES.length) {
    listEl.innerHTML = `<div class="muted">Aucun service enregistr√©.</div>`;
    return;
  }

  // On r√©utilise la logique d'affichage des services
  listEl.innerHTML = SERVICES.map(s => {
    const typeLabel = s.priceFixed > 0
      ? `Forfait: ${money(s.priceFixed)} $`
      : (s.hours > 0 && s.rate > 0
          ? `${s.hours} h x ${money(s.rate)} $/h`
          : `Non d√©fini`);

    const icon = (typeof SERVICE_ICONS !== "undefined" && SERVICE_ICONS[s.category])
      ? SERVICE_ICONS[s.category]
      : "‚öôÔ∏è";

    return `
      <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;">
        <b>${icon} ${s.name}</b><br>
        <span class="muted">Cat√©gorie : ${s.category || "Divers"}</span><br>
        <span class="muted">Tarification : ${typeLabel}</span><br>
        ${s.desc ? `<div class="muted" style="margin-top:4px;">${s.desc}</div>` : ""}
        <button class="ghost" data-wo-service-id="${s.id}">
          ‚ûï Utiliser pour ce bon
        </button>
      </div>
    `;
  }).join("");

  // Quand on clique sur "Utiliser pour ce bon"
  listEl.querySelectorAll("button[data-wo-service-id]").forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.woServiceId;
      const srv = SERVICES.find(s => String(s.id) === String(id));
      if (!srv) return;

      let hours = 1;
      let rate = 0;

      if (srv.priceFixed > 0) {
        // Forfait : 1 "unit√©" √† prix fixe
        hours = 1;
        rate = Number(srv.priceFixed || 0);
      } else if (srv.hours > 0 && srv.rate > 0) {
        // Tarif horaire
        hours = Number(srv.hours || 0);
        rate = Number(srv.rate || 0);
      }

      wo.labor.push({
        description: srv.name,
        hours,
        rate,
        total: hours * rate
      });

      persistActiveWO(wo);
      woRenderLines(wo);

      modal.style.display = "none";
    };
  });
}

  
function backToWorkOrdersList(){
  $("woDetailContent").innerHTML = "";
  $("woDetailCard").style.display = "none";
  $("woListCard").style.display = "block";
}


function bindWOTimerUI(){
  // temporaire : √©vite le crash global
}
  
  
  /* Rendu des lignes d‚Äôun WO */
function woRenderLines(wo) {
  // pi√®ces
  const pBody = $("woPartsTable").querySelector("tbody");

  pBody.innerHTML = wo.parts.map((p,i)=>{

    const cost  = Number(p.cost || 0);   // prix co√ªtant
    const price = Number(p.rate || 0);   // prix vendu
    const qty   = Number(p.qty || 0);

    const profit = (price - cost) * qty;

    const marginPct = price > 0
  ? ((price - cost) / price) * 100
  : 0;

    return `
  <tr>
    <td>${p.name}</td>
    <td>${qty}</td>
    <td>${money(cost)} $</td>
    <td>${money(price)} $</td>
    <td>${money(price * qty)} $</td>
    <td style="color:${profit >= 0 ? '#4CAF50' : '#ff4d4d'}">
  ${money(profit)} $ 
  <span class="muted">(${marginPct.toFixed(1)}%)</span>
</td>
    <td>
      <button class="ghost" onclick="woEditLine('${wo.id}','part',${i})">‚úèÔ∏è</button>
      <button class="ghost" onclick="woRemovePart('${wo.id}',${i})">üóë</button>
    </td>
  </tr>
`;
  }).join("");


  // ===== SERVICE MANUEL (BON DE TRAVAIL) =====
const manualLaborBtn = document.getElementById("woAddLaborManual");
const manualLaborBox = document.getElementById("woManualLaborBox");

if (manualLaborBtn && manualLaborBox){
  manualLaborBtn.onclick = () => {
  manualLaborBox.style.display = "block";

  // üßº RESET COMPLET DU FORMULAIRE (AJOUT)
  $("woManualLaborDesc").value  = "";
  $("woManualLaborHours").value = 1;
  $("woManualLaborRate").value  = SETTINGS.defaultHourlyRate || 0;
};
}

const manualLaborSave = document.getElementById("woManualLaborSave");
const manualLaborCancel = document.getElementById("woManualLaborCancel");

if (manualLaborSave){
  manualLaborSave.onclick = () => {
    const desc = document.getElementById("woManualLaborDesc").value.trim();
    const hours = Number(document.getElementById("woManualLaborHours").value);
    const rate = Number(document.getElementById("woManualLaborRate").value);

    if (!desc || hours <= 0 || rate <= 0){
      return alert("Informations du service incompl√®tes.");
    }

    wo.labor.push({
      description: desc,
      hours,
      rate,
      total: hours * rate
    });

    saveWorkOrders();
    woRenderLines(wo);

    // reset + fermer
    document.getElementById("woManualLaborDesc").value = "";
    document.getElementById("woManualLaborHours").value = 1;
    document.getElementById("woManualLaborRate").value =
  SETTINGS.defaultHourlyRate || 0;
    manualLaborBox.style.display = "none";
  };
}

if (manualLaborCancel){
  manualLaborCancel.onclick = () => {
    manualLaborBox.style.display = "none";
  };
}


  // main d‚Äô≈ìuvre
const lBody = $("woLaborTable").querySelector("tbody");
lBody.innerHTML = wo.labor.map((l,i)=>{

  const total = l.hours * l.rate;   // üí∞ total = profit (100%)

  return `
    <tr>
      <td>${l.description}</td>
      <td>${l.hours}</td>
      <td>${money(l.rate)} $</td>
      <td>${money(total)} $</td>

      <!-- ‚úÖ NOUVELLE COLONNE PROFIT -->
      <td style="color:#4CAF50;">
        ${money(total)} $ <span class="muted">(100%)</span>
      </td>

      <td>
        <button class="ghost" onclick="woEditLine('${wo.id}','labor',${i})">‚úèÔ∏è</button>
        <button class="ghost" onclick="woRemoveLabor('${wo.id}',${i})">üóë</button>
      </td>
    </tr>
  `;
}).join("");

  // === NOUVEAU : total pi√®ces et total main-d'≈ìuvre ===
  const totalParts = wo.parts.reduce((s,p)=> s + (p.qty * p.rate), 0);
  const totalLabor = wo.labor.reduce((s,l)=> s + (l.hours * l.rate), 0);

  // Affichage s√©par√©
  if ($("woPartsTotal")) $("woPartsTotal").innerText = money(totalParts) + " $";
  if ($("woLaborTotal")) $("woLaborTotal").innerText = money(totalLabor) + " $";

  // === Total estim√© ===
  const total = totalParts + totalLabor;
  wo.estimateTotal = total;

  if ($("woEstimateTotal")) $("woEstimateTotal").innerText = money(total) + " $";

    // === PROFIT TOTAL (pi√®ces + main-d'≈ìuvre) ===

// profit pi√®ces
const profitParts = wo.parts.reduce((sum, p) => {
  const cost  = Number(p.cost || 0);
  const price = Number(p.rate || 0);
  const qty   = Number(p.qty || 0);
  return sum + ((price - cost) * qty);
}, 0);

// profit main-d'≈ìuvre (100 %)
const profitLabor = wo.labor.reduce((sum, l) => {
  return sum + (Number(l.hours || 0) * Number(l.rate || 0));
}, 0);

// profit global
const profitTotal = calcWorkOrderProfit(wo);

if ($("woEstimatedProfit")) {
  $("woEstimatedProfit").innerText = money(profitTotal) + " $";
  $("woEstimatedProfit").style.color =
    profitTotal >= 0 ? "#4CAF50" : "#ff4d4d";
}
  
  saveWorkOrders();
}


  
  function openNewWorkOrderFromDashboard(){
  // 1Ô∏è‚É£ Aller √† la page Bons de travail
  showPage('page-workorders');

  // 2Ô∏è‚É£ Attendre que la page soit visible, puis cliquer sur le vrai bouton
  setTimeout(() => {
    const btn = document.getElementById("btnNewWorkOrder");
    if (btn) btn.click();
  }, 0);
}

  
function formatTime(ms) {
  const totalSec = Math.floor(ms / 1000);
  const h = String(Math.floor(totalSec / 3600)).padStart(2, "0");
  const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, "0");
  const s = String(totalSec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

function updateTimerDisplay() {
  if (!timerDisplay) return;

  const current = WO_TIMER.running
    ? Date.now() - WO_TIMER.startTime + WO_TIMER.elapsed
    : WO_TIMER.elapsed;

  timerDisplay.innerText = "‚è± " + formatTime(current);
}

function woEditLine(woId, type, index) {
  const wo = getActiveWOById(woId);
  if (!wo) return;

  const modal = $("woEditModal");
  const box = $("woEditContent");

  let line = (type === "part") ? wo.parts[index] : wo.labor[index];

  if (type === "part") {
    box.innerHTML = `
  <label>Nom</label>
  <input id="woEditName" value="${line.name}">

  <label>Quantit√©</label>
  <input id="woEditQty" type="number" value="${line.qty}">

  <label>Prix co√ªtant</label>
  <input id="woEditCost" type="number" step="0.01" value="${Number(line.cost || 0)}">

  <label>Prix de vente</label>
  <input id="woEditRate" type="number" step="0.01" value="${line.rate}">
`;
  } else {
    box.innerHTML = `
      <label>Description</label>
      <input id="woEditDesc" value="${line.description}">

      <label>Heures</label>
      <input id="woEditHours" type="number" step="0.1" value="${line.hours}">

      <label>Taux horaire</label>
      <input id="woEditRate" type="number" step="0.01" value="${line.rate}">
    `;
  }

  modal.style.display = "flex";

  $("woEditCancel").onclick = () => modal.style.display = "none";

  $("woEditSave").onclick = () => {
    if (type === "part") {
      line.name = $("woEditName").value;
      line.qty  = Number($("woEditQty").value);
      line.cost = Number($("woEditCost").value) || 0;
      line.rate = Number($("woEditRate").value);
      line.total = line.qty * line.rate;
    } else {
      line.description = $("woEditDesc").value;
      line.hours = Number($("woEditHours").value);
      line.rate = Number($("woEditRate").value);
      line.total = line.hours * line.rate;
    }

    persistActiveWO(wo);
    woRenderLines(wo);

    modal.style.display = "none";
  };
}

  
function woRemovePart(woId,index){
  const wo = getActiveWOById(woId);
  if(!wo) return;
  wo.parts.splice(index,1);
  persistActiveWO(wo);
  woRenderLines(wo);
}

function woRemoveLabor(woId,index){
  const wo = getActiveWOById(woId);
  if(!wo) return;
  wo.labor.splice(index,1);
  persistActiveWO(wo);
  woRenderLines(wo);
}


function renderWorkOrders(){
  const table = $("woTable");
  const tbody = table ? table.querySelector("tbody") : null;
  if (!tbody) return;

  if (!WORKORDERS.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="muted">Aucun bon de travail pour le moment.</td>
      </tr>`;
    return;
  }

  tbody.innerHTML = "";

  const selectedStatus = $("woStatusFilter")?.value || "";
  const search = ($("woSearch")?.value || "").toLowerCase();

  let filtered = WORKORDERS.filter(wo => {

  if (!wo || !wo.id) return false;

  // üîí Masquer WO si facture pay√©e
  const invoice = INVOICES.find(inv =>
    String(inv.workOrderNumber) === String(wo.number)
  );

  if (invoice && invoice.status === "paid") return false;

  if (!["en_cours", "termine"].includes(wo.status)) return false;
  if (selectedStatus && wo.status !== selectedStatus) return false;

  if (search) {
    const clientObj = CLIENTS.find(c =>
      c.id === wo.clientId ||
      c.name === wo.clientName
    );

    const clientNameSearch = clientObj
      ? `${clientObj.lastName || ""} ${clientObj.firstName || ""}`
      : (wo.clientName || "");

    const hay = `
      ${clientNameSearch}
      ${wo.vehicleLabel || ""}
      ${wo.number || ""}
    `.toLowerCase();

    if (!hay.includes(search)) return false;
  }

  return true;
});

  filtered
  .slice()
  .sort((a, b) => {

    // ‚≠ê Priorit√© statut
    if (a.status === "en_cours" && b.status === "termine") return -1;
    if (a.status === "termine" && b.status === "en_cours") return 1;

    // ‚≠ê Sinon tri par date d√©croissante
    return new Date(b.date) - new Date(a.date);

  })
  .forEach(wo => {

    const tr = document.createElement("tr");
    tr.dataset.id = wo.id;

    const clientObj = CLIENTS.find(c =>
      c.id === wo.clientId ||
      c.name === wo.clientName
    );

    const clientNameDisplay = clientObj
      ? `${clientObj.lastName || ""}${clientObj.firstName ? ", " + clientObj.firstName : ""}`.trim()
      : (wo.clientName || "");

    const statusLabel =
      wo.status === "en_cours" ? "En cours" :
      wo.status === "termine"  ? "Termin√©"  :
      wo.status;

    tr.innerHTML = `
      <td>${wo.number || ""}</td>
      <td>${wo.date || ""}</td>
      <td>${clientNameDisplay}</td>
      <td>${wo.vehicleLabel || ""}</td>
      <td id="wo-km-cell-${wo.id}">
        <div>
          <span class="muted">KM :</span>
          <b>${wo.vehicleKm || "-"}</b>
        </div>
      </td>
      <td>
        <span class="status-badge status-${wo.status}">
          ${statusLabel}
        </span>
      </td>
      <td>${money(wo.estimateTotal || 0)} $</td>
      <td>
  <button class="ghost" data-action="open">Ouvrir</button>

  ${
    wo.status !== "termine"
      ? `
        <button class="ghost" onclick="finishWorkOrder(${wo.id})">
          ‚úÖ Termin√©
        </button>

        <button class="ghost danger" onclick="deleteWorkOrder(${wo.id})">
          üóë Supprimer
        </button>
      `
      : ""
  }
</td>
    `;

    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-action='open']").forEach(btn=>{
    btn.onclick = () => {
      const id = btn.closest("tr").dataset.id;
      const wo = WORKORDERS.find(w => String(w.id) === String(id));
      if (wo) openWorkOrderDetail(wo);
    };
  });
}

  
function finishWorkOrder(id){
  const wo = WORKORDERS.find(w => String(w.id) === String(id));
  if(!wo) return alert("Bon de travail introuvable.");

  if (!confirm(`Terminer le bon de travail #${wo.number} et cr√©er une facture ?`)) return;

  // 1) Marquer le WO comme termin√© (HISTORIQUE)
wo.status = "termine";
wo.completedAt = new Date().toISOString();
saveWorkOrders();

// 2Ô∏è‚É£ Construire la facture PRO depuis le WO
const invoice = {
  id: Date.now(),
  number: btToInvoiceNumber(wo.number),
  workOrderNumber: wo.number,
  customer: wo.clientName,
  vehicle: wo.vehicleLabel,
  vehicleKm: wo.vehicleKm || null,
  date: new Date().toLocaleDateString("fr-CA"),
  items: [],
  status: "unpaid",     // unpaid | partial | paid
  paidAmount: 0,
  paidDate: null,
  payments: [],
  locked: true
};
  // üî© PI√àCES
(wo.parts || []).forEach(p=>{
  invoice.items.push({
    type: "Pi√®ce",
    desc: `${p.name}${p.number ? " (#"+p.number+")" : ""}`,
    qty: Number(p.qty),
    rate: Number(p.rate),
    total: Number(p.qty) * Number(p.rate)
  });
});
// üõ†Ô∏è MAIN-D‚Äô≈íUVRE
(wo.labor || []).forEach(l=>{
  invoice.items.push({
    type: "Main-d'≈ìuvre",
    desc: l.description,
    qty: Number(l.hours),
    rate: Number(l.rate),
    total: Number(l.hours) * Number(l.rate)
  });
});
// üí∞ TOTAUX
invoice.subTotal = invoice.items.reduce(
  (s,it)=> s + (it.qty * it.rate), 0
);

invoice.gst = invoice.subTotal * (SETTINGS.gst / 100);
invoice.qst = (invoice.subTotal + invoice.gst) * (SETTINGS.qst / 100);
invoice.total = invoice.subTotal + invoice.gst + invoice.qst;


  INVOICES.push(invoice);
  saveInvoices();

  renderWorkOrders();
  if (typeof renderInvoiceList === "function") renderInvoiceList();
  showPage("page-invoice-list");

  // 3) Ouvrir la facture en r√©sum√© (lecture seule) avec bouton Modifier
  openInvoiceEditModal(invoice.number);
}

  
function deleteWorkOrder(id){
  const wo = WORKORDERS.find(w => String(w.id) === String(id));
  if(!wo) return alert("Bon de travail introuvable.");

  if(!confirm(`Supprimer le bon de travail #${wo.number} ?`)) return;

  WORKORDERS = WORKORDERS.filter(w => String(w.id) !== String(id));
  saveWorkOrders();
  renderWorkOrders();

  // vider le panneau de droite si c'√©tait ouvert
  const detail = $("woDetailContent");
  if (detail) detail.innerHTML = `<div class="muted">Bon de travail supprim√©.</div>`;
}

// ===== Voir un BON DE TRAVAIL dans l'historique =====
function openWorkOrderDetail(wo){
  if (!wo) return;

  // afficher la page WO
  showPage("page-workorders");

  // masquer la liste
  $("woListCard").style.display = "none";
  $("woDetailCard").style.display = "block";

  // üß† IMPORTANT : injecter l‚ÄôID courant
  const hidden = document.createElement("input");
  hidden.type = "hidden";
  hidden.id = "woEditId";
  hidden.value = wo.id;

  const detail = $("woDetailContent");
  detail.innerHTML = "";
  detail.appendChild(hidden);

  // üîπ Pr√©-remplir KM depuis le v√©hicule client si absent dans le WO
  if (!wo.vehicleKm){
    const client = CLIENTS.find(c => c.name === wo.clientName);
    if (client && Array.isArray(client.vehicles)){
      const veh = client.vehicles.find(v =>
        `${v.year} ${v.make} ${v.model}` === wo.vehicleLabel
      );
      if (veh && veh.km){
        wo.vehicleKm = veh.km;
      }
    }
  }

  // üî• UI DU WO
  detail.innerHTML += `
    <div class="card">
      <h2>${wo.__fromInvoice ? "Facture" : "Bon de travail"} #${wo.number}</h2>

      <p><b>Client :</b> ${wo.clientName}</p>
      <p><b>V√©hicule :</b> ${wo.vehicleLabel}</p>

      <p>
        <b>Kilom√©trage :</b>
        <input
          id="woVehicleKmInput"
          type="number"
          min="0"
          value="${wo.vehicleKm || ''}"
          style="
            margin-left:6px;
            width:120px;
            padding:4px;
            border-radius:4px;
            border:1px solid var(--border);
            background:#111;
            color:#fff;
          "
        >
        km
      </p>
    </div>

    <div class="card">
      <h3>Pi√®ces</h3>
      <table id="woPartsTable">
        <thead>
          <tr>
            <th>Description</th>
            <th>Qt√©</th>
            <th>Co√ªt</th>
            <th>Prix</th>
            <th>Total</th>
            <th>Profit</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="text-align:right;margin-top:6px;">
        Total pi√®ces : <b><span id="woPartsTotal">0.00 $</span></b>
      </div>
      <button class="ghost" onclick="woAddPartLine(window.__currentWO)">‚ûï Ajouter une pi√®ce</button>
    </div>

    <div class="card">
      <h3>Main-d‚Äô≈ìuvre</h3>
      <table id="woLaborTable">
        <thead>
          <tr>
            <th>Description</th>
            <th>Heures</th>
            <th>Taux</th>
            <th>Total</th>
            <th>Profit</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="text-align:right;margin-top:6px;">
        Total main-d‚Äô≈ìuvre : <b><span id="woLaborTotal">0.00 $</span></b>
      </div>
      <button class="ghost" onclick="woAddLaborLine(window.__currentWO)">‚ûï Ajouter main-d‚Äô≈ìuvre</button>
    </div>

    <div class="card" style="text-align:right;">
  <h3>
    Total estim√© :
    <span id="woEstimateTotal">0.00 $</span>
  </h3>

  <div class="muted" style="margin-top:6px;">
    Profit estim√© :
    <span id="woEstimatedProfit"
          style="color:#3ddc84;font-weight:600;">
      0.00 $
    </span>
  </div>

  ${
    wo.__fromInvoice
      ? `
        <button class="ghost" onclick="saveTempWOToInvoice(window.__currentWO); alert('Facture enregistr√©e !');">
          üíæ Enregistrer facture
        </button>
        <button class="ghost" onclick="showPage('page-invoice-list')">‚¨Ö Retour</button>
      `
      : `
        <button class="ghost" onclick="backToWorkOrdersList()">‚¨Ö Retour</button>
      `
  }
</div>
  `;

  // m√©moriser le WO actif
  window.__currentWO = wo;

  // üîÅ BIND KM ‚Üí SYNC CENTRALIS√â
  setTimeout(() => {
    const kmInput = document.getElementById("woVehicleKmInput");
    if (!kmInput) return;

    const saveKm = () => {
      if (typeof syncKmEverywhereFromWO === "function"){
        syncKmEverywhereFromWO(wo, kmInput.value);
      }
    };

    kmInput.onchange = saveKm;
    kmInput.onblur   = saveKm;
  }, 0);

  // rendu des lignes
  woRenderLines(wo);

  // üí∞ PROFIT ESTIM√â GLOBAL
if (typeof calcWorkOrderProfit === "function") {
  const profit = calcWorkOrderProfit(wo);

  if ($("woEstimatedProfit")) {
    $("woEstimatedProfit").textContent = money(profit) + " $";
  }
}

    // ===============================
  // TIMER ‚Äì BRANCHEMENT DU BOUTON
  // ===============================
  setTimeout(() => {

  const startBtn = document.getElementById("woTimerBtn");
  const stopBtn  = document.getElementById("woTimerStopBtn");
  const pauseBtn = document.getElementById("woTimerPauseBtn");


  if (!startBtn || !stopBtn){
    console.warn("Boutons timer introuvables");
    return;
  }

    if (pauseBtn){
  pauseBtn.onclick = () => {
    pauseWOTimer();
    syncWOTimerUI();
  };
}

  startBtn.onclick = () => {
    startWOTimer();
    syncWOTimerUI();
  };

  stopBtn.onclick = () => {
    stopWOTimer();
    syncWOTimerUI();
  };

  // üîÅ IMPORTANT : resynchroniser l‚ÄôUI au chargement du WO
  syncWOTimerUI();

}, 0);

}



   // ===============================
  // Cr√©ation de Work-Order + rentrer pi√®ces, main-d'oeuvre, LE MAIN EN FAIT
  // ===============================
function initWorkOrdersModule(){
  loadWorkOrders();
  renderWorkOrders();


  $("woStatusFilter").onchange = renderWorkOrders;
$("woSearch").oninput = renderWorkOrders;

  const btnNew = $("btnNewWorkOrder");
  if (btnNew){
        btnNew.onclick = () => {
  const detail = $("woDetailContent");
  if (!detail) return;

$("woListCard").style.display = "none";
$("woDetailCard").style.display = "block";

  detail.innerHTML = `
    <div class="card" style="max-width:600px;display:grid;gap:10px;">

      <h2>Nouveau bon de travail</h2>
      <button id="woCancelCreateBtn" class="ghost" style="margin-bottom:10px;">
  ‚¨Ö Annuler / Retour
</button>

      <label>Client</label>
      <select id="woClientSelect"></select>
      <button id="woAddClientBtn" class="ghost" style="margin-top:6px;">
  ‚ûï Nouveau client
</button>

      <label>V√©hicule</label>
      <select id="woVehicleSelect">
        <option value="">S√©lectionner un client d'abord</option>
      </select>

      <label>Description</label>
      <textarea id="woDescription" style="min-height:100px;"></textarea>

      <button id="btnSaveWO">üíæ Enregistrer</button>
    </div>
  `;

  // Remplir clients
  const cSel = $("woClientSelect");
  cSel.innerHTML = `<option value="">S√©lectionner</option>`;
  CLIENTS.forEach(c => {
    cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
          
document.addEventListener("client:created", function handler(e){
  const newClient = e.detail;
  if (!newClient || !cSel) return;

  loadClients();

  cSel.innerHTML = `<option value="">S√©lectionner</option>`;
  CLIENTS.forEach(c => {
    cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });

  cSel.value = newClient.id;
  cSel.dispatchEvent(new Event("change"));

  document.removeEventListener("client:created", handler);
});

          
          const btnAddClient = $("woAddClientBtn");
if (btnAddClient){
  btnAddClient.onclick = () => {
    // ouvrir le modal client en mode "nouveau"
    renderClientModal();
    $("clientModal").style.display = "flex";
  };
}


  // Charger v√©hicules
  cSel.onchange = () => {
    const vSel = $("woVehicleSelect");
    vSel.innerHTML = `<option value="">S√©lectionner</option>`;

    const client = CLIENTS.find(c => String(c.id) === String(cSel.value));
    if (!client || !client.vehicles) return;

    client.vehicles.forEach(v => {
  const label = `${v.year} ${v.make} ${v.model}`;
  vSel.innerHTML += `<option value="${v.id}">${label}</option>`;
});
  };

  $("btnSaveWO").onclick = saveNewWorkOrder;
          
          const cancelBtn = $("woCancelCreateBtn");
if (cancelBtn){
  cancelBtn.onclick = () => {
    // vider le formulaire
    $("woDetailContent").innerHTML = "";

    // afficher la liste
    $("woDetailCard").style.display = "block";
    $("woListCard").style.display = "block";
  };
}
};

  const table = $("woTable");
if (table){
  table.onclick = (e) => {
    const btn = e.target.closest("button[data-action='open']");
    if (!btn) return;

    const tr = btn.closest("tr");
    const id = tr?.dataset.id;
    const wo = WORKORDERS.find(w => String(w.id) === String(id));
    const detail = $("woDetailContent");
if(!detail){
  showPage('workorders');
  return;
}
if (!wo) return;


    $("woListCard").style.display = "none";
$("woDetailCard").style.display = "block";

const statusLabel =
  wo.status === "en_cours" ? "En cours" :
  wo.status === "termine"  ? "Termin√©"  :
  wo.status;

    detail.innerHTML = `
  <button class="ghost" onclick="backToWorkOrdersList()" style="margin-bottom:10px;">
    ‚¨Ö Retour aux bons de travail
  </button>

  <input type="hidden" id="woEditId" value="${wo.id}">


  <!-- EN-T√äTE -->
  <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
    <div>
      <h2 style="margin:0;">Bon de travail #${wo.number}</h2>
      <div class="muted">${wo.date || ""}</div>
      <div style="margin-top:6px;">
  <b>Client :</b> ${wo.clientName || ""}<br>
  <b>V√©hicule :</b> ${wo.vehicleLabel || ""}<br>
  <div>
  Kilom√©trage :
  <input
    id="woKmInput"
    type="number"
    value="${wo.vehicleKm || ''}"
    style="
      width:120px;
      padding:4px;
      border-radius:4px;
      border:1px solid var(--border);
      background:#111;
      color:#fff;
    "
  > km
</div>
  <b>Description Probl√®me/Travail :</b>
<span style="
  background: #ffeb3b;
  color: #000;
  padding: 2px 6px;
  border-radius: 4px;
">
  ${wo.description || "‚Äî"}
</span>
</div>
    </div>

    <span class="status-badge status-${wo.status}">
      ${statusLabel}
    </span>
  </div>


  <!-- PI√àCES -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
  <h3 style="margin:0;">üß© Pi√®ces</h3>
  <div style="display:flex;gap:6px;">
    <button id="woAddPart" class="ghost">‚ûï Pi√®ce enregistr√©e</button>
    <button id="woAddPartManual" class="ghost">‚ûï Ajouter pi√®ce</button>
  </div>
</div>

    <table id="woPartsTable" style="margin-top:10px;">
      <thead>
        <tr>
  <th>Nom</th>
  <th>Qt√©</th>
  <th>Co√ªt</th>
  <th>Prix</th>
  <th>Total</th>
  <th>Profit</th>
  <th></th>
</tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="woManualPartBox" class="card" style="display:none;margin-top:10px;">
  <h4>‚ûï Ajouter une pi√®ce manuellement</h4>

  <label>Nom de la pi√®ce</label>
  <input id="woManualPartName">

  <label>Quantit√©</label>
  <input id="woManualPartQty" type="number" value="1">

  <!-- ‚úÖ NOUVEAU CHAMP -->
  <label>Prix co√ªtant ($)</label>
  <input id="woManualPartCost" type="number" step="0.01">

  <label>Prix de vente ($)</label>
  <input id="woManualPartRate" type="number" step="0.01">

  <div style="display:flex;gap:8px;margin-top:10px;">
    <button id="woManualPartSave">Ajouter</button>
    <button id="woManualPartCancel" class="ghost">Annuler</button>
  </div>
</div>
  </div>

  <!-- MAIN D‚Äô≈íUVRE -->
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
  <div>
    <h3 style="margin:0;">üîß Main-d'≈ìuvre</h3>
    <div id="woTimerDisplay" class="wo-timer-display muted">
      ‚è± 00:00:00
    </div>
  </div>

<div style="display:flex;gap:6px;">
  <button id="woAddLabor" class="ghost">‚ûï Service enregistr√©</button>

  <!-- üÜï NOUVEAU BOUTON -->
  <button id="woAddLaborManual" class="ghost">‚ûï Ajouter Service</button>

  <button id="woTimerBtn" class="ghost">‚ñ∂Ô∏è D√©marrer</button>

  <button id="woTimerStopBtn" class="ghost danger" style="display:none;">
    ‚èπ Arr√™ter
  </button>

  <button id="woTimerPauseBtn" class="ghost" style="display:none;">
  ‚è∏ Pause
</button>

</div>
</div>

    <table id="woLaborTable" style="margin-top:10px;">
      <thead>
        <tr><th>Description</th><th>Heures</th><th>Taux</th><th>Total</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="woManualLaborBox" class="card" style="display:none;margin-top:10px;">
  <h4>‚ûï Ajouter un service manuellement</h4>

  <label>Description</label>
  <input id="woManualLaborDesc">

  <label>Heures</label>
  <input id="woManualLaborHours" type="number" step="0.1" value="1">

  <label>Taux horaire ($)</label>
  <input id="woManualLaborRate" type="number" step="0.01" value="60">

  <div style="display:flex;gap:8px;margin-top:10px;">
    <button id="woManualLaborSave">Ajouter</button>
    <button id="woManualLaborCancel" class="ghost">Annuler</button>
  </div>
</div>


  <!-- R√âSUM√â -->
  <div class="card" style="text-align:right;">
    <div class="muted">Pi√®ces : <span id="woPartsTotal">0 $</span></div>
    <div class="muted">Main-d'≈ìuvre : <span id="woLaborTotal">0 $</span></div>
    <h3 style="margin-top:10px;">Total estim√© : <span id="woEstimateTotal">0 $</span></h3>
    <div>
  <b>Profit estim√© :</b>
  <span id="woEstimatedProfit" style="color:#4CAF50;">0 $</span>
</div>
  </div>


<!-- NOTES TECHNIQUES -->
<div class="card">
  <h3>üìù Notes techniques</h3>
  <textarea
    id="woNotes"
    placeholder="D√©cris le diagnostic, les r√©parations effectu√©es, observations, etc."
    style="min-height:140px;"
  ></textarea>
  <div class="muted" style="margin-top:6px;">
    Ces notes sont sauvegard√©es automatiquement pour ce bon de travail.
  </div>
</div>


  <!-- ACTIONS -->
  <div class="card" style="display:flex;justify-content:flex-end;gap:10px;">
    <button id="woSaveBtn">üíæ Enregistrer</button>
    <button class="ghost" onclick="finishWorkOrder(${wo.id})">‚úÖ Termin√©</button>
    <button class="danger" onclick="deleteWorkOrder(${wo.id})">üóë Supprimer</button>
  </div>
`;


    // Bind boutons (safe) ‚Äî DOIT √äTRE DANS LE SCOPE DE wo
const btnAddPart  = $("woAddPart");
const btnAddLabor = $("woAddLabor");

if (btnAddPart){
  btnAddPart.onclick = () => woAddPartLine(wo);
}

if (btnAddLabor){
  btnAddLabor.onclick = () => woAddLaborLine(wo);
}


    // ================= KM sauvegarde =================
setTimeout(() => {
  const kmInput = document.getElementById("woKmInput");
  if (!kmInput) return;

  const saveKm = () => {
    syncKmEverywhereFromWO(wo, kmInput.value);

    // üî• INVALIDATION CACHE V√âHICULES (OBLIGATOIRE)
    if (typeof VEHICLES_FLAT !== "undefined"){
      VEHICLES_FLAT = [];
    }

    // üîÑ UI live update ‚Äî LISTES
    if (typeof renderWorkOrders === "function"){
      renderWorkOrders();
    }

    if (typeof renderVehiclesPage === "function"){
      renderVehiclesPage();
    }

    // üîÑ cellule locale (s√©curit√©)
    const kmCell = document.getElementById("wo-km-cell-" + wo.id);
    if (kmCell){
      kmCell.textContent = wo.vehicleKm + " km";
    }
  };

  // ‚úÖ sauvegarde quand la valeur est finale
  kmInput.onchange = saveKm;
  kmInput.onblur   = saveKm;

}, 0);

    
    woRenderLines(wo);

    // === AJOUT PI√àCE MANUELLE ===
const manualBtn = document.getElementById("woAddPartManual");
const manualBox = document.getElementById("woManualPartBox");

if (manualBtn && manualBox){
  manualBtn.onclick = () => {
    manualBox.style.display = "block";
  };
}

    const saveManualBtn = document.getElementById("woManualPartSave");
const cancelManualBtn = document.getElementById("woManualPartCancel");

if (saveManualBtn){
  saveManualBtn.onclick = () => {
    const name = document.getElementById("woManualPartName").value.trim();
    const qty = Number(document.getElementById("woManualPartQty").value);
    const rate = Number(document.getElementById("woManualPartRate").value);

    if (!name || qty <= 0 || rate <= 0){
      return alert("Informations de la pi√®ce incompl√®tes.");
    }

    const cost = Number(document.getElementById("woManualPartCost").value) || 0;

wo.parts.push({
  name,
  qty,
  cost,
  rate,
  total: qty * rate
});

    saveWorkOrders();
    woRenderLines(wo);

    // reset + fermer
    document.getElementById("woManualPartName").value = "";
    document.getElementById("woManualPartQty").value = 1;
    document.getElementById("woManualPartRate").value = "";
    manualBox.style.display = "none";
  };
}

if (cancelManualBtn){
  cancelManualBtn.onclick = () => {
    manualBox.style.display = "none";
  };
}

    
    // === NOTES TECHNIQUES DU BON DE TRAVAIL ===
const notesField = document.getElementById("woNotes");
if (notesField){
  notesField.value = wo.notes || "";

  notesField.oninput = () => {
    wo.notes = notesField.value;
    saveWorkOrders();
  };
}

initWorkOrderSaveButton();

  }; // ‚úÖ fin table.onclick
} // ‚úÖ fin if(table)
} // ‚úÖ fin initWorkOrdersModule
}

    
// ===== TIMER MAIN-D‚Äô≈íUVRE (VERSION STABLE) =====
let WO_TIMER = {
  running: false,
  startTime: null,
  elapsed: 0,
  intervalId: null
};

let timerBtn = null;
let timerDisplay = null;
let stopBtn = null;

// ‚úÖ FONCTION APPEL√âE PAR L‚ÄôINPUT HTML
function saveWorkOrderVehicleKm(woId, kmValue){
  const wo = WORKORDERS.find(w => String(w.id) === String(woId));
  if (!wo) return;

  syncKmEverywhereFromWO(wo, kmValue);
}


function bindWOTimerUI(){
  timerBtn = document.getElementById("woTimerBtn");
  timerDisplay = document.getElementById("woTimerDisplay");
  stopBtn = document.getElementById("woTimerStopBtn");

  if (!timerBtn || !timerDisplay || !stopBtn) return;

  // reset button visibility based on state
  timerBtn.style.display = WO_TIMER.running ? "none" : "inline-block";
  stopBtn.style.display = WO_TIMER.running ? "inline-block" : "none";

  timerBtn.onclick = () => {
    if (WO_TIMER.running) return;
    WO_TIMER.running = true;
    WO_TIMER.startTime = Date.now();
    timerBtn.style.display = "none";
    stopBtn.style.display = "inline-block";
    if (WO_TIMER.intervalId) clearInterval(WO_TIMER.intervalId);
    WO_TIMER.intervalId = setInterval(updateTimerDisplay, 250);
    updateTimerDisplay();
  };

  stopBtn.onclick = () => {
    if (!WO_TIMER.running) return;
    WO_TIMER.running = false;
    WO_TIMER.elapsed += Date.now() - WO_TIMER.startTime;
    WO_TIMER.startTime = 0;
    if (WO_TIMER.intervalId) clearInterval(WO_TIMER.intervalId);
    WO_TIMER.intervalId = null;
    timerBtn.style.display = "inline-block";
    stopBtn.style.display = "none";
    updateTimerDisplay();
  };

  updateTimerDisplay();
}

    
if (stopBtn) {
  stopBtn.onclick = () => {

    // 1Ô∏è‚É£ Si le timer roulait, on ajoute le dernier segment
    if (WO_TIMER.running && WO_TIMER.startTime) {
      WO_TIMER.elapsed += Date.now() - WO_TIMER.startTime;
    }

    // 2Ô∏è‚É£ STOPPER l‚Äôinterval (OBLIGATOIRE)
    clearInterval(WO_TIMER.intervalId);
    WO_TIMER.intervalId = null;

    // 3Ô∏è‚É£ Calcul des heures finales
    const hours = +(WO_TIMER.elapsed / 3600000).toFixed(2);
    if (hours <= 0) {
      alert("Aucun temps enregistr√©.");
      return;
    }

    const rate = Number(prompt("Taux horaire :", 60)) || 60;

    // 4Ô∏è‚É£ Ajouter la main-d'≈ìuvre au WO
    wo.labor.push({
      description: "Main-d'≈ìuvre (timer)",
      hours,
      rate,
      total: hours * rate
    });

    // 5Ô∏è‚É£ RESET COMPLET DU TIMER
    WO_TIMER.running = false;
    WO_TIMER.startTime = null;
    WO_TIMER.elapsed = 0;

    // 6Ô∏è‚É£ Reset UI
    if (timerDisplay) timerDisplay.innerText = "‚è± 00:00:00";
    if (timerBtn) {
      timerBtn.innerText = "‚ñ∂Ô∏è D√©marrer";
      timerBtn.classList.remove("warning");
    }
  }

function updateTimerDisplay(){
  if (!timerDisplay) return;
  const current = WO_TIMER.running
    ? Date.now() - WO_TIMER.startTime + WO_TIMER.elapsed
    : WO_TIMER.elapsed;
  timerDisplay.innerText = "‚è± " + formatTime(current);
}

if (timerBtn){
  timerBtn.onclick = () => {

    // ‚ñ∂Ô∏è D√âMARRER / REPRENDRE
    if (!WO_TIMER.running){
      WO_TIMER.running = true;
      WO_TIMER.startTime = Date.now();

      updateTimerDisplay();
      WO_TIMER.intervalId = setInterval(updateTimerDisplay, 1000);

      timerBtn.innerText = "‚è∏ Pause";
      timerBtn.classList.add("warning");
      if (stopBtn) stopBtn.style.display = "inline-block";
      return;
    }

    // ‚è∏ PAUSE
    WO_TIMER.running = false;
    WO_TIMER.elapsed += Date.now() - WO_TIMER.startTime;
    WO_TIMER.startTime = null;

    clearInterval(WO_TIMER.intervalId);
    WO_TIMER.intervalId = null;

    timerBtn.innerText = "‚ñ∂Ô∏è Reprendre";
    timerBtn.classList.remove("warning");
  };
}

if (stopBtn){
  stopBtn.onclick = () => {

    if (WO_TIMER.running && WO_TIMER.startTime){
      WO_TIMER.elapsed += Date.now() - WO_TIMER.startTime;
    }

    clearInterval(WO_TIMER.intervalId);

    const hours = +(WO_TIMER.elapsed / 3600000).toFixed(2);
    if (hours <= 0){
      alert("Aucun temps enregistr√©.");
      return;
    }

    const rate = Number(prompt("Taux horaire :", 60)) || 60;

    wo.labor.push({
      description: "Main-d'≈ìuvre (timer)",
      hours,
      rate,
      total: hours * rate
    });

    WO_TIMER.running = false;
    WO_TIMER.startTime = null;
    WO_TIMER.elapsed = 0;
    WO_TIMER.intervalId = null;

    timerDisplay.innerText = "‚è± 00:00:00";
    timerBtn.innerText = "‚ñ∂Ô∏è D√©marrer";
    timerBtn.classList.remove("warning");
    stopBtn.style.display = "none";

    woRenderLines(wo);
    saveWorkOrders();
    renderWorkOrders();
  };
}


const saveBtn = $("woSaveBtn");
if (saveBtn){
  saveBtn.onclick = () => {

    // recalcul totals
    const totalParts = wo.parts.reduce((s,p)=> s + (Number(p.rate||0) * Number(p.qty||0)), 0);
    const totalLabor = wo.labor.reduce((s,l)=> s + (Number(l.rate||0) * Number(l.hours||0)), 0);
    wo.estimateTotal = totalParts + totalLabor;

    // refresh panneau de droite (tout de suite)
    if ($("woPartsTotal")) $("woPartsTotal").innerText = money(totalParts) + " $";
    if ($("woLaborTotal")) $("woLaborTotal").innerText = money(totalLabor) + " $";
    if ($("woEstimateTotal")) $("woEstimateTotal").innerText = money(wo.estimateTotal) + " $";

    // save + refresh liste BT + refresh dashboard
    saveWorkOrders();
    renderWorkOrders();
    renderDashboard();

    alert("Modifications enregistr√©es !");
  };
}
  };


  
// === Mise √† jour automatique du menu v√©hicule selon le client ===
if ($("customerSelect") && $("vehicleSelect")) {
  $("customerSelect").onchange = () => {
    const clientName = $("customerSelect").value;
    const client = CLIENTS.find(c => c.name === clientName);
    const vehicleMenu = $("vehicleSelect");

    vehicleMenu.innerHTML = "";

    if (!client) {
      vehicleMenu.innerHTML = `<option value="">‚Äî S√©lectionnez un client ‚Äî</option>`;
      if ($("jobDesc")) $("jobDesc").value = "";
      return;
    }

    if (!client.vehicles || client.vehicles.length === 0) {
      vehicleMenu.innerHTML = `<option value="">‚Äî Aucun v√©hicule enregistr√© ‚Äî</option>`;
      if ($("jobDesc")) $("jobDesc").value = "";
      return;
    }

    client.vehicles.forEach(v => {
      const label = `${v.year || ""} ${v.make || ""} ${v.model || ""}`.trim();
      vehicleMenu.innerHTML += `<option value="${label}">${label}</option>`;
    });

    if ($("jobDesc")) $("jobDesc").value = vehicleMenu.value;
  };
}

// Quand un v√©hicule est s√©lectionn√© ‚Üí mettre la valeur dans jobDesc
if ($("vehicleSelect")) {
  $("vehicleSelect").onchange = () => {
    if ($("jobDesc")) $("jobDesc").value = $("vehicleSelect").value;
  };
}

  
function initWorkOrderSaveButton(){
  const btn = $("woSaveBtn");
  if (!btn) return;

  btn.onclick = () => {

    const editId = $("woEditId")?.value;
    const isEditing = editId && editId !== "";

    // ================= MODE MODIFICATION =================
    if (isEditing){
      const wo = WORKORDERS.find(w => String(w.id) === String(editId));
      if (!wo) return alert("Erreur : bon de travail introuvable.");

      // üîí Description non modifiable ici (elle est dans l'ent√™te)
      // wo.description = $("woDescription")?.value.trim();

      // üîÅ Recalcul COMPLET
      const totalParts = wo.parts.reduce((s,p)=> s + (p.rate * p.qty), 0);
      const totalLabor = wo.labor.reduce((s,l)=> s + (l.rate * l.hours), 0);
      wo.estimateTotal = totalParts + totalLabor;

      const totalProfit = wo.parts.reduce((s,p)=> {
  const qty  = Number(p.qty || 0);
  const rate = Number(p.rate || 0);
  const cost = Number(p.cost || 0);
  return s + ((rate - cost) * qty);
}, 0);

wo.estimateProfit = totalProfit;

if ($("woProfitTotal")) $("woProfitTotal").innerText = money(totalProfit) + " $";

      // üíæ Sauvegarde
      saveWorkOrders();

      // üîÑ RAFRA√éCHISSEMENT IMM√âDIAT
      woRenderLines(wo);      // ‚¨ÖÔ∏è MET √Ä JOUR LES TOTAUX VISIBLES
      renderWorkOrders();     // ‚¨ÖÔ∏è MET √Ä JOUR LA LISTE

      alert("Bon de travail mis √† jour !");
      return;
    }

    // ================= MODE CR√âATION =================
    const clientId = $("woClientSelect")?.value;
    const vehicleId = $("woVehicleSelect")?.value;
    const description = $("woDescription")?.value.trim();

    if (!clientId) return alert("Veuillez choisir un client.");
    if (!vehicleId) return alert("Veuillez choisir un v√©hicule.");

    const client = CLIENTS.find(c => String(c.id) === String(clientId));
    const vehicle = client.vehicles.find(v => String(v.id) === String(vehicleId));

    const wo = {
      id: Date.now(),
      number: "BT-" + Date.now(),
      date: new Date().toLocaleString("fr-CA"),
      clientName: client.name,
      vehicleLabel: `${vehicle.year} ${vehicle.make} ${vehicle.model}`,
      description,
      parts: [],
      labor: [],
      estimateTotal: 0,
      status: "en_cours"
    };

    WORKORDERS.push(wo);
    saveWorkOrders();
    renderWorkOrders();

    alert("Bon de travail cr√©√© !");
  };
}


  

/* ===================== SETTINGS ===================== */
  // ‚úÖ Parse number safe (accepte "90,00" ou "90.00")
function toNum(v, fallback=0){
  if (v === null || v === undefined) return fallback;
  const n = Number(String(v).replace(",", ".").trim());
  return Number.isFinite(n) ? n : fallback;
}


  
  
function loadSettings(){
  try{
    SETTINGS = JSON.parse(localStorage.getItem(STORAGE.settings) || 'null') || SETTINGS;
  }catch(e){}
}


function saveSettings(){
  localStorage.setItem(STORAGE.settings, JSON.stringify(SETTINGS));

  // üî• RECALCULER TOUTES LES FACTURES AVEC LES NOUVEAUX TAUX
  if (Array.isArray(INVOICES)){
    INVOICES.forEach(inv => {
      recalcInvoice(inv);
    });
    saveInvoices(); // sauvegarde + sync
  } else {
    scheduleCloudSync();
  }
}


  // ===============================
// üíæ Sauvegarde des param√®tres
// ===============================
if ($("saveSettings")){
  $("saveSettings").onclick = () => {

    SETTINGS.garageName =
      $("settingGarageName").value.trim() || "Garage";

    SETTINGS.gst =
      Number($("settingGST").value || 0);

    SETTINGS.qst =
      Number($("settingQST").value || 0);

    SETTINGS.defaultHourlyRate =
      Number($("settingDefaultHourlyRate").value || 0);

    localStorage.setItem(
      STORAGE.settings,
      JSON.stringify(SETTINGS)
    );

    scheduleCloudSync();

    updateGarageNameUI();

    alert("Param√®tres enregistr√©s");
  };
}

  
function initSettings(){
  loadSettings();
  
  // üîí DEBUG ‚Äì v√©rifier le taux horaire charg√©
  console.log("Default hourly rate:", SETTINGS.defaultHourlyRate);
  
  if($('settingGarageName')) $('settingGarageName').value = SETTINGS.garageName;
  if($('settingGST')) $('settingGST').value = SETTINGS.gst;
  if($('settingQST')) $('settingQST').value = SETTINGS.qst;
  if($('settingDefaultHourlyRate'))
  $('settingDefaultHourlyRate').value = SETTINGS.defaultHourlyRate || 0;

  if($('saveSettings')){
    $('saveSettings').addEventListener('click',()=>{
      SETTINGS.garageName = $('settingGarageName').value.trim() || SETTINGS.garageName;
      SETTINGS.gst = toNum($('settingGST')?.value, SETTINGS.gst);
      SETTINGS.qst = toNum($('settingQST')?.value, SETTINGS.qst);
      SETTINGS.defaultHourlyRate = toNum($('settingDefaultHourlyRate')?.value, SETTINGS.defaultHourlyRate);
      
      saveSettings();
      alert('Param√®tres enregistr√©s.');
      renderTotals();
    });
  }
}

  // ===================== APPLY DEFAULT RATE TO SERVICES =====================
if ($('applyDefaultRateToServices')){
  $('applyDefaultRateToServices').addEventListener('click', () => {

    // ‚úÖ Toujours lire le champ (pas l'ancienne valeur en m√©moire)
const rate = toNum($('settingDefaultHourlyRate')?.value, 0);

// ‚úÖ On sauvegarde aussi le setting, sinon au refresh √ßa revient en arri√®re
SETTINGS.defaultHourlyRate = rate;
saveSettings();

if (!rate || rate <= 0){
  alert("Taux horaire par d√©faut invalide.");
  return;
}

    const ok = confirm(
      `Appliquer ${rate} $/h √† TOUS les services horaires ?\n\n` +
      `Les forfaits (prix fixes) ne seront PAS modifi√©s.`
    );
    if (!ok) return;

    let updated = 0;

    loadServices(); // s√©curit√©: s'assure d'avoir les services √† jour


    SERVICES.forEach(s => {
      // service horaire = PAS de prix fixe
      if (!s.priceFixed || Number(s.priceFixed) <= 0){
        if (Number(s.rate) !== rate){
          s.rate = rate;
          updated++;
        }
      }
    });

    saveServices();
    renderServices();

    alert(`‚úî ${updated} service(s) mis √† jour.`);
  });
}

/* ===================== INVOICES CORE ===================== */
function loadInvoices(){
  try{
    INVOICES = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
    if(!Array.isArray(INVOICES)) INVOICES=[];
  }catch(e){INVOICES=[];}
}
  
function renderInvoiceList(){
  const table = $("invoiceListTable");
  const tbody = table?.querySelector("tbody");
  if (!tbody) return;

  if (!INVOICES.length){
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="muted">Aucune facture enregistr√©e.</td>
      </tr>
    `;
    return;
  }

  const search = ($("invoiceSearch")?.value || "").toLowerCase();
  const statusFilter = $("invoiceStatusFilter")?.value || "";

  tbody.innerHTML = "";

  INVOICES
  .filter(inv => inv.archived !== true)
  .filter(inv => {

    if (statusFilter){

      if (statusFilter === "pending"){
        if (!["unpaid","pending"].includes(inv.status)) return false;
      }
      else if (inv.status !== statusFilter){
        return false;
      }

    }

    if (search){
      const clientObj = CLIENTS.find(c =>
        c.id === inv.customerId ||
        c.name === inv.customer
      );

      const clientNameSearch = clientObj
        ? `${clientObj.lastName || ""} ${clientObj.firstName || ""}`
        : (inv.customer || "");

      const hay = `
        ${inv.number}
        ${clientNameSearch}
        ${inv.job || ""}
      `.toLowerCase();

      if (!hay.includes(search)) return false;
    }

    return true;
  })
  
    .forEach(inv => {
      const tr = document.createElement("tr");
      tr.dataset.number = inv.number;

      const clientObj = CLIENTS.find(c =>
        c.id === inv.customerId ||
        c.name === inv.customer
      );

      const clientNameDisplay = clientObj
        ? `${clientObj.lastName || ""}${clientObj.firstName ? ", " + clientObj.firstName : ""}`.trim()
        : (inv.customer || "");

      normalizeInvoiceTaxes(inv);
      recalcInvoice(inv);

      tr.innerHTML = `
        <td>${inv.number}</td>
        <td>${inv.date || ""}</td>
        <td>${clientNameDisplay}</td>
        <td class="invoice-total">${money(inv.total)} $</td>
        <td class="invoice-status">
  <span class="status-badge ${
    inv.status === "paid"
      ? "status-paid"
      : inv.status === "partial"
        ? "status-partial"
        : "status-unpaid"
  }">
    ${
      inv.status === "paid"
        ? (inv.paymentMethod === "cash"
            ? "Pay√©e (Comptant)"
            : inv.paymentMethod === "transfer"
              ? "Pay√©e (Virement)"
              : "Pay√©e")
        : inv.status === "partial"
          ? "Partielle"
          : "Impay√©e"
    }
  </span>
</td>
        <td style="text-align:right;">
          <button class="ghost" onclick="openInvoiceEditModal('${inv.number}')">
            Ouvrir
          </button>

          ${
            inv.status === "paid"
              ? `<button class="ghost" onclick="archiveInvoice('${inv.number}')">
                   Archiver
                 </button>`
              : `<button class="ghost danger" onclick="deleteInvoice('${inv.number}')">
                   Supprimer
                 </button>`
          }
        </td>
      `;

      tbody.appendChild(tr);
    });
}


  /* ===================== UPDATE FACTURE DANS LA LISTE ===================== */
function updateInvoiceRow(inv){
  // Supporte les 2 formats possibles de dataset (ancien + nouveau)
  const row =
    document.querySelector(`tr[data-number="${inv.number}"]`) ||
    document.querySelector(`tr[data-invoice-number="${inv.number}"]`);
  if (!row) return;

  // ‚úÖ Total: dans ton tableau c'est la 4e colonne (index 3)
  const totalCell =
    row.querySelector(".invoice-total") ||
    row.children?.[3] ||
    null;
  if (totalCell){
    totalCell.textContent = money(inv.total) + " $";
  }

  // ‚úÖ Statut: dans ton tableau c'est la 5e colonne (index 4)
  const statusCell =
    row.querySelector(".invoice-status") ||
    row.children?.[4] ||
    null;
  if (statusCell){
    statusCell.innerHTML = `
  <span class="status-badge ${
    inv.status === "paid"
      ? "status-paid"
      : inv.status === "partial"
        ? "status-partial"
        : "status-unpaid"
  }">
    ${
      inv.status === "paid"
        ? (inv.paymentMethod === "cash"
            ? "Pay√©e (Comptant)"
            : inv.paymentMethod === "transfer"
              ? "Pay√©e (Virement)"
              : "Pay√©e")
        : inv.status === "partial"
          ? "Partielle"
          : "Impay√©e"
    }
  </span>
`.trim();
  }
}

  
/* ===================== FACTURES ‚Äì ACTIONS ===================== */
const invoiceTableEl = $("invoiceListTable");

if (invoiceTableEl){
  invoiceTableEl.addEventListener("click", (e)=>{

    // üîì OUVRIR FACTURE
    const openBtn = e.target.closest(".btn-open-invoice");
    if (openBtn){
      const tr = openBtn.closest("tr");
      const number = tr?.dataset.number;
      if (number){
        openInvoiceEditModal(number);
      }
      return;
    }

    // MODIFIER FACTURE
    const btnEdit = e.target.closest(".btn-edit-invoice");
if (btnEdit){
  const tr = btnEdit.closest("tr");
  const number = tr?.dataset?.number;
  if (!number) return;

  // IMPORTANT: ouvre l'UI WO-like (pas l'ancien editor)
  openInvoiceAsWO(number);
  return;
}

    // üóë SUPPRIMER FACTURE
    const deleteBtn = e.target.closest(".btn-delete-invoice");
    if (deleteBtn){
      const tr = deleteBtn.closest("tr");
      const number = tr?.dataset.number;
      if (!number) return;

      const idx = INVOICES.findIndex(i => String(i.number) === String(number));
      if (idx === -1) return;

      // üîí BLOQUER SI FACTURE PAY√âE
      if (INVOICES[idx].status === "paid"){
  alert("Impossible de supprimer une facture pay√©e.");
  return;
}

      if (!confirm(`Supprimer la facture #${number} ?`)) return;

      INVOICES.splice(idx, 1);
      saveInvoices();
      renderInvoiceList();
      return;
    }
  });
}


  console.log(
  "GLOBAL openInvoiceEditModal =",
  typeof window.openInvoiceEditModal
);


  function deleteInvoice(number) {
  if (!confirm("Supprimer cette facture ?")) return;

  // Retirer la facture de la liste actuelle
  INVOICES = INVOICES.filter(inv => inv.number !== number);
  saveInvoices();

  // Rafra√Æchir l'affichage des factures
  renderInvoiceList();

  // Mettre √† jour le reste de l‚Äôinterface si les fonctions existent
  if (typeof renderHistoryTable === "function") {
    renderHistoryTable();
  }
  if (typeof renderDashboard === "function") {
    renderDashboard();
  }
}


  function addInvoiceToHistory(inv){
  let HISTORY = JSON.parse(localStorage.getItem("history") || "[]");
  HISTORY.push(inv);
  localStorage.setItem("history", JSON.stringify(HISTORY));
    scheduleCloudSync();
}


/* STOCK & INVENTAIRE */
function loadParts(){
  PARTS = loadArrayFromStorage(STORAGE.parts);
}

  
function saveParts(){
  localStorage.setItem(STORAGE.parts, JSON.stringify(PARTS));
scheduleCloudSync();
}

  
function findInventoryPartFromText(text){
  text = (text||'').toLowerCase();
  for(const p of PARTS){
    const num = String(p.number||'').toLowerCase();
    if(num && text.includes(num)) return p;
  }
  return null;
}

  
function adjustStockForLinkedItem(item, deltaQty){
  if(!item || !item.invNumber) return;
  const num = String(item.invNumber);
  const part = PARTS.find(p=>String(p.number)===num);
  if(!part) return;
  const current = Number(part.qty||0);
  part.qty = current + deltaQty;
  if(part.qty<0) part.qty=0;
  saveParts();
  renderDashboard();
}

  
function linkNewItemToInventory(item){
  if(!item || !item.desc || !item.type || !item.type.toLowerCase().includes('pi√®ce')) return;
  const part = findInventoryPartFromText(item.desc);
  if(!part) return;
  const qty = Number(item.qty)||1;
  const currentQty = Number(part.qty||0);
  if(currentQty<qty){
    alert("Stock insuffisant pour cette pi√®ce en inventaire.");
    return false;
  }
  part.qty = currentQty - qty;
  item.invNumber = part.number;
  saveParts();
  renderDashboard();
  return true;
}
  

/* RENDER ITEMS & TOTALS */
function renderTotals(subTotalOverride){
  const sub = (typeof subTotalOverride === 'number') ? subTotalOverride
               : items.reduce((s,it)=>s+it.qty*it.rate,0);
  const gstRate = Number(SETTINGS.gst||5)/100;
  const qstRate = Number(SETTINGS.qst||9.975)/100;

  const gst = sub * gstRate;
  const qst = (sub + gst) * qstRate;
  const total = sub + gst + qst;

  if($('subTotal')) $('subTotal').innerText = money(sub);
  if($('gstAmount')) $('gstAmount').innerText = money(gst);
  if($('qstAmount')) $('qstAmount').innerText = money(qst);
  if($('totalAmount')) $('totalAmount').innerText = money(total);
}


  function renderItems(){
  const tbody = document.querySelector("#itemsTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  items.forEach((it, i) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <select onchange="updateInvoiceItem(${i}, 'type', this.value)">
          <option ${it.type==="Pi√®ce"?"selected":""}>Pi√®ce</option>
          <option ${it.type==="Main-d'≈ìuvre"?"selected":""}>Main-d'≈ìuvre</option>
        </select>
      </td>

      <td>
        <input value="${escapeHTML(it.desc)}"
               onchange="updateInvoiceItem(${i}, 'desc', this.value)">
      </td>

      <td>
        <input type="number" step="0.01" min="0"
               value="${it.qty}"
               onchange="updateInvoiceItem(${i}, 'qty', this.value)">
      </td>

      <td>
        <input type="number" step="0.01" min="0"
               value="${it.rate}"
               onchange="updateInvoiceItem(${i}, 'rate', this.value)">
      </td>

      <td>${money(it.qty * it.rate)} $</td>

      <td>
        <button class="ghost danger"
                onclick="removeInvoiceItem(${i})">üóë</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}


  function addItem(){
  items.push({
    type: "Pi√®ce",
    desc: "",
    qty: 1,
    rate: 0
  });
  invoiceCalcTotals();
  renderItems();
}
  

function removeItem(i){
  const item = items[i];
  if(item && item.invNumber){
    const qty = Number(item.qty)||1;
    adjustStockForLinkedItem(item, qty);
  }
  items.splice(i,1);
  renderItems();
}

if($('clearItems')){
  $('clearItems').addEventListener('click',()=>{
    if(!items.length) return;
    if(!confirm("Vider tous les articles de la facture ?")) return;
    items.forEach(it=>{
      if(it.invNumber){
        const qty = Number(it.qty)||1;
        adjustStockForLinkedItem(it, qty);
      }
    });
    items=[];
    renderItems();
  });
}

/* ADD PART & LABOR */
if($('addPart')){
  $('addPart').addEventListener('click',()=>{
    const name = $('partName').value.trim();
    const qty = Number($('partQty').value)||0;
    const price = Number($('partPrice').value)||0;
    if(!name || qty<=0) return alert("Informations pi√®ce incompl√®tes");
    const newItem = {type:'Pi√®ce',desc:name,qty,rate:price};
    const linkedOk = linkNewItemToInventory(newItem);
    if(linkedOk===false) return;
    items.push(newItem);
    $('partName').value='';
    $('partPrice').value='';
    $('partQty').value=1;
    renderItems();
  });
}
if($('addLabor')){
  $('addLabor').addEventListener('click',()=>{
    const desc=$('laborDesc').value.trim();
    const hours=Number($('laborHours').value)||0;
    const rate=Number($('laborRate').value)||0;
    if(!desc || hours<=0 || rate<=0) return alert("Infos main-d'≈ìuvre incompl√®tes");
    items.push({type:"Main-d'≈ìuvre",desc,qty:hours,rate});
    $('laborDesc').value='';
    $('laborHours').value='';
    $('laborRate').value='';
    renderItems();
  });
}

/* INVOICE NUMBERS */
function nextInvoiceNumber(){
  let num = Number(localStorage.getItem(STORAGE.invoiceCounter)||0);
  num++;
  localStorage.setItem(STORAGE.invoiceCounter, String(num));
  scheduleCloudSync();
  return num;
}
function resetInvoiceForm(){
  // On vide la s√©lection client (nouveau select)
  if ($('customerSelect')) {
    $('customerSelect').value = '';
  }

  // On vide la description du job si le champ existe
  if ($('jobDesc')) {
    $('jobDesc').value = '';
  }

  // On vide les items de la facture
  items = [];
  renderItems();

  // On met le prochain num√©ro de facture
  if ($('invoiceNumber')) {
    $('invoiceNumber').value = nextInvoiceNumber();
  }
}

/* SAVE INVOICE (NEW) */
function renderInvoicesTable(){
  // plus de table sur la page Factures; on met √† jour Historique + Dashboard
  renderHistoryTable();
  renderDashboard();
}

  
if($('saveInvoice')){
  $('saveInvoice').addEventListener('click',()=>{

  // üö´ INTERDICTION CR√âATION MANUELLE DE FACTURE
  if (!window.currentEditingInvoice){
    alert("La cr√©ation de facture est d√©sactiv√©e.\nVeuillez passer par un bon de travail.");
    return;
  }

  if(!items.length) return alert("Aucun article dans la facture.");


    let customerId, job;

// üîí MODE MODIFICATION : reprendre les valeurs existantes
if (window.currentEditingInvoice){
  customerId = CLIENTS.find(c => c.name === window.currentEditingInvoice.customer)?.id || "";
  job = window.currentEditingInvoice.vehicle || "";
} else {
  // (normalement plus utilis√©, mais s√©curis√©)
  customerId = $("customerSelect").value;
  job = $("vehicleSelect").value || "";
}


    // üîí ANTI-CONTOURNEMENT ABSOLU
    if (window.currentEditingInvoice){
      customerId = CLIENTS.find(c => c.name === window.currentEditingInvoice.customer)?.id || customerId;
      job = window.currentEditingInvoice.job || job;

      $("customerSelect").value = customerId;
      $("vehicleSelect").value  = job;
    }

    if(!customerId){
      alert("Veuillez s√©lectionner un client.");
      return;
    }

    const clientObj = CLIENTS.find(c => String(c.id) === String(customerId));
    const cust = clientObj ? clientObj.name : "Client inconnu";

    const number = $('invoiceNumber').value || nextInvoiceNumber();
    const dateStr = new Date().toLocaleDateString('fr-CA');

    const sub = items.reduce((s,it)=>s+it.rate*it.qty,0);
    const gst = sub*(SETTINGS.gst/100);
    const qst = (sub+gst)*(SETTINGS.qst/100);
    const total = sub+gst+qst;

    const inv = {
      number,
      date:dateStr,
      customer:cust,
      job,
      items:[...items],
      subTotal:sub,
      gst,
      qst,
      applyGST: true,
      applyQST: true,
      total,
      status: $("invoiceStatus").value
    };

    const existingIndex = INVOICES.findIndex(i => i.number === inv.number);
    if (existingIndex !== -1) INVOICES[existingIndex] = inv;
    else INVOICES.push(inv);

    saveInvoices();
    alert("Facture enregistr√©e.");
    resetInvoiceForm();
    renderInvoicesTable();
  });
}


/* INIT INVOICES */
function initInvoices(){
  loadInvoices();
  loadParts();
  loadClients();
  resetInvoiceForm();
  renderInvoicesTable();
  refreshInvoiceClientSelect();
}

/* ===================== CLIENTS ===================== */
  let clientSortAsc = true;

  let vehEditIndex = null;
  
function loadClients(){
  CLIENTS = loadArrayFromStorage(STORAGE.clients);
}

  
function saveClients(){
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
  scheduleCloudSync();
}

  
  /* ======== AJOUT POUR INVOICES : s√©lectionner un client ======== */
function refreshInvoiceClientSelect() {
  const select = $("customerSelect");
  if (!select) return;
  select.innerHTML = "";

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "-- S√©lectionner un client --";
  select.appendChild(opt0);

  CLIENTS.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    select.appendChild(opt);
  });
}

/* ======== REMPLIR LE MENU DES V√âHICULES ======== */
function refreshVehicleListForInvoice() {
  const cs = $("customerSelect");
  const select = $("vehicleSelect");

  if (!cs || !select) return;

  const customerId = cs.value;
  select.innerHTML = "";

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "-- Choisir un v√©hicule --";
  select.appendChild(opt0);

  if (!customerId) return;

  const clientObj = CLIENTS.find(c => String(c.id) === String(customerId));
  if (!clientObj || !Array.isArray(clientObj.vehicles)) return;

  clientObj.vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = `${v.year} ${v.make} ${v.model} - ${v.plate}`;
    opt.textContent = `${v.year} ${v.make} ${v.model} (${v.plate})`;
    select.appendChild(opt);
  });
}


/* ======== Quand on change de client => Raffra√Æchir les v√©hicules ======== */
const cs = $("customerSelect");
if (cs) {
  cs.addEventListener("change", refreshVehicleListForInvoice);
}

  
/* ======== AJOUT : cr√©er un client pendant une facture ======== */
const btnNewClient = $("btnCreateCustomerFromInvoice");
if (btnNewClient) {
  btnNewClient.onclick = () => {
    const name = prompt("Nom du nouveau client :");
    if (!name) return;

    const phone = prompt("T√©l√©phone (optionnel) :") || "";
    const email = prompt("Email (optionnel) :") || "";
    const address = prompt("Adresse (optionnel) :") || "";

    const newClient = {
      id: Date.now(),
      name,
      phone,
      email,
      address,
      vehicles: []
    };

    CLIENTS.push(newClient);
    saveClients();
    refreshInvoiceClientSelect();

    if ($("customerSelect")) {
      $("customerSelect").value = newClient.id;
    }

    alert("Client ajout√© !");
    renderClientsTable();
  };
}


function renderVehiclesPage(){
  const tbody = document.querySelector('#vehiclesTable tbody');
  
  if(!tbody) return;
  tbody.innerHTML='';

  const q = ($("vehicleSearch")?.value || "").toLowerCase();



  // 1Ô∏è‚É£ Aplatir les v√©hicules
const vehiclesFlat = [];

CLIENTS.forEach(c => {
  (c.vehicles || []).forEach(v => {
    vehiclesFlat.push({
  clientId: c.id,
  vehicleId: v.id,

  clientLastName: c.lastName || "",
  clientFirstName: c.firstName || "",
  clientNameDisplay: `${c.lastName || ""}${c.firstName ? ", " + c.firstName : ""}`.trim(),

  year: Number(v.year || 0),
  make: v.make || "",
  model: v.model || "",
  plate: v.plate || "",
  vin: v.vin || "",
  km: v.km || ""
    });
  });
});

// 2Ô∏è‚É£ Trier
vehiclesFlat.sort((a, b) => {
  let va = "";
  let vb = "";

  switch (VEHICLES_SORT.key) {
    case "client":
  va = a.clientLastName;
  vb = b.clientLastName;
  break;
    case "make":
      va = a.make;
      vb = b.make;
      break;
    case "model":
      va = a.model;
      vb = b.model;
      break;
    case "year":
      va = a.year;
      vb = b.year;
      break;
  }

  if (typeof va === "number") {
    return (va - vb) * VEHICLES_SORT.dir;
  }

  return va.localeCompare(vb, "fr", { sensitivity: "base" }) * VEHICLES_SORT.dir;
});

// 3Ô∏è‚É£ Afficher
vehiclesFlat.forEach(v => {

  // üîç Filtre recherche
  if (q) {
    const hay = `
      ${v.clientNameDisplay}
      ${v.year}
      ${v.make}
      ${v.model}
      ${v.plate}
      ${v.vin}
      ${v.km}
    `.toLowerCase();

    if (!hay.includes(q)) return;
  }

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <button class="link"
        onclick="openClientFromVehicles('${v.clientId}')">
        ${v.clientNameDisplay}
      </button>
    </td>
    <td>${v.year || ""}</td>
    <td>${v.make}</td>
    <td>${v.model}</td>
    <td>${v.plate}</td>
    <td>${v.vin}</td>
    <td>${v.km}</td>
    <td>
  <button class="ghost"
  onclick="openVehicleModal('${v.clientId}','${v.vehicleId}')">
  Fiche
</button>
</td>
  `;
  tbody.appendChild(tr);
});
}


  function renderVehicles(){
  renderVehiclesPage();
}


  if ($("btnAddVehicle")){
  $("btnAddVehicle").onclick = openAddVehicleModal;
}


  function openAddVehicleModal(){
  const sel = $("vehClientSelect");
  sel.innerHTML = `<option value="">‚Äî S√©lectionner un client ‚Äî</option>`;

  CLIENTS.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id;
    o.textContent=c.name;
    sel.appendChild(o);
  });

  $("addVehicleModal").style.display = "flex";
}

function closeAddVehicleModal(){
  $("addVehicleModal").style.display = "none";
}


  function saveNewVehicle(){

  const clientId = $("vehClientSelect").value;
  if (!clientId){
    alert("Veuillez s√©lectionner un client.");
    return;
  }

  const client = CLIENTS.find(c => String(c.id) === String(clientId));
  if (!client){
    alert("Client introuvable.");
    return;
  }

  const vehicle = {
    id: Date.now(),
    year: Number($("vehYear").value) || "",
    make: $("vehMake").value.trim(),
    model: $("vehModel").value.trim(),
    plate: $("vehPlate").value.trim(),
    vin: $("vehVin").value.trim(),
    km: $("vehKm").value.trim()
  };

  if (!vehicle.make || !vehicle.model){
    alert("Marque et mod√®le requis.");
    return;
  }

  client.vehicles = client.vehicles || [];
  client.vehicles.push(vehicle);

  saveClients();
  renderVehiclesPage();
  closeAddVehicleModal();
}


  function updateVehicleSortLabels(){
  const map = {
    sortVehClient: "Client",
    sortVehMake: "Marque",
    sortVehModel: "Mod√®le",
    sortVehYear: "Ann√©e"
  };

  Object.keys(map).forEach(id => {
    const btn = $(id);
    if (!btn) return;

    let key = "";
    if (id === "sortVehClient") key = "client";
    if (id === "sortVehMake")   key = "make";
    if (id === "sortVehModel")  key = "model";
    if (id === "sortVehYear")   key = "year";

    btn.textContent =
      map[id] +
      (VEHICLES_SORT.key === key
        ? (VEHICLES_SORT.dir === 1 ? " ‚¨ÜÔ∏è" : " ‚¨áÔ∏è")
        : " ‚¨ç");
  });
}

  
function bindVehicleSort(){
  const bind = (id, key) => {
    const btn = $(id);
    if (!btn) return;

    btn.onclick = () => {
      if (VEHICLES_SORT.key === key) VEHICLES_SORT.dir *= -1;
      else { VEHICLES_SORT.key = key; VEHICLES_SORT.dir = 1; }

      renderVehiclesPage();
      updateVehicleSortLabels();
    };
  };

  bind("sortVehClient", "client");
  bind("sortVehMake", "make");
  bind("sortVehModel", "model");
  bind("sortVehYear", "year");
}


function renderClientsTable(){
  const tbody = document.querySelector('#clientsTable tbody');
  if(!tbody) return;
  const q = ($('clientSearch')?.value || '').toLowerCase();
  tbody.innerHTML='';
[...CLIENTS]
  .sort((a,b)=>{
  const na = (a.lastName || a.name || '').toLowerCase().trim();
  const nb = (b.lastName || b.name || '').toLowerCase().trim();
  return clientSortAsc ? na.localeCompare(nb) : nb.localeCompare(na);
})
  .forEach(c=>{
    const hay = `${c.name||''} ${c.phone||''} ${c.email||''} ${c.address||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    const vehicleCount = Array.isArray(c.vehicles)?c.vehicles.length:0;
    const tr=document.createElement('tr');
    tr.innerHTML = `
  <td 
    class="client-name-link"
    data-action="open-client"
    data-id="${c.id}"
  >
    ${c.lastName || ''}${c.firstName ? ', ' + c.firstName : ''}
  </td>
  <td>${c.phone||''}</td>
  <td>${c.email||''}</td>
  <td>${c.address||''}</td>
  <td>${vehicleCount}</td>
`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-action="open-client"]').forEach(el=>{
  el.addEventListener('click',()=>{
    const id = el.dataset.id;
    openClientModal(id);
  });
});
  renderVehiclesPage();
  renderDashboard();
}

  
  if ($('toggleClientSort')){
  $('toggleClientSort').onclick = () => {
    clientSortAsc = !clientSortAsc;
    $('toggleClientSort').textContent = clientSortAsc ? 'Nom ‚¨ÜÔ∏è' : 'Nom ‚¨áÔ∏è';
    renderClientsTable();
  };
}


function findClientById(id){
  return CLIENTS.find(c=>String(c.id)===String(id));
}

function openClientModal(id){
  const modal=$('clientModal');
  if(!modal) return;
  modal.style.display='flex';
  renderClientModal(id);
  let vehEditIndex = null;

}
function closeClientModal(){
  const modal=$('clientModal');
  if(modal) modal.style.display='none';
}
if($('closeClientModal')){
  $('closeClientModal').addEventListener('click',closeClientModal);
}


  /* ===================== VEHICLE MODAL (FICHE V√âHICULE) ===================== */
function closeVehicleModal(){
  const modal = $("vehicleModal");
  const content = $("vehicleModalContent");
  if (content) content.innerHTML = "";
  if (modal) modal.style.display = "none";
}

function openVehicleModal(clientId, vehicleId){
// s√©curit√©: data peut ne pas √™tre charg√©e
loadClients?.();
loadWorkOrders?.();
loadInvoices?.();

  const modal = $("vehicleModal");
  const content = $("vehicleModalContent");
  if (!modal || !content){
    alert("Modal v√©hicule introuvable.");
    return;
  }

  const client = (CLIENTS || []).find(c => String(c.id) === String(clientId));
  const vehicle = client?.vehicles?.find(v => String(v.id) === String(vehicleId));

  if (!client || !vehicle){
    content.innerHTML = `<div class="muted">V√©hicule introuvable.</div>`;
    modal.style.display = "flex";
    return;
  }

  content.innerHTML = renderVehicleModalContent(client, vehicle);
  modal.style.display = "flex";

}


  function renderVehicleModalContent(client, vehicle){

  const clientName = `${client.lastName || ""}${client.firstName ? ", " + client.firstName : ""}`.trim();
  const vehicleLabel = `${vehicle.year || ""} ${vehicle.make || ""} ${vehicle.model || ""}`.trim();

  // =========================
  // HISTORIQUE BONS DE TRAVAIL
  // =========================
  const wos = (WORKORDERS || [])
    .filter(wo => {
      const sameClient =
        String(wo.clientId || "") === String(client.id || "") ||
        String(wo.clientName || "").trim() === String(client.name || "").trim();

      const sameVehId  = wo.vehicleId != null && String(wo.vehicleId) === String(vehicle.id);
      const sameLabel  = (wo.vehicleLabel || "").trim() === vehicleLabel;

      return sameClient && (sameVehId || sameLabel);
    })
    .sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));

  let woRows = "";
  if (!wos.length){
    woRows = `<tr><td colspan="5" class="muted">Aucun bon de travail pour ce v√©hicule.</td></tr>`;
  } else {
    wos.forEach(wo => {
      const statusLabel =
        wo.status === "en_cours" ? "En cours" :
        wo.status === "termine"  ? "Termin√©"  :
        wo.status || "";

      woRows += `
        <tr>
          <td>${wo.number || ""}</td>
          <td>${wo.date || ""}</td>
          <td><span class="status-badge status-${wo.status}">${statusLabel}</span></td>
          <td style="text-align:right;">${money(wo.estimateTotal || 0)} $</td>
          <td style="text-align:right;">
            <button class="ghost" onclick="openWorkOrderFromVehicleModal('${wo.id}')">Ouvrir</button>
          </td>
        </tr>
      `;
    });
  }

  // =========================
  // HISTORIQUE FACTURES
  // =========================
  const invs = (INVOICES || [])
    .filter(inv => {
      const sameClient =
        String(inv.customerId || "") === String(client.id || "") ||
        String(inv.customer || "").trim() === String(client.name || "").trim();

      const sameVeh = String(inv.vehicle || "").trim() === vehicleLabel;

      return sameClient && sameVeh;
    })
    .sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));

  let invRows = "";
  if (!invs.length){
    invRows = `<tr><td colspan="5" class="muted">Aucune facture pour ce v√©hicule.</td></tr>`;
  } else {
    invs.forEach(inv => {
      const statusLabel =
        inv.status === "paid" ? "Pay√©e" :
        inv.status === "unpaid" ? "Non pay√©e" :
        (inv.status || "");

      invRows += `
        <tr>
          <td>${inv.number || ""}</td>
          <td>${inv.date || ""}</td>
          <td>${statusLabel}</td>
          <td style="text-align:right;">${money(inv.total || 0)} $</td>
          <td style="text-align:right;">
            <button class="ghost" onclick="openInvoiceFromVehicleModal('${inv.number}')">Ouvrir</button>
          </td>
        </tr>
      `;
    });
  }
      return `
    <div style="border:1px solid var(--border); border-radius:10px; padding:12px; background:#111; margin-bottom:12px;">
      <div class="muted">Client</div>
      <div style="font-weight:700; font-size:1.05rem;">
        ${clientName || client.name || ""}
      </div>

      <div style="margin-top:10px;" class="muted">V√©hicule</div>
      <div style="font-weight:700;">${vehicleLabel}</div>

      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:10px;">

  <div>
    <div class="muted">Plaque</div>
    <input id="vehEditPlate" value="${escapeHTML(vehicle.plate || "")}">
  </div>

  <div>
    <div class="muted">VIN</div>
    <input id="vehEditVin" value="${escapeHTML(vehicle.vin || "")}">
  </div>

  <div>
    <div class="muted">KM</div>
    <input id="vehEditKm" type="number" value="${vehicle.km || ""}">
  </div>

</div>

<div style="text-align:right; margin-top:12px;">
  <button class="ghost"
    onclick="saveVehicleInfo('${client.id}','${vehicle.id}')">
    üíæ Enregistrer
  </button>
</div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h3 style="margin:0 0 8px;">Historique des bons de travail</h3>
      <table style="width:100%;">
        <thead>
          <tr>
            <th># BT</th>
            <th>Date</th>
            <th>Statut</th>
            <th style="text-align:right;">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${woRows}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Historique des factures</h3>
      <table style="width:100%;">
        <thead>
          <tr>
            <th># Facture</th>
            <th>Date</th>
            <th>Statut</th>
            <th style="text-align:right;">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${invRows}
        </tbody>
      </table>
    </div>
  `;
}


  function saveVehicleInfo(clientId, vehicleId){

  const plate = document.getElementById("vehEditPlate").value.trim();
  const vin   = document.getElementById("vehEditVin").value.trim();
  const km    = Number(document.getElementById("vehEditKm").value || 0);

  if (!plate || !vin){
    alert("Plaque et VIN sont obligatoires.");
    return;
  }

  CLIENTS = loadArrayFromStorage(STORAGE.clients);

  const client = CLIENTS.find(c => String(c.id) === String(clientId));
  if (!client) return alert("Client introuvable.");

  const veh = client.vehicles.find(v => String(v.id) === String(vehicleId));
  if (!veh) return alert("V√©hicule introuvable.");

  // ‚úèÔ∏è mise √† jour
  veh.plate = plate;
  veh.vin   = vin;
  veh.km    = km;

  // üíæ sauvegarde
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
  scheduleCloudSync();

  // üîÅ refresh UI sans reload
  renderClientsTable();
  renderVehiclesPage();
  loadWorkOrders();
  renderInvoiceList();

  // üîÅ re-render du modal
  document.getElementById("vehicleModalContent").innerHTML =
    renderVehicleModalContent(client, veh);
}

    
/* Ouvrir un BT depuis la fiche v√©hicule */
function openWorkOrderFromVehicleModal(woId){
  closeVehicleModal();

  // s'assurer d'√™tre sur la page BT
  showPage("page-workorders");

  // ouvrir le d√©tail (robuste m√™me si la liste n'est pas cliquable imm√©diatement)
  setTimeout(() => {
    loadWorkOrders?.();
    const wo = (WORKORDERS || []).find(w => String(w.id) === String(woId));
    if (wo && typeof openWorkOrderDetail === "function"){
      openWorkOrderDetail(wo);
      return;
    }

    // fallback: clique le bouton "Ouvrir" dans la table si pr√©sent
    const btn = document.querySelector(`tr[data-id="${woId}"] button[data-action="open"]`);
    if (btn) btn.click();
  }, 0);
}

  /* Ouvrir une FACTURE depuis la fiche v√©hicule */
function openInvoiceFromVehicleModal(invoiceNumber){
  closeVehicleModal();

  // aller √† la liste de factures
  showPage("page-invoice-list");

  setTimeout(() => {
    loadInvoices?.();
    renderInvoiceList?.();

    if (typeof openInvoiceEditModal === "function"){
      openInvoiceEditModal(invoiceNumber);
      return;
    }
  }, 0);
}


function renderClientModal(id){
  loadClients();
  const content=$('clientModalContent');
  if(!content) return;
  const isNew = !id;
  let client;
  if(isNew){
    client={
  id:Date.now(),
  firstName:'',
  lastName:'',
  name:'',
  phone:'',
  email:'',
  address:'',
  notes:'',
  vehicles:[]
};
  }else{
    client=findClientById(id);
    if(!client){
      alert('Client introuvable');
      closeClientModal();
      return;
    }
  }
  const invoices=INVOICES;
  const clientInvoices=invoices.filter(inv=>(inv.customer||'').toLowerCase()===(client.name||'').toLowerCase());

  content.innerHTML=`
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div>
        <h3 style="margin:0 0 6px;color:var(--accent);">Informations client</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;min-width:160px;">
  <label>Pr√©nom</label>
  <input id="clientFormFirstName" value="${client.firstName||''}" />
</div>

<div style="flex:1;min-width:200px;">
  <label>Nom</label>
  <input id="clientFormLastName" value="${client.lastName||''}" />
</div>
          <div style="flex:1;min-width:160px;">
            <label>T√©l√©phone</label>
            <input id="clientFormPhone" value="${client.phone||''}" />
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <div style="flex:1;min-width:200px;">
            <label>Email</label>
            <input id="clientFormEmail" value="${client.email||''}" />
          </div>
          <div style="flex:1;min-width:200px;">
            <label>Adresse</label>
            <input id="clientFormAddress" value="${client.address||''}" />
          </div>
        </div>
        <label style="margin-top:8px;">Notes</label>
        <textarea id="clientFormNotes">${client.notes||''}</textarea>
      </div>

      <div>
        <h3 style="margin:10px 0 6px;color:var(--accent);">V√©hicules</h3>
        <div id="clientVehiclesList" class="small"></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:80px;"><label>Ann√©e</label><input id="vehYear" /></div>
          <div style="flex:1;min-width:120px;"><label>Marque</label><input id="vehMake" /></div>
          <div style="flex:1;min-width:120px;"><label>Mod√®le</label><input id="vehModel" /></div>
        </div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:120px;"><label>Plaque</label><input id="vehPlate" /></div>
          <div style="flex:1;min-width:150px;"><label>VIN</label><input id="vehVin" /></div>
          <div style="flex:1;min-width:80px;"><label>KM</label><input id="vehKm" type="number" /></div>
        </div>
        <label style="margin-top:6px;">Notes v√©hicule</label>
        <textarea id="vehNotes"></textarea>
        <button id="clientAddVehicleBtn" style="margin-top:6px;">Ajouter v√©hicule</button>
      </div>

      <div>
        <h3 style="margin:10px 0 6px;color:var(--accent);">Historique (factures)</h3>
        <div id="clientHistory" class="small"></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        ${isNew ? '' : '<button id="clientDeleteBtn" class="ghost">Supprimer client</button>'}
        <button id="clientSaveBtn">üíæ Enregistrer</button>
      </div>
    </div>
  `;


  function renderVehiclesList(){
    const wrap=$('clientVehiclesList');
    if(!wrap) return;
    if(!client.vehicles || client.vehicles.length===0){
      wrap.innerHTML='<div class="muted">Aucun v√©hicule pour ce client.</div>';
      return;
    }
    wrap.innerHTML=client.vehicles.map((v,idx)=>`
      <div style="border:1px solid var(--border);border-radius:6px;padding:6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div><strong>${v.year||''} ${v.make||''} ${v.model||''}</strong></div>
          <div class="small">Plaque: ${v.plate||''} | VIN: ${v.vin||''} | KM: ${v.km||''}</div>
          <div class="small">${v.notes||''}</div>
        </div>
        <div style="display:flex; gap:8px;">
  <button class="ghost" data-role="edit-veh" data-index="${idx}">Modifier</button>
  <button class="ghost danger" data-index="${idx}" data-role="del-veh">Supprimer</button>
</div>
      </div>
    `).join('');
    wrap.querySelectorAll('button[data-role="del-veh"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx=Number(btn.dataset.index);
        client.vehicles.splice(idx,1);
        saveClients();
        renderVehiclesList();
      });
    });

    
    wrap.querySelectorAll('button[data-role="edit-veh"]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const idx = Number(btn.dataset.index);
    const v = client.vehicles?.[idx];
    if(!v) return;

    vehEditIndex = idx;

    // Remplir les champs du formulaire v√©hicule
    $('vehYear').value  = v.year  || '';
    $('vehMake').value  = v.make  || '';
    $('vehModel').value = v.model || '';
    $('vehPlate').value = v.plate || '';
    $('vehVin').value   = v.vin   || '';
    $('vehKm').value    = v.km    || '';
    $('vehNotes').value = v.notes || '';

    // Visuel: le bouton "Ajouter v√©hicule" devient "Enregistrer modifications"
    if($('clientAddVehicleBtn')) $('clientAddVehicleBtn').textContent = "üíæ Enregistrer v√©hicule";
  });
});
  }
  renderVehiclesList();

  const histWrap=$('clientHistory');
  if(histWrap){
    if(clientInvoices.length===0){
      histWrap.innerHTML='<div class="muted">Aucune facture associ√©e pour ce client pour le moment.</div>';
    }else{
      histWrap.innerHTML=clientInvoices.map(inv=>`
        <div style="border-bottom:1px solid var(--border);padding:4px 0;">
          <div><strong>#${inv.number}</strong> - ${inv.date}</div>
          <div class="small">${inv.job||''}</div>
          <div class="small">Total: ${money(inv.total||0)} $</div>
        </div>
      `).join('');
    }
  }

  if($('clientSaveBtn')){
    $('clientSaveBtn').addEventListener('click',()=>{
      const firstName = $('clientFormFirstName').value.trim();
const lastName  = $('clientFormLastName').value.trim();

if (!firstName && !lastName){
  alert('Le pr√©nom ou le nom est requis');
  return;
}

const name = `${firstName} ${lastName}`.trim();

      if(!name){alert('Le pr√©nom ou le nom du client est requis.');return;}
      client.firstName = firstName;
      client.lastName  = lastName;
      client.name      = name; // compatibilit√©
      client.phone=$('clientFormPhone').value.trim();
      client.email=$('clientFormEmail').value.trim();
      client.address=$('clientFormAddress').value.trim();
      client.notes=$('clientFormNotes').value.trim();
      
      const idx=CLIENTS.findIndex(c=>String(c.id)===String(client.id));
      if(idx===-1) CLIENTS.push(client);
      else CLIENTS[idx]=client;
      saveClients();
      
      document.dispatchEvent(new CustomEvent("client:created", {detail: client}));
      refreshInvoiceClientSelect();
      renderClientsTable();
      closeClientModal();
    });
  }
  if($('clientAddVehicleBtn')){
    $('clientAddVehicleBtn').addEventListener('click',()=>{
      const make=$('vehMake').value.trim();
      const model=$('vehModel').value.trim();
      const year=$('vehYear').value.trim();
      if(!make && !model){
        alert('Au moins marque ou mod√®le requis pour le v√©hicule.');
        return;
      }
      const v={
        id:Date.now(),
        make,
        model,
        year,
        plate:$('vehPlate').value.trim(),
        vin:$('vehVin').value.trim(),
        km:$('vehKm').value.trim(),
        notes:$('vehNotes').value.trim()
      };
      if(!Array.isArray(client.vehicles)) client.vehicles=[];

if (vehEditIndex !== null && client.vehicles[vehEditIndex]) {
  // ‚úèÔ∏è MODIFICATION
  client.vehicles[vehEditIndex] = {
    ...client.vehicles[vehEditIndex],
    ...v
  };
  vehEditIndex = null;
  $('clientAddVehicleBtn').textContent = '‚ûï Ajouter v√©hicule';
} else {
  // ‚ûï AJOUT
  client.vehicles.push(v);
}

    saveClients();
    renderVehiclesList();

      
      $('vehMake').value='';
      $('vehModel').value='';
      $('vehYear').value='';
      $('vehPlate').value='';
      $('vehVin').value='';
      $('vehKm').value='';
      $('vehNotes').value='';
      renderVehiclesList();
    });
  }

    
  if($('clientDeleteBtn') && !isNew){
    $('clientDeleteBtn').addEventListener('click',()=>{
      if(!confirm('Supprimer ce client ?')) return;
      CLIENTS=CLIENTS.filter(c=>String(c.id)!==String(client.id));
      saveClients();
      renderClientsTable();
      closeClientModal();
    });
  }
}

function initClientsModule(){
  loadClients();
  if($('clientSearch')){
    $('clientSearch').addEventListener('input',renderClientsTable);
  }
  if($('btnAddClient')){
    $('btnAddClient').addEventListener('click',()=>openClientModal(null));
  }
  renderClientsTable();
}

/* ===================== INVENTAIRE PI√àCES ===================== */
function renderParts_OLD_DO_NOT_USE(){
  const wrap=$('partsInventoryList');
  if(!wrap) return;
  wrap.innerHTML='';
  const q=($('partInvSearch')?.value || '').toLowerCase();
  const filterCat=($('partInvFilter')?.value || '');
  PARTS.forEach((p,i)=>{
    const hay = `${p.name||''} ${p.number||''} ${p.category||''}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(filterCat && p.category && p.category!==filterCat) return;
    const icon = PART_ICONS[p.category] || "üì¶";
    const profit = p.price>0 ? ((p.price-p.cost)/p.price*100).toFixed(0) : 0;
    const card=document.createElement('div');
    card.style=`
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      width:260px;
    `;
    card.innerHTML=`
      <h3 style="margin-bottom:10px;color:var(--accent);">${PART_ICONS[p.category] || "üì¶"} ${p.name}</h3>
      <div class="small"># Pi√®ce : <b>${p.number||''}</b></div>
      <div class="small">Cat√©gorie : <b>${p.category||'Divers'}</b></div>
      <div class="small">Stock : <b>${p.qty}</b></div>
      <div class="small">Co√ªt : <b>${money(p.cost)} $</b></div>
      <div class="small">Prix : <b>${money(p.price)} $</b></div>
      <div class="small">Marge : <b>${profit}%</b></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="ghost" data-action="edit" data-id="${i}" style="flex:1;">Modifier</button>
        <button class="ghost" data-action="del" data-id="${i}" style="flex:1;">Supprimer</button>
      </div>
      <button class="ghost" onclick="addPartToCurrentWO(${i})">
  ‚ûï Ajouter au bon de travail
</button>
    `;
    wrap.appendChild(card);
  });

  wrap.querySelectorAll('button[data-action="del"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.dataset.id);
      if(!confirm('Supprimer cette pi√®ce ?')) return;
      PARTS.splice(id,1);
      saveParts();
      renderDashboard();
    });
  });
  wrap.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.dataset.id);
      const p=PARTS[id];
      if(!p) return;
      const newName=prompt("Nom de la pi√®ce :",p.name)||p.name;
      const newNumber=prompt("Num√©ro de pi√®ce :",p.number||"")||p.number;
      const newCat=prompt("Cat√©gorie :",p.category||'Divers')||p.category||'Divers';
      const newQty=Number(prompt("Quantit√© :",p.qty)||p.qty);
      const newCost=Number(prompt("Prix co√ªtant :",p.cost)||p.cost);
      const newPrice=Number(prompt("Prix de vente :",p.price)||p.price);
      PARTS[id]={name:newName,number:newNumber,category:newCat,qty:newQty,cost:newCost,price:newPrice};
      saveParts();
      renderDashboard();
    });
  });
  wrap.querySelectorAll('button[data-action="addToInvoice"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.dataset.id);
      const p=PARTS[id];
      if(!p) return;
      const currentQty=Number(p.qty||0);
      if(currentQty<=0){
        alert("Stock insuffisant pour cette pi√®ce.");
        return;
      }
      p.qty=currentQty-1;
      saveParts();
      renderDashboard();
      const newItem={
        type:"Pi√®ce (Inventaire)",
        desc:`${p.name} (#${p.number})`,
        qty:1,
        rate:p.price,
        invNumber:p.number
      };
      items.push(newItem);
      renderItems();
    });
  });
}
  

function initPartsModule(){
  loadParts();

  const btn = $('partInvAddBtn');
  if (!btn) return;

  btn.onclick = null; // üî• √©vite le multi-binding
  btn.onclick = () => {

    const name = $('partInvName').value.trim();
    const number = $('partInvNumber').value.trim();
    const qty = Number($('partInvQty').value) || 0;
    const cost = Number($('partInvCost').value) || 0;
    const price = Number($('partInvPrice').value) || 0;
    const category = $('partInvCategory')?.value || 'Divers';

    if (!name){
      alert("Nom obligatoire");
      return;
    }

    if (qty < 0){
      alert("Quantit√© invalide");
      return;
    }

    PARTS.push({
      id: Date.now(),
      name,
      number,
      qty,
      cost,
      price,
      category
    });

    saveParts();
    renderDashboard();
    renderPartsList(); // ‚úÖ affichage imm√©diat

    $('partInvName').value='';
    $('partInvNumber').value='';
    $('partInvQty').value=1;
    $('partInvCost').value='';
    $('partInvPrice').value='';
  };
}
  

/* ===================== SERVICES ===================== */
function loadServices(){
  SERVICES = loadArrayFromStorage(STORAGE.services);
}


  function editService(id){
  const srv = SERVICES.find(s => String(s.id) === String(id));
  if (!srv) return;

  EDITING_SERVICE_ID = srv.id;

  $("srvName").value = srv.name || "";
  $("srvCategory").value = srv.category || "";
  $("srvDesc").value = srv.desc || "";

  $("srvPriceFixed").value = srv.priceFixed || "";
  $("srvHours").value = srv.hours || "";
  $("srvRate").value = srv.rate || "";

  $("srvAddBtn").textContent = "üíæ Modifier le service";

  // optionnel mais pro : focus
  $("srvName").focus();
}
  

function deleteService(id){
  const srv = SERVICES.find(s => String(s.id) === String(id));
  if (!srv) return;

  const ok = confirm(`Supprimer le service : "${srv.name}" ?`);
  if (!ok) return;

  SERVICES = SERVICES.filter(s => String(s.id) !== String(id));

  localStorage.setItem(STORAGE.services, JSON.stringify(SERVICES));
  scheduleCloudSync();

  renderServicesList();
}


  function renderServicesList(){
  const list = $("servicesList");
  if (!list) return;

  const search = $("serviceSearchInput")?.value.toLowerCase() || "";
  const category = $("serviceCategoryFilter")?.value || "";

  list.innerHTML = "";

  const filtered = SERVICES.filter(s => {
    const matchText =
      s.name.toLowerCase().includes(search) ||
      (s.desc || "").toLowerCase().includes(search);

    const matchCategory =
      !category || s.category === category;

    return matchText && matchCategory;
  });

  if (filtered.length === 0){
    list.innerHTML = `<div class="muted">Aucun service trouv√©.</div>`;
    return;
  }

  filtered.forEach(s => {
    list.innerHTML += `
      <div class="service-row">
        <div class="srv-name">
          <strong>${escapeHTML(s.name)}</strong>
          <div class="srv-desc">${escapeHTML(s.desc || "")}</div>
        </div>

        <div class="srv-cat">${escapeHTML(s.category)}</div>

        <div class="srv-price">
          ${
            s.priceFixed > 0
              ? `Forfait : ${money(s.priceFixed)} $`
              : `${s.hours} h x ${money(s.rate)} $ / h`
          }
        </div>

        <div class="srv-actions">
          <button class="ghost" onclick="editService('${s.id}')">Modifier</button>
          <button class="ghost danger" onclick="deleteService('${s.id}')">Supprimer</button>
          <button onclick="addServiceToCurrentWO('${s.id}')">+ Bon de travail</button>
        </div>
      </div>
    `;
  });
}


function renderPartsList(){
  const list = $("partsInventoryList");
  if (!list) return;

  const search = ($("partInvSearch")?.value || "").toLowerCase();
  const category = $("partInvFilter")?.value || "";

  list.innerHTML = "";

  const filtered = PARTS.filter(p=>{
    const hay = `${p.name} ${p.number||""} ${p.category}`.toLowerCase();
    if (search && !hay.includes(search)) return false;
    if (category && p.category !== category) return false;
    return true;
  });

  if (!filtered.length){
    list.innerHTML = `<div class="muted">Aucune pi√®ce trouv√©e.</div>`;
    return;
  }

  filtered.forEach(p=>{

    list.innerHTML += `
      <div class="service-row">

        <!-- COL 1 : NOM + DESC -->
        <div>
          <div class="srv-name">
            <strong>${escapeHTML(p.name)}</strong>
          </div>
          <div class="srv-desc">
            # Pi√®ce : ${escapeHTML(p.number||"")}
            ‚Ä¢ Stock : ${p.qty}
            ‚Ä¢ Co√ªt : ${money(p.cost)} $
            ‚Ä¢ Marge : ${calcMargin(p.cost,p.price)}%
          </div>
        </div>

        <!-- COL 2 : CAT -->
        <div class="srv-cat">
          ${escapeHTML(p.category)}
        </div>

        <!-- COL 3 : PRIX -->
        <div class="srv-price">
          ${money(p.price)} $
        </div>

        <!-- COL 4 : ACTIONS -->
        <div class="srv-actions">
          <button class="ghost" onclick="editPart('${p.id}')">Modifier</button>
          <button class="ghost danger" onclick="deletePart('${p.id}')">Supprimer</button>
          <button onclick="addPartToCurrentWO('${p.id}')">+ Bon de travail</button>
        </div>

      </div>
    `;
  });
}


  function deletePart(id){
    if (!id) {
  console.error("deletePart appel√© sans id valide", id);
  return;
}
  const p = PARTS.find(x => String(x.id) === String(id));
  if (!p) return;

  if (!confirm(`Supprimer la pi√®ce "${p.name}" ?`)) return;

  PARTS = PARTS.filter(x => String(x.id) !== String(id));
  localStorage.setItem(STORAGE.parts, JSON.stringify(PARTS));
  scheduleCloudSync();

  // üî• FIX CRITIQUE
  PARTS = loadArrayFromStorage(STORAGE.parts);

  renderPartsList();
}


  function editPart(id){
  const p = PARTS.find(x => String(x.id) === String(id));
  if (!p) return;

  EDITING_PART_ID = p.id;

  $("partInvName").value = p.name || "";
  $("partInvNumber").value = p.number || "";
  $("partInvCategory").value = p.category || "Divers";
  $("partInvQty").value = p.qty || 0;
  $("partInvCost").value = p.cost || 0;
  $("partInvPrice").value = p.price || 0;

  $("partInvAddBtn").textContent = "üíæ Modifier la pi√®ce";
}


  document.addEventListener("DOMContentLoaded", () => {

  if ($("partInvSearch")){
  $("partInvSearch").addEventListener("input", renderPartsList);
  }
  if ($("partInvFilter")){
  $("partInvFilter").addEventListener("change", renderPartsList);
  }

  if ($("serviceSearchInput")){
    $("serviceSearchInput").addEventListener("input", renderServicesList);
  }
  if ($("serviceCategoryFilter")){
    $("serviceCategoryFilter").addEventListener("change", renderServicesList);
  }

});

  
function saveServices(){
  localStorage.setItem(STORAGE.services, JSON.stringify(SERVICES));
scheduleCloudSync();
}

  
const SERVICE_ICONS = {
  "Entretien":"üõ¢Ô∏è",
  "M√©canique g√©n√©rale":"üß∞",
  "Freins":"üõë",
  "Suspension":"ü¶æ",
  "Direction":"üõû",
  "Refroidissement":"‚ùÑÔ∏è",
  "Diagnostic":"üîé",
  "√âlectricit√©":"üîå",
  "Pneus":"üöó",
  "√âchappement":"üî©",
  "Transmission":"‚öôÔ∏è",
  "Moteur":"üöÄ",
  "Divers":"üì¶"
};

  
  const PART_ICONS = {
  "Moteur": "üß†",
  "Transmission": "‚öôÔ∏è",
  "Suspension": "üõû",
  "Direction": "üß≠",
  "Freins": "üõë",
  "√âchappement": "üí®",
  "√âlectrique": "‚ö°",
  "Tuning": "üî•",
  "Fabrication": "üß∞",
  "Hybride": "üîã",
  "Carrosserie": "üöó",
  "Pneus": "üõû",
  "Divers": "üì¶"
};

  function partIcon(cat){
  return PART_ICONS[cat] || "üì¶";
}

  
function addServiceToInvoice(s){
  let desc=s.name;
  if(s.desc) desc+=" ‚Äî "+s.desc;
  let item;
  if(s.priceFixed>0){
    item={type:"Service",desc,qty:1,rate:s.priceFixed};
  }else if(s.hours>0 && s.rate>0){
    item={type:"Service (horaire)",desc,qty:s.hours,rate:s.rate};
  }else{
    item={type:"Service",desc,qty:1,rate:0};
  }
  items.push(item);
  renderItems();
}

function renderServices(){
  const wrap=$('servicesList');
  if(!wrap) return;
  wrap.innerHTML='';
  if(!SERVICES.length){
    wrap.innerHTML='<div class="muted">Aucun service enregistr√© pour le moment.</div>';
    return;
  }
  SERVICES.forEach(s=>{
    const typeLabel = s.priceFixed>0
      ? `Forfait: ${money(s.priceFixed)} $`
      : (s.hours>0 && s.rate>0
        ? `${s.hours} h x ${money(s.rate)} $/h`
        : `Non d√©fini`);
    const icon = SERVICE_ICONS[s.category] || "‚öôÔ∏è";
    const row = document.createElement('div');
row.className = 'service-row';

row.innerHTML = `
  <div class="srv-col srv-name">
    <strong>${icon} ${s.name}</strong>
    ${s.desc ? `<div class="srv-desc">${s.desc}</div>` : ``}
  </div>

  <div class="srv-col srv-cat">
    ${s.category}
  </div>

  <div class="srv-col srv-price">
    ${typeLabel}
  </div>

  <div class="srv-col srv-actions">
    <button class="ghost" data-action="edit-srv" data-id="${s.id}">Modifier</button>
    <button class="ghost" data-action="del-srv" data-id="${s.id}">Supprimer</button>
    <button class="ghost" onclick="addServiceToCurrentWO(${s.id})">
      ‚ûï Bon de travail
    </button>
  </div>
`;
wrap.appendChild(row);
  });

  wrap.querySelectorAll('button[data-action="del-srv"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      if(!confirm('Supprimer ce service ?')) return;
      SERVICES=SERVICES.filter(s=>String(s.id)!==String(id));
      saveServices();
      renderServices();
    });
  });
  wrap.querySelectorAll('button[data-action="edit-srv"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      const s=SERVICES.find(x=>String(x.id)===String(id));
      if(!s) return;
      const newName=prompt("Nom du service :",s.name)||s.name;
      const newCat=prompt("Cat√©gorie :",s.category)||s.category;
      const newDesc=prompt("Description :",s.desc||"") ?? s.desc;
      const newFixed=Number(prompt("Prix fixe (0 si aucun):",s.priceFixed||0)||s.priceFixed||0);
      const newHours=Number(prompt("Heures (0 si aucun):",s.hours||0)||s.hours||0);
      const newRate=Number(prompt("Taux horaire (0 si aucun):",s.rate||0)||s.rate||0);
      Object.assign(s,{name:newName,category:newCat,desc:newDesc,priceFixed:newFixed,hours:newHours,rate:newRate});
      saveServices();
      renderServices();
    });
  });
  wrap.querySelectorAll('button[data-action="add-to-invoice"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id;
      const s=SERVICES.find(x=>String(x.id)===String(id));
      if(!s) return;
      addServiceToInvoice(s);
      alert("Service ajout√© √† la facture en cours.");
    });
  });
}

  function initServiceSearchAndFilter(){
  const searchInput = document.getElementById("serviceSearchInput");
  const catFilter   = document.getElementById("serviceCategoryFilter");

  if (searchInput){
    searchInput.oninput = e=>{
      SERVICE_SEARCH_TERM = e.target.value.toLowerCase();
      renderServices();
    };
  }

  if (catFilter){
    catFilter.onchange = e=>{
      SERVICE_CATEGORY_FILTER = e.target.value;
      renderServices();
    };
  }
}


// ===============================
// SERVICES ‚Äî SEARCH & FILTER INIT
// ===============================
(function initServiceFilters(){

  const searchInput = document.getElementById("serviceSearchInput");
  if (searchInput){
    searchInput.addEventListener("input", e=>{
      SERVICE_SEARCH_TERM = e.target.value.toLowerCase();
      renderServices();
    });
  }

  const catFilter = document.getElementById("serviceCategoryFilter");
  if (catFilter){
    catFilter.addEventListener("change", e=>{
      SERVICE_CATEGORY_FILTER = e.target.value;
      renderServices();
    });
  }

})();


function initServicesModule(){
  loadServices();
  renderServicesList();

  EDITING_SERVICE_ID = null;
if ($("srvAddBtn")) $("srvAddBtn").textContent = "Ajouter le service";

  const modal=$('servicePickerModal');
  const list=$('servicePickerList');
  const btnOpen=$('openServicePicker');
  const btnClose=$('closeServicePicker');
  const filterSelect=$('servicePickerFilter');

  function renderPicker(){
    loadServices();
    if(!SERVICES.length){
      list.innerHTML='<div class="muted">Aucun service enregistr√© pour le moment.</div>';
      return;
    }
    const filter=filterSelect?.value || '';
    const grouped={};
    SERVICES.forEach(s=>{
      if(filter && s.category!==filter) return;
      if(!grouped[s.category]) grouped[s.category]=[];
      grouped[s.category].push(s);
    });
    let html='';
    Object.keys(grouped).sort().forEach(cat=>{
      const icon=SERVICE_ICONS[cat] || "‚öôÔ∏è";
      html+=`
        <h3 style="color:var(--accent);margin-top:15px;">${icon} ${cat}</h3>
        <div style="margin-bottom:10px;border-bottom:1px solid var(--border);"></div>
      `;
      grouped[cat].forEach(s=>{
        const label = s.priceFixed>0
          ? `${s.name} ‚Äî ${money(s.priceFixed)} $`
          : `${s.name} ‚Äî ${s.hours} h √ó ${money(s.rate)} $/h`;
        html+=`
          <div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:6px;">
            <div><b>${label}</b></div>
            ${s.desc ? `<div class="small">${s.desc}</div>` : ""}
            <button class="ghost" data-action="pick-service" data-id="${s.id}" style="margin-top:4px;">Ajouter √† la facture</button>
          </div>
        `;
      });
    });
    list.innerHTML=html;
    list.querySelectorAll('button[data-action="pick-service"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.dataset.id;
        const s=SERVICES.find(x=>String(x.id)===String(id));
        if(!s) return;
        addServiceToInvoice(s);
        modal.style.display='none';
      });
    });
  }

  if(btnOpen && modal && list){
    btnOpen.addEventListener('click',()=>{
      renderPicker();
      modal.style.display='flex';
    });
  }
  if(btnClose && modal){
    btnClose.addEventListener('click',()=>modal.style.display='none');
  }
  if(filterSelect){
    filterSelect.addEventListener('change',renderPicker);
  }
}

  /* ===================== PART PICKER ===================== */

const partPickerModal = $("partPickerModal");
const partPickerList = $("partPickerList");
const partPickerFilter = $("partPickerFilter");
const btnOpenPartPicker = $("openPartPicker");
const btnClosePartPicker = $("closePartPicker");

/* Rendu du modal */
function renderPartPicker() {
    loadParts(); // recharge √† jour
    let filter = partPickerFilter?.value || "";
    let html = "";

    let partsToShow = PARTS.filter(p => !filter || p.category === filter);

    if (partsToShow.length === 0) {
        partPickerList.innerHTML = `<div class="muted">Aucune pi√®ce dans cette cat√©gorie.</div>`;
        return;
    }

    partsToShow.forEach(p => {
        html += `
    <div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:6px;">
        <b>${partIcon(p.category)} ${p.name}</b> (#${p.number})<br>
        Cat√©gorie : ${p.category}<br>
        Prix : ${money(p.price)} $<br>
        Stock : ${p.qty}<br>

        <label style="font-size:0.8rem; color:var(--muted);">Quantit√© :</label>
        <input type="number" min="1" max="${p.qty}" value="1"
               id="qty_${p.number}"
               style="width:70px; padding:4px; margin-top:4px; background:#111; color:white; border:1px solid var(--border); border-radius:4px;">

        <button class="ghost" data-number="${p.number}" style="margin-top:6px;">
          ‚ûï Ajouter
        </button>
    </div>
`;

    });

    partPickerList.innerHTML = html;

    // √âv√©nement pour chaque bouton Ajouter
    partPickerList.querySelectorAll("button[data-number]").forEach(btn => {
        btn.onclick = () => {
            const num = btn.dataset.number;
            const part = PARTS.find(x => String(x.number) === String(num));
            if (!part) return;

            // Quantit√© choisie
const qField = $("qty_" + num);
let qtyToAdd = Number(qField?.value || 1);
if (qtyToAdd < 1) qtyToAdd = 1;

// V√©rifie stock
if (part.qty < qtyToAdd) {
    alert("Stock insuffisant. Disponible : " + part.qty);
    return;
}

// D√©cr√©mente le stock
part.qty -= qtyToAdd;
saveParts();
renderDashboard();

// Ajoute dans la facture
items.push({
    type: "Pi√®ce (Inventaire)",
    desc: `${part.name} (#${part.number})`,
    qty: qtyToAdd,
    rate: part.price,
    invNumber: part.number
});

renderItems();
partPickerModal.style.display = "none";
        };
    });
}

/* Ouvrir le PartPicker */
if (btnOpenPartPicker) {
    btnOpenPartPicker.onclick = () => {
        renderPartPicker();
        partPickerModal.style.display = "flex";
    };
}

/* Fermer */
if (btnClosePartPicker) {
    btnClosePartPicker.onclick = () => {
        partPickerModal.style.display = "none";
    };
}

/* Filtre cat√©gorie */
partPickerFilter.onchange = renderPartPicker;

  
/* ===================== HISTORIQUE & DASHBOARD ===================== */
function renderHistoryTable(){
  const tbody = document.querySelector('#historyTable tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  const filterClient = $("filterClient")?.value || "";
  const filterVehicle = $("filterVehicle")?.value || "";

  // üî• Mettre √† jour les filtres UNE seule fois
  populateHistoryFiltersFromWorkOrders();

  INVOICES
  .slice()
  .sort((a, b) => Number(b.number) - Number(a.number))
  .filter(inv => {

    // üî• Historique = factures pay√©es ET archiv√©es
    if (inv.status !== "paid") return false;
    if (inv.archived !== true) return false;

    if (filterClient && inv.customer !== filterClient) return false;

    if (filterVehicle) {
      const job = (inv.job || "").toLowerCase();
      const v = filterVehicle.toLowerCase();

      if (!job.includes(v)) {
        const parts = v.split(" ").filter(x => x.trim().length > 0);
        let allMatch = true;

        parts.forEach(p => {
          if (!job.includes(p)) allMatch = false;
        });

        if (!allMatch) return false;
      }
    }

    return true;
  })
  .forEach(inv => {

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><button class="ghost" onclick="openInvoiceEditModal('${inv.number}')">#${inv.number}</button></td>
        <td>${inv.date}</td>
        <td>${inv.customer || ""}</td>
        <td>${inv.job || ""}</td>
        <td>${money(inv.total || 0)} $</td>
      `;

      tbody.appendChild(tr);
    });
}


  function populateHistoryFiltersFromWorkOrders(){
  const selClient  = $("filterClient");
  const selVehicle = $("filterVehicle");
  if (!selClient || !selVehicle) return;

  const workorders = loadArrayFromStorage(STORAGE.workorders);

  workorders.forEach(wo=>{
    if (wo.clientName && ![...selClient.options].some(o=>o.value===wo.clientName)){
      selClient.appendChild(new Option(wo.clientName, wo.clientName));
    }

    if (wo.vehicleLabel && ![...selVehicle.options].some(o=>o.value===wo.vehicleLabel)){
      selVehicle.appendChild(new Option(wo.vehicleLabel, wo.vehicleLabel));
    }
  });
}


  // Badge Statut pour les WO (historique)
function renderWOStatusBadge(status){
  const raw = String(status || "").trim();
  const safe = raw.toLowerCase().replace(/[^a-z0-9_-]/g, "_");

  // Label affich√© (tu peux ajuster si tu veux)
  let label = raw || "-";
  if (safe === "en_cours") label = "En cours";
  if (safe === "termine")  label = "Termin√©";
  if (safe === "billed")   label = "billed"; // ou "Factur√©" si tu pr√©f√®res

  return `<span class="status-badge status-${safe}">${label}</span>`;
}


  function renderHistoryWOTable(){
  const tbody = document.querySelector("#historyWOTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  const workorders = loadArrayFromStorage(STORAGE.workorders);

  const filterClient = $("filterClient")?.value || "";
const filterVehicle = $("filterVehicle")?.value || "";

workorders
  .filter(wo => wo.status !== "en_cours")
  .filter(wo => {
    if (filterClient && wo.clientName !== filterClient) return false;
    if (filterVehicle && wo.vehicleLabel !== filterVehicle) return false;
    return true;
  })
  .sort((a,b)=> new Date(b.date) - new Date(a.date))
  .forEach(wo => {
  const tr = document.createElement("tr");

  const total  = calcWorkOrderTotal(wo);
const profit = calcWorkOrderProfit(wo);

tr.innerHTML = `
  <td>
  <button class="ghost"
    onclick="openWorkOrderReadOnly('${wo.id || wo.number}')">
    ${wo.number}
  </button>
</td>
  <td>${wo.date}</td>
  <td>${wo.clientName}</td>
  <td>${wo.vehicleLabel}</td>
  <td>${renderWOStatusBadge(wo.status)}</td>

  <td style="text-align:right;">
    ${money(total)} $
  </td>

  <td style="text-align:right;color:#3ddc84;">
    ${money(profit)} $
  </td>
`;

  tbody.appendChild(tr);
});
}


  const historyWOTable = document.querySelector("#historyWOTable");

if (historyWOTable){
  historyWOTable.addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn-open-wo");
    if (!btn) return;

    const woId = btn.dataset.woId;
    if (!woId) return;

    openWorkOrderReadOnly(woId);
  });
}


  function calcWorkOrderTotal(wo){
  let total = 0;

  if (Array.isArray(wo.parts)){
    wo.parts.forEach(p=>{
      total += Number(p.qty || 0) * Number(p.rate || 0);
    });
  }

  if (Array.isArray(wo.labor)){
    wo.labor.forEach(l=>{
      total += Number(l.hours || 0) * Number(l.rate || 0);
    });
  }

  return total;
}


  function openWorkOrderReadOnly(woId){
  loadWorkOrders();

  const wo = WORKORDERS.find(w => String(w.id) === String(woId));
  if (!wo){
    alert("Bon de travail introuvable.");
    return;
  }

  // Aller sur la page Work Orders
  showPage("page-workorders");

  // Injecter l‚ÄôID (important pour le moteur existant)
  if ($("woEditId")) $("woEditId").value = String(wo.id);

  // Rendre le WO
  openWorkOrderDetail(wo);

  // üîí LECTURE SEULE
  setWorkOrderReadOnlyMode();
}


  function setWorkOrderReadOnlyMode(){

  const scope = document.getElementById("woDetailCard");
  if (!scope) return;

  // 1Ô∏è‚É£ D√©sactiver tous les champs
  scope.querySelectorAll("input, textarea, select").forEach(el=>{
    el.disabled = true;
    el.classList.add("readonly");
  });

  // 2Ô∏è‚É£ Supprimer / cacher TOUS les boutons d‚Äôaction
  scope.querySelectorAll("button").forEach(btn=>{
    // garder seulement les boutons neutres si tu en as (ex: imprimer)
    btn.style.display = "none";
  });

  // 3Ô∏è‚É£ Emp√™cher les clics r√©siduels (s√©curit√©)
  scope.querySelectorAll("[onclick]").forEach(el=>{
    el.onclick = null;
  });

  // 4Ô∏è‚É£ Marqueur global (utile plus tard)
  scope.dataset.readonly = "1";
}
  

  // === Activation des filtres historique ===
if ($("filterClient")) {
  $("filterClient").onchange = () => {
    renderDashboard();     // Met √† jour la liste des v√©hicules selon le client
    renderHistoryTable();  // Rafra√Æchit le tableau
  };
}

if ($("filterVehicle")) {
  $("filterVehicle").onchange = renderHistoryTable;
}


function renderDashboard(){
  // üîí Source de v√©rit√© directe (dashboard = lecture seule)
INVOICES = loadArrayFromStorage(STORAGE.invoices);
WORKORDERS = loadArrayFromStorage(STORAGE.workorders);

  
  // Recharge les factures depuis le storage
  loadInvoices(); // INVOICES = loadArrayFromStorage(...) :contentReference[oaicite:2]{index=2}

  // 1) Dashboard = m√™me logique que page Factures : factures "actives" = pas pay√©es
  const activeInvoices = (INVOICES || []).filter(inv => (inv.status || "unpaid") !== "paid");
  const invoicesCount = activeInvoices.length;

// ===== REVENUS = FACTURES ARCHIV√âES SEULEMENT =====
const archivedInvoices = (INVOICES || []).filter(inv => inv.archived === true);

const revenue = archivedInvoices.reduce(
  (sum, inv) => sum + Number(inv.total || 0),
  0
);


  const clientsCount=CLIENTS.length;
  let vehiclesCount=0;
  CLIENTS.forEach(c=>vehiclesCount+=(c.vehicles||[]).length);
  const partsCount=PARTS.reduce((s,p)=>s+Number(p.qty||0),0);
  const lowStock=PARTS.filter(p=>Number(p.qty||0)<=2).length;

  // === WORK ORDERS EN COURS ===
const woInProgressCount = WORKORDERS.filter(
  wo => wo.status === "en_cours"
).length;
  
  if($('statInvoices')) $('statInvoices').innerText=invoicesCount;
  if ($('statWOInProgress')) {
  $('statWOInProgress').innerText = woInProgressCount;
}
  if($('dashTotalRevenue')) $('dashTotalRevenue').innerText = money(revenue) + ' $';

  // === PROFITS TOTAUX (WO dont facture pay√©e seulement) ===
const paidWorkOrders = WORKORDERS.filter(wo => {

  const invoice = INVOICES.find(inv =>
    String(inv.workOrderNumber) === String(wo.number)
  );

  return invoice && invoice.status === "paid";
});

const totalProfit = paidWorkOrders.reduce((sum, wo) => {
  return sum + calcWorkOrderProfit(wo);
}, 0);


if ($('dashTotalProfit')) {
  $('dashTotalProfit').innerText = money(totalProfit) + ' $';
}
  
  if($('statClients')) $('statClients').innerText=clientsCount;
  if($('statVehicles')) $('statVehicles').innerText=vehiclesCount;


/* ===== 5 DERNI√àRES NOTES ===== */
if ($("lastNotesBox")) {

  const NOTE_CATEGORY_PRIORITY = {
    urgent: 1,   // üî¥ en haut
    afaire: 2,   // üü° ensuite
    todo:   2,   // alias
    general:3    // üîµ en bas
  };

  const NOTE_CATEGORY_COLORS = {
    urgent: "#ff4d4d",     // üî¥ Urgent
    afaire: "#f5c542",     // üü° √Ä faire
    todo:   "#f5c542",     // alias
    general:"#4da6ff"      // üîµ G√©n√©ral
  };

  const lastFiveNotes = [...(NOTES || [])]
    .sort((a, b) => {

      const pa = NOTE_CATEGORY_PRIORITY[(a.category || "").toLowerCase()] || 99;
      const pb = NOTE_CATEGORY_PRIORITY[(b.category || "").toLowerCase()] || 99;

      // 1Ô∏è‚É£ priorit√© cat√©gorie
      if (pa !== pb) return pa - pb;

      // 2Ô∏è‚É£ sinon ‚Üí plus r√©cente d'abord
      return new Date(b.date) - new Date(a.date);
    })
    .slice(0, 5);

  let html = "";

  if (lastFiveNotes.length === 0) {
    html = `<span class="muted">Aucune note enregistr√©e.</span>`;
  } else {
    html += `<div style="display:flex;flex-direction:column;gap:6px;">`;

    lastFiveNotes.forEach(n => {

      const preview = (n.text || n.description || "")
        .replace(/\n+/g, " ")
        .slice(0, 100);

      const color =
        NOTE_CATEGORY_COLORS[(n.category || "").toLowerCase()] ||
        "var(--accent)";

      html += `
        <div
          style="
            padding:6px 6px 6px 10px;
            border:1px solid var(--border);
            border-left:6px solid ${color};
            border-radius:6px;
            cursor:pointer;
          "
          onclick="openNoteFromDashboard('${n.id}')"
        >
          <div style="font-weight:600;">
            ${(n.title || "Note").slice(0, 40)}
          </div>

          <div class="muted" style="font-size:0.8rem; margin:2px 0;">
            ${n.date || ""}
          </div>

          ${preview ? `
            <div style="font-size:0.85rem; line-height:1.2;">
              ${preview}${preview.length >= 100 ? "‚Ä¶" : ""}
            </div>
          ` : ""}
        </div>
      `;
    });

    html += `</div>`;
  }

  $("lastNotesBox").innerHTML = html;
}

  
    /* ===== 5 DERNI√àRES FACTURES ===== */
if ($("lastInvoicesBox")) {

    const lastFive = [...activeInvoices]
        .sort((a, b) => new Date(b.date) - new Date(a.date)) // plus r√©cent ‚Üí plus ancien
        .slice(0, 5);

    $("lastInvoicesBox").innerHTML = "";

    let html = "";

    if (lastFive.length === 0) {
        html = `<span style="color:var(--muted);">Aucune facture enregistr√©e.</span>`;
    } else {
        html += `<div style="display:flex;flex-direction:column;gap:6px;">`;

        // ICI : affichage direct dans l‚Äôordre tri√©
        lastFive.forEach(inv => {
            html += `
                <div 
                    style="padding:6px; border:1px solid var(--border); border-radius:6px; cursor:pointer;"
                    onclick="openFromDashboard('${inv.number}')"
                >
                    <b>#${inv.number}</b> ‚Äî ${money(inv.total)} $
                    <br><span class="muted">${inv.customer || "Client inconnu"}</span>
                </div>
            `;
        });

        html += `</div>`;
    }

    $("lastInvoicesBox").innerHTML = html;
}

  
/* ===== 5 DERNIERS BONS DE TRAVAIL (EN COURS SEULEMENT) ===== */
if ($("lastWorkOrdersBox")) {

  const activeWO = WORKORDERS
    .filter(wo => wo.status === "en_cours")
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 5);

  let html = "";

  if (activeWO.length === 0) {
    html = `<span style="color:var(--muted);">Aucun bon de travail en cours.</span>`;
  } else {
    html += `<div style="display:flex;flex-direction:column;gap:6px;">`;

    activeWO.forEach(wo => {

  const descPreview = (wo.description || wo.problem || "")
    .replace(/\n+/g, " ")
    .slice(0, 100);

  html += `
    <div
      style="
        padding:6px;
        border:1px solid var(--border);
        border-radius:6px;
        cursor:pointer;
      "
      onclick="openWorkOrderFromDashboard(${wo.id})"
    >
      <div style="font-weight:600;">
        ${wo.number}
      </div>

      <div class="muted" style="font-size:0.85rem;">
        ${wo.clientName || ""}
        ${wo.vehicleLabel ? "‚Ä¢ " + wo.vehicleLabel : ""}
      </div>

      ${descPreview ? `
        <div style="font-size:0.85rem; margin-top:4px; line-height:1.2;">
          ${descPreview}${descPreview.length >= 100 ? "‚Ä¶" : ""}
        </div>
      ` : ""}
    </div>
  `;
});

    html += `</div>`;
  }

  $("lastWorkOrdersBox").innerHTML = html;
}


    /* === Mettre √† jour les filtres (client & v√©hicule) === */
  if ($("filterClient")) {
      const selClient = $("filterClient");
      const currentClient = selClient.value || "";

      const clients = [...new Set(CLIENTS.map(c => c.name))].sort();
      selClient.innerHTML =
        `<option value="">Tous les clients</option>` +
        clients.map(c => `<option value="${c}">${c}</option>`).join("");

      // On garde la s√©lection si possible
      if (currentClient && clients.includes(currentClient)) {
        selClient.value = currentClient;
      }
  }

  if ($("filterVehicle")) {
      const selVeh = $("filterVehicle");
      const currentVeh = selVeh.value || "";

      // Quel client est s√©lectionn√© dans le filtre ?
      const selectedClientName = $("filterClient")?.value || "";

      let vehicles = [];

      if (selectedClientName) {
          // ‚ûú Seulement les v√©hicules de CE client
          const clientObj = CLIENTS.find(c => c.name === selectedClientName);
          if (clientObj && Array.isArray(clientObj.vehicles)) {
              vehicles = clientObj.vehicles;
          }
      } else {
          // ‚ûú Aucun client filtr√© ‚ûú tous les v√©hicules de tous les clients
          CLIENTS.forEach(c => (c.vehicles || []).forEach(v => vehicles.push(v)));
      }

      const unique = [];
      vehicles.forEach(v => {
          const label = `${v.year || ""} ${v.make || ""} ${v.model || ""}`.trim();
          if (label && !unique.includes(label)) unique.push(label);
      });

      unique.sort();

      selVeh.innerHTML =
        `<option value="">Tous les v√©hicules</option>` +
        unique.map(label => `<option value="${label}">${label}</option>`).join("");

      // Si l'ancien v√©hicule existe encore dans la liste, on le remet
      if (currentVeh && unique.includes(currentVeh)) {
        selVeh.value = currentVeh;
      }
  }
}

  
  function openFromDashboard(number){
    showPage("page-history");
    const row = document.querySelector(`[data-invoice-number="${number}"]`);
    if(row) row.scrollIntoView({behavior:"smooth", block:"center"});
}


  function openNoteFromDashboard(noteId){
  showPage("page-notes");

  setTimeout(() => {
    const el = document.querySelector(`[data-note-id="${noteId}"]`);
    if (el) el.scrollIntoView({ behavior:"smooth", block:"center" });
  }, 0);
}


  /* ===================== Ouvrir WO a partir du Dashboard ===================== */
function openWorkOrderFromDashboard(id){
  showPage("page-workorders");

  setTimeout(() => {
    const btn = document.querySelector(`tr[data-id="${id}"] button[data-action="open"]`);
    if (btn) btn.click();
  }, 0);
}


/* ===================== EDIT EXISTING INVOICE ===================== */
function openInvoiceEditModal(invoiceNumber){
  const modal = $("invoiceEditModal");
  const content = $("invoiceEditContent");
  if(!modal || !content){
    alert("Interface facture introuvable.");
    return;
  }

const inv = INVOICES.find(x =>
  String(x.number) === String(invoiceNumber) ||
  String(x.workOrderNumber) === String(invoiceNumber)
);

if (!inv){
  alert("Facture introuvable.");
  return;
}

// üîí VERROUILLAGE DE L'√âTAT DES TAXES (CRITIQUE)
inv.applyGST = (inv.applyGST === true);
inv.applyQST = (inv.applyQST === true);

// ‚ö†Ô∏è normalisation APR√àS verrouillage
normalizeInvoiceTaxes(inv);
recalcInvoice(inv);


if(!inv){
  alert("Facture introuvable.");
  return;
}


  // ‚úÖ clientObj manquant (corrige: clientObj is not defined)
const clientObj = CLIENTS.find(c => String(c.name) === String(inv.customer));

// ‚úÖ v√©hicule du client (si pr√©sent)
let vehicleObj = null;
if (clientObj && Array.isArray(clientObj.vehicles)){
  vehicleObj = clientObj.vehicles.find(v =>
    `${v.year} ${v.make} ${v.model}` === inv.vehicle
  );
}

  if (!inv.number && inv.workOrderNumber){
  inv.number = btToInvoiceNumber(inv.workOrderNumber);
  saveInvoices(); // recommand√©
}


  // Lecture seule
  inv.locked = true;

  // Calcul Balance paiement partiel
  const balance = Math.max(0, (inv.total || 0) - (inv.paidAmount || 0));

  let paymentsHtml = "";
(inv.payments || []).forEach((p,i)=>{
  paymentsHtml += `
    <tr>
      <td>${i+1}</td>
      <td>${p.date}</td>
      <td style="text-align:right;">${money(p.amount)} $</td>
    </tr>
  `;
});

  // === RENDU FACTURE (r√©sum√© propre) ===
  let rows = "";

  (inv.items || []).forEach(it=>{
    rows += `
      <tr>
        <td>${it.type || ""}</td>
        <td>${it.desc || ""}</td>
        <td style="text-align:right;">${Number(it.qty).toFixed(2)}</td>
        <td style="text-align:right;">${money(it.rate)} $</td>
        <td style="text-align:right;">${money((it.qty||0)*(it.rate||0))} $</td>
      </tr>
    `;
  });

const isLocked = inv.status === "paid";

  
content.innerHTML = `
  <!-- EN-T√äTE -->
  <div style="
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:4px;
">
    <div>
      <h2 style="margin:0;">Facture #${inv.number}</h2>
      <div class="muted">Date : ${inv.date || ""}</div>
    </div>
    <div style="text-align:right;">
      <div style="font-weight:bold;">${SETTINGS.garageName || ""}</div>
      <div class="muted">Bon de travail : ${inv.referenceWO || "-"}</div>
    </div>
  </div>


<!-- CLIENT / V√âHICULE -->
<div style="
  border:1px solid #444;
  border-radius:8px;
  padding:12px;
  margin-bottom:15px;
  background:#2b2b2b;
  color:#f1f1f1;
">
  <div style="
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:6px;
">

  <!-- COLONNE GAUCHE : CLIENT + ADRESSE -->
  <div>
    <div>
      <span style="color:#aaa;">Client :</span>
      <b style="color:#fff;">${inv.customer || ""}</b>
    </div>

    ${clientObj ? `
      <div style="margin-top:4px; font-size:0.9em; color:#ccc;">
        ${clientObj.address ? `<div><b>Adresse :</b> ${clientObj.address}</div>` : ""}
        ${clientObj.phone ? `<div><b>T√©l√©phone :</b> ${clientObj.phone}</div>` : ""}
      </div>
    ` : ""}
  </div>

  <!-- COLONNE DROITE : BADGE -->
  ${inv.status === "paid" ? `
    <div class="invoice-paid-badge">
      PAY√â (${inv.paymentMethod === "cash" ? "Comptant" : "Virement"})
    </div>
  ` : ""}
</div>

  <div style="margin-top:6px;">
    <span style="color:#aaa;">V√©hicule :</span>
    <b style="color:#fff;">${inv.vehicle || ""}</b>
  </div>

  ${vehicleObj ? `
  <div style="margin-left:12px; font-size:0.9em; color:#ccc;">
    ${(inv.vehicleKm || vehicleObj?.km)
  ? "KM : " + (inv.vehicleKm || vehicleObj.km) + "<br>"
  : ""}
    ${vehicleObj.vin ? "VIN : " + vehicleObj.vin + "<br>" : ""}
    ${vehicleObj.plate ? "Plaque : " + vehicleObj.plate : ""}
  </div>
` : ""}
</div>


  <!-- D√âTAILS -->
  <table class="table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
        <th style="text-align:right;">Qt√©</th>
        <th style="text-align:right;">Prix</th>
        <th style="text-align:right;">Total</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
  </table>

 <!-- TOTAUX -->
<div style="
  display:flex;
  justify-content:flex-end;
  margin-top:15px;
">

  <!-- CONTENEUR 2 COLONNES -->
  <div style="
  display:flex;
  gap:24px;
  align-items:flex-start;
  width:auto;
">

    <!-- üü® COLONNE GAUCHE : TAXES -->
    <div class="invoice-ui-taxes" style="
      min-width:220px;
      padding:8px;
      border:1px solid var(--border);
      border-radius:8px;
    ">
      <div style="font-weight:600;margin-bottom:6px;">Taxes</div>

      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="invApplyGST" ${inv.applyGST !== false ? 'checked' : ''}>
        TPS (${SETTINGS.gst}%)
      </label>

      <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
        <input type="checkbox" id="invApplyQST" ${inv.applyQST !== false ? 'checked' : ''}>
        TVQ (${SETTINGS.qst}%)
      </label>
    </div>

    <!-- üü¶ COLONNE DROITE : MONTANTS -->

<!-- üü¶ ESCOMPTE -->
<div class="invoice-ui-discount" style="
  margin-bottom:10px;
  padding:8px;
  border:1px dashed var(--border);
  border-radius:8px;
">

  <div style="font-weight:600;margin-bottom:6px;">
    Escompte
  </div>

  <div style="display:flex; gap:6px;">
    <input
      id="invDiscountValue"
      type="number"
      step="0.01"
      placeholder="0.00"
      value="${inv.discountValue || ""}"
      style="flex:1 1 auto; min-width:140px;"
    >

    <select id="invDiscountType" style="width:48px; flex:0 0 48px;">
      <option value="amount" ${inv.discountType === "amount" ? "selected" : ""}>$</option>
      <option value="percent" ${inv.discountType === "percent" ? "selected" : ""}>%</option>
    </select>
  </div>

  <div class="muted" style="margin-top:4px;font-size:0.8em;">
    Appliqu√© sur le sous-total avant taxes
  </div>
</div>


      <!-- Montants Taxes + Total -->
    <div style="min-width:280px;">

<!-- üü¶ LIGNE ESCOMPTE (affich√©e seulement si > 0) -->
${inv.discount && inv.discount > 0 ? `
  <div
  id="invDiscountRow"
  style="
    display:${inv.discount && inv.discount > 0 ? 'flex' : 'none'};
    justify-content:space-between;
    color:#ffb74d;
    font-weight:600;
    margin-bottom:4px;
  "
>
  <span>Escompte</span>
  <span id="invDiscountAmount">- ${money(inv.discount || 0)} $</span>
</div>
` : ``}
    
      <div style="display:flex; justify-content:space-between;">
        <span>Sous-total</span>
        <b id="invSubTotal">${money(inv.subTotal)} $</b>
      </div>

      <div style="display:flex; justify-content:space-between;">
        <span>TPS</span>
        <b id="invGST">${money(inv.gst)} $</b>
      </div>

      <div style="display:flex; justify-content:space-between;">
        <span>TVQ</span>
        <b id="invQST">${money(inv.qst)} $</b>
      </div>

      <hr>

      <div style="
        display:flex;
        justify-content:space-between;
        font-size:1.3em;
      ">
        <span>TOTAL</span>
        <b id="invTotal">${money(inv.total)} $</b>
      </div>
    </div>

  </div>
</div>


  <!-- PAIEMENTS -->
  ${(inv.payments && inv.payments.length) ? `
    <h3 style="margin-top:25px;">Historique des paiements</h3>

    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th style="text-align:right;">Montant</th>
        </tr>
      </thead>
      <tbody>
        ${paymentsHtml}
      </tbody>
    </table>

    <div style="
      margin-top:10px;
      text-align:right;
      font-size:1.1em;
    ">
      <div>Total pay√© : <b>${money(inv.paidAmount)} $</b></div>
      <div>Solde restant : <b>${money(balance)} $</b></div>
    </div>
  ` : ""}

<!-- ACTIONS -->
<div style="
  margin-top:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
">
  <div class="muted">
    Statut :
    <b>${
      inv.status === "paid"
        ? (inv.paymentMethod === "cash"
            ? "Pay√©e (Comptant)"
            : inv.paymentMethod === "transfer"
              ? "Pay√©e (Virement)"
              : "Pay√©e")
        : inv.status === "partial"
          ? "Partielle"
          : "Impay√©e"
    }</b>
  </div>

  <div class="no-print">

    <!-- ‚úî Pay√©e + menu -->
    <div style="position:relative; display:inline-block;">
      <button class="ghost" ${isLocked ? "disabled" : ""} onclick="toggleInvoicePaymentMenu('${inv.number}')">
        ‚úî Pay√©e
      </button>

      <div id="invoicePayMenu-${inv.number}"
           style="
             display:none;
             position:absolute;
             right:0;
             bottom:100%;
             margin-bottom:6px;
             background:#111;
             border:1px solid #444;
             border-radius:6px;
             z-index:50;
             overflow:hidden;
             min-width:160px;
           ">
        <button class="ghost"
                style="width:100%;text-align:left;"
                onclick="payInvoiceWithMethod('${inv.number}','cash')">
          üíµ Comptant
        </button>

        <button class="ghost"
                style="width:100%;text-align:left;"
                onclick="payInvoiceWithMethod('${inv.number}','transfer')">
          üîÅ Virement
        </button>
      </div>
    </div>

    <!-- autres boutons -->
    <button class="ghost" ${isLocked ? "disabled" : ""} onclick="markInvoicePartial('${inv.number}')">‚ûó Partielle</button>
    <button class="ghost" onclick="printInvoice()">üñ® Imprimer</button>
    <button class="ghost" onclick="closeInvoiceModal()">Fermer</button>

  </div>
</div>
`;

  
  // ===================== TAXES PAR FACTURE (UI LIVE) =====================
setTimeout(() => {
  const gstBox = $("invApplyGST");
  const qstBox = $("invApplyQST");
  const discountInput = $("invDiscountValue");
  const discountType  = $("invDiscountType");

  // üîí Verrouillage escompte si facture pay√©e
if (inv.status === "paid"){
  if (discountInput) discountInput.disabled = true;
  if (discountType)  discountType.disabled  = true;
}

  // üîí Verrouillage taxes si facture pay√©e
if (inv.status === "paid"){
  if (gstBox) gstBox.disabled = true;
  if (qstBox) qstBox.disabled = true;
}

  if (inv.status === "paid"){
  if (discountInput) discountInput.style.opacity = "0.6";
  if (discountType)  discountType.style.opacity  = "0.6";
}

  if (inv.status === "paid"){
  if (gstBox) gstBox.parentElement.style.opacity = "0.6";
  if (qstBox) qstBox.parentElement.style.opacity = "0.6";
}

  if (!gstBox && !qstBox) return;

  // üîí Re-synchroniser l'UI sur l'objet inv (au cas o√π)
  if (gstBox) gstBox.checked = (inv.applyGST !== false);
  if (qstBox) qstBox.checked = (inv.applyQST !== false);

  const applyAndRefresh = () => {
    if (gstBox) inv.applyGST = !!gstBox.checked;
    if (qstBox) inv.applyQST = !!qstBox.checked;

    recalcInvoice(inv);
    saveInvoices();

    // ‚úÖ update visuel imm√©diat
    renderInvoiceTotals(inv, content);
    renderInvoiceDiscount(inv, content);

    // ‚úÖ update la liste des factures (montant)
    if (typeof renderInvoiceList === "function") renderInvoiceList();
  };

  if (gstBox) gstBox.onchange = applyAndRefresh;
  if (qstBox) qstBox.onchange = applyAndRefresh;

if (discountInput && discountType){
  const onDiscountChange = () => {
    inv.discountValue = Number(discountInput.value || 0);
    inv.discountType  = discountType.value;

    recalcInvoice(inv);
    saveInvoices();
    renderInvoiceTotals(inv, content);
    renderInvoiceDiscount(inv, content);

    if (typeof renderInvoiceList === "function") renderInvoiceList();
  };

  discountInput.oninput = onDiscountChange;
  discountType.onchange = onDiscountChange;
}
}, 0);


  renderInvoiceTotals(inv, content);

  // === AFFICHER LA MODAL ===
  modal.style.display = "flex";

  // ‚úÖ Bouton fermer modal
const closeBtn = $("closeInvoiceEditModal");
if (closeBtn){
  closeBtn.onclick = () => {
    $("invoiceEditModal").style.display = "none";
  };
}
}


  function preventLegacyInvoiceEditor(){
  const legacy = document.getElementById("page-invoice-editor");
  if (legacy){
    legacy.remove();
    console.warn("page-invoice-editor supprim√©e (s√©curit√©)");
  }
}


  /* ======================================================
   ‚ö†Ô∏è D√âPR√âCI√â (NE PLUS UTILISER POUR "MODIFIER")
   Cette fonction sert UNIQUEMENT si on veut
   volontairement ouvrir le Work Order li√© √† une facture.
   
   ‚ùå INTERDIT pour l‚Äô√©dition de facture
====================================================== */
  // ‚úÖ Alias pour compatibilit√© (le tableau appelle openInvoiceAsWO)
function openInvoiceAsWO(number){
  // üî• fermer le modal facture
  if ($("invoiceEditModal")) {
    $("invoiceEditModal").style.display = "none";
  }

  // üîÅ ouvrir la facture en mode Work Order
  openInvoiceAsWorkOrder(number);
}


function openInvoiceEdit(number){
  // ‚úÖ On ouvre l'UI identique au WO
  openInvoiceEditModal(number);
  loadInvoices();
}

  
function editInvoiceFromModal(number){
  openInvoiceAsWO(number);
}


  function closeInvoiceModal(){
  const modal = $("invoiceEditModal");
  if(modal) modal.style.display = "none";
}


  function computeTotals(){
    const sub = editItems.reduce((s,it)=> s + (Number(it.qty)||0) * (Number(it.rate)||0), 0);
    const gst = sub * (SETTINGS.gst/100);
    const qst = (sub + gst) * (SETTINGS.qst/100);
    const total = sub + gst + qst;
    return {sub,gst,qst,total};
  }

  function renderEditItems(){
    const tbody = $("editItemsBody");
    if(!tbody) return;
    tbody.innerHTML = "";
    editItems.forEach((it,i)=>{
      const total = (Number(it.qty)||0) * (Number(it.rate)||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input ${inv.locked?'disabled':''} value="${it.type||''}" data-field="type" data-i="${i}" /></td>
        <td><input ${inv.locked?'disabled':''} value="${it.desc||''}" data-field="desc" data-i="${i}" /></td>
        <td><input ${inv.locked?'disabled':''} type="number" value="${it.qty||0}" data-field="qty" data-i="${i}" /></td>
        <td><input ${inv.locked?'disabled':''} type="number" value="${it.rate||0}" data-field="rate" data-i="${i}" /></td>
        <td>${money(total)}</td>
        <td>
          <button class="ghost" data-del="${i}" ${inv.locked?'disabled':''}>X</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("input[data-field]").forEach(inp=>{
      inp.addEventListener("input",()=>{
        const idx = Number(inp.dataset.i);
        const field = inp.dataset.field;
        let val = inp.value;
        if (field === "qty" || field === "rate") val = Number(val);
        editItems[idx][field] = val;
        renderTotalsUI();
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx = Number(btn.dataset.del);
        editItems.splice(idx,1);
        renderEditItems();
        renderTotalsUI();
      });
    });
  }

  function renderTotalsUI(){
    const {sub,gst,qst,total} = computeTotals();
    const elSub = $("editSubTotal");
    const elGst = $("editGST");
    const elQst = $("editQST");
    const elTot = $("editTotal");
    if (elSub) elSub.innerText = money(sub);
    if (elGst) elGst.innerText = money(gst);
    if (elQst) elQst.innerText = money(qst);
    if (elTot) elTot.innerText = money(total);
  }

  
function renderEditUI(){
  const locked = inv.locked === true;

  content.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <h2 style="margin:0;">Facture #${inv.number}</h2>
      <button id="unlockInvoiceBtn"
              class="ghost"
              style="${locked ? '' : 'display:none;'}">
        ‚úèÔ∏è Modifier
      </button>
    </div>

    <div class="muted" style="margin-top:6px;">
      Date : ${inv.date || ""}
    </div>

    <div style="margin-top:12px;">
      <label>Client</label>
      <input id="editInvCustomer"
             value="${inv.customer || inv.clientName || ''}"
             ${locked ? 'disabled' : ''}/>

      <label>Description / V√©hicule</label>
      <input id="editInvJob"
             value="${inv.job || inv.vehicle || ''}"
             ${locked ? 'disabled' : ''}/>
    </div>

    <h3 style="margin-top:16px;">Articles</h3>

    <table style="margin-top:10px;width:100%;">
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
          <th>Qt√©</th>
          <th>Prix</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="editItemsBody"></tbody>
    </table>

    <div style="margin-top:10px;display:flex;gap:10px;">
      <button id="addEditItemBtn"
              class="ghost"
              ${locked ? 'disabled' : ''}>
        + Ajouter un article
      </button>
    </div>

    <h3 style="margin-top:20px;">Totaux</h3>
    <div>Sous-total : <span id="editSubTotal">0.00</span> $</div>
    <div>TPS : <span id="editGST">0.00</span> $</div>
    <div>TVQ : <span id="editQST">0.00</span> $</div>
    <div style="font-weight:700;">
      Total : <span id="editTotal">0.00</span> $
    </div>

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px;">
      <button id="printInvoiceEditBtn" class="ghost">üñ® Imprimer</button>
      <button id="exportPdfEditBtn" class="ghost">üìÑ PDF</button>
      <button id="deleteInvoiceBtn"
              class="ghost"
              style="color:#f55;"
              ${locked ? 'disabled' : ''}>
        Supprimer
      </button>
      <button id="saveInvoiceEditBtn"
              ${locked ? 'disabled' : ''}>
        üíæ Enregistrer
      </button>
      <button id="closeInvoiceEditModal" class="ghost">
        Fermer
      </button>
    </div>
  `;

  /* ===== BINDS ===== */

  const unlockBtn = $("unlockInvoiceBtn");
  if (unlockBtn){
    unlockBtn.onclick = () => {
      if (!confirm("Passer la facture en mode modification ?")) return;
      inv.locked = false;
      saveInvoices();
      renderEditUI();
    };
  }

  const addBtn = $("addEditItemBtn");
  if (addBtn){
    addBtn.onclick = () => {
      editItems.push({type:"Autre", desc:"Nouvel article", qty:1, rate:0});
      renderEditItems();
      renderTotalsUI();
    };
  }

      
const btnSave = $("saveInvoiceEditBtn");
if (btnSave){
  btnSave.onclick = () => {

    const custInput = $("editInvCustomer");
    const jobInput  = $("editInvJob");

    if (custInput) {
      inv.customer = custInput.value.trim();
    }

    if (jobInput) {
      inv.job = jobInput.value.trim();
    }

    inv.items = editItems;

    const {sub, gst, qst, total} = computeTotals();
    inv.subTotal = sub;
    inv.gst = gst;
    inv.qst = qst;
    inv.total = total;

    saveInvoices();
    alert("Facture mise √† jour !");
    modal.style.display = "none";

    if (typeof renderInvoiceList === "function") renderInvoiceList();
    if (typeof renderHistoryTable === "function") renderHistoryTable();
    if (typeof renderDashboard === "function") renderDashboard();
  };
}


  const btnDel = $("deleteInvoiceBtn");
  if (btnDel){
    btnDel.onclick = () => {
      if (!confirm("Supprimer cette facture ?")) return;
      INVOICES = INVOICES.filter(x => String(x.number) !== String(inv.number));
      saveInvoices();
      modal.style.display = "none";
      renderInvoiceList?.();
      renderHistoryTable?.();
      renderDashboard?.();
    };
  }

  
const btnClose = $("closeInvoiceEditModal");
if (btnClose){
  btnClose.onclick = () => {
    modal.style.display = "none";
  };
}


  renderEditItems();
  renderTotalsUI();
}


/* ===================== PRINT SIMPLE ===================== */
if($('btnPrint')){
  $('btnPrint').addEventListener('click',()=>{
    if(!items.length){alert("Aucun article √† imprimer.");return;}
    window.print();
  });
}

/* ===================== BACKUP EXPORT / IMPORT ===================== */
function exportAllData(){
  const data={
    settings:SETTINGS,
    invoices:INVOICES,
    clients:CLIENTS,
    parts:PARTS,
    services:SERVICES
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const date=new Date().toISOString().split("T")[0];
  a.href=url;
  a.download=`garage_backup_${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importAllData(json){
  try{
    if(json.settings) SETTINGS=json.settings;
    if(json.invoices) INVOICES=json.invoices;
    if(json.clients) CLIENTS=json.clients;
    if(json.parts) PARTS=json.parts;
    if(json.services) SERVICES=json.services;
    saveSettings();
    saveInvoices();
    saveClients();
    saveParts();
    saveServices();
    initSettings();
    renderInvoicesTable();
    renderClientsTable();
    renderServices();
    renderDashboard();
    alert("Backup import√© avec succ√®s !");
  }catch(e){
    alert("Erreur lors de l‚Äôimportation du fichier.");
  }
}

if($("btnExportData")){
  $("btnExportData").addEventListener("click", exportAllData);
}
if($("btnImportData")){
  $("btnImportData").addEventListener("click",()=>{
    $("importBackupFile").click();
  });
}
if($("importBackupFile")){
  $("importBackupFile").addEventListener("change",(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=function(evt){
      try{
        const json=JSON.parse(evt.target.result);
        importAllData(json);
      }catch(err){
        alert("Fichier invalide.");
      }
    };
    reader.readAsText(file);
  });
}

/* ===================== NOTES ===================== */

let NOTES = [];

/* Charger */
function loadNotes(){
  NOTES = loadArrayFromStorage(STORAGE.notes);
}


/* Sauver */
function saveNotes() {
    localStorage.setItem(STORAGE.notes, JSON.stringify(NOTES));
  scheduleCloudSync();
}

/* Ajouter note */
function addNote(text, category) {
    const now = new Date();
    const stamp = now.toLocaleString("fr-CA");

    NOTES.push({
        id: Date.now(),
        text,
        category,
        date: stamp
    });

    NOTES.sort((a, b) => b.id - a.id);
    saveNotes();
    renderNotes();
    renderDashboard();
}

/* Modifier */
function updateNote(id, newText) {
    const n = NOTES.find(x => x.id === id);
    if (!n) return;
    n.text = newText;
    saveNotes();
    renderNotes();
}

/* Supprimer */
function deleteNote(id) {
    if (!confirm("Supprimer cette note ?")) return;
    NOTES = NOTES.filter(n => n.id !== id);
    saveNotes();
    renderNotes();
}

/* Rendu Notes */
function renderNotes() {
    const wrap = $("notesList");
    if (!wrap) return;

    const search = ($("noteSearch")?.value || "").toLowerCase();

    let filtered = NOTES.filter(n =>
        n.text.toLowerCase().includes(search) ||
        n.category.toLowerCase().includes(search) ||
        n.date.toLowerCase().includes(search)
    );

  // TRI INTELLIGENT : Urgent ‚Üí √Ä faire ‚Üí G√©n√©ral, puis date
const priority = { urgent: 1, todo: 2, general: 3 };

filtered.sort((a, b) => {
    if (priority[a.category] !== priority[b.category]) {
        return priority[a.category] - priority[b.category];
    }
    return b.id - a.id; // plus r√©cent en premier
});

    if (filtered.length === 0) {
        wrap.innerHTML = `<div class="muted">Aucune note correspondante.</div>`;
        return;
    }

    let html = "";

// GROUPES PAR CAT√âGORIE
const groups = {
    urgent: filtered.filter(n => n.category === "urgent"),
    todo: filtered.filter(n => n.category === "todo"),
    general: filtered.filter(n => n.category === "general")
};

// Fonction pour g√©n√©rer un s√©parateur propre
function categoryHeader(cat, count) {
    const colors = {
        urgent: "#c62828",
        todo: "#f9a825",
        general: "#1565c0"
    };

    const labels = {
        urgent: "üö® Urgent",
        todo: "üìù √Ä faire",
        general: "üìò G√©n√©ral"
    };

    return `
        <h3 style="
            margin-top:20px;
            color:${colors[cat]};
            border-bottom:2px solid ${colors[cat]};
            padding-bottom:4px;
        ">
            ${labels[cat]} (${count})
        </h3>
    `;
}

// Construction du HTML group√©
["urgent", "todo", "general"].forEach(cat => {
    if (groups[cat].length === 0) return;

    html += categoryHeader(cat, groups[cat].length);

    groups[cat].forEach(n => {
        html += `
            <div style="border:1px solid var(--border);padding:10px;border-radius:8px;margin-bottom:8px;">
                
                <div style="font-size:0.8rem;color:var(--muted); display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem;">${n.date}</span>

                    <span style="
                        padding:3px 8px;
                        border-radius:6px;
                        font-size:0.9rem;
                        font-weight:700;
                        color:white;
                        background:${n.category === 'urgent' 
                            ? '#c62828' 
                            : n.category === 'todo' 
                              ? '#f9a825' 
                              : '#1565c0'};
                    ">
                        ${n.category === 'urgent'
                            ? 'üö® Urgent'
                            : n.category === 'todo'
                                ? 'üìù √Ä faire'
                                : 'üìò G√©n√©ral'}
                    </span>
                </div>

                <div id="noteText_${n.id}" style="margin-top:6px;">
                    ${n.text.replace(/\n/g,'<br>')}
                </div>

                <div style="margin-top:8px; display:flex;gap:10px;">
                    <button class="ghost" onclick="editNote(${n.id})">‚úèÔ∏è Modifier</button>
                    <button class="ghost" onclick="deleteNote(${n.id})">üóëÔ∏è Supprimer</button>
                </div>
            </div>
        `;
    });
});

wrap.innerHTML = html;
}

/* Mode √©dition */
function editNote(id) {
    const n = NOTES.find(x => x.id === id);
    if (!n) return;

    const container = $("noteText_" + id);

    container.innerHTML = `
        <textarea id="editNoteInput_${id}" style="width:100%;min-height:80px;">${n.text}</textarea>
        <button class="ghost" onclick="saveEdit(${id})" style="margin-top:6px;">üíæ Sauver</button>
    `;
}

function saveEdit(id) {
    const field = $("editNoteInput_" + id);
    if (!field) return;

    updateNote(id, field.value);
}

/* Export */
function exportNotes() {
    const blob = new Blob([JSON.stringify(NOTES, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "notes_export.json";
    a.click();
}

/* Import */
function importNotes(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) throw "Format invalide";

            NOTES = data;
            saveNotes();
            renderNotes();
            alert("Import compl√©t√© !");
        } catch (err) {
            alert("Erreur : fichier invalide.");
        }
    };

    reader.readAsText(file);
}

/* Initialisation */
function initNotesModule() {
    loadNotes();
    renderNotes();

    if ($("addNoteBtn")) {
        $("addNoteBtn").onclick = () => {
            const text = $("noteInput").value.trim();
            const cat = $("noteCategory").value;
            if (!text) return alert("Entrez une note.");
            addNote(text, cat);
            $("noteInput").value = "";
        };
    }

    if ($("noteSearch")) $("noteSearch").oninput = renderNotes;

    if ($("exportNotesBtn")) $("exportNotesBtn").onclick = exportNotes;

    if ($("importNotesBtn")) {
        $("importNotesBtn").onclick = () => $("importNotesFile").click();
    }

    if ($("importNotesFile")) {
        $("importNotesFile").onchange = importNotes;
    }
}


  /* ===================== LIENS RAPIDES ===================== */

let LINKS = [];

/* Charger */
function loadLinks() {
    try {
        LINKS = JSON.parse(localStorage.getItem("ar_links_v1") || "[]");
        if (!Array.isArray(LINKS)) LINKS = [];
    } catch (e) { LINKS = []; }
}

/* Sauver */
function saveLinks() {
    localStorage.setItem("ar_links_v1", JSON.stringify(LINKS));
  scheduleCloudSync();
}

/* Ajouter lien */
function addLink(name, url, cat, icon) {
    LINKS.push({
        id: Date.now(),
        name,
        url,
        category: cat,
        fav: false
    });

    renderLinks();
    saveLinks();
}

/* Supprimer */
function deleteLink(id) {
    if (!confirm("Supprimer ce lien ?")) return;
    LINKS = LINKS.filter(l => l.id !== id);
    saveLinks();
    renderLinks();
}

/* Modifier */
function editLink(id) {
    const link = LINKS.find(l => l.id === id);
    if (!link) return;

    const newName = prompt("Nom :", link.name);
    if (!newName) return;

    const newURL = prompt("URL :", link.url);
    if (!newURL) return;

    const newIcon = prompt("Ic√¥ne :", link.icon);
    if (!newIcon) return;

    link.name = newName;
    link.url = newURL;
    link.icon = newIcon;

    saveLinks();
    renderLinks();
}

/* Favori */
function toggleFav(id) {
    const link = LINKS.find(l => l.id === id);
    if (!link) return;
    link.fav = !link.fav;
    saveLinks();
    renderLinks();
}

/* Rendu */
function renderLinks() {
    const wrap = $("linksList");
    if (!wrap) return;

    const search = ($("linkSearch")?.value || "").toLowerCase();

    // Filtre par recherche
    let filtered = LINKS.filter(l =>
        l.name.toLowerCase().includes(search) ||
        l.url.toLowerCase().includes(search) ||
        l.category.toLowerCase().includes(search)
    );

    // Tri intelligent : favoris en haut
    filtered.sort((a, b) => {
        if (a.fav && !b.fav) return -1;
        if (!a.fav && b.fav) return 1;
        return a.name.localeCompare(b.name);
    });

    wrap.innerHTML = filtered.map(l => `
        <div class="quick-tile">
            <div class="qt-left">
                <div class="qt-icon">${l.icon || "üîó"}</div>
                <div class="qt-info">
                    <div class="qt-name">${l.name}</div>
                    <div class="qt-url">${l.url}</div>
                </div>
            </div>

            <div class="qt-actions">
                <button class="ghost" onclick="window.open('${l.url}','_blank')">üåê</button>
                <button class="ghost" onclick="editLink(${l.id})">‚úèÔ∏è</button>
                <button class="ghost" onclick="deleteLink(${l.id})">üóëÔ∏è</button>
                <button class="ghost" onclick="toggleFav(${l.id})">${l.fav ? "‚≠ê" : "‚òÜ"}</button>
            </div>
        </div>
    `).join("");
}

/* Export */
function exportLinks() {
    const blob = new Blob([JSON.stringify(LINKS, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "liens_rapides_export.json";
    a.click();
}

/* Import */
function importLinks(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) throw "Format invalide";

            LINKS = data;
            saveLinks();
            renderLinks();
            alert("Import compl√©t√© !");
        } catch {
            alert("Erreur : fichier invalide.");
        }
    };

    reader.readAsText(file);
}

  
function initLinksModule() {
  loadLinks();
  renderLinks();

  if ($("addLinkBtn")) {
    $("addLinkBtn").onclick = () => {
      const name = $("linkName").value.trim();
      const url = $("linkURL").value.trim();
      const cat = $("linkCategory").value;

      if (!name || !url) return alert("Nom et URL obligatoires.");

      addLink(name, url, cat);

      $("linkName").value = "";
      $("linkURL").value = "";
    };
  }

  if ($("linkSearch")) $("linkSearch").oninput = renderLinks;

  if ($("exportLinksBtn")) $("exportLinksBtn").onclick = exportLinks;

  if ($("importLinksBtn")) {
    $("importLinksBtn").onclick = () => $("importLinksFile")?.click();
  }

  if ($("importLinksFile")) {
    $("importLinksFile").onchange = importLinks;
  }
}


  function loadSettings(){
  const saved = JSON.parse(localStorage.getItem(STORAGE.settings) || "{}");

  SETTINGS = {
    ...SETTINGS,
    ...saved
  };

  if ($("settingGarageName"))
    $("settingGarageName").value = SETTINGS.garageName || "";

  if ($("settingGST"))
    $("settingGST").value = SETTINGS.gst ?? 0;

  if ($("settingQST"))
    $("settingQST").value = SETTINGS.qst ?? 0;

  if ($("settingDefaultHourlyRate"))
    $("settingDefaultHourlyRate").value = SETTINGS.defaultHourlyRate ?? 0;

  updateGarageNameUI();
}


  function updateGarageNameUI(){
  const title = document.querySelector(".topbar h1");
  if (title){
    title.textContent = `${SETTINGS.garageName} ‚Äî Gestion`;
  }

  document.title = `${SETTINGS.garageName} ‚Äî Gestion`;
}


  function syncKmEverywhereFromWO(wo, newKm){
  const km = Number(newKm);
  if (!wo || !km || km <= 0) return;

  // 1Ô∏è‚É£ WO (source)
  wo.vehicleKm = km;

  // 2Ô∏è‚É£ V√©hicule du client
  const client = CLIENTS.find(c => String(c.id) === String(wo.clientId));
  if (client && Array.isArray(client.vehicles)){
    const vehicle = client.vehicles.find(v =>
      String(v.id) === String(wo.vehicleId) ||
      `${v.year} ${v.make} ${v.model}` === wo.vehicleLabel
    );
    if (vehicle){
      vehicle.km = km;
    }
  }

  // 3Ô∏è‚É£ Facture li√©e (si existe)
let invoice = null;

// Mode normal : facture li√©e √† un BT
invoice = INVOICES.find(inv => inv.workOrderNumber === wo.number);

// Mode "facture ouverte comme WO"
if (!invoice && wo && wo.__fromInvoice && wo.__invoiceNumber){
  invoice = INVOICES.find(inv => String(inv.number) === String(wo.__invoiceNumber));
}

if (invoice){
  invoice.vehicleKm = km;
}

  // 4Ô∏è‚É£ Persistance
  saveWorkOrders();
  saveInvoices();
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));

  // 5Ô∏è‚É£ UI refresh (safe)
  if (typeof renderWorkOrders === "function") renderWorkOrders();
  if (typeof renderVehiclesPage === "function") renderVehiclesPage();
  if (typeof renderClientsTable === "function") renderClientsTable();
  if (typeof renderInvoiceList === "function") renderInvoiceList();
}

  
function woConvertToInvoice(wo) {
  const number = nextInvoiceNumber();

  const invoice = {
    number,
    date: new Date().toLocaleDateString("fr-CA"),

    clientId: wo.clientId,
    vehicleId: wo.vehicleId,
    vehicleKm: wo.vehicleKm ?? null,
    
    customer: wo.clientName,
    job: wo.vehicleLabel + " - " + (wo.description || ""),
    items: [],
    subTotal: 0,
    gst: 0,
    qst: 0,
    total: 0,
    status: "unpaid",
    locked: true
  };

  // === PI√àCES ===
  wo.parts.forEach(p => {
    invoice.items.push({
      type: "Pi√®ce",
      desc: p.name,
      qty: p.qty,
      rate: p.rate
    });
  });

  // === MAIN-D‚Äô≈íUVRE ===
  wo.labor.forEach(l => {
    invoice.items.push({
      type: "Main-d'≈ìuvre",
      desc: l.description,
      qty: l.hours,
      rate: l.rate
    });
  });

  // === TOTAUX ===
  invoice.subTotal = invoice.items.reduce((s,it)=>s + it.qty * it.rate, 0);
  invoice.gst = invoice.subTotal * (SETTINGS.gst / 100);
  invoice.qst = (invoice.subTotal + invoice.gst) * (SETTINGS.qst / 100);
  invoice.total = invoice.subTotal + invoice.gst + invoice.qst;

  // === SAUVEGARDE ===
  INVOICES.push(invoice);
  saveInvoices();
  renderInvoicesTable();

  // === STATUT WO ===
  wo.status = "billed";
  saveWorkOrders();
  renderWorkOrders();

  // === OUVRIR LA FACTURE ===
  openInvoiceEditModal(invoice.number);
}

  
function printInvoice(){

  const content = document.getElementById("invoiceEditContent");
  if (!content) return;

  // üîß Clone du contenu pour impression (on ne touche PAS √† l'√©cran)
  const clone = content.cloneNode(true);

  // ‚ùå Supprimer bloc TAXES (UI)
  clone.querySelectorAll(".invoice-ui-taxes").forEach(el => el.remove());

  // ‚ùå Supprimer bloc ESCOMPTE (UI)
  clone.querySelectorAll(".invoice-ui-discount").forEach(el => el.remove());

  // ‚ùå Supprimer toute UI interactive restante
  clone.querySelectorAll("input, select, textarea, button, label").forEach(el => el.remove());


  // ================== PDF LAYOUT (position bas gauche/droite) ==================

// --- A) TOTAUX : trouver le conteneur qui contient TOUTES les lignes ---
(function(){
  const needIds = ["invSubTotal", "invGST", "invQST", "invTotal"]; // + invDiscountLine si tu l'ajoutes un jour
  const totalEl = clone.querySelector("#invTotal");
  if (!totalEl) return;

  // remonte jusqu'√† trouver un parent qui contient tous les IDs de montants
  let box = totalEl.parentElement;
  while (box && box !== clone && !needIds.every(id => box.querySelector("#" + id))){
    box = box.parentElement;
  }

  if (box && box !== clone){
    box.classList.add("pdf-totals");
  }
})();


// --- B) PAIEMENTS : regrouper Historique + table + r√©sum√© dans un wrapper ---
(function(){
  const headers = Array.from(clone.querySelectorAll("h1,h2,h3,h4"));
  const h = headers.find(x => (x.textContent || "").toLowerCase().includes("historique des paiements"));
  if (!h) return;

  // wrapper bas-gauche
  const wrap = clone.ownerDocument.createElement("div");
  wrap.className = "pdf-payments";

  // ins√©rer wrapper avant le titre
  h.parentNode.insertBefore(wrap, h);

  // d√©placer le titre
  wrap.appendChild(h);

  // d√©placer la table qui suit (la premi√®re table apr√®s le titre)
  let next = wrap.nextElementSibling; // √©l√©ment juste apr√®s le wrapper (qui √©tait apr√®s h)
  // On cherche la prochaine table dans les siblings
  let table = null;
  while (next){
    if (next.tagName && next.tagName.toLowerCase() === "table"){
      table = next;
      break;
    }
    // stop si on tombe sur le bloc Totaux
    if (next.querySelector && next.querySelector("#invTotal")) break;
    next = next.nextElementSibling;
  }
  if (table) wrap.appendChild(table);

  // d√©placer le petit r√©sum√© "Total pay√© / Solde restant" (div texte √† droite)
  // On prend les 1-2 div suivants qui contiennent "Total pay√©" ou "Solde restant"
  let scan = wrap.nextElementSibling;
  let moved = 0;
  while (scan && moved < 3){
    const txt = (scan.textContent || "").toLowerCase();
    const looksLikeSummary = txt.includes("total pay√©") || txt.includes("solde restant");
    if (looksLikeSummary){
      const keep = scan;
      scan = scan.nextElementSibling;
      wrap.appendChild(keep);
      moved++;
      continue;
    }
    // stop si on tombe sur Totaux
    if (scan.querySelector && scan.querySelector("#invTotal")) break;
    scan = scan.nextElementSibling;
  }
})();

  
  // ================== POSITIONNEMENT PDF ==================

// üîπ Marquer le bloc COMPLET des montants (Escompte, Sous-total, Taxes, Total)
const totalsContainer = clone.querySelector("#invTotal")?.parentElement;
if (totalsContainer){
  totalsContainer.classList.add("pdf-totals");
}

// üîπ Marquer le bloc HISTORIQUE PAIEMENTS (bas gauche)
clone.querySelectorAll("h3").forEach(h=>{
  if (h.textContent.includes("Historique")){
    const payBlock = h.parentElement;
    if (payBlock) payBlock.classList.add("pdf-payments");
  }
});


  const printWindow = window.open("", "", "width=800,height=900");

  printWindow.document.write(`
    <html>
    <head>
      <title>Facture</title>
      <style>
        body {
          font-family: Arial, Helvetica, sans-serif;
          padding: 25px;
          color: #000;
        }
        h2 {
          margin-top: 0;
          border-bottom: 2px solid #000;
          padding-bottom: 6px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
          font-size: 13px;
        }
        th, td {
          border: 1px solid #000;
          padding: 6px;
        }
        th {
          background: #eee;
        }
        .muted {
          color: #555;
        }


/* ================= PDF LAYOUT ================= */

/* ====== BLOC TOTAUX PDF ‚Äî LAYOUT SOLIDE ====== */

.pdf-totals{
  position: fixed;
  right: 25px;
  bottom: 25px;
  width: 260px;

  display: flex;
  flex-direction: column;
  gap: 4px;

  font-size: 12px;
  line-height: 1.25;
}

/* lignes normales (Escompte, Sous-total, TPS, TVQ) */
.pdf-totals > div{
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin: 0;
  padding: 0;
}

/* ligne de s√©paration */
.pdf-totals hr{
  margin: 6px 0;
  border: none;
  border-top: 1px solid #000;
}

/* ===== TOTAL ===== */
.pdf-totals .total-row{
  display: flex;
  justify-content: space-between;
  align-items: baseline;

  margin-top: 4px;
  padding-top: 4px;

  font-size: 15px;
  font-weight: bold;
}

.pdf-totals *{
  position: static !important;
  float: none !important;
}


/* ===== Historique paiements en bas √† gauche ===== */
.pdf-payments{
  position: fixed;
  left: 20px;
  bottom: 22px;
  width: 38%;              /* ‚úÖ plus √©troit */
  font-size: 9px;
  line-height: 1.1;
}

.pdf-payments h1,
.pdf-payments h2,
.pdf-payments h3,
.pdf-payments h4{
  margin: 0 0 4px 0;
  font-size: 10px;
  font-weight: bold;
}

/* Table compacte */
.pdf-payments table{
  width: 100%;
  table-layout: fixed;
  margin-top: 4px;
  font-size: 9px;
  border-collapse: collapse;
}

.pdf-payments th,
.pdf-payments td{
  padding: 2px 4px;
  border: 1px solid #000;
}

.pdf-payments table tr{
  line-height: 1.05;
}

/* Colonnes mieux proportionn√©es */
.pdf-payments th:nth-child(1),
.pdf-payments td:nth-child(1){
  width: 10%;
}

.pdf-payments th:nth-child(2),
.pdf-payments td:nth-child(2){
  width: 60%;
}

.pdf-payments th:nth-child(3),
.pdf-payments td:nth-child(3){
  width: 30%;
  text-align: right;
}

      </style>
    </head>
    <body>
      ${clone.innerHTML}
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}


  function markInvoicePaid(number){
  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv) return;

  inv.status = "paid";
  inv.paidAmount = inv.total;
  inv.paidDate = new Date().toLocaleDateString("fr-CA");

  saveInvoices();
  renderInvoiceList();
  openInvoiceEditModal(number);
}


function archiveInvoice(number){
  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv) return;

  if (inv.status !== "paid"){
    alert("Seules les factures pay√©es peuvent √™tre archiv√©es.");
    return;
  }

  if (!confirm(`Archiver la facture ${inv.number} ?`)) return;

  inv.archived = true;
  inv.archivedDate = new Date().toLocaleDateString("fr-CA");

  saveInvoices();

  // üîÑ AJOUT CRUCIAL üëá
  INVOICES = loadArrayFromStorage(STORAGE.invoices);

  renderInvoiceList();
  renderHistoryTable();
  renderDashboard();
}

  
function markInvoicePartial(number){
  const inv = INVOICES.find(i => String(i.number) === String(number));
  if (!inv) return;

  if (!Array.isArray(inv.payments)) inv.payments = [];

  const remaining = Math.max(0, inv.total - (inv.paidAmount || 0));

  const amt = Number(
    prompt(
      `Montant pay√© (reste ${money(remaining)} $) :`,
      remaining
    )
  );

  if (!amt || amt <= 0 || amt > remaining) return;

  // Ajouter le paiement √† l'historique
  inv.payments.push({
    date: new Date().toLocaleDateString("fr-CA"),
    amount: amt
  });

  // Recalculer le total pay√©
  inv.paidAmount = inv.payments.reduce((s,p)=>s + p.amount, 0);

  // Mettre √† jour le statut
  inv.status = inv.paidAmount >= inv.total ? "paid" : "partial";
  inv.paidDate = new Date().toLocaleDateString("fr-CA");

  saveInvoices();
  renderInvoiceList();
  openInvoiceEditModal(number);
}


  if ($("vehicleSearch")){
  $("vehicleSearch").oninput = renderVehicles;
}

  
console.log("openInvoiceEditModal =", typeof openInvoiceEditModal);

  
/* ===================== INIT ALL ===================== */
window.addEventListener('load',()=>{
  preventLegacyInvoiceEditor();
  initSettings();
  initInvoices();
  initClientsModule();
  initPartsModule();
  initServicesModule();
  initNotesModule();
  initLinksModule();
  loadWorkOrders();
  renderDashboard();
  bindVehicleSort();
updateVehicleSortLabels();

  if ($("invoiceSearch")) {
    $("invoiceSearch").oninput = renderInvoiceList;
  }
  if ($("invoiceStatusFilter")) {
    $("invoiceStatusFilter").onchange = renderInvoiceList;
  }
});

  
  function editVehicle(clientId, vehicleId){
  const client = CLIENTS.find(c => String(c.id) === String(clientId));
  if (!client) return;

  const v = client.vehicles.find(v => String(v.id) === String(vehicleId));
  if (!v) return;

  $("vehEditClientId").value = clientId;
  $("vehEditId").value = vehicleId;

  $("vehEditYear").value  = v.year  || "";
  $("vehEditMake").value  = v.make  || "";
  $("vehEditModel").value = v.model || "";
  $("vehEditPlate").value = v.plate || "";
  $("vehEditVin").value   = v.vin   || "";
  $("vehEditKm").value    = v.km    || "";

  $("vehicleEditModal").style.display = "flex";
}

function closeVehicleEdit(){
  $("vehicleEditModal").style.display = "none";
}

function saveVehicleEdit(){
  const clientId  = $("vehEditClientId").value;
  const vehicleId = $("vehEditId").value;

  const client = CLIENTS.find(c => String(c.id) === String(clientId));
  if (!client) return;

  const v = client.vehicles.find(v => String(v.id) === String(vehicleId));
  if (!v) return;
  v.year = Number($("vehEditYear").value) || "";
  v.make  = $("vehEditMake").value.trim();
  v.model= $("vehEditModel").value.trim();
  v.plate= $("vehEditPlate").value.trim();
  v.vin  = $("vehEditVin").value.trim();
  v.km   = Number($("vehEditKm").value) || 0;

  saveClients();                 // üîí sauvegarde r√©elle
  closeVehicleEdit();            // ferme le modal
  renderVehiclesPage();     // üîÅ refresh CORRECT
} 


  function openClientFromVehicles(clientId){
  // ouvrir le modal client en mode √©dition
  renderClientModal(clientId);
  $("clientModal").style.display = "flex";
}



  /* =====================================================
   ARCHIVE ‚Äì Fonctions non utilis√©es (SAFE)
   Gard√©es volontairement pour √©volutions futures
   ===================================================== */
  
function formatVehicleLabel(v){
  if (!v) return "";
  const y = v.year || "";
  const m = v.make || "";
  const md = v.model || "";
  return `${y} ${m} ${md}`.trim();
}


  function btToInvoiceNumber(btNumber){
  if (!btNumber) return "";
  return btNumber.replace(/^BT/, "FA");
}


  function woRenderDetail(id){
  const detail = $("woDetailContent");
  if(!detail){
    console.warn("woDetailContent absent (page non active)");
    return;
  }

  const wo = WORKORDERS.find(w=>String(w.id)===String(id));
  if(!wo){
    alert("Bon de travail introuvable");
    return;
  }

  detail.innerHTML = `
    <div class="card">
      <h2>Bon de travail #${wo.id}</h2>
      <p><b>Statut :</b> ${wo.status || ''}</p>
      <p><b>Description :</b> ${wo.desc || ''}</p>
    </div>
  `;
}


  /* ===================== APP INIT (SUPABASE) ===================== */
(async function initApp(){
  await supabaseLogin();
  await loadCloudData();
})();

  
</script>

<!-- MODAL D'√âDITION DE LIGNE -->
<div id="woEditModal" class="modal-backdrop">
  <div class="modal-panel" style="width:400px;">
    <h2>Modifier la ligne</h2>
    <div id="woEditContent"></div>

    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px;">
      <button id="woEditCancel" class="ghost">Annuler</button>
      <button id="woEditSave">üíæ Enregistrer</button>
    </div>
  </div>
</div>

  <!-- MODAL √âDITION FACTURE -->
<div id="invoiceEditModal" class="modal-backdrop" style="display:none;">
  <div class="modal-panel" style="max-width:800px;">
    <div id="invoiceEditContent"></div>
  </div>
</div>

  <!-- MODAL √âDITION V√âHICULE -->
<div id="vehicleEditModal" class="modal-backdrop">
  <div class="modal-panel" style="max-width:600px;">
    <h2>Modifier le v√©hicule</h2>

    <input type="hidden" id="vehEditClientId">
    <input type="hidden" id="vehEditId">

    <label>Marque</label>
    <input id="vehEditMake">

    <label>Mod√®le</label>
    <input id="vehEditModel">

    <label>Ann√©e</label>
    <input id="vehEditYear" type="number">

    <label>Plaque</label>
    <input id="vehEditPlate">

    <label>VIN</label>
    <input id="vehEditVin">

    <label>Kilom√©trage</label>
    <input id="vehEditKm" type="number">

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px;">
      <button class="ghost" onclick="closeVehicleEdit()">Annuler</button>
      <button onclick="saveVehicleEdit()">üíæ Enregistrer</button>
    </div>
  </div>
</div>
  
</body>
</html>
