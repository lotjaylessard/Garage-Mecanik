<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier Mécanique J.L — Gestion</title>
  <style>
    :root{
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
      --muted:#aaaaaa;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }
    h1,h2,h3,h4{
      color:var(--accent);
      margin:0 0 10px;
    }
    .muted{color:var(--muted);font-size:0.85rem;}
    a{color:var(--accent);}
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      border:1px solid var(--border);
      border-radius:5px;
      background:var(--bg);
      color:var(--text);
      font-family:inherit;
      margin-bottom:10px;
      resize:vertical;
    }
    button{
      padding:10px 15px;
      background:var(--accent);
      color:var(--bg);
      border:none;
      border-radius:5px;
      cursor:pointer;
      font-weight:bold;
      transition:background 0.2s;
    }
    button:hover{
      background:#e0b43e;
    }
    button.danger{
      background:var(--danger);
      color:var(--text);
    }
    button.danger:hover{
      background:#cc3d3d;
    }
    button.secondary{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
    }
    button.secondary:hover{
      background:#333333;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    th,td{
      padding:10px;
      text-align:left;
      border-bottom:1px solid var(--border);
    }
    th{
      color:var(--accent);
      background:var(--card);
    }
    tr:hover{
      background:var(--card);
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:15px;
    }
    @media(max-width:768px){
      .grid{grid-template-columns:1fr;}
    }
    .view{
      padding:20px;
      max-width:1200px;
      margin:0 auto;
    }
    .modal-backdrop{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      display:none;
      justify-content:center;
      align-items:flex-start;
      padding-top:50px;
      z-index:1000;
    }
    .modal-content{
      background:var(--bg);
      padding:20px;
      border-radius:10px;
      width:90%;
      max-width:800px;
      border:1px solid var(--accent);
      box-shadow:0 0 20px rgba(0,0,0,0.5);
    }
    .modal-content-lg{
      max-width:1000px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    .modal-header h3{
      margin:0;
    }
    .tab-nav button{
      margin-right:10px;
      margin-bottom:10px;
    }
    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:5px;
      font-size:0.8rem;
      font-weight:bold;
    }
    .badge.in_progress{background:#007bff;color:white;}
    .badge.completed{background:#28a745;color:white;}
    .badge.billed{background:var(--accent);color:var(--bg);}
    .badge.cancelled{background:var(--danger);color:white;}
    .action-button{
      margin-left:5px;
      padding:6px 10px;
      font-size:0.9rem;
    }
  </style>
</head>
<body>

<header style="background:var(--card);padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
  <h2 style="margin:0;">Gestion Atelier J.L</h2>
  <nav>
    <button onclick="showView('dashboard')">Tableau de Bord</button>
    <button onclick="showView('workOrders')">Bons de Travail</button>
    <button onclick="showView('invoices')">Factures</button>
    <button onclick="showView('clients')">Clients</button>
    <button onclick="showView('parts')">Pièces</button>
    <button onclick="showView('services')">Services</button>
    <button onclick="showView('settings')">Paramètres</button>
  </nav>
</header>

<main>
  <div id="dashboardView" class="view">
    <h1>Tableau de Bord</h1>
    <div class="grid">
      <div class="card">
        <h3>Bons de Travail Ouverts</h3>
        <p id="dashboardOpenWoCount">0</p>
      </div>
      <div class="card">
        <h3>Revenu Total (Mois)</h3>
        <p id="dashboardMonthlyRevenue">0.00 $</p>
      </div>
    </div>
  </div>

  <div id="workOrdersView" class="view" style="display: none;">
    <h1>Bons de Travail</h1>
    <button onclick="openWoEditModal('new')">Créer un Bon de Travail</button>
    <div id="workOrdersTableContainer" style="margin-top:20px;">
      </div>
  </div>

  <div id="invoicesView" class="view" style="display: none;">
    <h1>Factures</h1>
    <div id="invoicesTableContainer" style="margin-top:20px;">
      </div>
  </div>

  <div id="clientsView" class="view" style="display: none;">
    <h1>Clients</h1>
    <div id="clientsModule">
      </div>
  </div>

  <div id="partsView" class="view" style="display: none;">
    <h1>Inventaire de Pièces</h1>
    <div id="partsModule">
      </div>
  </div>

  <div id="servicesView" class="view" style="display: none;">
    <h1>Catalogue de Services</h1>
    <div id="servicesModule">
      </div>
  </div>
  
  <div id="settingsView" class="view" style="display: none;">
    <h1>Paramètres</h1>
    <div id="settingsModule">
      </div>
  </div>

  <div id="notesView" class="view" style="display: none;">
    <h1>Notes Générales</h1>
    <div id="notesModule">
      </div>
  </div>

  <div id="linksView" class="view" style="display: none;">
    <h1>Liens Rapides</h1>
    <div id="linksModule">
      </div>
  </div>

</main> 

<script>
/* ===================== GLOBAL STATE & STORAGE ===================== */
var CURRENT_VIEW = 'dashboard';
var WORK_ORDERS = [];
var INVOICES = [];
var SETTINGS = {};

/* ===================== VUES & NAVIGATION ===================== */
function showView(viewId){
  // Cache la vue actuelle
  document.getElementById(CURRENT_VIEW + 'View').style.display = 'none';

  // Affiche la nouvelle vue
  let newView = document.getElementById(viewId + 'View');
  if(newView){
    newView.style.display = 'block';
    CURRENT_VIEW = viewId;
  }
}

function renderDashboard(){
  let openCount = WORK_ORDERS.filter(wo => wo.status === 'in_progress').length;
  document.getElementById('dashboardOpenWoCount').textContent = openCount;

  // Calcul du revenu mensuel
  let currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
  let monthlyRevenue = INVOICES
    .filter(inv => inv.date.substring(0, 7) === currentMonth)
    .reduce((sum, inv) => sum + inv.total, 0);

  document.getElementById('dashboardMonthlyRevenue').textContent = monthlyRevenue.toFixed(2) + ' $';
}

/* ===================== GESTION DES PARAMÈTRES ===================== */
function initSettings(){
  let json = localStorage.getItem('settings');
  SETTINGS = json ? JSON.parse(json) : {
    gst: 5.0, // Taxe sur les produits et services
    qst: 9.975, // Taxe de vente du Québec
    nextInvoiceNumber: 1001,
  };
}
function saveSettings(){localStorage.setItem('settings', JSON.stringify(SETTINGS));}
function initClientsModule(){/* Implémentation du module Clients */}
function initPartsModule(){/* Implémentation du module Pièces */}
function initServicesModule(){/* Implémentation du module Services */}
function initNotesModule(){/* Implémentation du module Notes */}
function initLinksModule(){/* Implémentation du module Liens */}

/* ===================== GESTION DES FACTURES ===================== */
function getNextInvoiceNumber(){
  let num = SETTINGS.nextInvoiceNumber;
  SETTINGS.nextInvoiceNumber++;
  saveSettings();
  return num;
}

function initInvoices(){
  let json = localStorage.getItem('invoices');
  INVOICES = json ? JSON.parse(json) : [];
  renderInvoicesTable();
}

// **CORRECTION 2: AJOUT DE saveInvoices()**
function saveInvoices(){localStorage.setItem('invoices', JSON.stringify(INVOICES));}


function renderInvoicesTable(){
  let html = '<table><thead><tr><th># Facture</th><th>Date</th><th>Client</th><th>Total</th><th>Actions</th></tr></thead><tbody>';
  INVOICES.forEach(inv => {
    html += `
      <tr>
        <td>${inv.number}</td>
        <td>${inv.date}</td>
        <td>${inv.client.name}</td>
        <td>${inv.total.toFixed(2)} $</td>
        <td>
          <button class="action-button" onclick="openInvoiceEditModal(${inv.number})">Voir/Modifier</button>
        </td>
      </tr>
    `;
  });
  html += '</tbody></table>';
  document.getElementById('invoicesTableContainer').innerHTML = html;
}

// **CORRECTION 1: AJOUT DE openInvoiceEditModal() (Placeholder)**
// Cette fonction était appelée dans billWorkOrder mais n'était pas définie, causant une ReferenceError.
function openInvoiceEditModal(invoiceNumber){
  console.warn(`La fonction openInvoiceEditModal est appelée pour la facture #${invoiceNumber} mais son implémentation est manquante. Ajout d'une fonction vide pour éviter une erreur console.`);
  // Votre logique d'ouverture du modal d'édition de facture devrait aller ici.
}


/* ===================== GESTION DES BONS DE TRAVAIL ===================== */
function saveWorkOrders(){localStorage.setItem('workOrders', JSON.stringify(WORK_ORDERS));}

// **CORRECTION 3: AJOUT DE loadWorkOrders()**
// Cette fonction était appelée à l'initialisation mais manquait.
function loadWorkOrders(){
  let json = localStorage.getItem('workOrders');
  WORK_ORDERS = json ? JSON.parse(json) : [];
  renderWorkOrders();
}

function renderWorkOrders(){
  let html = '<table><thead><tr><th>ID</th><th>Client</th><th>Véhicule</th><th>Statut</th><th>Actions</th></tr></thead><tbody>';
  WORK_ORDERS.forEach(wo => {
    let statusClass = wo.status.replace('_', '');
    let actionsHtml = '';
    if (wo.status === 'in_progress') {
      actionsHtml = `<button class="action-button" onclick="billWorkOrder(${wo.id})">Facturer</button>`;
    }
    
    html += `
      <tr>
        <td>${wo.id}</td>
        <td>${wo.client.name}</td>
        <td>${wo.vehicle.make} ${wo.vehicle.model}</td>
        <td><span class="badge ${statusClass}">${wo.status.toUpperCase().replace('_', ' ')}</span></td>
        <td>
          <button class="action-button" onclick="openWoEditModal(${wo.id})">Modifier</button>
          ${actionsHtml}
        </td>
      </tr>
    `;
  });
  html += '</tbody></table>';
  document.getElementById('workOrdersTableContainer').innerHTML = html;
}

function openWoEditModal(woId){
  let wo;
  if (woId === 'new') {
    // Logique pour un nouveau bon de travail (non implémentée ici)
    wo = {
      id: WORK_ORDERS.length + 1,
      client: {name: "Nouveau Client"},
      vehicle: {make: "Marque", model: "Modèle"},
      status: "in_progress",
      parts: [],
      labor: [],
    };
  } else {
    wo = WORK_ORDERS.find(w => w.id === woId);
    if (!wo) return;
  }

  // Remplissage du modal (simplifié pour cet exemple)
  document.getElementById('woModalTitle').textContent = `Bon de Travail #${wo.id}`;
  
  // Afficher le modal
  document.getElementById('woEditModal').style.display = 'flex';
}

function closeWoEditModal(){
  document.getElementById('woEditModal').style.display = 'none';
}

function billWorkOrder(woId){
  let wo = WORK_ORDERS.find(w => w.id === woId);

  if(!wo) return;
  if(wo.status !== "in_progress") return;

  let invoice = {
    number: getNextInvoiceNumber(),
    date: new Date().toISOString().split('T')[0],
    client: wo.client,
    items: [],
    subTotal: 0,
    gst: 0,
    qst: 0,
    total: 0,
    woId: wo.id,
  };

  // === PIÈCES ===
  wo.parts.forEach(p => {
    invoice.items.push({
      type: "Pièce",
      desc: `${p.code} - ${p.description}`,
      qty: p.qty,
      rate: p.rate
    });
  });

  // === MAIN-D’ŒUVRE ===
  wo.labor.forEach(l => {
    invoice.items.push({
      type: "Main-d'œuvre",
      desc: l.description,
      qty: l.hours,
      rate: l.rate
    });
  });

  // === TOTAUX ===
  invoice.subTotal = invoice.items.reduce((s,it)=>s + it.qty * it.rate, 0);
  invoice.gst = invoice.subTotal * (SETTINGS.gst / 100);
  invoice.qst = (invoice.subTotal + invoice.gst) * (SETTINGS.qst / 100);
  invoice.total = invoice.subTotal + invoice.gst + invoice.qst;

  // === SAUVEGARDE ===
  INVOICES.push(invoice);
  saveInvoices(); // **CORRIGÉ: Cette fonction existe maintenant**
  renderInvoicesTable();

  // === STATUT WO ===
  wo.status = "billed";
  saveWorkOrders();
  renderWorkOrders();

  // === OUVRIR LA FACTURE ===
  openInvoiceEditModal(invoice.number); // **CORRIGÉ: Cette fonction existe maintenant (en tant que placeholder)**
}

  
/* ===================== INIT ALL ===================== */
window.addEventListener('load',()=> {
  initSettings();
  initInvoices();
  initClientsModule();
  initPartsModule();
  initServicesModule();
  initNotesModule();
  initLinksModule();
  loadWorkOrders(); // **CORRIGÉ: Cette fonction existe maintenant**
  renderDashboard();
});

  
</script>

<div id="woEditModal" class="modal-backdrop">
  <div class="modal-content modal-content-lg">
    <div class="modal-header">
      <h3 id="woModalTitle">Bon de Travail #...</h3>
      <button onclick="closeWoEditModal()" class="secondary">Fermer</button>
    </div>
    
    <div class="tab-nav">
      <button>Informations</button>
      <button>Pièces</button>
      <button>Main-d'œuvre</button>
    </div>
    
    <div style="margin-top: 20px;">
      <p>Contenu du Bon de Travail pour édition...</p>
      <label for="clientName">Nom du Client</label>
      <input type="text" id="clientName" value="[À remplir par JS]">
    </div>

    <div style="margin-top:20px;text-align:right;">
      <button class="danger">Annuler Bon de Travail</button>
      <button>Sauvegarder les Changements</button>
    </div>
  </div>
</div>

<div id="invoiceEditModal" class="modal-backdrop">
  </div>

</body>
</html>
