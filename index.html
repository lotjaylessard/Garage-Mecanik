<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier M√©canique J.L ‚Äî Gestion</title>
  <style>
    :root{
      --bg:#1b1b1b; --card:#262626; --accent:#f5c542; --text:#e6e6e6;
      --border:#3a3a3a; --danger:#ff4d4d;
    }
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0;}
    h1,h2,h3{color:var(--accent);margin:0 0 10px}
    .card{background:var(--card);padding:18px;border-radius:10px;border:1px solid var(--border);margin-bottom:14px;}
    input,select,textarea{width:100%;padding:8px;background:#111;color:var(--text);border:1px solid var(--border);border-radius:6px;margin-top:6px;}
    button{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;}
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent);}    
    table{width:100%;border-collapse:collapse;margin-top:10px;color:var(--text);}    
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;}    
    th{background:#333;color:var(--accent);}    

    /* --- Sidebar --- */
    #sidebar{position:fixed;left:0;top:0;width:240px;height:100%;background:#111;border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:14px;z-index:10}
    #sidebar h2{color:var(--accent);margin-bottom:20px;font-size:20px;}

    /* --- Header --- */
    .topbar{position:fixed;top:0;left:240px;right:0;height:70px;background:#1b1b1b;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:10px 20px;z-index:9}

    /* --- Pages Wrapper --- */
    #appPages{margin-left:240px;margin-top:70px;padding:20px;}
    .page{display:none;}

  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="#FFD400"><path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-.46-.5z"/></svg>
      <h1>Garage-Atelier M√©canique J.L ‚Äî Gestion</h1>
    </div>
    <div style="display:flex;gap:10px;">
      <button id="btnSettings">Param√®tres</button>
      <button id="btnExportCSV" class="ghost">Exporter CSV</button>
      <button id="btnPrint">Imprimer</button>
    </div>
  </div>

  <!-- PAGES CONTAINER -->
  <div id="appPages">

    <!-- PAGE FACTURES -->
    <div class="page" id="page-invoices" style="display:block;">
      <div class="card">
        <h2>Cr√©er Devis / Travail</h2>
        <label>Client</label>
        <input id="customerName" />

        <label>Num√©ro de facture</label>
        <input id="invoiceNumber" disabled />

        <label>Description / V√©hicule</label>
        <input id="jobDesc" />

        <h3>Ajouter une pi√®ce</h3>
        <label>Nom pi√®ce</label>
        <input id="partName" />
        <label>Quantit√©</label>
        <input id="partQty" type="number" value="1" />
        <label>Prix unitaire</label>
        <input id="partPrice" type="number" />
        <button id="addPart">Ajouter pi√®ce</button>

        <h3>Ajouter main-d'≈ìuvre</h3>
        <label>Description</label>
        <input id="laborDesc" />
        <label>Heures</label>
        <input id="laborHours" type="number" />
        <label>Taux / h</label>
        <input id="laborRate" type="number" />
        <button id="addLabor">Ajouter main-d'≈ìuvre</button>

        <h3>Articles</h3>
        <table id="itemsTable"><thead><tr>
          <th>Type</th><th>Description</th><th>Qt√©/hrs</th><th>Prix</th><th>Total</th><th></th>
        </tr></thead><tbody></tbody></table>

        <h3>Total</h3>
        <div>Sous-total: <span id="subTotal">0.00</span> $</div>
        <div>TPS: <span id="gstAmount">0.00</span> $</div>
        <div>TVQ: <span id="qstAmount">0.00</span> $</div>
        <div>Total: <span id="totalAmount">0.00</span> $</div>

        <button id="saveInvoice">Enregistrer facture</button>
        <button id="clearItems" class="ghost">Vider</button>
      </div>

      <div class="card">
        <h2>Factures enregistr√©es</h2>
        <input id="searchInvoices" placeholder="Rechercher..." />
        <select id="filterSort"><option value="new">Plus r√©centes</option><option value="old">Plus anciennes</option></select>
        <table id="invoicesTable"><thead><tr>
          <th>#</th><th>Date</th><th>Client</th><th>Job</th><th>Total</th><th></th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div id="printArea" style="display:none"></div>
    </div>

    <!-- PAGE CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Gestion des Clients</h2>
      <input id="clientSearch" placeholder="Rechercher un client..." />
      <button id="btnAddClient">Ajouter client</button>
      <table id="clientsTable"><thead><tr>
        <th>Nom</th><th>T√©l√©phone</th><th>V√©hicules</th><th></th>
      </tr></thead><tbody></tbody></table>
    </div>

    <div class="page" id="page-vehicles"></div>
    <div class="page" id="page-parts"></div>
    <div class="page" id="page-history"></div>
    <div class="page" id="page-settings"></div>
  </div>


  <!-- CLIENT MODAL -->
  <div id="clientModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:var(--card); width:750px; max-width:95%; padding:20px; border-radius:12px; border:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,0.6); max-height:90vh; overflow-y:auto;">
      <h2>Fiche Client</h2>
      <div id="clientModalContent">Chargement...</div>
      <div style="text-align:right; margin-top:15px;"><button id="closeClientModal" class="ghost">Fermer</button></div>
    </div>
  </div>


<script>
// ===================== PAGE NAVIGATION =====================

document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const pg = document.getElementById(btn.dataset.page);
    if(pg) pg.style.display='block';
  });
});

// ===================== INVOICES ENGINE =====================

const STORAGE = {
  invoices:'ar_invoices_v1', settings:'ar_settings_v1', invoiceCounter:'ar_invoice_counter_v1', clients:'ar_clients_v1'
};

let items=[];
const $=id=>document.getElementById(id);
function money(n){return Number(n||0).toFixed(2);}

  // --- Num√©ro de facture ---
function updateInvoiceNumber(){
  let n = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
  $('invoiceNumber').value = String(n).padStart(5,'0');
}
updateInvoiceNumber();

/* --- Ajouter pi√®ce --- */
$('addPart').addEventListener('click',()=>{
  const name=$('partName').value.trim();
  const qty=Number($('partQty').value)||0;
  const price=Number($('partPrice').value)||0;

  if(!name || qty<=0) return alert("Informations pi√®ce incompl√®tes");

  items.push({type:'Pi√®ce',desc:name,qty,rate:price});
  $('partName').value='';
  $('partPrice').value='';
  $('partQty').value=1;
  renderItems();
});

/* --- Ajouter main-d'≈ìuvre --- */
$('addLabor').addEventListener('click',()=>{
  const desc=$('laborDesc').value.trim();
  const hrs=Number($('laborHours').value)||0;
  const rate=Number($('laborRate').value)||0;

  if(!desc || hrs<=0) return alert("Informations main-d'≈ìuvre incompl√®tes");

  items.push({type:"Main-d'≈ìuvre",desc,qty:hrs,rate});
  $('laborDesc').value='';
  $('laborHours').value='';
  $('laborRate').value='';
  renderItems();
});

/* --- Affichage des items --- */
function renderItems(){
  const tbody=document.querySelector('#itemsTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  let sub=0;

  items.forEach((it,i)=>{
    const total = it.qty * it.rate;
    sub += total;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.type}</td>
      <td>${it.desc}</td>
      <td>${it.qty}</td>
      <td>${money(it.rate)}</td>
      <td>${money(total)}</td>
      <td><button class="ghost" onclick="removeItem(${i})">X</button></td>
    `;
    tbody.appendChild(tr);
  });

  $('subTotal').innerText = money(sub);
  $('gstAmount').innerText = money(sub * 0.05);
  $('qstAmount').innerText = money((sub + sub*0.05) * 0.09975);
  $('totalAmount').innerText = money(sub + (sub*0.05) + ((sub+sub*0.05)*0.09975));
}

function removeItem(i){
  items.splice(i,1);
  renderItems();
}

/* --- Sauvegarder facture --- */
$('saveInvoice').addEventListener('click',()=>{
  const customer=$('customerName').value.trim();
  if(!customer) return alert("Nom du client requis");

  let number = $('invoiceNumber').value;
  let list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');

  list.unshift({
    number,
    date:new Date().toLocaleString(),
    customer,
    job:$('jobDesc').value.trim(),
    items,
    subtotal:Number($('subTotal').innerText),
    gst:Number($('gstAmount').innerText),
    qst:Number($('qstAmount').innerText),
    total:Number($('totalAmount').innerText)
  });

  localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
  localStorage.setItem(STORAGE.invoiceCounter, Number(number));

  items=[];
  renderItems();
  loadInvoices();
  updateInvoiceNumber();

  alert("Facture enregistr√©e !");
});

/* --- Listage factures --- */
function loadInvoices(){
  const list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  const tbody=document.querySelector('#invoicesTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';

  list.forEach((inv,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.customer}</td>
      <td>${inv.job}</td>
      <td>${money(inv.total)}</td>
      <td><button class="ghost" onclick="deleteInvoice(${i})">Suppr</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function deleteInvoice(i){
  if(!confirm("Supprimer ?")) return;
  let list = JSON.parse(localStorage.getItem(STORAGE.invoices)||'[]');
  list.splice(i,1);
  localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
  loadInvoices();
}

loadInvoices();
renderItems();

/* ====================================================================
   CLIENTS (Module complet)
==================================================================== */

let CLIENTS = [];

function loadClientsFromStorage(){
  try{
    CLIENTS = JSON.parse(localStorage.getItem(STORAGE.clients) || '[]');
    if(!Array.isArray(CLIENTS)) CLIENTS = [];
  }catch(e){
    CLIENTS = [];
  }
}

function saveClientsToStorage(){
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
}

function renderClientsTable(){
  const tbody = document.querySelector('#clientsTable tbody');
  if(!tbody) return;
  const qEl = $('clientSearch');
  const q = qEl ? qEl.value.trim().toLowerCase() : '';
  tbody.innerHTML = '';

  CLIENTS.forEach(client => {
    const haystack = `${client.name||''} ${client.phone||''} ${client.email||''} ${client.address||''}`.toLowerCase();
    if(q && !haystack.includes(q)) return;

    const vehicleCount = Array.isArray(client.vehicles) ? client.vehicles.length : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${client.name||''}</td>
      <td>${client.phone||''}</td>
      <td>${client.email||''}</td>
      <td>${client.address||''}</td>
      <td>${vehicleCount}</td>
      <td>
        <button class="ghost" data-action="open-client" data-id="${client.id}">Fiche</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-action="open-client"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      openClientModal(id);
    });
  });
}

function findClientById(id){
  return CLIENTS.find(c => String(c.id) === String(id));
}

function openClientModal(id){
  const modal = $('clientModal');
  if(!modal) return;
  modal.style.display = 'flex';
  renderClientModal(id);
}

function closeClientModal(){
  const modal = $('clientModal');
  if(modal) modal.style.display = 'none';
}

function renderClientModal(id){
  loadClientsFromStorage();
  const content = $('clientModalContent');
  if(!content) return;

  const isNew = !id;
  let client;

  if(isNew){
    client = {
      id: Date.now(),
      name:'',
      phone:'',
      email:'',
      address:'',
      notes:'',
      vehicles:[]
    };
  }else{
    client = findClientById(id);
    if(!client){
      alert('Client introuvable');
      closeClientModal();
      return;
    }
  }

  const invoices = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
  const clientInvoices = invoices.filter(inv => (inv.customer||'').toLowerCase() === (client.name||'').toLowerCase());

  content.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div>
        <h3 style="margin:0 0 6px;color:var(--accent);">Informations client</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <label>Nom</label>
            <input id="clientFormName" value="${client.name||''}" />
          </div>
          <div style="flex:1;min-width:160px;">
            <label>T√©l√©phone</label>
            <input id="clientFormPhone" value="${client.phone||''}" />
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <div style="flex:1;min-width:200px;">
            <label>Email</label>
            <input id="clientFormEmail" value="${client.email||''}" />
          </div>
          <div style="flex:1;min-width:200px;">
            <label>Adresse</label>
            <input id="clientFormAddress" value="${client.address||''}" />
          </div>
        </div>
        <label style="margin-top:8px;">Notes</label>
        <textarea id="clientFormNotes">${client.notes||''}</textarea>
      </div>

      <div>
        <h3 style="margin:10px 0 6px;color:var(--accent);">V√©hicules</h3>
        <div id="clientVehiclesList" class="small"></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:120px;"><label>Marque</label><input id="vehMake" /></div>
          <div style="flex:1;min-width:120px;"><label>Mod√®le</label><input id="vehModel" /></div>
          <div style="flex:1;min-width:80px;"><label>Ann√©e</label><input id="vehYear" /></div>
        </div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:120px;"><label>Plaque</label><input id="vehPlate" /></div>
          <div style="flex:1;min-width:150px;"><label>VIN</label><input id="vehVin" /></div>
          <div style="flex:1;min-width:80px;"><label>KM</label><input id="vehKm" type="number" /></div>
        </div>
        <label style="margin-top:6px;">Notes v√©hicule</label>
        <textarea id="vehNotes"></textarea>
        <button id="clientAddVehicleBtn" style="margin-top:6px;">Ajouter v√©hicule</button>
      </div>

      <div>
        <h3 style="margin:10px 0 6px;color:var(--accent);">Historique (√† partir des factures)</h3>
        <div id="clientHistory" class="small"></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        ${isNew ? '' : '<button id="clientDeleteBtn" class="ghost">Supprimer client</button>'}
        <button id="clientSaveBtn">Enregistrer</button>
      </div>
    </div>
  `;

  function renderVehicles(){
    const wrap = $('clientVehiclesList');
    if(!wrap) return;
    if(!client.vehicles || client.vehicles.length===0){
      wrap.innerHTML = '<div class="muted">Aucun v√©hicule pour ce client.</div>';
      return;
    }
    wrap.innerHTML = client.vehicles.map((v,idx)=>`
      <div style="border:1px solid var(--border);border-radius:6px;padding:6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div><strong>${v.make||''} ${v.model||''} ${v.year||''}</strong></div>
          <div class="small">Plaque: ${v.plate||''} | VIN: ${v.vin||''} | KM: ${v.km||''}</div>
          <div class="small">${v.notes||''}</div>
        </div>
        <button class="ghost" data-index="${idx}" data-role="del-veh">Suppr</button>
      </div>
    `).join('');
    wrap.querySelectorAll('button[data-role="del-veh\"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const idx = Number(btn.getAttribute('data-index'));
        client.vehicles.splice(idx,1);
        renderVehicles();
      });
    });
  }
  renderVehicles();

  const histWrap = $('clientHistory');
  if(histWrap){
    if(clientInvoices.length===0){
      histWrap.innerHTML = '<div class="muted">Aucune facture associ√©e pour ce client pour le moment.</div>';
    }else{
      histWrap.innerHTML = clientInvoices.map(inv=>`
        <div style="border-bottom:1px solid var(--border);padding:4px 0;">
          <div><strong>#${inv.number}</strong> - ${inv.date}</div>
          <div class="small">${inv.job||''}</div>
          <div class="small">Total: ${Number(inv.total||0).toFixed(2)} $</div>
        </div>
      `).join('');
    }
  }

  const btnSave = $('clientSaveBtn');
  if(btnSave){
    btnSave.addEventListener('click',()=>{
      const name = $('clientFormName').value.trim();
      if(!name){ alert('Le nom du client est requis.'); return; }
      client.name = name;
      client.phone = $('clientFormPhone').value.trim();
      client.email = $('clientFormEmail').value.trim();
      client.address = $('clientFormAddress').value.trim();
      client.notes = $('clientFormNotes').value.trim();

      const idx = CLIENTS.findIndex(c => String(c.id) === String(client.id));
      if(idx === -1){
        CLIENTS.push(client);
      }else{
        CLIENTS[idx] = client;
      }
      saveClientsToStorage();
      renderClientsTable();
      closeClientModal();
    });
  }

  const vehBtn = $('clientAddVehicleBtn');
  if(vehBtn){
    vehBtn.addEventListener('click',()=>{
      const make = $('vehMake').value.trim();
      const model = $('vehModel').value.trim();
      const year = $('vehYear').value.trim();
      if(!make && !model){
        alert('Au moins marque ou mod√®le requis pour le v√©hicule.');
        return;
      }
      const v = {
        id: Date.now(),
        make,
        model,
        year,
        plate: $('vehPlate').value.trim(),
        vin: $('vehVin').value.trim(),
        km: $('vehKm').value.trim(),
        notes: $('vehNotes').value.trim()
      };
      if(!Array.isArray(client.vehicles)) client.vehicles = [];
      client.vehicles.push(v);
      $('vehMake').value='';
      $('vehModel').value='';
      $('vehYear').value='';
      $('vehPlate').value='';
      $('vehVin').value='';
      $('vehKm').value='';
      $('vehNotes').value='';
      renderVehicles();
    });
  }

  const btnDelete = $('clientDeleteBtn');
  if(btnDelete && !isNew){
    btnDelete.addEventListener('click',()=>{
      if(!confirm('Supprimer ce client ?')) return;
      CLIENTS = CLIENTS.filter(c => String(c.id) !== String(client.id));
      saveClientsToStorage();
      renderClientsTable();
      closeClientModal();
    });
  }
}

function initClients(){
  loadClientsFromStorage();
  const search = $('clientSearch');
  if(search){
    search.addEventListener('input', renderClientsTable);
  }
  const btnAdd = $('btnAddClient');
  if(btnAdd){
    btnAdd.addEventListener('click', () => openClientModal(null));
  }
  const btnClose = $('closeClientModal');
  if(btnClose){
    btnClose.addEventListener('click', closeClientModal);
  }
  renderClientsTable();
}

initClients();

</script>

</body>
</html>
