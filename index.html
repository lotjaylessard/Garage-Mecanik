<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Atelier - Gestion Mécanique</title>
<style>
  /* === Thème mécanique / industriel === */
  :root{
    --bg:#0f1113; --panel:#141617; --muted:#9aa3ac; --accent:#f5c542;
    --card:#17191b; --glass: rgba(255,255,255,0.03);
    --success:#2ecc71;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#0c0d0e 0%,#0f1113 100%); color:#e6e9eb;}
  header{display:flex;align-items:center;gap:18px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg,#0d0f10 0,#111214 100%)}
  header .brand{display:flex;gap:12px;align-items:center}
  .logo{
    width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#2b2d2f,#131516);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 6px 18px rgba(0,0,0,0.7) inset;
  }
  .brand h1{margin:0;font-size:18px;color:var(--accent);letter-spacing:0.6px}
  nav{margin-left:auto;display:flex;gap:8px;align-items:center}
  .nav-btn{
    background:var(--panel);border:1px solid rgba(255,255,255,0.03);color:#e9ecef;padding:8px 12px;border-radius:8px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;
  }
  .nav-btn:hover{transform:translateY(-1px)}
  main{max-width:1100px;margin:18px auto;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:linear-gradient(180deg,var(--card),#0f1113);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow: 0 8px 30px rgba(0,0,0,0.6)}
  .card h2{margin:0 0 10px;font-size:16px;color:var(--accent)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:6px}
  button{background:linear-gradient(180deg,var(--accent),#e6bf3b);border:none;padding:8px 10px;border-radius:8px;cursor:pointer;color:#111;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:10px;color:inherit}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;font-size:14px}
  th{color:var(--muted);font-weight:600}
  .right{text-align:right}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .page{display:none}
  .page.active{display:block}
  .history-item{background:linear-gradient(180deg,#151617,#101112);border-left:4px solid var(--accent);padding:10px;border-radius:6px;margin-bottom:8px}
  .kbd{background:#111;padding:2px 6px;border-radius:4px;border:1px solid rgba(255,255,255,0.03);font-size:12px}
  /* responsive */
  @media (max-width:980px){.grid{grid-template-columns:1fr;}.nav-btn{padding:8px}}
  /* print */
  @media print{
    body *{visibility:hidden}
    #printArea, #printArea *{visibility:visible}
    #printArea{position:fixed;left:0;top:0;width:100%}
  }
  /* small icons */
  .icon {width:18px;height:18px;display:inline-block;vertical-align:middle}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <!-- simple gearSVG -->
      <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="#f5c542" stroke-width="1.4"/><path d="M19.4 15a7 7 0 0 0 .1-1 7 7 0 0 0-.1-1l2.2-1.7a.5.5 0 0 0 .12-.63l-2.1-3.64a.5.5 0 0 0-.6-.22l-2.6 1a6.9 6.9 0 0 0-1.7-.98L14.5 2.4a.5.5 0 0 0-.5-.4h-4.1a.5.5 0 0 0-.5.4L8.2 6.2c-.6.2-1.1.5-1.7.9l-2.6-1a.5.5 0 0 0-.6.22L1.2 9.9a.5.5 0 0 0 .12.63L3.5 12a7 7 0 0 0 0 2l-2.2 1.7a.5.5 0 0 0-.12.63l2.1 3.64a.5.5 0 0 0 .6.22l2.6-1c.5.4 1.1.7 1.7.9l.9 3.8c.08.3.36.4.5.4h4.1c.14 0 .42-.1.5-.4l.9-3.8c.6-.2 1.1-.5 1.7-.9l2.6 1a.5.5 0 0 0 .6-.22l2.1-3.64a.5.5 0 0 0-.12-.63L19.4 15z" stroke="#f5c542" stroke-width="0.9" fill="rgba(0,0,0,0)"/></svg>
    </div>
    <div>
      <h1>Atelier — Gestion Mécanique</h1>
    </div>
  </div>

  <nav>
    <button class="nav-btn" id="nav-dashboard" title="Tableau de bord">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 13h8V3H3v10zM13 21h8V11h-8v10zM13 3v6h8V3h-8zM3 21h8v-4H3v4z" fill="#fff"/></svg> Dashboard
    </button>

    <button class="nav-btn" id="nav-newwo" title="Bon de travail">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="#fff" stroke-width="1.2"/><path d="M6 6v14h12V6" stroke="#fff" stroke-width="1.2"/></svg> Bon de travail
    </button>

    <button class="nav-btn" id="nav-invoices" title="Factures / Devis">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 7h16" stroke="#fff" stroke-width="1.4"/><rect x="4" y="5" width="16" height="14" rx="2" stroke="#fff" stroke-width="1.2"/></svg> Factures
    </button>

    <button class="nav-btn" id="nav-history" title="Client">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 6v6l4 2" stroke="#fff" stroke-width="1.4"/><circle cx="12" cy="12" r="9" stroke="#fff" stroke-width="1.2"/></svg> Client
    </button>

    <button class="nav-btn" id="nav-history" title="Historique">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 6v6l4 2" stroke="#fff" stroke-width="1.4"/><circle cx="12" cy="12" r="9" stroke="#fff" stroke-width="1.2"/></svg> Historique
    </button>
    
    <button class="nav-btn" id="btn-install" style="display:none" title="Installer l'application">Installer</button>
    <button class="nav-btn" id="nav-settings" title="Paramètres">Paramètres</button>
  </nav>
</header>

<main>
  <div class="grid">
    <!-- Left column -->
    <div>
      <!-- Dashboard Page -->
      <section id="page-dashboard" class="page active card">
        <h2>Tableau de bord</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px" class="card">
            <div class="muted">Bons de travail ouverts</div>
            <div id="stat-open" style="font-size:22px;margin-top:8px">0</div>
          </div>
          <div style="flex:1;min-width:220px" class="card">
            <div class="muted">Nombre de factures</div>
            <div id="stat-invoices" style="font-size:22px;margin-top:8px">0</div>
          </div>
          <div style="flex:1;min-width:220px" class="card">
            <div class="muted">Total encaissé (tous)</div>
            <div id="stat-total" style="font-size:22px;margin-top:8px">0.00 $</div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Récents (bons de travail)</div>
            <div class="muted" style="font-size:13px">Double-cliquer sur un bon pour l'ouvrir</div>
          </div>
          <div id="recent-wo" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- New Work Order Page -->
      <section id="page-newwo" class="page card">
        <h2>Bon de travail</h2>
        
        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>Client</label>
            <input id="wo_client" placeholder="Nom client" />
          </div>
          <div style="width:160px">
            <label>Plaque / VIN</label>
            <input id="wo_vehicle" placeholder="Plaque ou VIN" />
          </div>
        </div>

        <label>Véhicule - modèle / année</label>
        <input id="wo_vehicle_info" placeholder="Ex: Honda Civic 2012" />

        <label>Description du problème / job</label>
        <textarea id="wo_description" rows="3" placeholder="Détails..."></textarea>

        <div style="display:flex;gap:12px;margin-top:10px">
          <div class="card" style="flex:1;padding:10px">
            <div class="muted">Ajouter une pièce</div>
            <input id="wo_part_name" placeholder="Nom pièce" />
            <div style="display:flex;gap:8px;margin-top:6px">
              <input id="wo_part_qty" type="number" placeholder=Prix uni step=0.01 /­­>
              <button class="ghost"
                id="wo_add_part">Ajouter</button>
            </div>
          </div>

        </div> class="card"
        style="flex:1;padding:10px">
            <div class="muted"Ajouter main-d'oeuvre</div>
            <input id="wo_lab_desc"
              placeholder="Ex: Remplacement plaquettes" />
            <div>
              style="display:flex;gap:8px;margin-top:6px">
              <input id="wo_lab_hours"
                type="number" placeholder="Heures"
                step="0.1" />
              <input id="wo_lab_rate"
                type="number" placeholder="Taux/h"
                step="0.01" />
              <button class="ghost"
                id="wo_add_lab">Ajouter</button>
            </div>
          </div>
        </div>

       <h3 style="margin-top:12px">Articles</h3>
        <table id="wo_items_table"><thead><tr><th>Type</th><th>Description</th><th>Qté/hrs</th><th>Prix/u</th><th>Total</th><th></th></tr></thead><tbody></tbody></table>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted">TPS</label><input id="wo_gst" style="width:80px" type="number" step="0.001" value="5.00" />
            <label class="muted">TVQ</label><input id="wo_qst" style="width:80px" type="number" step="0.001" value="9.975" />
          </div>
          <div style="text-align:right">
            <div class="muted">Sous-total: <span id="wo_subtotal">0.00</span> $</div>
            <div class="muted">TPS: <span id="wo_gst_amt">0.00</span> $</div>
            <div class="muted">TVQ: <span id="wo_qst_amt">0.00</span> $</div>
            <h3>Total: <span id="wo_total">0.00</span> $</h3>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
              <button id="wo_save" title="Enregistrer bon">Enregistrer</button>
              <button id="wo_to_invoice" class="ghost" title="Transformer en facture">Vers facture</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Invoices Page -->
      <section id="page-invoices" class="page card">
        <h2>Factures / Devis</h2>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="inv_search" placeholder="Rechercher client, n°, date" />
          <select id="inv_sort">
            <option value="new">Récentes</option>
            <option value="old">Anciennes</option>
          </select>
          <button id="export_invoices_csv" class="ghost">Export CSV</button>
        </div>

        <table id="invoices_table"><thead><tr><th>N°</th><th>Date</th><th>Client</th><th>Job</th><th>Total</th><th></th></tr></thead><tbody></tbody></table>
      </section>

      <!-- History Page -->
      <section id="page-history" class="page card">
        <h2>Historique des bons de travail</h2>

        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="hist_search" placeholder="Client, plaque/VIN, description..." />
          <button id="filter_by_vehicle" class="ghost">Par véhicule</button>
          <button id="export_wo_csv" class="ghost">Export CSV</button>
        </div>

        <div id="history-list"></div>
      </section>

      <!-- Settings Page -->
      <section id="page-settings" class="page card">
        <h2>Paramètres</h2>
        <label>Nom de l'entreprise</label>
        <input id="s_company" placeholder="Mon Garage" />
        <label>Coordonnées (adresse, tel, email)</label>
        <textarea id="s_contact" rows="3"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>TPS (%)</label>
            <input id="s_gst" type="number" step="0.001" />
          </div>
          <div style="width:140px">
            <label>TVQ (%)</label>
            <input id="s_qst" type="number" step="0.001" />
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button id="s_save">Sauvegarder</button>
          <button id="s_reset" class="ghost">Réinitialiser données</button>
        </div>
      </section>
    </div>

    <!-- Right column -->
    <aside>
      <div class="card">
        <h2>Actions rapides</h2>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
          <button id="quick_newwo" class="ghost">Nouveau Bon</button>
          <button id="quick_newinv">Nouvelle facture</button>
          <button id="quick_history" class="ghost">Voir historique</button>
          <button id="quick_install" class="ghost" style="display:none">Installer PWA</button>
        </div>
      </div>

      <div class="card">
        <h2>Rechercher véhicule / client</h2>
        <input id="lookup_input" placeholder="Plaque, VIN ou nom client" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="lookup_btn">Chercher</button>
          <button id="lookup_clear" class="ghost">Effacer</button>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Résultats</div>
          <div id="lookup_results" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <h2>Imprimer / Export</h2>
        <div style="display:flex;gap:8px">
          <button id="print_all" class="ghost">Imprimer Aperçu</button>
          <button id="export_all_json" class="ghost">Exporter JSON</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Hidden printable area -->
  <div id="printArea" style="display:none"></div>
</main>

<script>
/* ========== Storage keys & helpers ========== */
const KEYS = {
  WORK: 'ar_workorders_v2',
  INV: 'ar_invoices_v2',
  SETTINGS: 'ar_settings_v2',
  COUNTER: 'ar_invoice_counter_v2'
};
const $ = id => document.getElementById(id);
function money(n){return Number(n||0).toFixed(2);}

/* ========== Load / Save ========== */
function loadWorkOrders(){ return JSON.parse(localStorage.getItem(KEYS.WORK) || '[]'); }
function saveWorkOrders(list){ localStorage.setItem(KEYS.WORK, JSON.stringify(list)); }
function loadInvoices(){ return JSON.parse(localStorage.getItem(KEYS.INV) || '[]'); }
function saveInvoices(list){ localStorage.setItem(KEYS.INV, JSON.stringify(list)); }
function loadSettings(){ return JSON.parse(localStorage.getItem(KEYS.SETTINGS) || '{}'); }
function saveSettings(s){ localStorage.setItem(KEYS.SETTINGS, JSON.stringify(s)); }
function nextInvoiceNumber(){
  let n = Number(localStorage.getItem(KEYS.COUNTER) || 0) + 1;
  localStorage.setItem(KEYS.COUNTER, n);
  return String(n).padStart(5,'0');
}

/* ========== UI Navigation ========== */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el = $(id);
  if(el) el.classList.add('active');
}
['nav-dashboard','nav-newwo','nav-invoices','nav-history','nav-settings'].forEach(btn=>{
  const map = {
    'nav-dashboard':'page-dashboard',
    'nav-newwo':'page-newwo',
    'nav-invoices':'page-invoices',
    'nav-history':'page-history',
    'nav-settings':'page-settings'
  };
  const node = $(btn);
  if(node) node.addEventListener('click', ()=> showPage(map[btn]));
});

/* ========== Initialize settings and fields ========== */
function initSettingsUI(){
  const s = loadSettings();
  $('s_company').value = s.companyName || 'Mon Garage';
  $('s_contact').value = s.companyContact || 'Adresse\nTéléphone';
  $('s_gst').value = s.gst ?? 5.00;
  $('s_qst').value = s.qst ?? 9.975;
  // WO default tax fields:
  $('wo_gst').value = s.gst ?? 5.00;
  $('wo_qst').value = s.qst ?? 9.975;
}
$('s_save').addEventListener('click', ()=>{
  const s = { companyName: $('s_company').value, companyContact: $('s_contact').value, gst: Number($('s_gst').value)||0, qst: Number($('s_qst').value)||0 };
  saveSettings(s);
  alert('Paramètres sauvegardés');
  initSettingsUI();
});
$('s_reset').addEventListener('click', ()=>{
  if(confirm('Supprimer toutes les factures et bons de travail locaux ?')){
    localStorage.removeItem(KEYS.WORK);
    localStorage.removeItem(KEYS.INV);
    localStorage.removeItem(KEYS.COUNTER);
    loadAll();
  }
});

/* ========== Dashboard Stats & Recent WO ========== */
function refreshDashboard(){
  const wos = loadWorkOrders();
  const invs = loadInvoices();
  $('stat-open').innerText = wos.length;
  $('stat-invoices').innerText = invs.length;
  const total = invs.reduce((s,i)=>s + (Number(i.total)||0), 0);
  $('stat-total').innerText = money(total) + ' $';
  // recent workorders
  const recent = wos.slice(0,6);
  const container = $('recent-wo');
  container.innerHTML = recent.map(o=>`
    <div class="history-item" data-id="${o.id}" style="cursor:pointer">
      <strong>${o.client}</strong> — ${o.vehicle || ''} <span class="muted" style="float:right">${o.status||'OUVERT'}</span><br>
      <div class="muted" style="font-size:12px">${(new Date(o.id)).toLocaleString()}</div>
      <div style="margin-top:6px">${(o.description||'').slice(0,120)}</div>
    </div>
  `).join('');
  // double click to open
  container.querySelectorAll('.history-item').forEach(el=>{
    el.addEventListener('dblclick', ()=>{
      const id = Number(el.dataset.id);
      openWorkOrderEdit(id);
    });
  });
}

/* ========== Work Order (WO) logic ========== */
let WO_items = [];
function woRenderItems(){
  const tbody = document.querySelector('#wo_items_table tbody');
  tbody.innerHTML = '';
  let sub = 0;
  WO_items.forEach((it,idx)=>{
    const total = Number(it.qty)*Number(it.rate);
    sub += total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.type}</td><td>${it.desc}</td><td>${it.qty}</td><td>${money(it.rate)}</td><td>${money(total)}</td><td><button class="ghost" data-idx="${idx}">Suppr</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-idx]').forEach(b=>b.addEventListener('click', e=>{
    WO_items.splice(Number(e.currentTarget.dataset.idx),1);
    woRenderItems();
    woApplyTaxes();
  }));
  $('wo_subtotal').innerText = money(sub);
  woApplyTaxes();
}
function woApplyTaxes(){
  const sub = Number($('wo_subtotal').innerText) || 0;
  const gst = Number($('wo_gst').value)||0;
  const qst = Number($('wo_qst').value)||0;
  const gstAmt = sub * gst/100;
  const qstAmt = (sub + gstAmt) * qst/100;
  $('wo_gst_amt').innerText = money(gstAmt);
  $('wo_qst_amt').innerText = money(qstAmt);
  $('wo_total').innerText = money(sub + gstAmt + qstAmt);
}
$('wo_add_part').addEventListener('click', ()=>{
  const name = $('wo_part_name').value.trim();
  const qty = Number($('wo_part_qty').value) || 0;
  const price = Number($('wo_part_price').value) || 0;
  if(!name || qty<=0 || price<0){ alert('Nom, quantité et prix requis'); return; }
  WO_items.push({ type: 'Pièce', desc: name, qty, rate: price });
  $('wo_part_name').value=''; $('wo_part_price').value=''; $('wo_part_qty').value=1;
  woRenderItems();
});
$('wo_add_lab').addEventListener('click', ()=>{
  const desc = $('wo_lab_desc').value.trim();
  const hrs = Number($('wo_lab_hours').value) || 0;
  const rate = Number($('wo_lab_rate').value) || 0;
  if(!desc || hrs<=0 || rate<0){ alert('Description, heures et taux requis'); return; }
  WO_items.push({ type: "Main-d'oeuvre", desc, qty: hrs, rate });
  $('wo_lab_desc').value=''; $('wo_lab_hours').value=''; $('wo_lab_rate').value='';
  woRenderItems();
});
$('wo_gst').addEventListener('change', woApplyTaxes);
$('wo_qst').addEventListener('change', woApplyTaxes);

/* Save work order */
function saveWorkOrder(){
  const client = $('wo_client').value.trim();
  if(!client) return alert('Nom du client requis');
  const vehicle = $('wo_vehicle').value.trim();
  const description = $('wo_description').value.trim();
  if(WO_items.length===0) {
    if(!confirm('Aucun article ajouté. Sauvegarder quand même?')) return;
  }
  const id = Date.now();
  const wo = {
    id,
    client,
    vehicle,
    vehicleInfo: $('wo_vehicle_info').value || '',
    description,
    items: JSON.parse(JSON.stringify(WO_items)),
    subtotal: Number($('wo_subtotal').innerText)||0,
    gst: Number($('wo_gst_amt').innerText)||0,
    qst: Number($('wo_qst_amt').innerText)||0,
    total: Number($('wo_total').innerText)||0,
    status: 'OUVERT'
  };
  const list = loadWorkOrders();
  list.unshift(wo);
  saveWorkOrders(list);
  WO_items = [];
  woRenderItems();
  $('wo_client').value=''; $('wo_vehicle').value=''; $('wo_vehicle_info').value=''; $('wo_description').value='';
  alert('Bon de travail enregistré');
  loadAll();
}
$('wo_save').addEventListener('click', saveWorkOrder);

/* Convert WO to Invoice */
$('wo_to_invoice').addEventListener('click', ()=>{
  if(WO_items.length===0) return alert('Aucun article à convertir');
  // Create invoice object similar to earlier invoice structure
  const number = nextInvoiceNumber();
  const inv = {
    number,
    date: new Date().toLocaleString(),
    client: $('wo_client').value || '',
    job: $('wo_description').value || '',
    items: JSON.parse(JSON.stringify(WO_items)),
    subtotal: Number($('wo_subtotal').innerText)||0,
    gst: Number($('wo_gst_amt').innerText)||0,
    qst: Number($('wo_qst_amt').innerText)||0,
    total: Number($('wo_total').innerText)||0
  };
  const invs = loadInvoices();
  invs.unshift(inv); saveInvoices(invs);
  // Optionally mark WO closed or create a copy
  if(confirm('Enregistrer la facture et marquer ce bon comme TERMINÉ ?')){
    // Save WO as closed
    const id = Date.now();
    const wo = {
      id,
      client: $('wo_client').value || '',
      vehicle: $('wo_vehicle').value || '',
      vehicleInfo: $('wo_vehicle_info').value || '',
      description: $('wo_description').value || '',
      items: JSON.parse(JSON.stringify(WO_items)),
      subtotal: inv.subtotal, gst: inv.gst, qst: inv.qst, total: inv.total,
      status: 'TERMINÉ'
    };
    const list = loadWorkOrders(); list.unshift(wo); saveWorkOrders(list);
    // reset
    WO_items = [];
    woRenderItems();
    $('wo_client').value=''; $('wo_vehicle').value=''; $('wo_vehicle_info').value=''; $('wo_description').value='';
  }
  alert('Facture créée (#'+inv.number+')');
  loadAll();
});

/* Open existing WO in editor */
function openWorkOrderEdit(id){
  const list = loadWorkOrders();
  const wo = list.find(w=>w.id===id);
  if(!wo) return alert('Bon introuvable');
  showPage('page-newwo');
  $('wo_client').value = wo.client;
  $('wo_vehicle').value = wo.vehicle || '';
  $('wo_vehicle_info').value = wo.vehicleInfo || '';
  $('wo_description').value = wo.description || '';
  WO_items = JSON.parse(JSON.stringify(wo.items || []));
  $('wo_subtotal').innerText = money(wo.subtotal||0);
  $('wo_gst').value = (loadSettings().gst) || 5.00;
  $('wo_qst').value = (loadSettings().qst) || 9.975;
  woRenderItems();
  woApplyTaxes();
}

/* ========== Invoices UI ========== */
function renderInvoicesTable(){
  const list = loadInvoices() || [];
  const tbody = $('invoices_table').querySelector('tbody');
  tbody.innerHTML = '';
  const q = $('inv_search').value.trim().toLowerCase();
  const sorted = list.sort((a,b)=> $('inv_sort').value==='new' ? (new Date(b.date) - new Date(a.date)) : (new Date(a.date)-new Date(b.date)));
  sorted.forEach((inv, idx)=>{
    if(q && !(inv.client.toLowerCase().includes(q) || inv.number.includes(q) || (inv.job||'').toLowerCase().includes(q))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inv.number}</td><td>${inv.date}</td><td>${inv.client}</td><td>${inv.job||''}</td><td>${money(inv.total)}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="ghost view-inv" data-idx="${idx}">Voir</button>
          <button class="ghost del-inv" data-idx="${idx}">Suppr</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.view-inv').forEach(b => b.addEventListener('click', e=>{
    const i = Number(e.currentTarget.dataset.idx);
    viewInvoice(i);
  }));
  tbody.querySelectorAll('.del-inv').forEach(b => b.addEventListener('click', e=>{
    const i = Number(e.currentTarget.dataset.idx);
    if(!confirm('Supprimer facture ?')) return;
    const list = loadInvoices(); list.splice(i,1); saveInvoices(list); renderInvoicesTable(); loadAll();
  }));
}
$('inv_search').addEventListener('input', renderInvoicesTable);
$('inv_sort').addEventListener('change', renderInvoicesTable);

/* Render single invoice for print */
function buildInvoiceHTML(company, contact, inv){
  const itemsHtml = (inv.items || []).map(it=>`<tr><td>${it.type}</td><td>${it.desc}</td><td>${it.qty}</td><td>${money(it.rate)}</td><td>${money(it.qty*it.rate)}</td></tr>`).join('');
  return `
    <div style="padding:20px;color:#000;font-family:Arial;background:#fff;width:800px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2 style="margin:0">${company}</h2><div style="white-space:pre-wrap">${contact}</div></div>
        <div style="text-align:right">
          <div><strong>Facture #</strong> ${inv.number}</div>
          <div><strong>Date:</strong> ${inv.date}</div>
        </div>
      </div>
      <hr />
      <div style="margin-top:10px"><strong>Client:</strong> ${inv.client}</div>
      <div style="margin-top:10px"><strong>Job:</strong> ${inv.job || ''}</div>
      <table style="width:100%;margin-top:12px;border-collapse:collapse">
        <thead><tr style="background:#f3f3f3"><th>Type</th><th>Description</th><th>Qté/hrs</th><th>Prix/u</th><th>Total</th></tr></thead>
        <tbody>${itemsHtml}</tbody>
      </table>
      <div style="text-align:right;margin-top:12px">
        <div>Sous-total: ${money(inv.subtotal)} $</div>
        <div>TPS: ${money(inv.gst)} $</div>
        <div>TVQ: ${money(inv.qst)} $</div>
        <h3>Total: ${money(inv.total)} $</h3>
      </div>
      <hr />
      <div style="font-size:12px;color:#333">Merci! Paiement comptant ou par carte.</div>
    </div>
  `;
}
function viewInvoice(index){
  const invs = loadInvoices();
  const inv = invs[index];
  if(!inv) return alert('Introuvable');
  const s = loadSettings();
  $('printArea').style.display='block';
  $('printArea').innerHTML = buildInvoiceHTML(s.companyName||'Mon Garage', s.companyContact||'', inv);
  window.print();
  $('printArea').style.display='none';
}

/* ========== History UI ========== */
function renderHistoryList(){
  const list = loadWorkOrders() || [];
  const q = $('hist_search').value.trim().toLowerCase();
  const container = $('history-list');
  const filtered = list.filter(w=>{
    if(!q) return true;
    return (w.client||'').toLowerCase().includes(q) || (w.vehicle||'').toLowerCase().includes(q) || (w.description||'').toLowerCase().includes(q);
  });
  container.innerHTML = filtered.map(w=>`
    <div class="history-item" data-id="${w.id}">
      <strong>${w.client}</strong> — ${w.vehicle || ''} <span style="float:right" class="muted">${w.status||''}</span><br>
      <div class="muted" style="font-size:12px">${(new Date(w.id)).toLocaleString()}</div>
      <div style="margin-top:8px">${(w.description||'').slice(0,200)}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="ghost view-wo" data-id="${w.id}">Voir</button>
        <button class="ghost dup-wo" data-id="${w.id}">Dupliquer</button>
        <button class="ghost del-wo" data-id="${w.id}">Suppr</button>
      </div>
    </div>
  `).join('');
  // attach handlers
  container.querySelectorAll('.view-wo').forEach(b=>b.addEventListener('click', e=>{
    const id = Number(e.currentTarget.dataset.id);
    openWorkOrderEdit(id);
  }));
  container.querySelectorAll('.dup-wo').forEach(b=>b.addEventListener('click', e=>{
    const id = Number(e.currentTarget.dataset.id);
    const list = loadWorkOrders();
    const wo = list.find(x=>x.id===id);
    if(!wo) return;
    // duplicate into new WO editor
    showPage('page-newwo');
    $('wo_client').value = wo.client;
    $('wo_vehicle').value = wo.vehicle;
    $('wo_vehicle_info').value = wo.vehicleInfo || '';
    $('wo_description').value = wo.description || '';
    WO_items = JSON.parse(JSON.stringify(wo.items||[]));
    woRenderItems();
  }));
  container.querySelectorAll('.del-wo').forEach(b=>b.addEventListener('click', e=>{
    const id = Number(e.currentTarget.dataset.id);
    if(!confirm('Supprimer ce bon de travail ?')) return;
    let list = loadWorkOrders(); list = list.filter(w=>w.id !== id); saveWorkOrders(list); renderHistoryList(); loadAll();
  }));
}
$('hist_search').addEventListener('input', renderHistoryList);

/* ========== Lookup quick search ========== */
$('lookup_btn').addEventListener('click', ()=>{
  const q = $('lookup_input').value.trim().toLowerCase();
  if(!q) return;
  const wos = loadWorkOrders();
  const invs = loadInvoices();
  const matchesWO = wos.filter(w=> (w.client||'').toLowerCase().includes(q) || (w.vehicle||'').toLowerCase().includes(q));
  const matchesInv = invs.filter(i=> (i.client||'').toLowerCase().includes(q) || (i.number||'').toLowerCase().includes(q));
  const out = [];
  if(matchesWO.length){
    out.push('<div class="muted">Bons trouvés</div>');
    matchesWO.slice(0,8).forEach(w=> out.push(`<div class="history-item"><strong>${w.client}</strong> — ${w.vehicle||''}<div class="muted" style="font-size:12px">${(new Date(w.id)).toLocaleDateString()}</div></div>`));
  }
  if(matchesInv.length){
    out.push('<div class="muted" style="margin-top:8px">Factures trouvées</div>');
    matchesInv.slice(0,8).forEach(i=> out.push(`<div class="history-item"><strong>${i.client}</strong> — #${i.number}<div class="muted" style="font-size:12px">${i.date}</div></div>`));
  }
  $('lookup_results').innerHTML = out.join('') || '<div class="muted">Aucun résultat</div>';
});
$('lookup_clear').addEventListener('click', ()=>{ $('lookup_input').value=''; $('lookup_results').innerHTML=''; });

/* ========== Export / Print helpers ========== */
$('export_invoices_csv').addEventListener('click', ()=>{
  const list = loadInvoices();
  if(!list.length) return alert('Aucune facture');
  let csv = 'number,date,client,job,subtotal,gst,qst,total\n';
  list.forEach(i=> csv += `${i.number},"${i.date}","${(i.client||'').replace(/"/g,'""')}","${(i.job||'').replace(/"/g,'""')}",${i.subtotal},${i.gst},${i.qst},${i.total}\n`);
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'factures.csv'; a.click(); URL.revokeObjectURL(url);
});
$('export_wo_csv').addEventListener('click', ()=>{
  const list = loadWorkOrders();
  if(!list.length) return alert('Aucun bon de travail');
  let csv = 'id,date,client,vehicle,description,subtotal,gst,qst,total,status\n';
  list.forEach(w=> csv += `${w.id},"${(new Date(w.id)).toLocaleString()}","${(w.client||'').replace(/"/g,'""')}","${(w.vehicle||'').replace(/"/g,'""')}","${(w.description||'').replace(/"/g,'""')}",${w.subtotal},${w.gst},${w.qst},${w.total},"${w.status}"\n`);
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'bons_de_travail.csv'; a.click(); URL.revokeObjectURL(url);
});
$('print_all').addEventListener('click', ()=>{
  // print simple summary
  const s = loadSettings();
  const wos = loadWorkOrders();
  let html = `<div style="padding:20px;font-family:Arial;background:#fff;color:#000"><h2>${s.companyName||'Mon Garage'} - Résumé</h2>`;
  wos.forEach(w=> {
    html += `<div style="margin-bottom:8px"><strong>${w.client}</strong> — ${w.vehicle||''} — ${(new Date(w.id)).toLocaleString()}<div>${(w.description||'')}</div></div>`;
  });
  html += '</div>';
  $('printArea').style.display='block'; $('printArea').innerHTML = html; window.print(); $('printArea').style.display='none';
});
$('export_all_json').addEventListener('click', ()=>{
  const all = { settings: loadSettings(), workorders: loadWorkOrders(), invoices: loadInvoices() };
  const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='backup_atelier.json'; a.click(); URL.revokeObjectURL(url);
});

/* ========== Quick actions wiring ========== */
$('quick_newwo').addEventListener('click', ()=> showPage('page-newwo'));
$('quick_newinv').addEventListener('click', ()=> showPage('page-invoices'));
$('quick_history').addEventListener('click', ()=> showPage('page-history'));
$('quick_install').addEventListener('click', installPWA);

/* ========== PWA: basic service worker from blob ========= */
if('serviceWorker' in navigator){
  const swCode = `self.addEventListener('install', e => { self.skipWaiting(); }); self.addEventListener('activate', e => { clients.claim(); }); self.addEventListener('fetch', e => {});`;
  try{
    const blob = new Blob([swCode],{type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).then(()=>console.log('SW registered (blob)')).catch(()=>console.warn('SW failed'));
  }catch(e){console.warn('SW error', e)}
}
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  window.deferredPrompt = e;
  $('btn-install').style.display = 'inline-flex';
  $('quick_install').style.display = 'inline-flex';
});
$('btn-install').addEventListener('click', installPWA);
function installPWA(){ const prompt = window.deferredPrompt; if(!prompt) return; prompt.prompt(); window.deferredPrompt = null; }

/* ========== Load everything and refresh UI ========== */
function loadAll(){
  initSettingsUI();
  renderHistoryList();
  renderInvoicesTable();
  refreshDashboard();
}
loadAll();

/* ========== Initial demo population (only if empty) - optional ========== */
/* Uncomment to seed demo data for first run
if(loadWorkOrders().length===0){
  const demo = [{id:Date.now(),client:'Jean Tremblay',vehicle:'ABC-123',description:'Freins bruyants',items:[{type:'Pièce',desc:'Plaquettes',qty:4,rate:45},{type:'Main-d\'oeuvre',desc:'Changement',qty:1.5,rate:80}],subtotal: (4*45+1.5*80),gst:0,qst:0,total: (4*45+1.5*80),status:'OUVERT'}];
  saveWorkOrders(demo);
  loadAll();
}
*/

/* ========== Ensure links between modules update lists when changed ========== */
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') loadAll(); });

</script>
</body>
</html>
