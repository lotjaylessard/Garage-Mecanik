<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Repair Shop - Single User</title>
  <style>
  :root{
    --bg:#1b1b1b;
    --card:#262626;
    --accent:#f5c542;
    --text:#e6e6e6;
    --border:#3a3a3a;
    --danger:#ff4d4d;
  }
  body{
    font-family:Inter, system-ui, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:18px;
  }
  h1,h2,h3{color:var(--accent);margin:0 0 10px}
  .container{max-width:1080px;margin:0 auto}
  .card{
    background:var(--card);
    padding:18px;
    border-radius:10px;
    border:1px solid var(--border);
    margin-bottom:14px;
    box-shadow:0 4px 10px rgba(0,0,0,0.4);
  }
  input,select,textarea{
    width:100%;padding:8px;
    background:#111;
    color:var(--text);
    border:1px solid var(--border);
    border-radius:6px;
    margin-top:6px;
  }
  label{font-weight:600;font-size:13px}
  button{
    background:var(--accent);
    color:#000;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 3px 6px rgba(0,0,0,0.4);
  }
  button.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid var(--accent);
  }
  table{width:100%;border-collapse:collapse;margin-top:10px;color:var(--text)}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
  th{background:#333;color:var(--accent)}
  .topbar{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:12px
  }
  .history-item{
    background:#202020;border-left:4px solid var(--accent);
    padding:10px;margin-bottom:8px;border-radius:6px
  }
  @media print{
    body *{visibility:hidden}
    #printArea,*#printArea *{visibility:visible}
    #printArea{position:fixed;left:0;top:0;width:100%}
  }
</style>
</head>
<body>
  <!-- Sidebar Option A -->
  <div id="sidebar" style="position:fixed;left:0;top:0;width:220px;height:100%;background:#111;border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:14px;z-index:10">
    <h2 style="color:var(--accent);margin-bottom:20px;font-size:20px">Menu</h2>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.navBtn').forEach(btn=>{
        btn.onclick = ()=>{
          const page = btn.dataset.page;
          document.querySelectorAll('.page').forEach(p=>p.style.display='none');
          const target = document.getElementById(page);
          if(target) target.style.display='block';
        };
      });
    });
  </script>

  <div style="margin-left:240px">

  <!-- ======================= PAGES (STRUCTURE DE BASE) ======================= -->

  <!-- PAGE FACTURES -->
  <div class="page" id="page-invoices" style="display:block; padding:20px;">

  <!-- === Carte : Cr√©er devis / travail (RESTAUR√â) === -->
  <div class="card">
      <h2 style="margin-bottom:8px">Cr√©er Devis / Travail</h2>

      <div class="row">
        <div>
          <label>Client</label>
          <input id="customerName" placeholder="Nom du client" />
        </div>
        <div>
          <label>Num√©ro de facture (auto)</label>
          <input id="invoiceNumber" disabled />
        </div>
      </div>

      <label>V√©hicule / Description</label>
      <input id="jobDesc" placeholder="Ex: Honda Civic 2012 - Freins avant" />

      <div class="flex" style="margin-top:10px">

        <!-- Ajouter pi√®ce -->
        <div class="card" style="flex:1">
          <h3 class="small">Ajouter une pi√®ce</h3>
          <label>Nom pi√®ce</label>
          <input id="partName" placeholder="Ex: Plaquette de frein" />

          <div class="row">
            <div>
              <label>Quantit√©</label>
              <input id="partQty" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Prix unitaire</label>
              <input id="partPrice" type="number" min="0" step="0.01" />
            </div>
          </div>

          <button style="margin-top:8px" id="addPart">Ajouter pi√®ce</button>
        </div>


        <!-- Ajouter main-d'≈ìuvre -->
        <div class="card" style="flex:1">
          <h3 class="small">Ajouter main-d'≈ìuvre</h3>
          <label>Description</label>
          <input id="laborDesc" placeholder="Ex: Remplacement plaquettes" />

          <div class="row">
            <div>
              <label>Heures</label>
              <input id="laborHours" type="number" min="0" step="0.1" />
            </div>
            <div>
              <label>Taux /h</label>
              <input id="laborRate" type="number" min="0" step="0.01" />
            </div>
          </div>

          <button style="margin-top:8px" id="addLabor">Ajouter main-d'≈ìuvre</button>
        </div>
      </div>

      <h3 style="margin-top:12px">Articles</h3>
      <table id="itemsTable">
        <thead><tr><th>Type</th><th>Description</th><th>Qt√©/hrs</th><th>Prix/unit√©</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:12px;align-items:center">
        <div style="width:320px;">
          <label>Appliquer taxes</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <label><input type="checkbox" id="applyGST" /> TPS/GST</label>
            <label><input type="checkbox" id="applyQST" /> TVQ/QST</label>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <label class="small">TPS (%)</label>
            <input id="gstRate" type="number" step="0.001" />
            <label class="small">TVQ (%)</label>
            <input id="qstRate" type="number" step="0.001" />
          </div>
        </div>

        <div style="text-align:right;min-width:260px">
          <div class="muted">Sous-total: <span id="subTotal">0.00</span> $</div>
          <div class="muted">TPS: <span id="gstAmount">0.00</span> $</div>
          <div class="muted">TVQ: <span id="qstAmount">0.00</span> $</div>
          <h3>Total: $<span id="totalAmount">0.00</span></h3>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="saveInvoice">Enregistrer facture</button>
            <button id="clearItems" class="ghost">Vider</button>
          </div>
        </div>
      </div>
    </div>


    <!-- === Carte : Factures enregistr√©es (RESTAUR√âE) === -->
    <div class="card">
      <h2>Factures enregistr√©es</h2>

      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input id="searchInvoices" placeholder="Rechercher client, num√©ro ou date" />
        <select id="filterSort">
          <option value="new">Les plus r√©centes</option>
          <option value="old">Les plus anciennes</option>
        </select>
      </div>

      <table id="invoicesTable">
        <thead><tr><th>N¬∞</th><th>Date</th><th>Client</th><th>V√©hicule/Job</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

</div>

  <!-- === Carte : Factures enregistr√©es === -->
  <div class="card">
    <h2>Factures enregistr√©es</h2>
  </div>
  <!-- ======= FIN MODULE FACTURES ======= -->
</div>

  <!-- PAGE CLIENTS -->
  <div class="page" id="page-clients" style="display:none; padding:20px;">

  <h2 style="color:var(--accent); margin-bottom:15px;">üë§ Gestion des Clients</h2>

  <!-- Barre recherche + bouton ajouter -->
  <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
    <input id="clientSearch" placeholder="Rechercher un client..." style="flex:1;">
    <button id="btnAddClient">Ajouter un client</button>
  </div>

  <!-- Tableau des clients -->
  <table id="clientsTable" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Nom</th>
        <th>T√©l√©phone</th>
        <th>V√©hicules</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div></div>

  <!-- PAGE V√âHICULES -->
  <div class="page" id="page-vehicles" style="display:none; padding:20px;"></div>

  <!-- PAGE INVENTAIRE PI√àCES -->
  <div class="page" id="page-parts" style="display:none; padding:20px;"></div>

  <!-- PAGE HISTORIQUE -->
  <div class="page" id="page-history" style="display:none; padding:20px;"></div>

  <!-- PAGE PARAM√àTRES -->
  <div class="page" id="page-settings" style="display:none; padding:20px;"></div>

  <!-- ======================= FIN DES PAGES ======================= -->
  <div class="container">
    <div class="topbar">
      <div style="width:40px;height:40px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:10px">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="#FFD400" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-2.81-1.35-.1a6.94 6.94 0 0 0-.54-1.3l.84-1.07a.5.5 0 0 0-.04-.66l-1.42-1.42a.5.5 0 0 0-.66-.04l-1.07.84c-.42-.25-.86-.45-1.3-.54l-.1-1.35a.5.5 0 0 0-.5-.46h-2a.5.5 0 0 0-.5.46l-.1 1.35c-.45.1-.88.3-1.3.54l-1.07-.84a.5.5 0 0 0-.66.04L5.15 8.56a.5.5 0 0 0-.04.66l.84 1.07c-.25.42-.45.86-.54 1.3l-1.35.1a.5.5 0 0 0-.46.5v2c0 .26.2.48.46.5l1.35.1c.1.45.3.88.54 1.3l-.84 1.07a.5.5 0 0 0 .04.66l1.42 1.42c.18.18.46.2.66.04l1.07-.84c.42.25.86.45 1.3.54l.1 1.35c.02.26.24.46.5.46h2c.26 0 .48-.2.5-.46l.1-1.35c.45-.1.88-.3 1.3-.54l1.07.84c.2.16.48.14.66-.04l1.42-1.42a.5.5 0 0 0 .04-.66l-.84-1.07c.25-.42.45-.86.54-1.3l1.35-.1c.26-.02.46-.24.46-.5v-2a.5.5 0 0 0-.46-.5z"/>
        </svg>
      </div>
      <h1>Auto Repair Shop ‚Äî Gestion (1 utilisateur)</h1>
      <div class="actions">
        <button id="btnSettings">Param√®tres</button>
        <button id="btnExportCSV" class="ghost">Exporter CSV</button>
        <button id="btnPrint">Imprimer / Exporter PDF</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom:8px">Cr√©er Devis / Travail</h2>
      <div class="row">
        <div>
          <label>Client</label>
          <input id="customerName" placeholder="Nom du client" />
        </div>
        <div>
          <label>Num√©ro de facture (auto)</label>
          <input id="invoiceNumber" disabled />
        </div>
      </div>
      <label>V√©hicule / Description</label>
      <input id="jobDesc" placeholder="Ex: Honda Civic 2012 - Freins avant" />

      <div class="flex" style="margin-top:10px">
        <div class="card" style="flex:1">
          <h3 class="small">Ajouter une pi√®ce</h3>
          <label>Nom pi√®ce</label>
          <input id="partName" placeholder="Ex: Plaquette de frein" />
          <div class="row">
            <div>
              <label>Quantit√©</label>
              <input id="partQty" type="number" min="1" value="1" />
            </div>
            <div>
              <label>Prix unitaire</label>
              <input id="partPrice" type="number" min="0" step="0.01" />
            </div>
          </div>
          <button style="margin-top:8px" id="addPart">Ajouter pi√®ce</button>
        </div>

        <div class="card" style="flex:1">
          <h3 class="small">Ajouter main-d'≈ìuvre</h3>
          <label>Description</label>
          <input id="laborDesc" placeholder="Ex: Remplacement plaquettes" />
          <div class="row">
            <div>
              <label>Heures</label>
              <input id="laborHours" type="number" min="0" step="0.1" />
            </div>
            <div>
              <label>Taux /h</label>
              <input id="laborRate" type="number" min="0" step="0.01" />
            </div>
          </div>
          <button style="margin-top:8px" id="addLabor">Ajouter main-d'≈ìuvre</button>
        </div>
      </div>

      <h3 style="margin-top:12px">Articles</h3>
      <table id="itemsTable">
        <thead><tr><th>Type</th><th>Description</th><th>Qt√©/hrs</th><th>Prix/unit√©</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:12px;align-items:center">
        <div style="width:320px;">
          <label>Appliquer taxes</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <label><input type="checkbox" id="applyGST" /> TPS/GST</label>
            <label><input type="checkbox" id="applyQST" /> TVQ/QST</label>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <label class="small">TPS (%)</label>
            <input id="gstRate" type="number" step="0.001" />
            <label class="small">TVQ (%)</label>
            <input id="qstRate" type="number" step="0.001" />
          </div>
        </div>

        <div style="text-align:right;min-width:260px">
          <div class="muted">Sous-total: <span id="subTotal">0.00</span> $</div>
          <div class="muted">TPS: <span id="gstAmount">0.00</span> $</div>
          <div class="muted">TVQ: <span id="qstAmount">0.00</span> $</div>
          <h3>Total: $<span id="totalAmount">0.00</span></h3>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="saveInvoice">Enregistrer facture</button>
            <button id="clearItems" class="ghost">Vider</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Factures enregistr√©es</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input id="searchInvoices" placeholder="Rechercher client, num√©ro ou date" />
        <select id="filterSort">
          <option value="new">Les plus r√©centes</option>
          <option value="old">Les plus anciennes</option>
        </select>
      </div>
      <table id="invoicesTable">
        <thead><tr><th>N¬∞</th><th>Date</th><th>Client</th><th>V√©hicule/Job</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Clients & V√©hicules</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input id="searchClients" placeholder="Rechercher client ou v√©hicule" />
        <button id="addClient">Ajouter client</button>
      </div>
      <table id="clientsTable">
        <thead><tr><th>Client</th><th>V√©hicules</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Hidden printable area -->
    <div id="printArea" style="display:none"></div>

    <!-- Settings Modal (simple) -->
    <div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
      <div style="width:720px;max-width:95%;background:white;padding:18px;border-radius:10px">
        <h3>Param√®tres de l'atelier</h3>
        <label>Nom de l'entreprise</label>
        <input id="companyName" />
        <label>Adresse / T√©l√©phone</label>
        <textarea id="companyContact" rows="2"></textarea>
        <div class="row">
          <div>
            <label>TPS par d√©faut (%)</label>
            <input id="gstDefault" type="number" step="0.001" />
          </div>
          <div>
            <label>TVQ par d√©faut (%)</label>
            <input id="qstDefault" type="number" step="0.001" />
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="saveSettings">Sauvegarder</button>
          <button id="closeSettings" class="ghost">Fermer</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- State ---
    let items = [];
    const STORAGE = {
      invoices: 'ar_invoices_v1',
      settings: 'ar_settings_v1',
      invoiceCounter: 'ar_invoice_counter_v1',
      clients: 'ar_clients_v1'
    };

    // --- Utilities ---
    const $ = id => document.getElementById(id);
    function money(n){return Number(n||0).toFixed(2)}

    // --- Load settings or defaults ---
    function loadSettings(){
      const s = JSON.parse(localStorage.getItem(STORAGE.settings) || '{}');
      $('companyName').value = s.companyName || 'Garage-Atelier M√©canique J.L';
      $('companyContact').value = s.companyContact || 'Adresse 
T√©l√©phone';
      $('gstDefault').value = s.gstDefault ?? 5.00;
      $('qstDefault').value = s.qstDefault ?? 9.975;
      $('gstRate').value = s.gstDefault ?? 5.00;
      $('qstRate').value = s.qstDefault ?? 9.975;
    }

    // --- Invoice number ---
    function nextInvoiceNumber(){
      let n = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
      localStorage.setItem(STORAGE.invoiceCounter, n);
      return String(n).padStart(5,'0');
    }

    function updateInvoiceNumberField(){
      const next = Number(localStorage.getItem(STORAGE.invoiceCounter) || 0) + 1;
      $('invoiceNumber').value = String(next).padStart(5,'0');
    }

    // --- Add items ---
    $('addPart').addEventListener('click',()=>{
      const name = $('partName').value.trim();
      const qty = Number($('partQty').value)||0;
      const price = Number($('partPrice').value)||0;
      if(!name || qty<=0 || price<0) return alert('Nom, quantit√© et prix requis');
      items.push({type:'Pi√®ce',desc:name,qty,rate:price});
      renderItems();
      $('partName').value='';$('partPrice').value='';$('partQty').value=1;
    });

    $('addLabor').addEventListener('click',()=>{
      const desc = $('laborDesc').value.trim();
      const hrs = Number($('laborHours').value)||0;
      const rate = Number($('laborRate').value)||0;
      if(!desc || hrs<=0 || rate<0) return alert('Description, heures et taux requis');
      items.push({type:"Main-d'≈ìuvre",desc,qty:hrs,rate});
      renderItems();
      $('laborDesc').value='';$('laborHours').value='';$('laborRate').value='';
    });

    function renderItems(){
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML='';
      let sub=0;
      items.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        const total = Number(it.qty)*Number(it.rate);
        sub += total;
        tr.innerHTML = `<td>${it.type}</td><td>${it.desc}</td><td>${it.qty}</td><td>${money(it.rate)}</td><td>${money(total)}</td><td><button data-idx='${idx}' class='ghost'>Suppr</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('#itemsTable button[data-idx]').forEach(b=>b.addEventListener('click',e=>{
        const i = Number(e.currentTarget.dataset.idx); items.splice(i,1); renderItems();
      }));
      $('subTotal').innerText = money(sub);
      applyTaxAndTotals();
    }

    function applyTaxAndTotals(){
      const sub = Number($('subTotal').innerText)||0;
      const gstOn = $('applyGST').checked;
      const qstOn = $('applyQST').checked;
      const gstRate = Number($('gstRate').value)||0;
      const qstRate = Number($('qstRate').value)||0;
      const gstAmount = gstOn ? sub * gstRate/100 : 0;
      const qstAmount = qstOn ? (sub + gstAmount) * qstRate/100 : 0; // QST applied on subtotal+GST in QC rules
      $('gstAmount').innerText = money(gstAmount);
      $('qstAmount').innerText = money(qstAmount);
      $('totalAmount').innerText = money(sub + gstAmount + qstAmount);
    }

    ['applyGST','applyQST','gstRate','qstRate'].forEach(id=>$(id).addEventListener('change',applyTaxAndTotals));

    $('clearItems').addEventListener('click',()=>{items=[];renderItems();});

    // --- Save invoice ---
    $('saveInvoice').addEventListener('click',()=>{
      const customer = $('customerName').value.trim();
      if(!customer) return alert('Nom du client requis');
      if(items.length===0) return alert('Ajouter au moins un √©l√©ment');
      const inv = {
        number: $('invoiceNumber').value || nextInvoiceNumber(),
        date: new Date().toLocaleString(),
        customer, job: $('jobDesc').value, items: JSON.parse(JSON.stringify(items)),
        subtotal: Number($('subTotal').innerText)||0,
        gst: Number($('gstAmount').innerText)||0,
        qst: Number($('qstAmount').innerText)||0,
        total: Number($('totalAmount').innerText)||0
      };
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      list.unshift(inv);
      localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
      // increment counter if needed
      if(!localStorage.getItem(STORAGE.invoiceCounter)) localStorage.setItem(STORAGE.invoiceCounter, Number(inv.number));
      updateInvoiceNumberField();
      // Reset
      items = [];
      $('customerName').value='';$('jobDesc').value='';
      renderItems();
      loadInvoices();
      alert('Facture enregistr√©e');
    });

    // --- Load invoices list ---
    function loadInvoices(){
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      const tbody = document.querySelector('#invoicesTable tbody');
      tbody.innerHTML='';
      const q = $('searchInvoices').value.trim().toLowerCase();
      const sorted = list.sort((a,b)=>{ return ($('filterSort').value==='new')? (new Date(b.date) - new Date(a.date)) : (new Date(a.date)-new Date(b.date)); });
      sorted.forEach((inv,idx)=>{
        if(q && !(inv.customer.toLowerCase().includes(q) || inv.number.includes(q) || inv.date.toLowerCase().includes(q))) return;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${inv.number}</td><td>${inv.date}</td><td>${inv.customer}</td><td>${inv.job||''}</td><td>${money(inv.total)}</td><td>
          <div style='display:flex;gap:6px'>
            <button data-idx='${idx}' class='ghost view'>Voir</button>
            <button data-idx='${idx}' class='ghost del'>Suppr</button>
          </div>
        </td>`;
        tbody.appendChild(tr);
      });
      // attach actions
      document.querySelectorAll('#invoicesTable .view').forEach(b=>b.addEventListener('click',e=>{
        const i = Number(e.currentTarget.dataset.idx);
        viewInvoice(i);
      }));
      document.querySelectorAll('#invoicesTable .del').forEach(b=>b.addEventListener('click',e=>{
        if(!confirm('Supprimer facture ?')) return;
        const i = Number(e.currentTarget.dataset.idx);
        const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
        list.splice(i,1);
        localStorage.setItem(STORAGE.invoices, JSON.stringify(list));
        loadInvoices();
      }));
    }

    function viewInvoice(i){
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      const inv = list[i];
      if(!inv) return alert('Facture introuvable');
      // populate printable area
      const settings = JSON.parse(localStorage.getItem(STORAGE.settings) || '{}');
      const company = settings.companyName || 'Garage-Atelier M√©canique J.L';
      const contact = settings.companyContact || '';
      const html = buildInvoiceHTML(company,contact,inv);
      const printArea = $('printArea');
      printArea.style.display='block';
      printArea.innerHTML = html;
      window.print();
      printArea.style.display='none';
    }

    function buildInvoiceHTML(company,contact,inv){
      let itemsHtml = '';
      inv.items.forEach(it=> itemsHtml += `<tr><td>${it.type}</td><td>${it.desc}</td><td>${it.qty}</td><td>${money(it.rate)}</td><td>${money(it.qty*it.rate)}</td></tr>`);
      return `
        <div style='padding:20px;font-family:Arial;width:800px'>
          <h2>${company}</h2>
          <div style='white-space:pre-wrap'>${contact}</div>
          <hr />
          <div style='display:flex;justify-content:space-between'>
            <div><strong>Facture #: </strong>${inv.number}<br/><strong>Date:</strong> ${inv.date}<br/><strong>Client:</strong> ${inv.customer}</div>
            <div><strong>Job:</strong><br/>${inv.job||''}</div>
          </div>
          <table style='width:100%;margin-top:12px;border-collapse:collapse'>
            <thead><tr style='background:#f3f4f6'><th>Type</th><th>Description</th><th>Qt√©/hrs</th><th>Prix/u</th><th>Total</th></tr></thead>
            <tbody>${itemsHtml}</tbody>
          </table>
          <div style='margin-top:12px;text-align:right'>
            <div>Sous-total: ${money(inv.subtotal)} $</div>
            <div>TPS: ${money(inv.gst)} $</div>
            <div>TVQ: ${money(inv.qst)} $</div>
            <h3>Total: ${money(inv.total)} $</h3>
          </div>
          <hr />
          <div class='small'>Merci! Paiement comptant ou par carte.</div>
        </div>
      `;
    }

    // --- Export CSV ---
    $('btnExportCSV').addEventListener('click',()=>{
      const list = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      if(list.length===0) return alert('Aucune facture');
      let csv = 'number,date,customer,job,subtotal,gst,qst,total
';
      list.forEach(i=> csv += `${i.number},"${i.date}","${i.customer}","${(i.job||'').replace(/"/g,'""')}",${i.subtotal},${i.gst},${i.qst},${i.total}
`);
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='factures.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // --- Print current draft (assemble invoice from current fields) ---
    $('btnPrint').addEventListener('click',()=>{
      if(items.length===0) return alert('Aucun article √† imprimer.');
      const inv = {
        number: $('invoiceNumber').value || nextInvoiceNumber(),
        date: new Date().toLocaleString(),
        customer: $('customerName').value || '', job: $('jobDesc').value,
        items: items, subtotal: Number($('subTotal').innerText)||0, gst: Number($('gstAmount').innerText)||0, qst: Number($('qstAmount').innerText)||0, total: Number($('totalAmount').innerText)||0
      };
      const settings = JSON.parse(localStorage.getItem(STORAGE.settings) || '{}');
      const html = buildInvoiceHTML(settings.companyName||'Garage-Atelier M√©canique J.L',settings.companyContact||'',inv);
      const printArea = $('printArea'); printArea.style.display='block'; printArea.innerHTML = html; window.print(); printArea.style.display='none';
    });

    // --- Settings modal ---
    $('btnSettings').addEventListener('click',()=>{$('settingsModal').style.display='flex';});
    $('closeSettings').addEventListener('click',()=>{$('settingsModal').style.display='none';});
    $('saveSettings').addEventListener('click',()=>{
      const s = {companyName:$('companyName').value,companyContact:$('companyContact').value,gstDefault:Number($('gstDefault').value)||0,qstDefault:Number($('qstDefault').value)||0};
      localStorage.setItem(STORAGE.settings,JSON.stringify(s));
      // update tax fields
      $('gstRate').value = s.gstDefault; $('qstRate').value = s.qstDefault;
      $('settingsModal').style.display='none';
      alert('Param√®tres sauvegard√©s');
    });

    // --- Search/sort handlers ---
    $('searchInvoices').addEventListener('input',loadInvoices);
    $('filterSort').addEventListener('change',loadInvoices);

    // === Gestion Clients ===
    let CLIENTS = [];

    function loadClientsFromStorage(){
      try{
        CLIENTS = JSON.parse(localStorage.getItem(STORAGE.clients) || '[]');
        if(!Array.isArray(CLIENTS)) CLIENTS = [];
      }catch(e){ CLIENTS = []; }
    }

    function saveClientsToStorage(){
      localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
    }

    function renderClientsTable(){
      const tbody = document.querySelector('#clientsTable tbody');
      if(!tbody) return;
      const qInput = document.getElementById('clientSearch');
      const q = qInput ? qInput.value.trim().toLowerCase() : '';
      tbody.innerHTML = '';
      CLIENTS.forEach(client=>{
        const vehicleCount = Array.isArray(client.vehicles) ? client.vehicles.length : 0;
        const hay = (client.name||'') + ' ' + (client.phone||'') + ' ' + (client.email||'');
        if(q && !hay.toLowerCase().includes(q)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${client.name||''}</td>
          <td>${client.phone||''}</td>
          <td>${vehicleCount}</td>
          <td>
            <button class="ghost" data-action="open-client" data-id="${client.id}">Fiche</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-action="open-client"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-id');
          openClientModal(id);
        });
      });
    }

    function findClientById(id){
      return CLIENTS.find(c => String(c.id) === String(id));
    }

    function openClientModal(id){
      const modal = document.getElementById('clientModal');
      if(!modal) return;
      modal.style.display = 'flex';
      renderClientModal(id);
    }

    function closeClientModal(){
      const modal = document.getElementById('clientModal');
      if(modal) modal.style.display = 'none';
    }

    function renderClientModal(id){
      loadClientsFromStorage();
      const content = document.getElementById('clientModalContent');
      if(!content) return;
      const isNew = !id;
      let client = null;
      if(isNew){
        client = { id: Date.now(), name:'', phone:'', email:'', address:'', notes:'', vehicles:[] };
      }else{
        client = findClientById(id);
        if(!client){
          alert('Client introuvable');
          closeClientModal();
          return;
        }
      }

      const invoices = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
      const clientInvoices = invoices.filter(inv => (inv.customer||'').toLowerCase() === (client.name||'').toLowerCase());

      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:14px;">
          <div>
            <h3 style="margin:0 0 6px; color:var(--accent);">Informations client</h3>
            <div class="row">
              <div>
                <label>Nom</label>
                <input id="clientFormName" value="${client.name||''}" />
              </div>
              <div>
                <label>T√©l√©phone</label>
                <input id="clientFormPhone" value="${client.phone||''}" />
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <div>
                <label>Email</label>
                <input id="clientFormEmail" value="${client.email||''}" />
              </div>
              <div>
                <label>Adresse</label>
                <input id="clientFormAddress" value="${client.address||''}" />
              </div>
            </div>
            <label style="margin-top:8px;">Notes</label>
            <textarea id="clientFormNotes">${client.notes||''}</textarea>
          </div>

          <div>
            <h3 style="margin:10px 0 6px; color:var(--accent);">V√©hicules</h3>
            <div id="clientVehiclesList" class="small"></div>
            <div style="margin-top:8px;" class="row">
              <div><label>Marque</label><input id="vehMake" /></div>
              <div><label>Mod√®le</label><input id="vehModel" /></div>
              <div><label>Ann√©e</label><input id="vehYear" /></div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div><label>Plaque</label><input id="vehPlate" /></div>
              <div><label>VIN</label><input id="vehVin" /></div>
              <div><label>KM</label><input id="vehKm" type="number" /></div>
            </div>
            <label style="margin-top:6px;">Notes v√©hicule</label>
            <textarea id="vehNotes"></textarea>
            <button id="clientAddVehicleBtn" style="margin-top:6px;">Ajouter v√©hicule</button>
          </div>

          <div>
            <h3 style="margin:10px 0 6px; color:var(--accent);">Historique (√† partir des factures)</h3>
            <div id="clientHistory" class="small"></div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
            ${isNew ? '' : '<button id="clientDeleteBtn" class="ghost">Supprimer client</button>'}
            <button id="clientSaveBtn">Enregistrer</button>
          </div>
        </div>
      `;

      function renderVehicles(){
        const wrap = document.getElementById('clientVehiclesList');
        if(!wrap) return;
        if(!client.vehicles || client.vehicles.length===0){
          wrap.innerHTML = '<div class="muted">Aucun v√©hicule pour ce client.</div>';
          return;
        }
        wrap.innerHTML = client.vehicles.map((v,idx)=>`
          <div style="border:1px solid var(--border); border-radius:6px; padding:6px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div><strong>${v.make||''} ${v.model||''} ${v.year||''}</strong></div>
              <div class="small">Plaque: ${v.plate||''} | VIN: ${v.vin||''} | KM: ${v.km||''}</div>
              <div class="small">${v.notes||''}</div>
            </div>
            <button class="ghost" data-index="${idx}" data-role="del-veh">Suppr</button>
          </div>
        `).join('');
        wrap.querySelectorAll('button[data-role="del-veh"]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const idx = Number(btn.getAttribute('data-index'));
            client.vehicles.splice(idx,1);
            renderVehicles();
          });
        });
      }
      renderVehicles();

      const histWrap = document.getElementById('clientHistory');
      if(histWrap){
        if(clientInvoices.length===0){
          histWrap.innerHTML = '<div class="muted">Aucune facture associ√©e pour ce client pour le moment.</div>';
        }else{
          histWrap.innerHTML = clientInvoices.map(inv=>`
            <div style="border-bottom:1px solid var(--border); padding:4px 0;">
              <div><strong>#${inv.number}</strong> - ${inv.date}</div>
              <div class="small">${inv.job||''}</div>
              <div class="small">Total: ${Number(inv.total||0).toFixed(2)} $</div>
            </div>
          `).join('');
        }
      }

      const btnSave = document.getElementById('clientSaveBtn');
      if(btnSave){
        btnSave.addEventListener('click',()=>{
          const name = document.getElementById('clientFormName').value.trim();
          if(!name){ alert('Le nom du client est requis.'); return; }
          client.name = name;
          client.phone = document.getElementById('clientFormPhone').value.trim();
          client.email = document.getElementById('clientFormEmail').value.trim();
          client.address = document.getElementById('clientFormAddress').value.trim();
          client.notes = document.getElementById('clientFormNotes').value.trim();

          const idx = CLIENTS.findIndex(c => String(c.id) === String(client.id));
          if(idx === -1){
            CLIENTS.push(client);
          }else{
            CLIENTS[idx] = client;
          }
          saveClientsToStorage();
          renderClientsTable();
          closeClientModal();
        });
      }

      const vehBtn = document.getElementById('clientAddVehicleBtn');
      if(vehBtn){
        vehBtn.addEventListener('click',()=>{
          const make = document.getElementById('vehMake').value.trim();
          const model = document.getElementById('vehModel').value.trim();
          const year = document.getElementById('vehYear').value.trim();
          if(!make && !model){
            alert('Au moins marque ou mod√®le requis pour le v√©hicule.');
            return;
          }
          const v = {
            id: Date.now(),
            make,
            model,
            year,
            plate: document.getElementById('vehPlate').value.trim(),
            vin: document.getElementById('vehVin').value.trim(),
            km: document.getElementById('vehKm').value.trim(),
            notes: document.getElementById('vehNotes').value.trim()
          };
          if(!Array.isArray(client.vehicles)) client.vehicles = [];
          client.vehicles.push(v);
          document.getElementById('vehMake').value='';
          document.getElementById('vehModel').value='';
          document.getElementById('vehYear').value='';
          document.getElementById('vehPlate').value='';
          document.getElementById('vehVin').value='';
          document.getElementById('vehKm').value='';
          document.getElementById('vehNotes').value='';
          renderVehicles();
        });
      }

      const btnDelete = document.getElementById('clientDeleteBtn');
      if(btnDelete && !isNew){
        btnDelete.addEventListener('click',()=>{
          if(!confirm('Supprimer ce client ?')) return;
          CLIENTS = CLIENTS.filter(c => String(c.id) !== String(client.id));
          saveClientsToStorage();
          renderClientsTable();
          closeClientModal();
        });
      }
    }

    function initClients(){
      loadClientsFromStorage();
      const search = document.getElementById('clientSearch');
      if(search){
        search.addEventListener('input', renderClientsTable);
      }
      const btnAdd = document.getElementById('btnAddClient');
      if(btnAdd){
        btnAdd.addEventListener('click', ()=> openClientModal(null));
      }
      const btnCloseModal = document.getElementById('closeClientModal');
      if(btnCloseModal){
        btnCloseModal.addEventListener('click', closeClientModal);
      }
      renderClientsTable();
    }

    // --- Init ---
    loadSettings();
    updateInvoiceNumberField();
    renderItems();
    loadInvoices();
    initClients();

    // --- Simple PWA: register a service worker created from a blob so the app can be installable offline ---
    if('serviceWorker' in navigator){
      const swCode = `self.addEventListener('install', e => { self.skipWaiting(); }); self.addEventListener('activate', e => {clients.claim();}); self.addEventListener('fetch', e => {/* no-op but allows offline install */});`;
      try{
        const blob = new Blob([swCode],{type:'text/javascript'});
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url).then(()=>console.log('SW registered (blob)')).catch(()=>{});
      }catch(e){console.warn('SW failed',e)}
    }

    // Provide guidance for first-time users
    if(!localStorage.getItem('ar_welcome_shown')){
      alert('Astuce: ouvre les Param√®tres pour configurer nom d\'entreprise et taux de taxes. Utilise Imprimer -> "Enregistrer en PDF" pour exporter la facture en PDF.');
      localStorage.setItem('ar_welcome_shown', '1');
    }

  // --- Add Work Order History Page & UI wiring (basic placeholders) ---
function openPage(id){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
}

// Button wiring example
const btnNewWO = document.getElementById('btn-new-workorder');
if(btnNewWO) btnNewWO.onclick = ()=> openPage('page-workorder');

const btnHistory = document.getElementById('btn-history');
if(btnHistory) btnHistory.onclick = ()=> openPage('page-history');

// Generate history list
function refreshHistory(){
  const container = document.getElementById('history-list');
  if(!container) return;
  container.innerHTML = db.workOrders.map(o=>`
    <div class='history-item'>
      <strong>${o.client}</strong> ‚Äî ${o.vehicleId}<br>
      <em>${new Date(o.id).toLocaleString()}</em><br>
      ${o.description || ''}
    </div>
  `).join('');
}

// Run at startup
refreshHistory();

// --- PWA Install Prompt ---
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  window.deferredPrompt = e;
  const installBtn = document.getElementById('btn-install');
  if(installBtn) installBtn.style.display='block';
});

async function installPWA(){
  const prompt = window.deferredPrompt;
  if(!prompt) return;
  prompt.prompt();
  window.deferredPrompt = null;
}
</script>

<script>
// --- Enable buttons & add work order history system ---
// Basic structure: store invoices + work orders separately
const db = {
  invoices: JSON.parse(localStorage.getItem('invoices')||'[]'),
  workOrders: JSON.parse(localStorage.getItem('workOrders')||'[]')
};

function saveDB(){
  localStorage.setItem('invoices', JSON.stringify(db.invoices));
  localStorage.setItem('workOrders', JSON.stringify(db.workOrders));
}

// Example button activation (placeholder ‚Äî wire to actual UI buttons)
document.querySelectorAll('button').forEach(btn=>{
  btn.onclick = ()=>{
    console.log('Button pressed:', btn.innerText);
  };
});

// Work order creation
function createWorkOrder(data){
  const id = Date.now();
  const order = { id, ...data };
  db.workOrders.push(order);
  saveDB();
  return order;
}

// Get history for a specific vehicle (by VIN or plate)
function getHistoryByVehicle(identifier){
  return db.workOrders.filter(o => o.vehicleId === identifier);
}

// Get history for a client
function getHistoryByClient(clientName){
  return db.workOrders.filter(o => o.client === clientName);
}

console.log('Enhanced system loaded.');
</script>
  
  <!-- ===================== CLIENT MODAL (NEW) ===================== -->
  <div id="clientModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:var(--card); width:750px; max-width:95%; padding:20px; border-radius:12px; border:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,0.6); max-height:90vh; overflow-y:auto;">
      <h2 style="color:var(--accent); margin-bottom:10px;">Fiche Client</h2>
      <div id="clientModalContent" style="margin-bottom:20px; color:var(--text);">
        <!-- CONTENU G√âN√âR√â PAR JS -->
        Chargement...
      </div>
      <div style="text-align:right; margin-top:15px;">
        <button id="closeClientModal" class="ghost">Fermer</button>
      </div>
    </div>
  </div>
  <!-- =================== END CLIENT MODAL =================== -->

</body>
</html>
